/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import"prop-types";import{createContext as t,useRef as r,useMemo as n,useCallback as o,useReducer as i,useState as a,useEffect as s}from"@googleforcreators/react";import{clamp as l}from"@googleforcreators/units";import{v4 as c}from"uuid";import"../types.js";import{AnimationPart as m}from"../parts/index.js";import"../parts/types.js";"KeyframeEffect"in window||import("web-animations-js/web-animations-next-lite.min.js").catch((()=>{}));const u=t(null),d={idle:{complete:"complete"},complete:{reset:"idle"}},WAAPIAnimationStateReducer=(e,t)=>d[e][t]||e,p=e=>{let{animation:t}=e;return new Promise((e=>{t.onfinish=e}))},f=[];function g(e,t){let[r,n]=t;return e?.has(r)&&e.get(r)===n}function Provider(t){let{animations:d,elements:h,children:y,onWAAPIFinish:A,selectedElementIds:I=[]}=t;const w=r(null),E=n((()=>(h||[]).reduce(((e,t)=>(e.set(t.id,t),e)),new Map)),[h]),P=r(null),v=n((()=>(d||[]).reduce(((e,t)=>(e.set(t.id,t),e)),new Map)),[d]),M=r(null),j=n((()=>{const{current:e}=P,{current:t}=w,{current:r}=M,n=new Map;for(const[o,i]of v.entries()){const a=g(e,[o,i]),s=i.targets.every((e=>g(t,[e,E.get(e)])));if(a&&s)i.targets.forEach((e=>n.set(e,r.get(e))));else{const{id:e,targets:t,type:r,...o}=i;(t||[]).forEach((e=>{const t=n.get(e)||[],i=E.get(e);n.set(e,[...t,m(r,{...o,element:i})])}))}}return P.current=v,w.current=E,M.current=n,n}),[v,E]),x=n((()=>c()),[]),T=n((()=>Array.from(j.keys()||[])),[j]),b=o((e=>j.get(e)||f),[j]),W=r(A),[C,F]=i(WAAPIAnimationStateReducer,"idle"),S=r(new Map),[k,q]=a([]),K=n((()=>(e=>{let{animations:t,selectedElementIds:r}=e;return r.length>0?t.filter((e=>{let{elementId:t}=e;return r.includes(t)})):t})({animations:k,selectedElementIds:I})),[I,k]),N=o((e=>{let{animation:t,elementId:r}=e;const n=Symbol();return S.current.set(n,{animation:t,elementId:r}),q(Array.from(S.current.values())),()=>{t?.cancel(),S.current.delete(n),q(Array.from(S.current.values()))}}),[]),X=n((()=>{const e=()=>K.forEach((e=>{let{animation:t}=e;return t?.pause()})),t=e=>K.forEach((t=>{let{animation:r}=t;const{duration:n,delay:o}=(r.effect?.timing||r.effect?.getTiming())??{},i=(o||0)+(n||0);r.currentTime="end"===e?i:l(e,{MIN:0,MAX:i})}));return{play:()=>K.forEach((e=>{let{animation:t}=e;t?.cancel(),t?.play()})),pause:e,setCurrentTime:t,reset:()=>{e(),requestAnimationFrame((()=>{t("end")}))}}}),[K]);s((()=>{let e=()=>{};return"idle"===C&&K.length&&new Promise(((t,r)=>{e=r,Promise.all(K.map(p)).then((()=>{e=()=>{},t()}))})).then((()=>F("complete"))).catch((()=>{})),e}),[K,C]),W.current=A,s((()=>{"complete"===C&&(W.current?.(),F("reset"))}),[C]);const z=n((()=>({state:{providerId:x,animationTargets:T},actions:{getAnimationParts:b,hoistWAAPIAnimation:N,WAAPIAnimationMethods:X}})),[x,b,T,N,X]);return e.createElement(u.Provider,{value:z},y)}export{u as StoryAnimationContext,Provider as default};
