/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");require("prop-types");var t=require("@googleforcreators/react"),r=require("@googleforcreators/units"),n=require("uuid");require("../types.js");var o=require("../parts/index.js");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("../parts/types.js");var i=s(e);"KeyframeEffect"in window||Promise.resolve().then((function(){return a(require("web-animations-js/web-animations-next-lite.min.js"))})).catch((()=>{}));const u=t.createContext(null),c={idle:{complete:"complete"},complete:{reset:"idle"}},WAAPIAnimationStateReducer=(e,t)=>c[e][t]||e,l=e=>{let{animation:t}=e;return new Promise((e=>{t.onfinish=e}))},m=[];function f(e,t){let[r,n]=t;return e?.has(r)&&e.get(r)===n}exports.StoryAnimationContext=u,exports.default=function Provider(e){let{animations:s,elements:a,children:c,onWAAPIFinish:d,selectedElementIds:p=[]}=e;const g=t.useRef(null),y=t.useMemo((()=>(a||[]).reduce(((e,t)=>(e.set(t.id,t),e)),new Map)),[a]),h=t.useRef(null),M=t.useMemo((()=>(s||[]).reduce(((e,t)=>(e.set(t.id,t),e)),new Map)),[s]),v=t.useRef(null),A=t.useMemo((()=>{const{current:e}=h,{current:t}=g,{current:r}=v,n=new Map;for(const[s,a]of M.entries()){const i=f(e,[s,a]),u=a.targets.every((e=>f(t,[e,y.get(e)])));if(i&&u)a.targets.forEach((e=>n.set(e,r.get(e))));else{const{id:e,targets:t,type:r,...s}=a;(t||[]).forEach((e=>{const t=n.get(e)||[],a=y.get(e);n.set(e,[...t,o.AnimationPart(r,{...s,element:a})])}))}}return h.current=M,g.current=y,v.current=n,n}),[M,y]),P=t.useMemo((()=>n.v4()),[]),b=t.useMemo((()=>Array.from(A.keys()||[])),[A]),E=t.useCallback((e=>A.get(e)||m),[A]),j=t.useRef(d),[w,I]=t.useReducer(WAAPIAnimationStateReducer,"idle"),q=t.useRef(new Map),[x,O]=t.useState([]),R=t.useMemo((()=>(e=>{let{animations:t,selectedElementIds:r}=e;return r.length>0?t.filter((e=>{let{elementId:t}=e;return r.includes(t)})):t})({animations:x,selectedElementIds:p})),[p,x]),C=t.useCallback((e=>{let{animation:t,elementId:r}=e;const n=Symbol();return q.current.set(n,{animation:t,elementId:r}),O(Array.from(q.current.values())),()=>{t?.cancel(),q.current.delete(n),O(Array.from(q.current.values()))}}),[]),k=t.useMemo((()=>{const e=()=>R.forEach((e=>{let{animation:t}=e;return t?.pause()})),t=e=>R.forEach((t=>{let{animation:n}=t;const{duration:o,delay:s}=(n.effect?.timing||n.effect?.getTiming())??{},a=(s||0)+(o||0);n.currentTime="end"===e?a:r.clamp(e,{MIN:0,MAX:a})}));return{play:()=>R.forEach((e=>{let{animation:t}=e;t?.cancel(),t?.play()})),pause:e,setCurrentTime:t,reset:()=>{e(),requestAnimationFrame((()=>{t("end")}))}}}),[R]);t.useEffect((()=>{let e=()=>{};return"idle"===w&&R.length&&new Promise(((t,r)=>{e=r,Promise.all(R.map(l)).then((()=>{e=()=>{},t()}))})).then((()=>I("complete"))).catch((()=>{})),e}),[R,w]),j.current=d,t.useEffect((()=>{"complete"===w&&(j.current?.(),I("reset"))}),[w]);const T=t.useMemo((()=>({state:{providerId:P,animationTargets:b},actions:{getAnimationParts:E,hoistWAAPIAnimation:C,WAAPIAnimationMethods:k}})),[P,E,b,C,k]);return i.default.createElement(u.Provider,{value:T},c)};
