/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{__,sprintf}from"@googleforcreators/i18n";import{useState as t,useRef as o,useMemo as r,useCallback as s,useEffect as i}from"@googleforcreators/react";import{trackEvent as a,trackScreenView as l}from"@googleforcreators/tracking";import{useLiveRegion as n,uniqueEntriesByKey as m}from"@googleforcreators/design-system";import"prop-types";import"../../../constants/index.js";import"../../../components/cardGallery/components.js";import"../../../components/cardGrid/index.js";import"../../../components/cardGridItem/index.js";import"../../../components/colorList/index.js";import"../../../components/contentGutter/index.js";import"styled-components";import"../../../components/fileUpload/index.js";import"../../../components/infiniteScroller/index.js";import"../../../components/inlineInputForm/index.js";import p from"../../../components/layout/index.js";import"../../../components/pageStructure/pageStructureComponents.js";import"../../../components/pageStructure/leftRail.js";import"../../../components/pageStructure/menuButton.js";import"../../../components/navProvider.js";import c from"../../../components/scrollToTop/index.js";import"../../../components/storyMenu/index.js";import"../../../components/table/index.js";import"../../config/context.js";import"../../../components/viewStyleBar/index.js";import"../../../utils/keyboardOnlyOutline.js";import"@googleforcreators/units";import"../../../utils/useStoryView.js";import d from"../../../utils/useTemplateView.js";import u from"../../api/useApi.js";import g from"../../router/useRouteHistory.js";import f from"../utils/getTemplateFilters.js";import j from"../utils/composeTemplateFilter.js";import x from"./content/index.js";import T from"./header/index.js";import y from"./modal/index.js";function ExploreTemplates(){const h=n(),[w,L]=t(!1),[P,v]=t(null),[E,F]=t(0),{templateIdParam:I,replace:S}=g((e=>{let{actions:t,state:o}=e;return{templateIdParam:o.queryParams.id,replace:t.replace}})),O=o(I),{allPagesFetched:b,isLoading:B,templates:k,templatesOrderById:A,totalPages:G,totalTemplates:V,createStoryFromTemplate:$,fetchExternalTemplates:C}=u((e=>{let{state:{templates:{allPagesFetched:t,isLoading:o,templates:r,templatesOrderById:s,totalPages:i,totalTemplates:a}},actions:{storyApi:{createStoryFromTemplate:l},templateApi:{fetchExternalTemplates:n}}}=e;return{allPagesFetched:t,isLoading:o,templates:r,templatesOrderById:s,totalPages:i,totalTemplates:a,createStoryFromTemplate:l,fetchExternalTemplates:n}})),{filter:D,page:R,search:_,sort:q,view:H}=d({totalPages:G}),M=r((()=>f(k)),[k]),U=r((()=>_.keyword?M.filter((e=>e.label.toLowerCase().includes(_.keyword.toLowerCase()))):M),[M,_.keyword]),z=r((()=>A.map((e=>k[e])).filter(j(U))),[A,k,U]),J=r((()=>V!==z.length?z.length:V),[z,V]),K=r((()=>m(U,"label")),[U]),N=s((e=>{const t=k[e];a("use_template",{name:t.title,template_id:t.id}),$(t)}),[$,k]),Q=s((e=>{const t=z.find((t=>t.id===e));v(t),F(z.findIndex((t=>t.id===e))),O.current&&(O.current=void 0),S(`?id=${t.id}&isLocal=${t.isLocal}`)}),[S,z]),W=s(((e,t)=>{L((o=>{const r=!o;return t&&l(t),r&&e&&Q(e),r||(S(""),h(__("Exit detail templates view","web-stories"))),r}))}),[S,h,Q]),X=s((e=>{const t=z[e];v(t),F(e),S(`?id=${t.id}&isLocal=${t.isLocal}`),h(sprintf(
/* translators: %s: template title */
__("Viewing %s","web-stories"),t.title))}),[z,S,h]),Y=r((()=>({createStoryFromTemplate:N,handleDetailsToggle:W,switchToTemplateByOffset:X})),[N,W,X]);return i((()=>{C()}),[C]),i((()=>{if(O.current&&z.length){if(!z.some((e=>e.id===parseInt(O.current))))return void S("");L(!0),Q(parseInt(O.current))}}),[z,S,Q]),e.createElement(p.Provider,null,e.createElement(T,{isLoading:B&&!V,filter:D,sort:q,totalTemplates:J,search:_,searchOptions:K,view:H}),e.createElement(x,{isLoading:B,allPagesFetched:b,page:R,templates:z,totalTemplates:J,search:_,view:H,templateActions:Y}),e.createElement(p.Fixed,null,e.createElement(c,null)),e.createElement(y,{activeTemplate:P,activeTemplateIndex:E,isDetailsViewOpen:w,templateActions:Y,filteredTemplatesLength:z.length}))}export{ExploreTemplates as default};
