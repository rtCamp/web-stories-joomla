/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("@googleforcreators/i18n"),r=require("@googleforcreators/react"),s=require("@googleforcreators/tracking"),a=require("@googleforcreators/design-system");require("prop-types"),require("../../../constants/index.js"),require("../../../components/cardGallery/components.js"),require("../../../components/cardGrid/index.js"),require("../../../components/cardGridItem/index.js"),require("../../../components/colorList/index.js"),require("../../../components/contentGutter/index.js"),require("styled-components"),require("../../../components/fileUpload/index.js"),require("../../../components/infiniteScroller/index.js"),require("../../../components/inlineInputForm/index.js");var i=require("../../../components/layout/index.js");require("../../../components/pageStructure/pageStructureComponents.js"),require("../../../components/pageStructure/leftRail.js"),require("../../../components/pageStructure/menuButton.js"),require("../../../components/navProvider.js");var o=require("../../../components/scrollToTop/index.js");require("../../../components/storyMenu/index.js"),require("../../../components/table/index.js"),require("../../config/context.js"),require("../../../components/viewStyleBar/index.js"),require("../../../utils/keyboardOnlyOutline.js"),require("@googleforcreators/units"),require("../../../utils/useStoryView.js");var l=require("../../../utils/useTemplateView.js"),n=require("../../api/useApi.js"),u=require("../../router/useRouteHistory.js"),c=require("../utils/getTemplateFilters.js"),m=require("../utils/composeTemplateFilter.js"),p=require("./content/index.js"),d=require("./header/index.js"),f=require("./modal/index.js");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var q=g(e);module.exports=function ExploreTemplates(){const e=a.useLiveRegion(),[g,j]=r.useState(!1),[y,x]=r.useState(null),[T,h]=r.useState(0),{templateIdParam:v,replace:w}=u((e=>{let{actions:t,state:r}=e;return{templateIdParam:r.queryParams.id,replace:t.replace}})),E=r.useRef(v),{allPagesFetched:S,isLoading:L,templates:P,templatesOrderById:F,totalPages:b,totalTemplates:k,createStoryFromTemplate:I,fetchExternalTemplates:O}=n((e=>{let{state:{templates:{allPagesFetched:t,isLoading:r,templates:s,templatesOrderById:a,totalPages:i,totalTemplates:o}},actions:{storyApi:{createStoryFromTemplate:l},templateApi:{fetchExternalTemplates:n}}}=e;return{allPagesFetched:t,isLoading:r,templates:s,templatesOrderById:a,totalPages:i,totalTemplates:o,createStoryFromTemplate:l,fetchExternalTemplates:n}})),{filter:B,page:C,search:M,sort:_,view:A}=l({totalPages:b}),V=r.useMemo((()=>c(P)),[P]),G=r.useMemo((()=>M.keyword?V.filter((e=>e.label.toLowerCase().includes(M.keyword.toLowerCase()))):V),[V,M.keyword]),R=r.useMemo((()=>F.map((e=>P[e])).filter(m(G))),[F,P,G]),$=r.useMemo((()=>k!==R.length?R.length:k),[R,k]),D=r.useMemo((()=>a.uniqueEntriesByKey(G,"label")),[G]),H=r.useCallback((e=>{const t=P[e];s.trackEvent("use_template",{name:t.title,template_id:t.id}),I(t)}),[I,P]),K=r.useCallback((e=>{const t=R.find((t=>t.id===e));x(t),h(R.findIndex((t=>t.id===e))),E.current&&(E.current=void 0),w(`?id=${t.id}&isLocal=${t.isLocal}`)}),[w,R]),U=r.useCallback(((r,a)=>{j((i=>{const o=!i;return a&&s.trackScreenView(a),o&&r&&K(r),o||(w(""),e(t.__("Exit detail templates view","web-stories"))),o}))}),[w,e,K]),z=r.useCallback((r=>{const s=R[r];x(s),h(r),w(`?id=${s.id}&isLocal=${s.isLocal}`),e(t.sprintf(
/* translators: %s: template title */
t.__("Viewing %s","web-stories"),s.title))}),[R,w,e]),J=r.useMemo((()=>({createStoryFromTemplate:H,handleDetailsToggle:U,switchToTemplateByOffset:z})),[H,U,z]);return r.useEffect((()=>{O()}),[O]),r.useEffect((()=>{if(E.current&&R.length){if(!R.some((e=>e.id===parseInt(E.current))))return void w("");j(!0),K(parseInt(E.current))}}),[R,w,K]),q.default.createElement(i.default.Provider,null,q.default.createElement(d,{isLoading:L&&!k,filter:B,sort:_,totalTemplates:$,search:M,searchOptions:D,view:A}),q.default.createElement(p,{isLoading:L,allPagesFetched:S,page:C,templates:R,totalTemplates:$,search:M,view:A,templateActions:J}),q.default.createElement(i.default.Fixed,null,q.default.createElement(o,null)),q.default.createElement(f,{activeTemplate:y,activeTemplateIndex:T,isDetailsViewOpen:g,templateActions:J,filteredTemplatesLength:R.length}))};
