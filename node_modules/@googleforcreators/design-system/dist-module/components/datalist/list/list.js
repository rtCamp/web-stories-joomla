/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{memo as t,forwardRef as r,useRef as o,useState as n,useMemo as i,useLayoutEffect as s,useCallback as a,useFocusOut as l,useEffect as c}from"@googleforcreators/react";import"prop-types";import{v4 as p}from"uuid";import{__}from"@googleforcreators/i18n";import m from"styled-components";import{isKeywordFilterable as u,createOptionFilter as d,addUniqueEntries as f,getOptions as g,getInset as b}from"../utils.js";import{THEME_CONSTANTS as h}from"../../../theme/constants/index.js";import{noop as y}from"../../../utils/noop.js";import{NoResult as E,List as w,Group as v,GroupLabel as x}from"./styled.js";import S from"./defaultRenderer.js";import{Text as O}from"../../typography/text/index.js";const L=m(O).attrs({forwardedAs:"span",size:h.TYPOGRAPHY.PRESET_SIZES.X_SMALL}).withConfig({displayName:"list__StyledLabel",componentId:"sc-1c2a66-0"})(["color:",";"],(e=>{let{theme:t}=e;return t.colors.fg.tertiary}));var I=t(r((function OptionList(t,r){let{keyword:m="",value:h="",onSelect:O=y,onClose:I=y,onExpandedChange:T=y,focusTrigger:j=0,options:k=[],primaryOptions:A,primaryLabel:C,priorityOptionGroups:M=[],searchResultsLabel:P,renderer:R=S,onObserve:_,focusSearch:D=y,listId:z,listStyleOverrides:G}=t;const H=R,K=o([]),[N,Y]=n(-1),$=o([]),q=i((()=>u(m)&&k?[{label:P,options:d(k)(m)}]:[...M?.length?M:[],{label:C,options:A}]),[m,k,M,A,C,P]),U=i((()=>new window.IntersectionObserver((e=>{if(_){const t=e.filter((e=>e.isIntersecting)).map((e=>e.target.dataset.option));$.current=f($.current,...t),_($.current)}}),{root:r.current,rootMargin:"60px"})),[_,r]);s((()=>{const e=K.current;return _&&e.forEach((e=>e&&U.observe(e))),()=>{_&&e.forEach((e=>e&&U.unobserve(e))),K.current=[]}}),[U,_,q,R]);const X=i((()=>g(q)),[q]),Z=a((e=>{const{key:t}=e;e.stopPropagation(),e.preventDefault(),"Tab"===t&&e.shiftKey&&D(),"Escape"===t?I():"Enter"===t?X[N]&&O(X[N]):"ArrowUp"===t?Y((e=>Math.max(0,e-1))):"ArrowDown"===t&&Y((e=>Math.min(X.length-1,e+1)))}),[N,X,I,O,D]);l(r,(()=>Y(-1)),[]),c((()=>{const e=r.current;if(!e)return;if(-1===N)return void e.scrollTo(0,0);const t=K.current[N];t&&(t.focus(),e.scrollTo(0,t.offsetTop-e.clientHeight/2))}),[N,X,m,I,r]);const B=X.length>0;return c((()=>T(B)),[T,B]),c((()=>{j>0&&Y(0)}),[j]),X.length<=0?e.createElement(E,null,__("No matches found","web-stories")):e.createElement(w,{ref:r,tabIndex:0,id:z,role:"listbox",onKeyDown:Z,"aria-label":__("Option List Selector","web-stories"),"aria-required":!1,$listStyleOverrides:G},q.map(((t,r)=>{const o=`group-${p()}`;return t.options.length>0&&e.createElement(v,{key:o,role:"group","aria-labelledby":o},t.label&&e.createElement(x,{id:o,role:"presentation"},e.createElement(L,null,t.label)),t.options.map(((t,o)=>{const n=b(q,r,o);return e.createElement(H,{key:t.id||"",role:"option",tabIndex:"-1","aria-selected":h===t.id,"aria-posinset":n+1,"aria-setsize":X.length,"data-option":t.id,onClick:()=>O(t),ref:e=>K.current[n]=e,option:t,value:h})})))})))})));export{I as default};
