/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import t,{css as r}from"styled-components";import{useState as o,useRef as i,useCallback as a,useUnmount as n,useEffect as s}from"@googleforcreators/react";import{__}from"@googleforcreators/i18n";import"prop-types";import{getMediaSizePositionProps as c,calculateSrcSet as l}from"@googleforcreators/media";import{BG_MAX_SCALE as m,BG_MIN_SCALE as d}from"@googleforcreators/animation";import{shouldDisplayBorder as p,DisplayWithMask as f}from"@googleforcreators/masks";import{getTransformFlip as g}from"@googleforcreators/elements";import{elementFillContent as u,elementWithFlip as h}from"../shared/shared.js";import"../shared/layerText.js";import"@googleforcreators/patterns";import"@googleforcreators/transform";import y from"./editCropMoveable.js";import{mediaWithScale as b}from"./util.js";import v from"./editPanMoveable.js";import x from"./scalePanel.js";import{MEDIA_MASK_OPACITY as E}from"./constants.js";import{CropBox as w}from"./index.js";function I(){return I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},I.apply(this,arguments)}const j=t.div.withConfig({displayName:"edit__Element",componentId:"sc-ybci2b-0"})(["",""],u),C=r(["position:absolute;opacity:",";pointer-events:none;"," ",""],(e=>{let{opacity:t}=e;return void 0!==t?t*E:E}),b,h),_=t.img.withConfig({displayName:"edit__FadedImage",componentId:"sc-ybci2b-1"})(["",""],C),M=t.video.withConfig({displayName:"edit__FadedVideo",componentId:"sc-ybci2b-2"})([""," max-width:initial;max-height:initial;"],C),P=r([""," "," position:absolute;cursor:grab;opacity:",";"],b,h,(e=>{let{opacity:t}=e;return void 0!==t?1-(1-t)/(1-t*E):null})),Y=t.img.withConfig({displayName:"edit__CropImage",componentId:"sc-ybci2b-3"})(["",""],P),N=t.video.withConfig({displayName:"edit__CropVideo",componentId:"sc-ybci2b-4"})([""," max-width:initial;max-height:initial;"],P);function MediaEdit(t){let{element:r,box:u,setLocalProperties:h,getProxiedUrl:b,updateElementById:E,zIndexCanvas:C}=t;const{id:P,resource:X,opacity:F,scale:O,flip:z,focalX:A,focalY:B,isBackground:L,type:S,borderRadius:T}=r,{x:k,y:D,width:H,height:V,rotationAngle:W}=u,[R,U]=o(null),[q,G]=o(null),[J,K]=o(null),Q=i(),Z=i(!1),$=i({scale:O}),ee=a((e=>{const t={...$.current,..."function"==typeof e?e($.current):e};$.current=t,Z.current=!0,h($.current)}),[h]),te=a((()=>{if(!Z.current)return;Z.current=!1;const e=$.current;E({elementId:P,properties:e})}),[P,E]);n(te);const re=["image","gif"].includes(S),oe="video"===S,ie=c(X,H,V,O,z?.horizontal?100-A:A,z?.vertical?100-B:B);ie.transformFlip=g(z),ie.crossOrigin="anonymous";const ae={ref:U,draggable:!1,alt:"",opacity:F/100,...ie},ne={ref:G,draggable:!1,src:X.src,alt:__("Drag to move media element","web-stories"),opacity:F/100,tabIndex:0,...ie},se=b(X,X?.src);s((()=>{q&&Q.current&&!Q.current.contains(document.activeElement)&&q.focus()}),[q]);const ce=l(r.resource);re&&ce&&(ne.srcSet=ce);const le=a((e=>{ee((t=>{let{scale:r}=t;return{scale:Math.min(m,Math.max(d,r+e.deltaY))}})),e.preventDefault(),e.stopPropagation()}),[ee]);s((()=>{const e=Q.current,t={passive:!1};return e.addEventListener("wheel",le,t),()=>e.removeEventListener("wheel",le,t)}),[le]);const me=p(r)&&T?r:null;return e.createElement(j,{ref:Q},re&&e.createElement(_,I({},ae,{src:se,srcSet:l(X)})),oe&&e.createElement(M,ae,se&&e.createElement("source",{src:se,type:X.mimeType})),e.createElement(w,I({ref:K},me),e.createElement(f,{element:r,fill:!0,applyFlip:!1,box:u},re&&e.createElement(Y,ne),oe&&e.createElement(N,ne,e.createElement("source",{src:se,type:X.mimeType})))),R&&q&&e.createElement(v,{setProperties:ee,fullMedia:R,croppedMedia:q,flip:z,x:k,y:D,width:H,height:V,rotationAngle:W,offsetX:ie.offsetX,offsetY:ie.offsetY,mediaWidth:ie.width,mediaHeight:ie.height}),!L&&J&&q&&e.createElement(y,{setProperties:ee,cropBox:J,croppedMedia:q,flip:z,x:k,y:D,width:H,height:V,rotationAngle:W,offsetX:ie.offsetX,offsetY:ie.offsetY,mediaWidth:ie.width,mediaHeight:ie.height}),e.createElement(x,{"aria-label":__("Scale media","web-stories"),"data-testid":"edit-panel-slider",setProperties:ee,x:k,y:D,width:H,height:V,scale:O||100,zIndexCanvas:C}))}export{MediaEdit as default};
