/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import t from"styled-components";import{useRef as r,useState as o,useEffect as s}from"@googleforcreators/react";import"prop-types";import{getSmallestUrlForWidth as i,resourceList as l,calculateSrcSet as a,getMediaSizePositionProps as c,preloadImage as n}from"@googleforcreators/media";import"@googleforcreators/elements";import{noop as m}from"../utils/noop.js";import{mediaWithScale as p}from"./util.js";import u from"./display.js";function f(){return f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},f.apply(this,arguments)}const g=t.img.withConfig({displayName:"imageDisplay__Img",componentId:"sc-17guqpr-0"})(["position:absolute;",""],p);function ImageDisplay(t){let{element:p,box:d,previewMode:y,getProxiedUrl:h,isCurrentResourceProcessing:w=m,isCurrentResourceUploading:z=m}=t;const{resource:b,scale:j,focalX:v,focalY:I}=p,{id:O,alt:P}=b,{width:x,height:C}=d,D=r();let E="smallest",R=i(0,b);"cached"===l.get(O)?.type&&(E="cached",R=l.get(O).url),("fullsize"===l.get(O)?.type||w(O)||z(O))&&(E="fullsize",R=b.src),R=h(b,R);const[M,S]=o(E),[T,U]=o(R),_="fullsize"===M?a(b):"",q=c(b,x,C,j,v,I);q.crossOrigin="anonymous",s((()=>{let e,t=!0;return"fullsize"!==l.get(O)?.type&&b.src?e=setTimeout((async()=>{const e=h(b,b.src);try{const r=await n({src:e,srcset:_});t&&(l.set(b.id,{type:"fullsize"}),U(r.currentSrc),S("fullsize"))}catch{}})):U(b.src),()=>{t=!1,clearTimeout(e)}}),[h,b,_,M,O]);const N="fullsize"!==M;return e.createElement(u,{element:p,mediaRef:D,showPlaceholder:N,previewMode:y},e.createElement(g,f({ref:D,draggable:!1,decoding:"sync",src:T,srcSet:_,alt:P,"data-testid":"imageElement","data-leaf-element":"true"},q)))}export{ImageDisplay as default};
