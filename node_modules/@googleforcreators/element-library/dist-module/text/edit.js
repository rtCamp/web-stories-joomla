/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import e from"styled-components";import{useMemo as r,useCallback as o,useRef as n,useEffect as i,useLayoutEffect as a,useUnmount as l}from"@googleforcreators/react";import"prop-types";import{generatePatternStyles as c}from"@googleforcreators/patterns";import{useUnits as d,calcRotatedResizeOffset as s}from"@googleforcreators/units";import{useTransform as g,useTransformHandler as u}from"@googleforcreators/transform";import{getHTMLInfo as p,useRichText as f,RichTextEditor as m}from"@googleforcreators/rich-text";import{stripHTML as h}from"@googleforcreators/dom";import{getBorderPositionCSS as y,shouldDisplayBorder as x}from"@googleforcreators/masks";import{BACKGROUND_TEXT_MODE as T}from"@googleforcreators/elements";import{elementFillContent as b,elementWithBackgroundColor as E,elementWithFont as C,elementWithTextParagraphStyle as H,elementWithHighlightBorderRadius as I,elementWithBorder as S}from"../shared/shared.js";import"../shared/layerText.js";import w from"../shared/useColorTransformHandler.js";import _ from"../shared/useCSSVarColorTransformHandler.js";import{generateParagraphTextStyle as v,getHighlightLineheight as k,calcFontMetrics as z}from"./util.js";function $(){return $=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},$.apply(this,arguments)}const N=e.div.withConfig({displayName:"edit__Wrapper",componentId:"sc-1ugcxaz-0"})([""," "," --faux-selection-color:inherit;span{box-decoration-break:clone;}"],b,E),B=e.div.withConfig({displayName:"edit__TextBox",componentId:"sc-1ugcxaz-1"})([""," "," opacity:",";position:absolute;top:0;left:0;right:0;"],C,H,(t=>{let{opacity:e}=t;return void 0!==e?e/100:null})),j=e(B).withConfig({displayName:"edit__TextBoxPadded",componentId:"sc-1ugcxaz-2"})((t=>{let{verticalPadding:e}=t;return{width:`calc(100% - ${e}px)`}})),A=e(B).withConfig({displayName:"edit__EditTextBox",componentId:"sc-1ugcxaz-3"})((t=>{let{hasHighlightBackgroundTextMode:e}=t;return e&&{paddingTop:0,paddingBottom:0}})),O=e.span.withConfig({displayName:"edit__Highlight",componentId:"sc-1ugcxaz-4"})([""," ",";color:transparent !important;*{color:transparent !important;}padding:",";width:",";"],I,(t=>{let{highlightColor:e}=t;return c(e)}),(t=>{let{padding:e}=t;return e}),(t=>{let{verticalPadding:e}=t;return`calc(100% - ${e}px)`})),R=e.div.withConfig({displayName:"edit__OutsideBorder",componentId:"sc-1ugcxaz-5"})([""," "," overflow:hidden;"],S,(t=>{let{border:e}=t;return e&&y(e)}));function TextEdit(e){let{element:c,box:{x:y,y:b,height:E,rotationAngle:C},editWrapper:H,onResize:I,updateElementById:S,deleteSelectedElements:B,maybeEnqueueFontStyle:Y}=e;const{id:D,content:P,backgroundColor:X,backgroundTextMode:L,border:M,borderRadius:G,opacity:W,height:F,...V}=c,{font:q,width:J}=V,K=r((()=>{const t=p(P);return{fontStyle:t.isItalic?"italic":"normal",fontWeight:t.fontWeight,content:h(P)}}),[P]),{dataToEditorX:Q,dataToEditorY:U,editorToDataX:Z,editorToDataY:tt}=d((t=>{let{actions:{dataToEditorX:e,dataToEditorY:r,editorToDataX:o,editorToDataY:n}}=t;return{dataToEditorX:e,dataToEditorY:r,editorToDataX:o,editorToDataY:n}})),et={...v(V,(t=>`${Q(t)}px`),(t=>`${U(t)}px`),U,c),font:q,element:c,backgroundColor:X,opacity:W,verticalPadding:Q(V.padding?.vertical||0),...L===T.HIGHLIGHT&&{lineHeight:k(V.lineHeight,Q(V.padding?.vertical||0)),backgroundColor:null,highlightColor:X},...L===T.NONE&&{backgroundColor:null}},{padding:rt,...ot}=et,{isAnythingTransforming:nt}=g((t=>({isAnythingTransforming:t.state.isAnythingTransforming}))),it=o((t=>S({elementId:D,properties:t})),[D,S]),at=n(null),lt=n(null),ct=n(null),dt=n(null),st=n(null),gt=n(),ut=n(),pt=n(0),ft=n(null);i((()=>{gt.current={x:y,y:b,height:E,rotationAngle:C}}),[y,b,E,C]);a((()=>{st.current&&st.current.focus()}),[]);const mt=o((()=>{const t=pt.current;if(at.current&&(at.current.style.height=""),ut.current){const e={content:ut.current};if(t){const[r,o]=s(gt.current.rotationAngle,0,0,0,t-gt.current.height);e.height=tt(t),e.x=Z(gt.current.x+r),e.y=tt(gt.current.y+o)}it(e)}}),[Z,tt,it]),ht=o((()=>{ut.current?mt():B()}),[mt,B]);l(ht),i((()=>{nt&&mt()}),[nt,mt]);const yt=o((()=>{const t=at.current,e=dt.current,{marginOffset:r}=z(c);if(pt.current=e.offsetHeight-U(r),t.style.height=`${pt.current}px`,e.style.margin="",H){const[t,e]=s(gt.current.rotationAngle,0,0,0,pt.current-gt.current.height);H.style.height=`${pt.current}px`,H.style.left=`${gt.current.x+t}px`,H.style.top=`${gt.current.y+e}px`,I&&I()}}),[U,H,c,I]),xt=o((t=>{ut.current=t,yt()}),[yt]);i(yt,[F,yt]),i((()=>{Y([{...K,font:q}])}),[q,K,Y]),u(D,(t=>{const e=dt.current,r=at.current,o=lt.current,n=t?.updates?.fontSize;if(e.style.fontSize=n?`${U(n)}px`:"",o){const r=t?.updates?.marginOffset;o.style.fontSize=e.style.fontSize,o.style.margin=U(-r)/2+"px 0",e.style.margin=U(-r)/2+"px 0"}if(null===t)r.style.width="",r.style.height="";else{const{resize:e}=t;e&&0!==e[0]&&0!==e[1]&&(r.style.width=`${e[0]}px`,r.style.height=`${e[1]}px`)}}));const Tt=L===T.HIGHLIGHT;_({id:D,targetRef:at,cssVar:"--faux-selection-color",expectedStyle:"color"});w({id:D,targetRef:Tt?ct:at,expectedStyle:"background"}),w({id:D,targetRef:x(c)?ft:null,expectedStyle:"border-color"});const{state:{editorState:bt},actions:{getContentFromState:Et}}=f(),Ct=bt&&Et(bt),Ht={backgroundColor:L===T.FILL&&X};return t.createElement(R,{ref:ft,border:M,borderRadius:G,width:J,height:F},t.createElement(N,$({ref:at,onClick:t=>{st.current.focus(),t.stopPropagation()},"data-testid":"textEditor"},Ht),Ct&&Tt&&t.createElement(j,$({ref:lt},ot),t.createElement(O,$({ref:ct,borderRadius:G,dataToEditorY:U,dangerouslySetInnerHTML:{__html:Ct}},et))),t.createElement(A,$({hasHighlightBackgroundTextMode:Tt,className:"syncMargin",ref:dt},et),t.createElement(m,{ref:st,content:P,onChange:xt}))))}export{TextEdit as default};
