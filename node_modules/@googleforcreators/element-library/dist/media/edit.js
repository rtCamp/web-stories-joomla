/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("styled-components"),r=require("@googleforcreators/react"),i=require("@googleforcreators/i18n");require("prop-types");var a=require("@googleforcreators/media"),o=require("@googleforcreators/animation"),l=require("@googleforcreators/masks"),n=require("@googleforcreators/elements"),s=require("../shared/shared.js");require("../shared/layerText.js"),require("@googleforcreators/patterns"),require("@googleforcreators/transform");var c=require("./editCropMoveable.js"),d=require("./util.js"),u=require("./editPanMoveable.js"),f=require("./scalePanel.js"),p=require("./constants.js"),m=require("./index.js");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=g(e),y=g(t);function b(){return b=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},b.apply(this,arguments)}const v=y.default.div.withConfig({displayName:"edit__Element",componentId:"sc-ybci2b-0"})(["",""],s.elementFillContent),E=t.css(["position:absolute;opacity:",";pointer-events:none;"," ",""],(e=>{let{opacity:t}=e;return void 0!==t?t*p.MEDIA_MASK_OPACITY:p.MEDIA_MASK_OPACITY}),d.mediaWithScale,s.elementWithFlip),_=y.default.img.withConfig({displayName:"edit__FadedImage",componentId:"sc-ybci2b-1"})(["",""],E),x=y.default.video.withConfig({displayName:"edit__FadedVideo",componentId:"sc-ybci2b-2"})([""," max-width:initial;max-height:initial;"],E),C=t.css([""," "," position:absolute;cursor:grab;opacity:",";"],d.mediaWithScale,s.elementWithFlip,(e=>{let{opacity:t}=e;return void 0!==t?1-(1-t)/(1-t*p.MEDIA_MASK_OPACITY):null})),q=y.default.img.withConfig({displayName:"edit__CropImage",componentId:"sc-ybci2b-3"})(["",""],C),I=y.default.video.withConfig({displayName:"edit__CropVideo",componentId:"sc-ybci2b-4"})([""," max-width:initial;max-height:initial;"],C);module.exports=function MediaEdit(e){let{element:t,box:s,setLocalProperties:d,getProxiedUrl:p,updateElementById:g,zIndexCanvas:y}=e;const{id:E,resource:C,opacity:w,scale:M,flip:S,focalX:A,focalY:P,isBackground:j,type:Y,borderRadius:F}=t,{x:B,y:D,width:O,height:T,rotationAngle:W}=s,[k,N]=r.useState(null),[X,L]=r.useState(null),[z,R]=r.useState(null),K=r.useRef(),G=r.useRef(!1),H=r.useRef({scale:M}),U=r.useCallback((e=>{const t={...H.current,..."function"==typeof e?e(H.current):e};H.current=t,G.current=!0,d(H.current)}),[d]),V=r.useCallback((()=>{if(!G.current)return;G.current=!1;const e=H.current;g({elementId:E,properties:e})}),[E,g]);r.useUnmount(V);const J=["image","gif"].includes(Y),Q="video"===Y,Z=a.getMediaSizePositionProps(C,O,T,M,S?.horizontal?100-A:A,S?.vertical?100-P:P);Z.transformFlip=n.getTransformFlip(S),Z.crossOrigin="anonymous";const $={ref:N,draggable:!1,alt:"",opacity:w/100,...Z},ee={ref:L,draggable:!1,src:C.src,alt:i.__("Drag to move media element","web-stories"),opacity:w/100,tabIndex:0,...Z},te=p(C,C?.src);r.useEffect((()=>{X&&K.current&&!K.current.contains(document.activeElement)&&X.focus()}),[X]);const re=a.calculateSrcSet(t.resource);J&&re&&(ee.srcSet=re);const ie=r.useCallback((e=>{U((t=>{let{scale:r}=t;return{scale:Math.min(o.BG_MAX_SCALE,Math.max(o.BG_MIN_SCALE,r+e.deltaY))}})),e.preventDefault(),e.stopPropagation()}),[U]);r.useEffect((()=>{const e=K.current,t={passive:!1};return e.addEventListener("wheel",ie,t),()=>e.removeEventListener("wheel",ie,t)}),[ie]);const ae=l.shouldDisplayBorder(t)&&F?t:null;return h.default.createElement(v,{ref:K},J&&h.default.createElement(_,b({},$,{src:te,srcSet:a.calculateSrcSet(C)})),Q&&h.default.createElement(x,$,te&&h.default.createElement("source",{src:te,type:C.mimeType})),h.default.createElement(m.CropBox,b({ref:R},ae),h.default.createElement(l.DisplayWithMask,{element:t,fill:!0,applyFlip:!1,box:s},J&&h.default.createElement(q,ee),Q&&h.default.createElement(I,ee,h.default.createElement("source",{src:te,type:C.mimeType})))),k&&X&&h.default.createElement(u,{setProperties:U,fullMedia:k,croppedMedia:X,flip:S,x:B,y:D,width:O,height:T,rotationAngle:W,offsetX:Z.offsetX,offsetY:Z.offsetY,mediaWidth:Z.width,mediaHeight:Z.height}),!j&&z&&X&&h.default.createElement(c,{setProperties:U,cropBox:z,croppedMedia:X,flip:S,x:B,y:D,width:O,height:T,rotationAngle:W,offsetX:Z.offsetX,offsetY:Z.offsetY,mediaWidth:Z.width,mediaHeight:Z.height}),h.default.createElement(f,{"aria-label":i.__("Scale media","web-stories"),"data-testid":"edit-panel-slider",setProperties:U,x:B,y:D,width:O,height:T,scale:M||100,zIndexCanvas:y}))};
