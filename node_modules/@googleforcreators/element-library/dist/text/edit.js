/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("styled-components"),r=require("@googleforcreators/react");require("prop-types");var o=require("@googleforcreators/patterns"),n=require("@googleforcreators/units"),a=require("@googleforcreators/transform"),i=require("@googleforcreators/rich-text"),l=require("@googleforcreators/dom"),s=require("@googleforcreators/masks"),c=require("@googleforcreators/elements"),d=require("../shared/shared.js");require("../shared/layerText.js");var u=require("../shared/useColorTransformHandler.js"),g=require("../shared/useCSSVarColorTransformHandler.js"),f=require("./util.js");function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=h(e),m=h(t);function y(){return y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},y.apply(this,arguments)}const x=m.default.div.withConfig({displayName:"edit__Wrapper",componentId:"sc-1ugcxaz-0"})([""," "," --faux-selection-color:inherit;span{box-decoration-break:clone;}"],d.elementFillContent,d.elementWithBackgroundColor),T=m.default.div.withConfig({displayName:"edit__TextBox",componentId:"sc-1ugcxaz-1"})([""," "," opacity:",";position:absolute;top:0;left:0;right:0;"],d.elementWithFont,d.elementWithTextParagraphStyle,(e=>{let{opacity:t}=e;return void 0!==t?t/100:null})),E=m.default(T).withConfig({displayName:"edit__TextBoxPadded",componentId:"sc-1ugcxaz-2"})((e=>{let{verticalPadding:t}=e;return{width:`calc(100% - ${t}px)`}})),C=m.default(T).withConfig({displayName:"edit__EditTextBox",componentId:"sc-1ugcxaz-3"})((e=>{let{hasHighlightBackgroundTextMode:t}=e;return t&&{paddingTop:0,paddingBottom:0}})),b=m.default.span.withConfig({displayName:"edit__Highlight",componentId:"sc-1ugcxaz-4"})([""," ",";color:transparent !important;*{color:transparent !important;}padding:",";width:",";"],d.elementWithHighlightBorderRadius,(e=>{let{highlightColor:t}=e;return o.generatePatternStyles(t)}),(e=>{let{padding:t}=e;return t}),(e=>{let{verticalPadding:t}=e;return`calc(100% - ${t}px)`})),R=m.default.div.withConfig({displayName:"edit__OutsideBorder",componentId:"sc-1ugcxaz-5"})([""," "," overflow:hidden;"],d.elementWithBorder,(e=>{let{border:t}=e;return t&&s.getBorderPositionCSS(t)}));module.exports=function TextEdit(e){let{element:t,box:{x:o,y:d,height:h,rotationAngle:m},editWrapper:T,onResize:_,updateElementById:H,deleteSelectedElements:S,maybeEnqueueFontStyle:k}=e;const{id:q,content:v,backgroundColor:B,backgroundTextMode:O,border:I,borderRadius:D,opacity:w,height:z,...M}=t,{font:N,width:A}=M,$=r.useMemo((()=>{const e=i.getHTMLInfo(v);return{fontStyle:e.isItalic?"italic":"normal",fontWeight:e.fontWeight,content:l.stripHTML(v)}}),[v]),{dataToEditorX:P,dataToEditorY:X,editorToDataX:L,editorToDataY:W}=n.useUnits((e=>{let{actions:{dataToEditorX:t,dataToEditorY:r,editorToDataX:o,editorToDataY:n}}=e;return{dataToEditorX:t,dataToEditorY:r,editorToDataX:o,editorToDataY:n}})),j={...f.generateParagraphTextStyle(M,(e=>`${P(e)}px`),(e=>`${X(e)}px`),X,t),font:N,element:t,backgroundColor:B,opacity:w,verticalPadding:P(M.padding?.vertical||0),...O===c.BACKGROUND_TEXT_MODE.HIGHLIGHT&&{lineHeight:f.getHighlightLineheight(M.lineHeight,P(M.padding?.vertical||0)),backgroundColor:null,highlightColor:B},...O===c.BACKGROUND_TEXT_MODE.NONE&&{backgroundColor:null}},{padding:G,...Y}=j,{isAnythingTransforming:F}=a.useTransform((e=>({isAnythingTransforming:e.state.isAnythingTransforming}))),U=r.useCallback((e=>H({elementId:q,properties:e})),[q,H]),K=r.useRef(null),V=r.useRef(null),J=r.useRef(null),Q=r.useRef(null),Z=r.useRef(null),ee=r.useRef(),te=r.useRef(),re=r.useRef(0),oe=r.useRef(null);r.useEffect((()=>{ee.current={x:o,y:d,height:h,rotationAngle:m}}),[o,d,h,m]),r.useLayoutEffect((()=>{Z.current&&Z.current.focus()}),[]);const ne=r.useCallback((()=>{const e=re.current;if(K.current&&(K.current.style.height=""),te.current){const t={content:te.current};if(e){const[r,o]=n.calcRotatedResizeOffset(ee.current.rotationAngle,0,0,0,e-ee.current.height);t.height=W(e),t.x=L(ee.current.x+r),t.y=W(ee.current.y+o)}U(t)}}),[L,W,U]),ae=r.useCallback((()=>{te.current?ne():S()}),[ne,S]);r.useUnmount(ae),r.useEffect((()=>{F&&ne()}),[F,ne]);const ie=r.useCallback((()=>{const e=K.current,r=Q.current,{marginOffset:o}=f.calcFontMetrics(t);if(re.current=r.offsetHeight-X(o),e.style.height=`${re.current}px`,r.style.margin="",T){const[e,t]=n.calcRotatedResizeOffset(ee.current.rotationAngle,0,0,0,re.current-ee.current.height);T.style.height=`${re.current}px`,T.style.left=`${ee.current.x+e}px`,T.style.top=`${ee.current.y+t}px`,_&&_()}}),[X,T,t,_]),le=r.useCallback((e=>{te.current=e,ie()}),[ie]);r.useEffect(ie,[z,ie]),r.useEffect((()=>{k([{...$,font:N}])}),[N,$,k]),a.useTransformHandler(q,(e=>{const t=Q.current,r=K.current,o=V.current,n=e?.updates?.fontSize;if(t.style.fontSize=n?`${X(n)}px`:"",o){const r=e?.updates?.marginOffset;o.style.fontSize=t.style.fontSize,o.style.margin=X(-r)/2+"px 0",t.style.margin=X(-r)/2+"px 0"}if(null===e)r.style.width="",r.style.height="";else{const{resize:t}=e;t&&0!==t[0]&&0!==t[1]&&(r.style.width=`${t[0]}px`,r.style.height=`${t[1]}px`)}}));const se=O===c.BACKGROUND_TEXT_MODE.HIGHLIGHT;g({id:q,targetRef:K,cssVar:"--faux-selection-color",expectedStyle:"color"}),u({id:q,targetRef:se?J:K,expectedStyle:"background"}),u({id:q,targetRef:s.shouldDisplayBorder(t)?oe:null,expectedStyle:"border-color"});const{state:{editorState:ce},actions:{getContentFromState:de}}=i.useRichText(),ue=ce&&de(ce),ge={backgroundColor:O===c.BACKGROUND_TEXT_MODE.FILL&&B};return p.default.createElement(R,{ref:oe,border:I,borderRadius:D,width:A,height:z},p.default.createElement(x,y({ref:K,onClick:e=>{Z.current.focus(),e.stopPropagation()},"data-testid":"textEditor"},ge),ue&&se&&p.default.createElement(E,y({ref:V},Y),p.default.createElement(b,y({ref:J,borderRadius:D,dataToEditorY:X,dangerouslySetInnerHTML:{__html:ue}},j))),p.default.createElement(C,y({hasHighlightBackgroundTextMode:se,className:"syncMargin",ref:Q},j),p.default.createElement(i.RichTextEditor,{ref:Z,content:v,onChange:le}))))};
