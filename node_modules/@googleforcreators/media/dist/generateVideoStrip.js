/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("./getMediaSizePositionProps.js"),t=require("./preloadVideo.js"),a=require("./seekVideo.js");module.exports=async function(i,o,r,s){const{width:n,height:c,scale:l,focalX:h,focalY:d,flip:f}=i,{src:u,length:g}=o,w=s,m=w/c*n,v=Math.ceil(r/m),p=r/v,z=p/m*n,{width:j,height:q,offsetX:P,offsetY:x}=e(o,z,c,l,f?.horizontal?100-h:h,f?.vertical?100-d:d),y=g/(v-1),M=await t(u);M.width=j,M.height=q,await a(M,1e-6);const V=document.createElement("canvas");V.width=r,V.height=s;const X=V.getContext("2d");let Y=0,k=0;const C=async()=>{await a(M,Y);const e=k*p;return(f.vertical||f.horizontal)&&(X.translate(e+p/2,w/2),X.scale(f.horizontal?-1:1,f.vertical?-1:1),X.translate(-(e+p/2),-w/2)),X.drawImage(M,P,x,z,c,e,0,p,w),X.setTransform(1,0,0,1,0,0),k+=1,k===v?Promise.resolve():(Y+=y,C())};return C().then((()=>V.toDataURL()))};
