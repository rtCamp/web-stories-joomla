/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import"prop-types";import{useState as t,useRef as o,useMemo as r,useEffect as n,useCallback as s}from"@googleforcreators/react";import i from"sat";import{UnitsProvider as l}from"@googleforcreators/units";import a from"../layout/useLayout.js";import"../layout/context.js";import"../layout/useZoomSetting.js";import"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../config/context.js";import"../api/context.js";import"../history/historyProvider.js";import"../history/context.js";import"../story/actions/useSaveStory.js";import"clone-deep";import"../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../story/storyTriggers/storyTriggersProvider.js";import"../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../story/storyTriggers/storyEvents/onPageAddedRegister.js";import m from"../story/useStory.js";import d from"./useCanvasCopyPaste.js";import c from"./useEditingElement.js";import g from"./utils/createPolygon.js";import p from"./context.js";import{RECT_OBSERVATION_KEY as u}from"./constants.js";function CanvasProvider(y){let{children:E}=y;const[f,h]=t({}),[v,S]=t(null),I=o(null),[j,C]=t(null),[P,b]=t(null),[x,w]=t(null),[k,B]=t(null),[A,R]=t(null),[T,D]=t(!1),[F,G]=t(null),[L,M]=t(null),[N,W]=t(null),[O,z]=t(null),H=r((()=>new window.IntersectionObserver((e=>{for(const t of e){if(!t.target.dataset[u])return;h((e=>({...e,[t.target.dataset[u]]:t.boundingClientRect})))}}))),[]);n((()=>()=>H.disconnect()),[H]);const K=a((e=>{let{state:{pageWidth:t,pageHeight:o}}=e;return{width:t,height:o}})),{nodesById:V,editingElement:Z,editingElementState:q,setEditingElementWithState:J,setEditingElementWithoutState:Q,clearEditing:U,getNodeForElement:X,setNodeForElement:Y}=c(),{elements:$,backgroundElementId:_,selectedElementIds:ee,toggleElementInSelection:te,setSelectedElementsById:oe}=m((e=>{let{state:{currentPage:t,selectedElementIds:o},actions:{toggleElementInSelection:r,setSelectedElementsById:n}}=e;const s=t?.elements||[];return{elements:s,backgroundElementId:s[0]?.id,selectedElementIds:o,toggleElementInSelection:r,setSelectedElementsById:n}})),re=s(((e,t)=>{Z&&Z!==e&&U(),I.current===e&&"focus"===t.type||(I.current=e,t.shiftKey?te({elementId:e}):oe({elementIds:[e]}),t.currentTarget.focus({preventScroll:!0}),_!==e&&t.stopPropagation(),"mousedown"===t.type&&(S(t),t.target.ownerDocument.addEventListener("mouseup",(()=>window.setTimeout(S,0,null)),{once:!0,capture:!0})))}),[Z,_,U,te,oe]),ne=s((e=>{let{x:t,y:o,width:r,height:n}=e;const s=g(0,t,o,r,n),l=$.filter((e=>{let{isBackground:t}=e;return!t})).map((e=>{let{id:t,rotationAngle:o,x:r,y:n,width:l,height:a}=e;const m=g(o,r,n,l,a);return i.testPolygonPolygon(s,m)?t:null})).filter((e=>e));oe({elementIds:l})}),[$,oe]);n((()=>{!Z||1===ee.length&&ee[0]===Z||U(),I.current&&!ee.includes(I.current)&&(I.current=null)}),[Z,ee,U]),d();const[se,ie]=t(null),le=r((()=>({state:{pageContainer:P,canvasContainer:j,fullbleedContainer:x,nodesById:V,editingElement:Z,editingElementState:q,isEditing:Boolean(Z),lastSelectionEvent:v,displayLinkGuidelines:T,pageAttachmentContainer:A,designSpaceGuideline:k,isEyedropperActive:N,eyedropperCallback:O,eyedropperImg:F,eyedropperPixelData:L,boundingBoxes:f,clientRectObserver:H,onMoveableMount:se},actions:{setPageContainer:b,setFullbleedContainer:w,getNodeForElement:X,setNodeForElement:Y,setEditingElement:Q,setEditingElementWithState:J,clearEditing:U,handleSelectElement:re,selectIntersection:ne,setDisplayLinkGuidelines:D,setPageAttachmentContainer:R,setCanvasContainer:C,setDesignSpaceGuideline:B,setIsEyedropperActive:W,setEyedropperCallback:z,setEyedropperImg:G,setEyedropperPixelData:M,setMoveableMount:ie}})),[P,j,x,V,Z,q,v,T,A,k,N,O,F,L,f,H,X,Y,Q,J,U,re,ne,se,ie]);return e.createElement(p.Provider,{value:le},e.createElement(l,{pageSize:K},E))}export{CanvasProvider as default};
