/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useRef as e,useEffect as t,useCallback as o}from"@googleforcreators/react";import{trackEvent as r}from"@googleforcreators/tracking";import{useGlobalKeyDownEffect as s,getKeyboardMovement as i}from"@googleforcreators/design-system";import{STORY_ANIMATION_STATE as n}from"@googleforcreators/animation";import{useTransform as m}from"@googleforcreators/transform";import{getDefinitionForType as a}from"@googleforcreators/elements";import{LAYER_DIRECTIONS as l}from"../../constants/index.js";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"react";import"prop-types";import"../story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../config/context.js";import"../api/context.js";import"../history/historyProvider.js";import"../history/context.js";import"../story/actions/useSaveStory.js";import"clone-deep";import"../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../story/storyTriggers/storyTriggersProvider.js";import"../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../story/storyTriggers/storyEvents/onPageAddedRegister.js";import c from"../story/useStory.js";import"sat";import"@googleforcreators/units";import"../layout/context.js";import"../layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/media";import"@googleforcreators/i18n";import"../media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../utils/generateBlurhash.worker.js";import"../media/media3p/providerConfiguration.js";import"../media/utils/useFFmpeg.js";import"../media/media3p/api/context.js";import"../media/local/constants.js";import"../media/media3p/providerReducer.js";import"../media/context.js";import"@googleforcreators/stickers";import"../../components/library/panes/text/textPresets.js";import"./context.js";import d from"./useCanvas.js";function p(p){const{selectedElementIds:g,selectedElements:u,arrangeSelection:f,clearSelection:y,deleteSelectedElements:E,duplicateElementsById:S,updateSelectedElements:j,setSelectedElementsById:v,currentPage:h,animationState:x,updateAnimationState:I}=c((e=>{let{state:{selectedElementIds:t,selectedElements:o,currentPage:r,animationState:s},actions:{arrangeSelection:i,clearSelection:n,deleteSelectedElements:m,duplicateElementsById:a,updateSelectedElements:l,setSelectedElementsById:c,updateAnimationState:d}}=e;return{currentPage:r,selectedElementIds:t,selectedElements:o,arrangeSelection:i,clearSelection:n,deleteSelectedElements:m,duplicateElementsById:a,updateSelectedElements:l,setSelectedElementsById:c,animationState:s,updateAnimationState:d}})),{actions:{clearTransforms:k}}=m(),{isEditing:A,getNodeForElement:B,setEditingElement:P}=d((e=>{let{state:{isEditing:t},actions:{getNodeForElement:o,setEditingElement:r}}=e;return{isEditing:t,getNodeForElement:o,setEditingElement:r}})),R=e(null);R.current=g,t((()=>{const e=p.current;if(!e)return;const t=e.ownerDocument,o=()=>{setTimeout((()=>{if(t.activeElement===t.body){const t=R.current,o=1===t?.length?B(t[0]):null;if(""!==window.getSelection().toString())return;o?o.focus({preventScroll:!0}):e.focus({preventScroll:!0})}}),300)};return t.addEventListener("focusout",o,!0),()=>{t.removeEventListener("focusout",o,!0)}}),[p,B]),s("delete",(()=>E()),[E]),s("esc",(()=>{y(),k()}),[y,k]),s({key:["mod+a"]},(()=>{const e=h.elements.map((e=>{let{id:t}=e;return t}));v({elementIds:e})}),[h,v]),s({key:["up","down","left","right"],shift:!0},(e=>{let{key:t,shiftKey:o}=e;if(A)return;if(u?.[0]?.isBackground)return;const{dx:r,dy:s}=i(t,o);j({properties:e=>{let{x:t,y:o}=e;return{x:t+r,y:o+s}}})}),[j,A,u]),s({key:["mod+up","mod+down","mod+left","mod+right"],shift:!0},(e=>{const{key:t,shiftKey:o}=e;e.preventDefault();const r=function(e,t){if("ArrowUp"===e)return t?l.FRONT:l.FORWARD;if("ArrowDown"===e)return t?l.BACK:l.BACKWARD;return null}(t,o);r&&f({position:r})}),[f]),s({key:"enter",clickable:!1},(()=>{if(1!==u.length)return;const{type:e,id:t}=u[0],{hasEditMode:o}=a(e);o&&P(t)}),[u,P]);const w=o((()=>{0!==u.length&&S({elementIds:u.map((e=>e.id))})}),[S,u]);s("clone",(()=>w()),[w]);const T=[n.PLAYING,n.PLAYING_SELECTED].includes(x);s({key:["mod+k"]},(e=>{e.preventDefault(),I({animationState:T?n.RESET:n.PLAYING}),r("canvas_play_animations",{status:T?"stop":"play"})}),[T,I])}export{p as default};
