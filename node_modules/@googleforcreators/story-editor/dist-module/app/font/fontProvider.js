/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import"prop-types";import{useState as e,useCallback as o,useRef as n}from"@googleforcreators/react";import{CURATED_FONT_NAMES as r}from"@googleforcreators/fonts";import{loadStylesheet as s}from"@googleforcreators/dom";import{FONT_WEIGHT_NAMES as a}from"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/templates";import"../config/context.js";import"../api/context.js";import i from"../api/useAPI.js";import c from"./context.js";import l from"./actions/useLoadFontFiles.js";const m="https://fonts.googleapis.com/css";function FontProvider(m){let{children:f}=m;const[u,p]=e([]),[g,d]=e([]),[y,F]=e([]),[h,v]=e(null),{actions:{getFonts:j}}=i(),b=u.length>0?u:g,w=o((async()=>{if(h||!j)return;const t=await j({service:"custom"});if(!t.length)return;const e=t.map((t=>({...t,id:t.family,name:t.family,value:t.family})));v(e)}),[j,h]),x=o((async()=>{if(g.length||!j)return;const t=await j({include:r.join(",")});if(!t.length)return;const e=t.map((t=>({id:t.family,name:t.family,value:t.family,...t})));d(e)}),[j,g]),{maybeEnqueueFontStyle:C,maybeLoadFont:E}=l(),L=o((t=>{const e=b.find((e=>e.family===t));return e||{}}),[b]),P=o((async t=>{if(t.length<2)return p([]),[];const e=(await j({search:t})).map((t=>({...t,id:t.family,name:t.family,value:t.family})));return p(e),e}),[j]),k=o((t=>{const e=[{name:a[400],value:400}],o=L(t);let n=e;if(o){const{weights:t}=o;t&&(n=t.map((t=>({name:a[t],value:t}))))}return n}),[L]),S=o((t=>{const e=L(t);return e?.fallbacks?e.fallbacks:[]}),[L]),q=o((t=>{const e=[t];y.forEach((o=>{t.family!==o.family&&e.push(o)})),F(e.slice(0,5))}),[y]),B=n([]),I=o((t=>{const e=t.filter((t=>!B.current.includes(t)));if(!e?.length)return;B.current=B.current.concat(e);const o=encodeURIComponent(e.join("|"));s(`https://fonts.googleapis.com/css?family=${o}&subset=menu&display=swap`,"web-stories-google-fonts-menu-css").catch((()=>{B.current=B.current.filter((t=>!e.includes(t)))}))}),[]),R=o((t=>{for(const e of t){const t=h.find((t=>{let{family:o}=t;return o===e}));t&&E(t)}}),[h,E]),A={state:{fonts:u.length>0?u:g,curatedFonts:g,customFonts:h,recentFonts:y},actions:{getFontsBySearch:P,getFontByName:L,maybeEnqueueFontStyle:C,getFontWeight:k,getFontFallback:S,ensureMenuFontsLoaded:I,ensureCustomFontsLoaded:R,addRecentFont:q,getCustomFonts:w,getCuratedFonts:x}};return t.createElement(c.Provider,{value:A},f)}export{m as GOOGLE_MENU_FONT_URL,FontProvider as default};
