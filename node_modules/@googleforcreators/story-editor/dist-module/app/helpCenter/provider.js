/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import"prop-types";import{useReducer as t,useMemo as n,useEffect as r,useRef as o,useState as i}from"@googleforcreators/react";import{trackEvent as s}from"@googleforcreators/tracking";import{clamp as a}from"@googleforcreators/units";import{localStore as p,LOCAL_STORAGE_PREFIX as d}from"@googleforcreators/design-system";import"@googleforcreators/templates";import"../config/context.js";import c from"../config/useConfig.js";import"../api/context.js";import g from"../api/useAPI.js";import"../currentUser/context.js";import l from"../currentUser/useCurrentUser.js";import{TIPS as u}from"../../components/helpCenter/constants.js";import m from"./context.js";import{composeEffects as T,deriveInitialOpen as f,deriveInitialUnreadTipsCount as v,resetNavigationIndexOnOpen as C,createDynamicNavigationFlow as y,deriveBottomNavigation as I,deriveTransitionDirection as x,deriveDisabledButtons as E,deriveReadTip as O,deriveUnreadTipsCount as _,deriveAutoOpen as h,resetIsOpeningToTip as j}from"./useHelpCenter/effects.js";const H=T([C,y,I,x,E,O,_,h,j]),P=(e,t)=>{let{state:n,actions:r}=e;const o={...n,...t(n)};return{state:H(n,o),actions:r}},U=T([f,v]),b=p.getItemByKey(d.HELP_CENTER),N=e=>({isOpen:!1,isOpeningToTip:!1,navigationIndex:-1,navigationFlow:Object.keys({...u,...e.additionalTips}),isLeftToRightTransition:!0,hasBottomNavigation:!1,isPrevDisabled:!0,isNextDisabled:!1,readTips:{},readError:!1,unreadTipsCount:b?.unreadTipsCount??0,isHydrated:!1,tips:{...u,...e.additionalTips},tipKeys:Object.keys({...u,...e.additionalTips})}),R=e=>({state:U(b,N(e)),actions:{goToNext:()=>e=>{let{navigationIndex:t,navigationFlow:n}=e;return{navigationIndex:a(t+1,{MIN:0,MAX:n.length-1})}},goToPrev:()=>e=>{let{navigationIndex:t,navigationFlow:n}=e;return{navigationIndex:a(t-1,{MIN:0,MAX:n.length-1})}},goToMenu:()=>()=>({navigationIndex:-1}),goToTip:e=>t=>{let{navigationFlow:n}=t;return{navigationIndex:n.findIndex((t=>t===e))}},openToUnreadTip:e=>t=>{let{navigationFlow:n,readTips:r}=t;return r[e]?{}:{isOpen:!0,isOpeningToTip:!0,navigationIndex:n.findIndex((t=>t===e))}},toggle:()=>e=>{let{isOpen:t}=e;return s("help_center_toggled",{status:t?"closed":"open"}),{isOpen:!t}},close:()=>e=>{let{isOpen:t}=e;return t&&s("help_center_toggled",{status:"closed"}),{isOpen:!1}},hydrateReadTipsSuccess:e=>t=>({readTips:{...e?.readTips??{},...t.readTips},isHydrated:!0}),persistingReadTipsError:()=>()=>({readError:!0})}});function HelpCenterProvider(a){let{children:u}=a;const{additionalTips:T={}}=c(),{actions:{updateCurrentUser:f}}=g(),v=Boolean(f),[C,y]=t(P,R({additionalTips:T})),{currentUser:I,updateCurrentUser:x}=l((e=>{let{state:t,actions:n}=e;return{currentUser:t.currentUser,updateCurrentUser:n.updateCurrentUser}})),E=n((()=>Object.entries(C.actions).reduce(((e,t)=>{let[n,r]=t;return e[n]=function(){return y(r(...arguments))},e}),{})),[C.actions]),{isHydrated:O,unreadTipsCount:_}=C.state;r((()=>{if(O){const e=p.getItemByKey(d.HELP_CENTER);p.setItemByKey(d.HELP_CENTER,{...e,unreadTipsCount:_})}}),[O,_]);const{isOpen:h}=C.state;r((()=>{const e=p.getItemByKey(d.HELP_CENTER);p.setItemByKey(d.HELP_CENTER,{...e,isOpen:h})}),[h]),r((()=>{!O&&I?.onboarding&&E.hydrateReadTipsSuccess({readTips:I.onboarding})}),[E,I,O]);const j=(H=C.state.readTips,Object.keys(H||{}).join(" "));var H;const U=o(!1);r((()=>{var e;(j||O)&&v&&(U.current?x({onboarding:(e=j,e.split(" ").sort(((e,t)=>e.localeCompare(t))).reduce(((e,t)=>({...e,[t]:!0})),{}))}).catch(E.persistingReadTipsError):U.current=!0)}),[E,x,v,j,O]);const[b,N]=i(C.state);r((()=>N(C.state)),[C.state]);const w=!b.isOpen&&C.state.isOpen?C.state.navigationIndex:b.navigationIndex;r((()=>{if(w>-1&&C.state.navigationFlow.length>=w){const e=C.state.navigationFlow[w];s("help_center_read_tip",{name:e,unread_count:C.state.unreadTipsCount}),C.state.unreadTipsCount===C.state.navigationFlow.length&&s("tutorial_begin"),"done"===e&&s("tutorial_complete")}}),[w]);const F=n((()=>({state:{...C.state,navigationIndex:w},actions:E})),[E,C.state,w]);return e.createElement(m.Provider,{value:F},u)}export{HelpCenterProvider as default,H as deriveState,R as getInitial,N as getInitialState};
