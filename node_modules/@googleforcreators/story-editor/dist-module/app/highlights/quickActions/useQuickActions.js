/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import"prop-types";import{useMemo as t,useCallback as o,useRef as r}from"@googleforcreators/react";import{sprintf,__,translateToExclusiveList as n}from"@googleforcreators/i18n";import{prettifyShortcut as s,useSnackbar as i,PLACEMENT as a,Icons as c}from"@googleforcreators/design-system";import{trackEvent as l}from"@googleforcreators/tracking";import{ELEMENT_TYPES as m}from"@googleforcreators/elements";import{getExtensionsFromMimeType as p,resourceList as d}from"@googleforcreators/media";import u from"../states.js";import g from"../useHighlights.js";import E from"../../../components/design/updateProperties.js";import"../../history/historyProvider.js";import y from"../../history/useHistory.js";import"../../config/context.js";import T from"../../config/useConfig.js";import"@googleforcreators/templates";import"../../api/context.js";import"../../../constants/fonts.js";import"../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"../../story/context.js";import"@googleforcreators/migration";import"../../story/actions/useSaveStory.js";import"clone-deep";import"../../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import{useStoryTriggersDispatch as I}from"../../story/storyTriggers/useStoryTriggers.js";import"../../story/storyTriggers/storyTriggersProvider.js";import"../../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../story/storyTriggers/storyEvents/onPageAddedRegister.js";import{STORY_EVENTS as A}from"../../story/storyTriggers/storyEvents/types.js";import k from"../../story/useStory.js";import"../../media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../utils/generateBlurhash.worker.js";import"../../media/media3p/providerConfiguration.js";import f from"../../media/utils/useFFmpeg.js";import"../../media/media3p/api/context.js";import"../../media/local/constants.js";import"../../media/media3p/providerReducer.js";import"../../media/context.js";import h from"../../media/local/useLocalMedia.js";import{TRANSCODABLE_MIME_TYPES as _}from"../../media/constants.js";import N from"../../../utils/useApplyTextAutoStyle.js";import R from"./utils/getResetProperties.js";import{RESET_PROPERTIES as P,ACTIONS as C,RESET_DEFAULTS as b}from"./constants.js";function D(){return D=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},D.apply(this,arguments)}const S=sprintf(
/* translators: %s: Ctrl/Cmd + Z keyboard shortcut */
__("Press %s to undo the last change","web-stories"),s("mod+z")),{Bucket:j,ColorBucket:M,CircleSpeed:v,Eraser:O,LetterTPlus:B,Link:L,Media:x,PictureSwap:F,Captions:w}=c,MediaPicker=r=>{let{render:s,...a}=r;const{allowedMimeTypes:{image:c,vector:l,video:m},MediaUpload:u}=T(),{selectedElements:g,updateElementsById:E}=k((e=>{let{state:{selectedElements:t},actions:{updateElementsById:o}}=e;return{selectedElements:t,updateElementsById:o}})),{resetWithFetch:y,postProcessingResource:I,optimizeVideo:A,optimizeGif:N,canTranscodeResource:R}=h((e=>{let{state:{canTranscodeResource:t},actions:{resetWithFetch:o,postProcessingResource:r,optimizeVideo:n,optimizeGif:s}}=e;return{canTranscodeResource:t,resetWithFetch:o,postProcessingResource:r,optimizeVideo:n,optimizeGif:s}})),{isTranscodingEnabled:P}=f(),{showSnackbar:C}=i();let b=t((()=>[...c,...l,...m]),[c,l,m]);const S=t((()=>b.map((e=>p(e))).flat()),[b]);P&&(b=b.concat(_));const j=_.filter((e=>!m.includes(e)));let M=__("No file types are currently supported.","web-stories");S.length&&(M=sprintf(
/* translators: %s: list of allowed file types. */
__("Please choose only %s to insert into page.","web-stories"),n(S)));const v=o(((e,t)=>{d.set(e.id,{url:t,type:"cached"}),E({elementIds:[g?.[0]?.id],properties:{type:e.type,resource:e}})}),[g,E]),O=o((e=>{try{P&&R(e)&&(j.includes(e.mimeType)&&A({resource:e}),"image/gif"===e.mimeType&&N({resource:e})),v(e,e.sizes?.medium?.sourceUrl||e.src),I(e)}catch(e){C({message:e.message,dismissable:!0})}}),[P,R,v,I,j,A,N,C]);return e.createElement(u,D({title:__("Replace media","web-stories"),buttonInsertText:__("Replace media","web-stories"),onSelect:O,onClose:y,type:b,onSelectErrorMessage:M,render:e=>s({onClick:e})},a))},G=()=>{const{capabilities:{hasUploadMediaAction:e},isRTL:n}=T(),s=I(),{backgroundElement:c,selectedElementAnimations:p,selectedElements:d,updateElementsById:f}=k((e=>{let{state:{currentPage:t,selectedElementAnimations:o,selectedElements:r},actions:{updateElementsById:n}}=e;return{backgroundElement:t?.elements.find((e=>e.isBackground)),selectedElementAnimations:o,selectedElements:r,updateElementsById:n}})),{undo:h}=y((e=>{let{actions:{undo:t}}=e;return{undo:t}})),_=i((e=>{let{showSnackbar:t}=e;return t})),{setHighlights:D}=g((e=>{let{setHighlights:t}=e;return{setHighlights:t}})),G=r(h);G.current=h;const U=d?.[0],q=o((e=>{e.stopPropagation()}),[]),K=o(((e,t,o)=>{const r={};o.includes(P.OVERLAY)&&(r.overlay=null),o.includes(P.ANIMATION)&&f({elementIds:[t],properties:e=>E(e,{animation:{...p?.[0],delete:!0}},!0)}),o.includes(P.STYLES)&&(r.opacity=100,r.border=null,r.borderRadius=null),e===m.TEXT&&(r.borderRadius=b.TEXT_BORDER_RADIUS),f({elementIds:[t],properties:e=>E(e,r,!0)})}),[p,f]),H=o((e=>{let{elementId:t,resetProperties:o,elementType:r}=e;K(r,t,o),_({actionLabel:__("Undo","web-stories"),dismissible:!1,message:__("Element properties have been reset","web-stories"),onAction:()=>{G.current(),l("quick_action",{name:`undo_${C.RESET_ELEMENT.trackingEventName}`,element:r,isBackground:!0})},actionHelpText:S})}),[K,_]),z=o((e=>t=>o=>{o.preventDefault(),D({elementId:t||U?.id,highlight:e})}),[D,U]),X=t((()=>{const e=(d?.[0]?.resource?.id?.toString()||"").startsWith("media/")?u.MEDIA3P:u.MEDIA;return z(e)}),[z,d]),{handleFocusAnimationPanel:V,handleFocusLinkPanel:W,handleFocusPageBackground:Y,handleFocusTextSetsPanel:$,handleFocusCaptionsPanel:J}=t((()=>({handleFocusAnimationPanel:z(u.ANIMATION),handleFocusLinkPanel:z(u.LINK),handleFocusPageBackground:z(u.PAGE_BACKGROUND),handleFocusTextSetsPanel:z(u.TEXT_SET),handleFocusCaptionsPanel:z(u.CAPTIONS)})),[z]),Q=t((()=>({tooltipPlacement:n?a.LEFT:a.RIGHT,onMouseDown:q})),[q,n]),Z=t((()=>[{Icon:j,label:C.CHANGE_BACKGROUND_COLOR.text,onClick:e=>{Y(c?.id)(e),l("quick_action",{name:C.CHANGE_BACKGROUND_COLOR.trackingEventName,element:"none"})},...Q},{Icon:x,label:C.INSERT_BACKGROUND_MEDIA.text,onClick:e=>{X()(e),l("quick_action",{name:C.INSERT_BACKGROUND_MEDIA.trackingEventName,element:"none"})},separator:"top",...Q},{Icon:B,label:C.INSERT_TEXT.text,onClick:e=>{$()(e),l("quick_action",{name:C.INSERT_TEXT.trackingEventName,element:"none"})},...Q}]),[Q,c,X,Y,$]),ee=t((()=>R(U,p)),[U,p]),te=ee.length>0,oe=t((()=>{const e=[{Icon:v,label:C.ADD_ANIMATION.text,onClick:e=>{V()(e),l("quick_action",{name:C.ADD_ANIMATION.trackingEventName,element:U?.type})},...Q},{Icon:L,label:C.ADD_LINK.text,onClick:e=>{W()(e),l("quick_action",{name:C.ADD_LINK.trackingEventName,element:U?.type})},...Q}],t={Icon:O,label:C.RESET_ELEMENT.text,onClick:()=>{H({elementId:U?.id,resetProperties:ee,elementType:U?.type}),l("quick_action",{name:C.RESET_ELEMENT.trackingEventName,element:U?.type})},separator:"top",...Q};return te?[...e,t]:e}),[V,U?.id,U?.type,Q,W,te,H,ee]),re=t((()=>{const t=[];return e&&t.push({Icon:F,label:C.REPLACE_MEDIA.text,onClick:()=>{s(A.onReplaceForegroundMedia),l("quick_action",{name:C.REPLACE_MEDIA.trackingEventName,element:U?.type})},wrapWithMediaPicker:!0,...Q}),[...t,...oe]}),[Q,oe,e,s,U?.type]),ne=oe,se=N(U,(e=>f({elementIds:[U?.id],properties:e}))),ie=t((()=>[{Icon:M,label:C.AUTO_STYLE_TEXT.text,onClick:()=>{se(),l("quick_action",{name:C.AUTO_STYLE_TEXT.trackingEventName,element:U?.type})},...Q},...oe]),[se,oe,Q,U?.type]),ae=t((()=>{const[e,t]=te?[re.slice(0,re.length-1),re.slice(-1)]:[re,[]];return[...e,{Icon:w,label:C.ADD_CAPTIONS.text,onClick:e=>{J()(e),l("quick_action",{name:C.ADD_CAPTIONS.trackingEventName,element:U?.type})},...Q},...t]}),[Q,re,J,U?.type,te]),ce=t((()=>{const t=[{Icon:v,label:C.ADD_ANIMATION.text,onClick:e=>{V()(e),l("quick_action",{name:C.ADD_ANIMATION.trackingEventName,element:U?.type,isBackground:!0})},...Q}];e&&t.unshift({Icon:F,label:C.REPLACE_BACKGROUND_MEDIA.text,onClick:()=>{s(A.onReplaceBackgroundMedia),l("quick_action",{name:C.REPLACE_BACKGROUND_MEDIA.trackingEventName,element:U?.type,isBackground:!0})},wrapWithMediaPicker:!0,...Q});const o={Icon:O,label:C.RESET_ELEMENT.text,onClick:()=>{H({elementId:U?.id,resetProperties:ee,elementType:m.IMAGE}),l("quick_action",{name:C.RESET_ELEMENT.trackingEventName,element:U?.type,isBackground:!0})},separator:"top",...Q};return te?[...t,o]:t}),[Q,s,H,V,e,ee,U,te]);if(d.length>1)return[];const le=Boolean(c&&c?.resource),me=0===d.length,pe=d?.[0]?.isBackground;if(me||pe&&!le)return Z;if(pe&&le){return"video"===U.type?[...ce]:ce}switch(d?.[0]?.type){case m.IMAGE:case m.GIF:return re;case m.SHAPE:return ne;case m.TEXT:return ie;case m.VIDEO:return ae;case m.STICKER:return oe;default:return[]}};export{MediaPicker,G as default};
