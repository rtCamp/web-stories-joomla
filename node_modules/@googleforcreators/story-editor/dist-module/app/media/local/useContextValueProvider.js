/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useRef as e,useEffect as s,useCallback as r}from"@googleforcreators/react";import{getSmallestUrlForWidth as i}from"@googleforcreators/media";import{getTimeTracker as t}from"@googleforcreators/tracking";import"react";import"prop-types";import"@googleforcreators/templates";import"../../config/context.js";import o from"../../config/useConfig.js";import"../../api/context.js";import a from"../../api/useAPI.js";import n from"../utils/useUploadVideoFrame.js";import c from"../utils/useProcessMedia.js";import d from"../useUploadMedia.js";import u from"../utils/useDetectVideoHasAudio.js";import m from"../utils/useDetectBaseColor.js";import l from"../utils/useDetectBlurhash.js";import{LOCAL_MEDIA_TYPE_ALL as p}from"./types.js";function g(g,T){const{media:f,pageToken:h,mediaType:M,searchTerm:P}=g,{fetchMediaStart:R,fetchMediaSuccess:y,fetchMediaError:E,resetFilters:C,prependMedia:B,setMediaType:j,setSearchTerm:w,setNextPage:V,setAudioProcessing:x,removeAudioProcessing:N,setPosterProcessing:k,removePosterProcessing:v,setBaseColorProcessing:b,removeBaseColorProcessing:I,setBlurhashProcessing:U,removeBlurhashProcessing:A,updateMediaElement:F,deleteMediaElement:H}=T,{actions:{getMedia:z,updateMedia:S}}=a(),D=e(!1);s((()=>(D.current=!0,()=>{D.current=!1})),[]);const G=r((function(){let{searchTerm:e="",pageToken:s=1,mediaType:r,cacheBust:i}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;if(!z)return null;R({pageToken:s});const a=t("load_media");return z({mediaType:r===p?"":r,searchTerm:e,pagingNum:s,cacheBust:i}).then((i=>{let{data:t,headers:a}=i;if(!D.current)return;const n=parseInt(a.totalPages),c=parseInt(a.totalItems);o({media:t,mediaType:r,searchTerm:e,pageToken:s,nextPageToken:s<n?s+1:void 0,totalPages:n,totalItems:c})})).catch(E).finally((()=>{a()}))}),[E,R,z]),{uploadMedia:W,isUploading:_,isTranscoding:q,isNewResourceProcessing:J,isCurrentResourceProcessing:K,isNewResourceTranscoding:L,isNewResourceMuting:O,isElementTrimming:Q,isCurrentResourceUploading:X,isCurrentResourceTranscoding:Y,isCurrentResourceMuting:Z,isCurrentResourceTrimming:$,canTranscodeResource:ee}=d({media:f,prependMedia:B,updateMediaElement:F,deleteMediaElement:H}),{uploadVideoFrame:se}=n({updateMediaElement:F}),{updateVideoIsMuted:re}=u({updateMediaElement:F}),{updateBaseColor:ie}=m({updateMediaElement:F}),{updateBlurHash:te}=l({updateMediaElement:F}),{allowedMimeTypes:{video:oe},capabilities:{hasUploadMediaAction:ae}}=o(),ne=e();ne.current=g;const ce=r((()=>{const{mediaType:e}=ne.current;C();const s=!ne.current.pageToken;e||ne.current.searchTerm||!s||G({mediaType:e,cacheBust:!0},y)}),[G,y,C]);s((()=>{G({searchTerm:P,pageToken:h,mediaType:M},y)}),[G,y,M,h,P]);const de=r(((e,s)=>{const{posterProcessed:r,posterProcessing:i}=ne.current;(async()=>{r.includes(e)||i.includes(e)||(k({id:e}),await se(e,s),v({id:e}))})()}),[k,se,v]),ue=r(((e,s)=>{const{audioProcessed:r,audioProcessing:i}=ne.current;(async()=>{r.includes(e)||i.includes(e)||(x({id:e}),await re(e,s),N({id:e}))})()}),[x,re,N]),me=r((e=>{const{baseColorProcessed:s,baseColorProcessing:r}=ne.current,{id:i}=e;(async()=>{s.includes(i)||r.includes(i)||(b({id:i}),await ie(e),I({id:i}))})()}),[b,ie,I]),le=r((e=>{const{blurHashProcessed:s,blurHashProcessing:r}=ne.current,{id:i}=e;(async()=>{s.includes(i)||r.includes(i)||(U({id:i}),await te({resource:e}),A({id:i}))})()}),[ne,U,te,A]),pe=r((e=>{if(!e)return;const{type:s,isMuted:r,baseColor:t,src:o,id:a,posterId:n,mimeType:c,poster:d,blurHash:u}=e;if(!ee(e))return;ae&&(!oe.includes(c)&&"gif"!==s||n||de(a,o),oe.includes(c)&&null===r&&ue(a,o));const m="image"===s?i(0,e):d;m&&!t&&me(e),m&&!u&&le(e)}),[ee,oe,me,le,ue,de,ae]),{optimizeVideo:ge,optimizeGif:Te,muteExistingVideo:fe,trimExistingVideo:he}=c({postProcessingResource:pe,uploadMedia:W,updateMedia:S,deleteMediaElement:H});s((()=>{f?.forEach((e=>pe(e)))}),[f,M,P,pe]);const Me=Boolean(ne.current?.posterProcessing?.length);return{state:{...g,isUploading:_||Me,isTranscoding:q,isNewResourceProcessing:J,isCurrentResourceProcessing:K,isNewResourceTranscoding:L,isNewResourceMuting:O,isElementTrimming:Q,isCurrentResourceUploading:X,isCurrentResourceTranscoding:Y,isCurrentResourceMuting:Z,isCurrentResourceTrimming:$,canTranscodeResource:ee},actions:{setNextPage:V,setMediaType:j,setSearchTerm:w,resetFilters:C,uploadMedia:W,resetWithFetch:ce,uploadVideoPoster:de,postProcessingResource:pe,deleteMediaElement:H,updateMediaElement:F,optimizeVideo:ge,optimizeGif:Te,muteExistingVideo:fe,trimExistingVideo:he}}}export{g as default};
