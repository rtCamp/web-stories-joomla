/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{createResource as e}from"@googleforcreators/media";import{PROVIDERS as t}from"../media3p/providerConfiguration.js";function r(e,r){const i=r.sort(((e,t)=>(t.width??0)-(e.width??0))),l=function(e){return{originalWidth:e[0].width,originalHeight:e[0].height}}(i);return i.map((r=>function(e,r,i){const{originalWidth:l,originalHeight:o}=i;if(!l||!o)throw new Error("No original size present.");const a=t[e.provider.toLowerCase()];if(!(r.width&&r.height||a.defaultPreviewWidth))throw new Error("Missing width and height for: "+e);return{file:e.name,sourceUrl:r.url,mimeType:r.mimeType,width:r.width??a.defaultPreviewWidth,height:r.height??a.defaultPreviewWidth*o/l}}(e,r,l)))}function i(e){return(e.author||e.registerUsageUrl)&&{author:e.author&&{displayName:e.author.displayName,url:e.author.url},registerUsageUrl:e.registerUsageUrl}}function l(e){return Math.floor(e/60)+":"+Math.floor(e%60).toString().padStart(2,"0")}function o(t){const l=function(e){if("image"!==e.type.toLowerCase())throw new Error("Invalid media type.");if(e.imageUrls?.length<3)throw new Error("Invalid number of urls for asset. Need at least 3: "+e);const t=r(e,e.imageUrls),i=[["full",t[0]],["large",t[1]],...t.slice(2,t.length-1).map((e=>[e.width+"_"+e.height,e])),["web_stories_thumbnail",t[t.length-1]]];return Object.fromEntries(new Map(i))}(t);return e({id:t.name,baseColor:t.color,blurHash:t.blurHash,type:t.type.toLowerCase(),mimeType:l.full.mimeType,creationDate:t.createTime,src:l.full.sourceUrl,width:l.full.width,height:l.full.height,alt:t.description||t.title||t.name,isExternal:!0,isPlaceholder:!1,sizes:l,attribution:i(t)})}function a(t){const o=function(e){if("video"!==e.type.toLowerCase())throw new Error("Invalid media type.");if(e.videoUrls?.length<2)throw new Error("Invalid number of urls for asset. Need at least 2: "+e);const t=r(e,e.videoUrls);return{full:t[0],preview:t[t.length-1]}}(t),a=parseInt(t.videoMetadata.duration.trimEnd("s"));return e({id:t.name,baseColor:t.color,posterId:t.name,type:t.type.toLowerCase(),mimeType:o.full.mimeType,creationDate:t.createTime,src:o.full.sourceUrl,width:o.full.width,height:o.full.height,poster:t.imageUrls[0].url,length:a,lengthFormatted:l(a),alt:t.description||t.title||t.name,isExternal:!0,isPlaceholder:!1,isOptimized:!0,isMuted:!0,sizes:o,attribution:i(t)})}function n(t){const{imageUrls:l,videoUrls:o,previewUrl:a}=function(e){if("gif"!==e.type.toLowerCase())throw new Error("Invalid media type");if(e.imageUrls?.length<3)throw new Error("Invalid number of urls for asset. Need at least 3: "+e);const t=e.imageUrls.filter((e=>{let{imageName:t}=e;return t.endsWith("preview")})).map((e=>{let{url:t}=e;return t})).shift(),i=e.imageUrls.filter((e=>{let{url:r}=e;return r!==t})),l=r(e,i),o=r(e,e.videoUrls.filter((e=>{let{mimeType:t}=e;return"image/webm"===t}))),a=r(e,e.videoUrls.filter((e=>{let{mimeType:t}=e;return"video/mp4"===t}))),n=[["full",l[0]],["large",l[1]],...l.slice(2,l.length-1).map((e=>[e.width+"_"+e.height,e])),["web_stories_thumbnail",l[l.length-1]]];return{imageUrls:Object.fromEntries(new Map(n)),videoUrls:{webm:{full:o[0],preview:o[o.length-1]},mp4:{full:a[0],preview:a[o.length-1]}},previewUrl:t}}(t);return e({id:t.name,baseColor:t.color,posterId:t.name,type:t.type.toLowerCase(),mimeType:l.full.mimeType,creationDate:t.createTime,src:l.full.sourceUrl,width:l.full.width,height:l.full.height,poster:a,alt:t.description||t.title||t.name,isPlaceholder:!1,isOptimized:!0,isExternal:!0,sizes:l,output:{mimeType:o.mp4.full.mimeType,src:o.mp4.full.sourceUrl},attribution:i(t)})}function s(e){switch(e.type.toLowerCase()){case"image":return o(e);case"video":return a(e);case"gif":return n(e);default:throw new Error("Invalid media type.")}}export{s as default};
