/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useMemo as e,useReduction as i,useRef as t,useEffect as r,useCallback as a}from"@googleforcreators/react";import{trackError as s,trackEvent as o,getTimeTracker as u}from"@googleforcreators/tracking";import{createBlob as n,getImageDimensions as d,getFileName as c,isAnimatedGif as l}from"@googleforcreators/media";import m from"../../../uploader/useUploader.js";import{noop as f}from"../../../../utils/noop.js";import p from"../useUploadVideoFrame.js";import I from"../useFFmpeg.js";import g from"../getResourceFromLocalFile.js";import*as D from"./reducer.js";import{ITEM_STATUS as N}from"./constants.js";const T={queue:[]};function y(){const{actions:{uploadFile:y}}=m(),{isTranscodingEnabled:M,canTranscodeFile:R,transcodeVideo:E,stripAudioFromVideo:h,getFirstFrameOfVideo:q,convertGifToVideo:G,trimVideo:w}=I(),[C,P]=i(T,D),{uploadVideoPoster:F}=p({updateMediaElement:f}),U=t(!1),A=t(null),v=t(null),{startUploading:S,finishUploading:O,cancelUploading:L,startTranscoding:_,startMuting:V,startTrimming:b,finishTranscoding:j,finishMuting:H,finishTrimming:z,replacePlaceholderResource:x}=P;r((()=>{(async()=>{await Promise.all(C.queue.map((async e=>{const{id:i,file:t,state:r,resource:a}=e;if([N.TRIMMED,N.MUTED,N.TRANSCODED].includes(r)&&a.isPlaceholder&&!a.poster)try{const{resource:e,posterFile:r}=await g(t);if(!U.current)return;x({id:i,resource:e,posterFile:r})}catch{}})))})()}),[C.queue,x]),r((()=>{(async()=>{await Promise.all(C.queue.map((async e=>{const{id:i,file:t,state:r,resource:a}=e;if(N.PENDING!==r||!a.isPlaceholder)return;if(!M||!R(t))return;if(!(null!==v.current)){v.current=i;try{const e=await q(t),r=n(e),{width:s,height:o}=await d(r),u={...a,poster:r,width:s,height:o};if(!U.current)return;x({id:i,resource:u,posterFile:e})}catch{}finally{v.current=null}}})))})()}),[C.queue,M,R,q,x]);const k=a((async e=>{const{id:i,file:t,additionalData:r={}}=e;_({id:i});try{const e=await G(t);if(!U.current)return;r.mediaSource="gif-conversion",r.isMuted=!0,j({id:i,file:e,additionalData:r})}catch(e){L({id:i,error:e}),s("upload_media",e?.message)}finally{A.current=null}}),[_,j,G,L]),B=a((async e=>{const{id:i,file:t,additionalData:r={},trimData:a}=e;b({id:i});try{const e=await w(t,a.start,a.end);if(!U.current)return;r.meta={...r.meta,trimData:a},z({id:i,file:e,additionalData:r})}catch(e){L({id:i,error:e}),s("upload_media",e?.message)}finally{A.current=null}}),[b,z,w,L]),J=a((async e=>{const{id:i,file:t,additionalData:r={}}=e;V({id:i});try{const e=await h(t);if(!U.current)return;r.isMuted=!0,H({id:i,file:e,additionalData:r})}catch(e){L({id:i,error:e}),s("upload_media",e?.message)}finally{A.current=null}}),[V,H,h,L]),K=a((async e=>{const{id:i,file:t,additionalData:r={}}=e;_({id:i});try{const e=await E(t);if(!U.current)return;r.mediaSource="video-optimization",j({id:i,file:e,additionalData:r})}catch(e){L({id:i,error:e}),s("upload_media",e?.message)}finally{A.current=null}}),[_,j,E,L]),Q=a((async e=>{const{id:i,file:t,resource:r,additionalData:a={}}=e;let{posterFile:s}=e,o=await y(t,a);if(U.current){if(!r.poster&&!s)try{s=await q(t)}catch{}try{const e=c(s),{poster:i,posterId:t}=await F(o.id,e,s);if(!U.current)return;o={...o,poster:i||o.poster||r.poster,posterId:t}}catch{}O({id:i,resource:o})}}),[O,q,y,F]),W=a((async e=>{const{id:i,file:t,additionalData:r={}}=e,a=await y(t,r);U.current&&O({id:i,resource:a})}),[O,y]),X=a((async e=>{const{id:i,file:t,resource:r}=e;S({id:i}),o("upload_media",{file_size:t?.size,file_type:t?.type});const a=u("load_upload_media");try{["video","gif"].includes(r.type)?await Q(e):await W(e)}catch(e){L({id:i,error:e}),s("upload_media",e?.message)}finally{a()}}),[S,L,W,Q]);return r((()=>{(async()=>{await Promise.all(C.queue.map((async e=>{const{id:i,file:t,state:r,resource:a,additionalData:s={},muteVideo:o,trimData:u}=e;if(N.PENDING!==r)return;"video"===a.type&&null!==a.isMuted&&void 0===s?.isMuted&&(s.isMuted=a.isMuted),a?.baseColor&&(s.meta={...s.meta,baseColor:a.baseColor}),a?.blurHash&&!a?.trimData&&(s.meta={...s.meta,blurHash:a.blurHash});const n="image/gif"===a.mimeType&&l(await t.arrayBuffer()),d=M&&(n||R(t)),c=null!==A.current;if(!d||!c){if(M){if(n)return A.current=i,void k(e);if(R(t))return A.current=i,u?void B(e):o?void J(e):void K(e)}X(e)}})))})()}),[C.queue,M,R,k,B,J,K,X]),r((()=>{C.queue.map((e=>{const{state:i}=e;[N.TRANSCODED,N.MUTED,N.TRIMMED].includes(i)&&X(e)}))}),[C.queue,X]),r((()=>(U.current=!0,()=>{U.current=!1})),[]),e((()=>{const e=C.queue.filter((e=>![N.PENDING,N.CANCELLED,N.UPLOADED,N.FINISHED].includes(e.state))),i=C.queue.filter((e=>e.state===N.PENDING)),t=C.queue.filter((e=>e.state===N.UPLOADED)),r=C.queue.filter((e=>e.state===N.FINISHED));return{state:{progress:e,pending:i,uploaded:t,failures:C.queue.filter((e=>e.state===N.CANCELLED)),finished:r,isUploading:C.queue.some((e=>![N.FINISHED,N.CANCELLED,N.PENDING].includes(e.state))),isTranscoding:C.queue.some((e=>e.state===N.TRANSCODING)),isMuting:C.queue.some((e=>e.state===N.MUTING)),isTrimming:C.queue.some((e=>e.state===N.TRIMMING)),isCurrentResourceMuting:e=>C.queue.some((i=>i.state===N.MUTING&&i.resource.id===e)),isCurrentResourceProcessing:e=>C.queue.some((i=>[N.TRANSCODING,N.TRIMMING,N.MUTING].includes(i.state)&&i.resource.id===e)),isCurrentResourceUploading:e=>C.queue.some((i=>[N.PENDING,N.UPLOADING,N.UPLOADED,N.FINISHED].includes(i.state)&&(i.resource.id===e||i.previousResourceId===e))),isCurrentResourceTranscoding:e=>C.queue.some((i=>i.state===N.TRANSCODING&&i.resource.id===e)),isCurrentResourceTrimming:e=>C.queue.some((i=>i.state===N.TRIMMING&&i.resource.id===e)),isNewResourceMuting:e=>C.queue.some((i=>i.state===N.MUTING&&i.originalResourceId===e)),isNewResourceProcessing:e=>C.queue.some((i=>[N.TRANSCODING,N.TRIMMING,N.MUTING].includes(i.state)&&i.originalResourceId===e)),isNewResourceTranscoding:e=>C.queue.some((i=>i.state===N.TRANSCODING&&i.originalResourceId===e)),isElementTrimming:e=>C.queue.some((i=>i.state===N.TRIMMING&&i.elementId===e)),canTranscodeResource:e=>{const{isExternal:i,id:t,src:r}=e||{};return!i&&r&&!C.queue.some((e=>e.resource.id===t||e.previousResourceId===t||e.originalResourceId===t))}},actions:{addItem:P.addItem,removeItem:P.removeItem,finishItem:P.finishItem}}}),[C,P])}export{y as default};
