/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{v4 as e}from"uuid";import{revokeBlob as r}from"@googleforcreators/media";import{ITEM_STATUS as t}from"./constants.js";function o(r,o){let{payload:{file:u,resource:a,onUploadStart:i,onUploadProgress:d,onUploadError:s,onUploadSuccess:n,additionalData:l,posterFile:c,muteVideo:p,trimData:f,originalResourceId:q,elementId:m}}=o;const D=e();a.id||(a.id=e());const I={id:D,file:u,state:t.PENDING,resource:a,onUploadStart:i,onUploadProgress:d,onUploadError:s,onUploadSuccess:n,additionalData:l,posterFile:c,muteVideo:p,trimData:f,originalResourceId:q,elementId:m};return{...r,queue:[...r.queue,I]}}function u(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.UPLOADING}:e))}}function a(e,o){let{payload:{id:u,resource:a}}=o;const i=e.queue.find((e=>e.id===u));return i?(i.resource.src&&i.resource.src!==a.src&&r(i.resource.src),a.poster&&i.resource.poster&&i.resource.poster!==a.poster&&r(i.resource.poster),{...e,queue:e.queue.map((e=>e.id===u?{...e,resource:{...a,poster:a.poster||e.resource.poster},previousResourceId:e.resource.id,posterFile:null,originalResourceId:null,state:t.UPLOADED}:e))}):e}function i(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.CANCELLED}:e))}}function d(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.TRANSCODING}:e))}}function s(e,r){let{payload:{id:o,file:u,additionalData:a={}}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,file:u,state:t.TRANSCODED,resource:{...e.resource,isOptimized:!0},additionalData:{...e.additionalData,...a}}:e))}}function n(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.MUTING}:e))}}function l(e,r){let{payload:{id:o,file:u,additionalData:a={}}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,file:u,state:t.MUTED,resource:{...e.resource,isMuted:!0},additionalData:{...e.additionalData,...a}}:e))}}function c(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.TRIMMING}:e))}}function p(e,r){let{payload:{id:o,file:u,additionalData:a={}}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,file:u,state:t.TRIMMED,additionalData:{...e.additionalData,...a}}:e))}}function f(e,t){let{payload:{id:o,resource:u,posterFile:a}}=t;const i=e.queue.find((e=>e.id===o));return i&&i.resource.isPlaceholder?(i.resource.src!==u.src&&(r(i.resource.src),r(i.resource.poster)),{...e,queue:e.queue.map((e=>e.id===o?{...e,resource:{...u,id:e.resource.id,isPlaceholder:!1},posterFile:a}:e))}):e}function q(e,r){let{payload:{id:o}}=r;return{...e,queue:e.queue.map((e=>e.id===o?{...e,state:t.FINISHED}:e))}}function m(e,r){let{payload:{id:t}}=r;const o=e.queue.filter((e=>e.id!==t));return{...e,queue:o}}export{o as addItem,i as cancelUploading,q as finishItem,l as finishMuting,s as finishTranscoding,p as finishTrimming,a as finishUploading,m as removeItem,f as replacePlaceholderResource,n as startMuting,d as startTranscoding,c as startTrimming,u as startUploading};
