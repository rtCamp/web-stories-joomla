/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useCallback as e}from"@googleforcreators/react";import{fetchRemoteFile as t,fetchRemoteBlob as r,isAnimatedGif as o}from"@googleforcreators/media";import i from"../../api/useAPI.js";import a from"../../story/useStory.js";function d(d){let{uploadMedia:s,postProcessingResource:c,updateMedia:u,deleteMediaElement:n}=d;const{actions:{getOptimizedMediaById:l,getMutedMediaById:p}}=i(),{updateElementsByResourceId:m,updateElementById:y}=a((e=>({updateElementsByResourceId:e.actions.updateElementsByResourceId,updateElementById:e.actions.updateElementById}))),I=e((e=>{let{oldResource:t,resource:r}=e;const{id:o,alt:i}=t;m({id:o,properties:()=>({type:r.type,resource:{...r,alt:i}})})}),[m]),g=e((e=>{let{elementId:t,oldResource:r,resource:o}=e;const{alt:i}=r;y({elementId:t,properties:()=>({type:o.type,resource:{...o,alt:i}})})}),[y]),f=e(((e,t)=>{y({elementId:e,properties:e=>({resource:{...e.resource,...t}})})}),[y]),R=e(((e,t)=>{m({id:e,properties:e=>({resource:{...e.resource,...t}})})}),[m]),w=e(((e,t,r)=>{u(e,{mediaSource:r,optimizedId:t})}),[u]),E=e(((e,t)=>{u(e,{mutedId:t})}),[u]),M=e((e=>{let{resource:r}=e;const{id:o,src:i,mimeType:a}=r,d=()=>R(o,{isOptimized:!1}),u=e=>{let{resource:t}=e;I({oldResource:r,resource:t}),w(o,t.id,"source-video"),n({id:o}),c(t)},p=e=>{let{resource:t}=e;const i={...t,id:r.id};R(o,{...i})};(async()=>{const e=await l(o);if(e)return void R(o,e);let c=!1;try{c=await t(i,a)}catch(e){return}await s([c],{onUploadSuccess:u,onUploadError:d,onUploadProgress:p,additionalData:{originalId:r.id,isMuted:r.isMuted},originalResourceId:r.id})})()}),[R,I,w,n,c,l,s]),U=e((e=>{let{resource:o,canvasResourceId:i,elementId:a,start:d,end:u}=e;const{id:n,...l}=o,{src:p,mimeType:m,poster:y,isMuted:I,isOptimized:R}=o,w={original:n,start:d,end:u},E=()=>f(a,{trimData:w}),M=()=>f(a,{trimData:o.trimData||{}}),U=e=>{let{resource:t}=e;const r={alt:o.alt,id:i};g({elementId:a,oldResource:r,resource:t}),c(t)},z=e=>{let{resource:t}=e;const r={...t,id:i};f(a,{...r})};return(async()=>{let e=!1,o=!1;try{e=await t(p,m)}catch(e){return}if(y)try{o=await r(y)}catch(e){}await s([e],{onUploadSuccess:U,onUploadStart:E,onUploadError:M,onUploadProgress:z,additionalData:{originalId:n,isMuted:I,mediaSource:R?"video-optimization":"editor"},elementId:a,trimData:w,resource:{...l,trimData:w},originalResourceId:i,posterFile:o})})()}),[f,g,c,s]),z=e((e=>{let{resource:o}=e;const{id:i,...a}=o,{src:d,mimeType:u,poster:n,isOptimized:l}=o,m=()=>{R(i,{isMuted:!1})},y=e=>{let{resource:t}=e;I({oldResource:o,resource:t}),E(o.id,t.id),c(t)},g=e=>{let{resource:t}=e;const r={...t,id:o.id};R(i,{...r})};(async()=>{const e=await p(i);if(e)return void R(i,e);let o=!1,c=!1;try{o=await t(d,u)}catch(e){return}if(n)try{c=await r(n)}catch(e){}await s([o],{onUploadSuccess:y,onUploadError:m,onUploadProgress:g,additionalData:{originalId:i,mediaSource:l?"video-optimization":"editor"},muteVideo:!0,resource:{...a,isMuted:!0},originalResourceId:i,posterFile:c})})()}),[R,I,E,c,p,s]);return{optimizeVideo:M,optimizeGif:e((e=>{let{resource:r}=e;const{id:i,src:a,mimeType:d}=r,u=e=>{let{resource:t}=e;I({oldResource:r,resource:t}),w(r.id,t.id,"source-image"),n({id:r.id}),c(t)},l=e=>{let{resource:t}=e;const o={...t,id:r.id};R(i,{...o})};return(async()=>{let e=!1;try{e=await t(a,d)}catch(e){return}const r=await e.arrayBuffer();o(r)&&await s([e],{onUploadSuccess:u,onUploadProgress:l,additionalData:{original_id:i},originalResourceId:i})})()}),[I,w,n,c,R,s]),muteExistingVideo:z,trimExistingVideo:U}}export{d as default};
