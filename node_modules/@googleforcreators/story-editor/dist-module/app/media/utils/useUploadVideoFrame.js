/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useCallback as o}from"@googleforcreators/react";import{getTimeTracker as t,trackError as r}from"@googleforcreators/tracking";import{preloadImage as e,getFileNameFromUrl as s,getFirstFrameOfVideo as i}from"@googleforcreators/media";import"react";import"prop-types";import"@googleforcreators/templates";import"../../config/context.js";import a from"../../config/useConfig.js";import"../../api/context.js";import p from"../../api/useAPI.js";import"../../../constants/fonts.js";import"../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../story/context.js";import"@googleforcreators/migration";import"../../history/historyProvider.js";import"../../history/context.js";import"../../story/actions/useSaveStory.js";import"clone-deep";import"../../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../story/storyTriggers/storyTriggersProvider.js";import"../../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../story/storyTriggers/storyEvents/onPageAddedRegister.js";import m from"../../story/useStory.js";import n from"../../uploader/useUploader.js";import d from"./getPosterName.js";function c(c){let{updateMediaElement:g}=c;const{actions:{updateMedia:l}}=p(),{actions:{uploadFile:u}}=n(),{storyId:y}=a(),{updateElementsByResourceId:f}=m((o=>({updateElementsByResourceId:o.actions.updateElementsByResourceId}))),j=o((async(o,t,r)=>{if(!r)return{};r.name||(r.name=t);const s=await u(r,{mediaId:o,mediaSource:"poster-generation"}),{id:i,src:a,width:p,height:m}=s;o&&await l(o,{posterId:i,storyId:y});try{await e({src:a})}catch{}return{posterId:i,poster:a,posterWidth:p,posterHeight:m}}),[y,l,u]);return{uploadVideoFrame:o((async(o,e)=>{const a=t("load_video_poster");try{const t=s(e),r=d(t),p=await i(e),{posterId:m,poster:n,posterWidth:c,posterHeight:l}=await j(o,r,p),u=c&&l&&{width:c,height:l}||null;f({id:o,properties:o=>{let{resource:t}=o;return{resource:{...t,posterId:m,poster:n,...u}}}}),g({id:o,data:{posterId:m,poster:n,...u}})}catch(o){r("video_poster_generation",o.message)}finally{a()}}),[j,f,g]),uploadVideoPoster:j}}export{c as default};
