/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{useState as t,useEffect as o,useCallback as r,useMemo as s}from"@googleforcreators/react";import n from"sat";import{__}from"@googleforcreators/i18n";import{Icons as i}from"@googleforcreators/design-system";import{trackEvent as m}from"@googleforcreators/tracking";import l from"styled-components";import{getDefinitionForType as a}from"@googleforcreators/elements";import{useUnits as c}from"@googleforcreators/units";import p from"../story/useStory.js";import"prop-types";import"../layout/context.js";import"../layout/useZoomSetting.js";import"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"../story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../config/context.js";import g from"../config/useConfig.js";import"../api/context.js";import"../history/historyProvider.js";import"../history/context.js";import"../story/actions/useSaveStory.js";import"clone-deep";import"../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../story/storyTriggers/storyTriggersProvider.js";import"../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../story/storyTriggers/storyEvents/onPageAddedRegister.js";import"@googleforcreators/rich-text";import"@googleforcreators/media";import"../media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../utils/generateBlurhash.worker.js";import"../media/media3p/providerConfiguration.js";import"../media/utils/useFFmpeg.js";import"../media/media3p/api/context.js";import"../media/local/constants.js";import"../media/media3p/providerReducer.js";import"../media/context.js";import"@googleforcreators/stickers";import"../../components/library/panes/text/textPresets.js";import"../canvas/context.js";import u from"../canvas/useCanvas.js";const d=l(i.ChevronRightSmall).withConfig({displayName:"useLayerSelect__ReversedIcon",componentId:"sc-169lxcx-0"})(["transform:rotate(180deg);"]);function y(l){let{menuItemProps:y,menuPosition:f,isMenuOpen:h}=l;const{isRTL:j}=g(),[x,S]=t(!1),B=u((e=>{let{state:{nodesById:t}}=e;return t})),{currentPage:k,selectedElements:v,setSelectedElementsById:w}=p((e=>{let{state:{currentPage:t,selectedElements:o},actions:{setSelectedElementsById:r}}=e;return{currentPage:t,selectedElements:o,setSelectedElementsById:r}})),I=c((e=>{let{actions:{getBox:t}}=e;return t}));o((()=>{h||S(!1)}),[h]);const{x:P,y:E}=f,b=r((()=>{if(!k?.elements?.length||!Object.keys(B)?.length)return[];const e=new n.Vector(P,E),t=k.elements.find((e=>{let{isBackground:t}=e;return t})),o=B[t.id],{x:r,y:s,width:i,height:m}=o.getBoundingClientRect(),l=new n.Box(new n.Vector(r,s),i,m).toPolygon(),a=-I(t).y,c=k.elements.map((e=>{if(e.isBackground)return{element:e,polygon:l};const{id:t,rotationAngle:o}=e;if(!B[t])return null;const r=I(e),s=new n.Vector(l.pos.x+r.x+r.width/2,l.pos.y+a+r.y+r.height/2),i=new n.Box(s,r.width,r.height).toPolygon(),m=new n.Vector(-r.width/2,-r.height/2);return i.setOffset(m),i.setAngle(o*Math.PI/180),{element:e,polygon:i}})).map((t=>{let{element:o,polygon:r}=t;return n.pointInPolygon(e,r)?o:null})).filter(Boolean);return c.reverse(),c}),[k,I,P,E,B]),C=s((()=>{if(!h||0===v.length)return[];const t=b();return 1===t.length&&t[0].id===v[0].id?[]:t.map((t=>{const{id:o,isBackground:r,type:s}=t,{LayerContent:n}=a(s);return{key:o,supportsIcon:!0,icon:v[0].id===o?e.createElement(i.CheckmarkSmall,null):null,label:r?e.createElement("span",null,__("Background","web-stories")):e.createElement(n,{element:t}),onClick:()=>{w({elementIds:[o]}),m("context_menu_action",{name:"layer_selected",element:s,isBackground:r})},...y}}))}),[b,h,y,w,v]);return C.length>0?{label:__("Select Layer","web-stories"),openSubMenu:()=>S(!0),closeSubMenu:()=>S(!1),isSubMenuOpen:x,subMenuItems:x?C:[],SuffixIcon:j?d:i.ChevronRightSmall,...y}:null}export{y as default};
