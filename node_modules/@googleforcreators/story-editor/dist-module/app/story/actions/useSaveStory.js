/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{_x,__,sprintf}from"@googleforcreators/i18n";import{useState as t,useCallback as s}from"@googleforcreators/react";import{getTimeTracker as e,trackError as o}from"@googleforcreators/tracking";import{useSnackbar as r}from"@googleforcreators/design-system";import{stripHTML as i}from"@googleforcreators/dom";import"react";import"prop-types";import"@googleforcreators/templates";import"../../config/context.js";import a from"../../config/useConfig.js";import"../../api/context.js";import n from"../../api/useAPI.js";import p from"../../../utils/useRefreshPostEditURL.js";import d from"../utils/getStoryPropsToSave.js";import"../../history/historyProvider.js";import l from"../../history/useHistory.js";const m={400:_x("Bad Request","HTTP status description","web-stories"),401:_x("Unauthorized","HTTP status description","web-stories"),403:_x("Forbidden","HTTP status description","web-stories"),500:_x("Internal Server Error","HTTP status description","web-stories")};function u(u){let{storyId:c,pages:g,story:f,updateStory:y}=u;const{actions:{saveStoryById:h}}=n(),{actions:{resetNewChanges:b}}=l(),{metadata:v,flags:w}=a(),{showSnackbar:P}=r(),[k,j]=t(!1),[T,L]=t(!1),{editLink:S}=f,F=p(c,S);return{saveStory:s((t=>{j(!0);const s=["publish","future","private"].includes(f.status),r=e("load_save_story");return Promise.resolve().then((()=>h({storyId:c,...d({story:f,pages:g,metadata:v,flags:w}),...t}))).then((t=>{const{status:e,slug:o,link:r,previewLink:i,editLink:a,embedPostLink:n,featuredMedia:p}=t;y({properties:{status:e,slug:o,link:r,previewLink:i,editLink:a,embedPostLink:n,featuredMedia:p}}),F();const d=["publish","future","private"].includes(t.status);L(!s&&d)})).catch((t=>{const s=t.message?i(t.message):null;let e=__("Failed to save the story","web-stories");s&&(e=sprintf(
/* translators: %s: error message */
__("Failed to save the story: %s","web-stories"),s)),Object.prototype.hasOwnProperty.call(m,t?.data?.status)&&(e=s?sprintf(
/* translators: 1: error message. 2: status code */
__("Failed to save the story: %1$s (%2$s)","web-stories"),s,m[t?.data?.status]):sprintf(
/* translators: %s: error message */
__("Failed to save the story: %s","web-stories"),m[t?.data?.status])),console.log(__("Failed to save the story","web-stories"),t),o("save_story",s),P({message:e,dismissible:!0})})).finally((()=>{j(!1),b(),r()}))}),[f,g,v,h,c,y,F,P,b,w]),isSaving:k,isFreshlyPublished:T}}export{u as default};
