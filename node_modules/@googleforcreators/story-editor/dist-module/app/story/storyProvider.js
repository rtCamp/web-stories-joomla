/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import"prop-types";import{useEffect as t,useMemo as r}from"@googleforcreators/react";import{STABLE_ARRAY as s}from"../../constants/index.js";import o from"./context.js";import i from"./effects/useLoadStory.js";import n from"./actions/useSaveStory.js";import a from"./effects/useHashState.js";import l from"./effects/useHistoryEntry.js";import u from"./effects/useHistoryReplay.js";import c from"./useStoryReducer/useStoryReducer.js";import d from"./actions/useAutoSave.js";import{StoryTriggersProvider as m}from"./storyTriggers/storyTriggersProvider.js";import"./storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"./storyTriggers/storyEvents/onPageAddedRegister.js";function StoryProvider(y){let{storyId:g,initialEdits:p,children:S}=y;const[f,v]=a("page",null),{state:h,api:j,internal:{restore:E}}=c({current:f}),{pages:P,current:I,selection:b,story:A,animationState:x,capabilities:R,copiedElementState:T}=h;t((()=>v(I)),[I,v]);let H=null,F=null,L=null,N=null;I&&(H=I,F=P.findIndex((e=>{let{id:t}=e;return t===I})),L=F+1,N=P[F]);const k=r((()=>b.length>0?b:s),[b]),q=!N,w=N?.elements,z=r((()=>{if(q)return s;const e=w.filter((e=>{let{id:t}=e;return b.includes(t)}));return e.length>0?e:s}),[q,w,b]),B=N?.animations,C=r((()=>{if(q)return s;const e=(B||[]).reduce(((e,t)=>{let{targets:r,...s}=t;return r.some((e=>b.includes(e)))?[...e,{targets:r,...s}]:e}),[]);return e.length>0?e:s}),[q,b,B]),D=z.length>0,G=0===P.length;i({restore:E,shouldLoad:G,storyId:g,story:p?.story}),l({pages:P,current:I,selection:b,story:A,capabilities:R}),u({restore:E});const{updateStory:J}=j,{saveStory:K,isSaving:M,isFreshlyPublished:O}=n({storyId:g,pages:P,story:A,updateStory:J}),{autoSave:Q,isAutoSaving:U}=d({storyId:g,pages:P,story:A}),V=r((()=>({pages:P,currentPage:N,currentPageId:H,currentPageIndex:F,currentPageNumber:L,selectedElementIds:k,selectedElements:z,selectedElementAnimations:C,hasSelection:D,story:A,animationState:x,capabilities:R,meta:{isSaving:M||U,isSavingStory:M,isAutoSavingStory:U,isFreshlyPublished:O},copiedElementState:T})),[P,N,H,F,L,k,z,C,D,A,x,R,M,U,O,T]),W={state:V,actions:{...j,autoSave:Q,saveStory:K},internal:{reducerState:h,restore:E}};return e.createElement(o.Provider,{value:W},e.createElement(m,{story:V},S))}export{StoryProvider as default};
