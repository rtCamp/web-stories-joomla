/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import{useState as r,useEffect as e,useRef as o,useCallback as s,useMemo as i}from"@googleforcreators/react";import n from"../../utils/cleanForSlug.js";import"prop-types";import"@googleforcreators/templates";import"../config/context.js";import"../api/context.js";import a from"../api/useAPI.js";import"../history/historyProvider.js";import c from"../history/useHistory.js";import"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../story/context.js";import"@googleforcreators/migration";import"../story/actions/useSaveStory.js";import"clone-deep";import"../story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../story/storyTriggers/storyTriggersProvider.js";import"../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../story/storyTriggers/storyEvents/onPageAddedRegister.js";import m from"../story/useStory.js";import l from"./context.js";import{dictionaryOnKey as p,mapObjectKeys as g,cacheFromEmbeddedTerms as u,mapObjectVals as y,mergeNestedDictionaries as d}from"./utils/index.js";function f(){return f=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},f.apply(this,arguments)}function TaxonomyProvider(h){const[j,v]=r([]),[T,x]=r({}),[S,P]=r(!0),{actions:{clearHistory:B}}=c(),{updateStory:A,isStoryLoaded:E,terms:R,hasTaxonomies:b}=m((t=>{let{state:{pages:r,story:e},actions:{updateStory:o}}=t;return{updateStory:o,isStoryLoaded:r.length>0,terms:e.terms,hasTaxonomies:e?.taxonomies?.length>0}})),{getTaxonomyTerm:w,createTaxonomyTerm:O,getTaxonomies:C}=a((t=>{let{actions:r}=t;return r}));e((()=>{b&&async function(){try{const t=await C();v(t)}catch(t){console.error(t.message)}}()}),[b,C]);const H=o(!1);e((()=>{if(j.length>0&&E&&!H.current){const t=p(j,"slug"),r=g(u(R),(r=>t[r]?.restBase)),e=y(r,(t=>Object.values(t).map((t=>t.id))));x(r),B(),A({properties:{terms:e}}),H.current=!0}}),[R,E,j,x,B,A]);const I=s((function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];A({properties:e=>{const o="function"==typeof r?r(e.terms[t.restBase]):r;return{...e,terms:{...e.terms,[t.restBase]:o}}}})}),[A]),L=s(((t,r)=>{I(t,(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return t.includes(r.id)?t:[...t,r.id]}))}),[I]),$=s((async function(t,r){let e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=[];const s=t?.restPath;if(!s)return[];try{o=await w(s,r)}catch(t){console.error(t.message)}if(o.length<1)return o;const i={[t.restBase]:p(o,"slug")};if(x((t=>d(t,i))),e&&r.search){const e=n(r.search),s=o.find((t=>t.slug===e));s&&L(t,s)}return o}),[w,L]),_=s((async function(t,r,e){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s={name:r};e?.id&&(s.parent=e.id,s.slug=`${e.slug}-${n(s.name)}`);const i=s?.slug||n(r),a=T[t.restBase]?.[i];if(a)return void(o&&L(t,a));const c=t?.restPath;if(c)try{const r=await O(c,s),e={[t.restBase]:{[r.slug]:r}};x((t=>d(t,e))),o&&L(t,r)}catch(e){"term_exists"===e.code&&$(t,{search:r},o)}}),[O,T,$,L]);e((()=>{if(S&&j?.length){j.filter((t=>t.hierarchical)).forEach((t=>$(t,{per_page:-1}))),P(!1)}}),[$,S,j]);const k=i((()=>({state:{taxonomies:j,termCache:T,terms:Array.isArray(R)?{}:R},actions:{createTerm:_,addSearchResultsToCache:$,setTerms:I,addTermToSelection:L}})),[T,R,j,_,$,I,L]);return t.createElement(l.Provider,f({},h,{value:k}))}export{TaxonomyProvider as default};
