/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import t from"styled-components";import{memo as r,useMemo as o,useCombinedRefs as a,useCallback as n,useEffect as i}from"@googleforcreators/react";import s from"prop-types";import{_x,__}from"@googleforcreators/i18n";import{STORY_ANIMATION_STATE as p,StoryAnimation as m,useStoryAnimationContext as l}from"@googleforcreators/animation";import"@googleforcreators/transform";import"../dropTargets/provider.js";import"../dropTargets/context.js";import"../../app/history/historyProvider.js";import"../../app/history/context.js";import"@googleforcreators/templates";import"../../app/config/context.js";import"../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import{STABLE_ARRAY as c}from"../../constants/index.js";import"../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../app/story/context.js";import"@googleforcreators/migration";import"../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../app/story/storyTriggers/storyTriggersProvider.js";import"../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import g from"../../app/story/useStory.js";import"../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../utils/generateBlurhash.worker.js";import"@googleforcreators/design-system";import"../../app/media/media3p/providerConfiguration.js";import"../../app/media/utils/useFFmpeg.js";import"../../app/media/media3p/api/context.js";import"../../app/media/local/constants.js";import"../../app/media/media3p/providerReducer.js";import"../../app/media/context.js";import"sat";import"@googleforcreators/units";import"../../app/layout/context.js";import"../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../library/panes/text/textPresets.js";import"../../app/canvas/context.js";import{CANVAS_BOUNDING_BOX_IDS as d}from"../../app/canvas/constants.js";import u from"../../app/canvas/useCanvas.js";import{useCanvasBoundingBoxRef as y}from"../../app/canvas/useCanvasBoundingBox.js";import"../../app/currentUser/context.js";import"../../app/helpCenter/provider.js";import"../../app/helpCenter/context.js";import"../helpCenter/constants.js";import"../../app/rightClickMenu/context.js";import"../../types.js";import f from"./displayElement.js";import{PageArea as E,Layer as j}from"./layout.js";import P from"./pageAttachment/index.js";import A from"./shoppingPageAttachment/index.js";import C from"./mediaCaptions/mediaCaptionsLayer.js";const S=t(E).withConfig({displayName:"displayLayer__DisplayPageArea",componentId:"sc-13e1aq-0"})(["position:absolute;"]);function DisplayPage(t){let{pageElements:r,editingElement:o}=t;return r?r.map((t=>o===t.id?null:e.createElement(f,{key:t.id,element:t,isAnimatable:!0}))):null}function DisplayPageAnimationController(e){let{resetAnimationState:t}=e;const{animationState:r,pageId:o}=g((e=>{let{state:t}=e;return{animationState:t.animationState,pageId:t.currentPage?.id}})),a=l((e=>{let{actions:t}=e;return t.WAAPIAnimationMethods}));return i((()=>{switch(r){case p.PLAYING_SELECTED:case p.PLAYING:return void a.play();case p.RESET:return void a.reset();case p.SCRUBBING:case p.PAUSED:return void a.pause();default:return}}),[r,a]),i((()=>t),[t,o]),null}function StoryAnimations(t){let{children:r}=t;const{isAnimationPlaying:a,currentPageAnimations:i,currentPageElements:s,selectedElements:l,updateAnimationState:d}=g((e=>{let{state:t,actions:r}=e;return{isAnimationPlaying:t.animationState===p.PLAYING_SELECTED,currentPageAnimations:t.currentPage?.animations||c,currentPageElements:t.currentPage?.elements||c,selectedElements:t.selectedElements,updateAnimationState:r.updateAnimationState}})),u=n((()=>{d({animationState:p.RESET})}),[d]),y=o((()=>l.map((e=>e.id))),[l]);return e.createElement(m.Provider,{animations:i,elements:s,onWAAPIFinish:u,selectedElementIds:a?y:c},e.createElement(DisplayPageAnimationController,{resetAnimationState:u}),r)}DisplayPageAnimationController.propTypes={resetAnimationState:s.func};var h=r((function DisplayLayer(){const{backgroundColor:t,isBackgroundSelected:r,pageAttachment:n,hasProducts:i}=g((e=>{let{state:t}=e;return{hasCurrentPage:Boolean(t.currentPage),backgroundColor:t.currentPage?.backgroundColor,isBackgroundSelected:t.selectedElements?.[0]?.isBackground,pageAttachment:t.currentPage?.pageAttachment||{},hasProducts:t.currentPage.elements?.some((e=>{let{type:t,product:r}=e;return"product"===t&&r?.productId}))}})),s=g((e=>{let{state:t}=e;return t.currentPage?.elements||c})),p=y(d.PAGE_CONTAINER),{editingElement:m,setPageContainer:l,setFullbleedContainer:f}=u((e=>{let{state:{editingElement:t},actions:{setPageContainer:r,setFullbleedContainer:o}}=e;return{editingElement:t,setPageContainer:r,setFullbleedContainer:o}})),E=o((()=>i?e.createElement(A,{theme:n.theme}):e.createElement(P,{pageAttachment:n})),[n,i]);return e.createElement(StoryAnimations,null,e.createElement(j,{"data-testid":"DisplayLayer",pointerEvents:"none","aria-label":_x("Display layer","compound noun","web-stories")},e.createElement(S,{ref:a(l,p),fullbleedRef:f,background:t,isBackgroundSelected:r,fullBleedContainerLabel:__("Fullbleed area (Display layer)","web-stories"),overlay:E,isControlled:!0},e.createElement(DisplayPage,{pageElements:s,editingElement:m})),e.createElement(C,null)))}));export{h as default};
