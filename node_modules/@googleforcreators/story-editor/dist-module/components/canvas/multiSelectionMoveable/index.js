/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import"prop-types";import{forwardRef as e,useRef as o,useEffect as r,useState as s,useCombinedRefs as a}from"@googleforcreators/react";import{useUnits as i}from"@googleforcreators/units";import{useTransform as n}from"@googleforcreators/transform";import{Moveable as p}from"@googleforcreators/moveable";import{getDefinitionForType as m}from"@googleforcreators/elements";import"../../dropTargets/provider.js";import"../../dropTargets/context.js";import"../../../app/history/historyProvider.js";import"../../../app/history/context.js";import"@googleforcreators/templates";import"../../../app/config/context.js";import"../../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../constants/fonts.js";import"../../../constants/multipleValue.js";import"../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import l from"../../../utils/objectWithout.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"../../../app/story/context.js";import"@googleforcreators/migration";import"../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import c from"../../../app/story/useStory.js";import"@googleforcreators/i18n";import"../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../utils/generateBlurhash.worker.js";import"@googleforcreators/design-system";import"../../../app/media/media3p/providerConfiguration.js";import"../../../app/media/utils/useFFmpeg.js";import"../../../app/media/media3p/api/context.js";import"../../../app/media/local/constants.js";import"../../../app/media/media3p/providerReducer.js";import"../../../app/media/context.js";import"sat";import d from"../../../app/layout/useLayout.js";import"../../../app/layout/context.js";import"../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../library/panes/text/textPresets.js";import"../../../app/canvas/context.js";import g from"../../../app/canvas/useCanvas.js";import"../../../app/currentUser/context.js";import"../../../app/helpCenter/provider.js";import"../../../app/helpCenter/context.js";import"../../helpCenter/constants.js";import"../../../app/rightClickMenu/context.js";import u from"../../../utils/isTargetOutOfContainer.js";import f from"../utils/useSnapping.js";import y from"../utils/useUpdateSelectionRectangle.js";import j from"../useWindowResizeHandler.js";import v from"./useDrag.js";import h from"./useResize.js";import E from"./useRotate.js";function x(){return x=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},x.apply(this,arguments)}const b=["nw","ne","sw","se"],T=e((function MultiSelectionMoveable(e,T){let{selectedElements:S,...R}=e;const z=o(),{updateElementsById:I,deleteElementsById:D,backgroundElement:B}=c((t=>({updateElementsById:t.actions.updateElementsById,deleteElementsById:t.actions.deleteElementsById,backgroundElement:t.state.currentPage.elements[0]??{}}))),{nodesById:C,fullbleedContainer:k}=g((t=>{let{state:{nodesById:e,fullbleedContainer:o}}=t;return{fullbleedContainer:o,nodesById:e}})),{editorToDataX:O,editorToDataY:w}=i((t=>({editorToDataX:t.actions.editorToDataX,editorToDataY:t.actions.editorToDataY}))),{zoomSetting:L,scrollLeft:P,scrollTop:F}=d((t=>{let{state:{zoomSetting:e,scrollLeft:o,scrollTop:r}}=t;return{zoomSetting:e,scrollLeft:o,scrollTop:r}})),{actions:{pushTransform:G}}=n();j(z),r((()=>{z.current&&z.current.updateRect()}),[S,z,C,P,F]),y(z,[L]);const M=S.map((t=>({element:t,node:C[t.id],updateForResizeEvent:m(t.type).updateForResizeEvent}))),[A,U]=s(!1),X=(t,e,o)=>{e.style.transform=`translate(${o.translate[0]}px, ${o.translate[1]}px) rotate(${o.rotate}deg)`,G(t,o)},Y=M?M.map((t=>{let{element:e}=t;return{translate:[0,0],rotate:e.rotationAngle,direction:[0,0],resize:[0,0],updates:null}})):[],$=t=>{let{events:e,isDrag:o,isRotate:r}=t;e.forEach(((t,e)=>{const s=Y[e];o?t.set(s.translate):r&&t.set(s.rotate)}))},N=t=>{let{targets:e,isRotate:o,isResize:r}=t;const s={},a=[];e.forEach(((t,e)=>{const{element:i,updateForResizeEvent:n}=M[e];if(u(t,k))return void a.push(i.id);const p=Y[e],{direction:m}=p,l=t=>Math.abs(t)<=1?0:t,c={x:l(i.x+O(p.translate[0])),y:l(i.y+w(p.translate[1]))};o&&(c.rotationAngle=p.rotate);const[d,g]=p.resize;if(r&&(0!==d&&0!==g)){const t=O(d),e=w(g);c.width=t,c.height=e,n&&Object.assign(c,n(i,m,t,e))}s[i.id]=c})),I({elementIds:Object.keys(s),properties:t=>s[t.id]}),a.length>0&&D({elementIds:a}),M.forEach(((t,e)=>{let{element:o,node:r}=t;Y[e].direction=[0,0],Y[e].translate=[0,0],Y[e].resize=[0,0],Y[e].updates=null,r.style.transform="",r.style.width="",r.style.height="",G(o.id,null)})),z.current&&z.current.updateRect()},W=Object.values(l(C,[...S.map((t=>t.id)),B.id])),H=f({canSnap:!0,otherNodes:W}),V=v({targetList:M,frames:Y,setTransformStyle:X,onGroupEventStart:$,onGroupEventEnd:N,isDragging:A,setIsDragging:U}),Z=h({onGroupEventEnd:N,targetList:M,setTransformStyle:X,frames:Y}),q=E({onGroupEventStart:$,setTransformStyle:X,onGroupEventEnd:N,targetList:M,frames:Y}),J=a(z,T);return M.some((t=>{let{node:e}=t;return void 0===e}))?null:t.createElement(p,x({},R,{className:"default-moveable",ref:J,zIndex:0,target:M.map((t=>{let{node:e}=t;return e})),draggable:!0,resizable:!0,rotatable:!0,renderDirections:b},V,q,Z,H))}));export{T as default};
