/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import"prop-types";import e from"styled-components";import{useMemo as o,useRef as r,useCallback as s,useEffect as i}from"@googleforcreators/react";import{useUnits as n,PAGE_RATIO as a}from"@googleforcreators/units";import{withOverlay as p,InOverlay as c}from"@googleforcreators/moveable";import"@googleforcreators/transform";import"../dropTargets/provider.js";import"../dropTargets/context.js";import"../../app/history/historyProvider.js";import"../../app/history/context.js";import"@googleforcreators/templates";import"../../app/config/context.js";import"../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import{STABLE_ARRAY as l}from"../../constants/index.js";import"../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../app/story/context.js";import"@googleforcreators/migration";import"../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../app/story/storyTriggers/storyTriggersProvider.js";import"../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import m from"../../app/story/useStory.js";import"@googleforcreators/i18n";import"../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../utils/generateBlurhash.worker.js";import"@googleforcreators/design-system";import"../../app/media/media3p/providerConfiguration.js";import"../../app/media/utils/useFFmpeg.js";import"../../app/media/media3p/api/context.js";import"../../app/media/local/constants.js";import"../../app/media/media3p/providerReducer.js";import"../../app/media/context.js";import"sat";import"../../app/layout/context.js";import"../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../library/panes/text/textPresets.js";import"../../app/canvas/context.js";import d from"../../app/canvas/useCanvas.js";import"../../app/currentUser/context.js";import"../../app/helpCenter/provider.js";import"../../app/helpCenter/context.js";import"../helpCenter/constants.js";import"../../app/rightClickMenu/context.js";const g=0,f=1,u=2,y=p(e.div.withConfig({displayName:"selectionCanvas__Container",componentId:"sc-qsqc5z-0"})(["position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;user-select:none;"])),h=e.div.withConfig({displayName:"selectionCanvas__Lasso",componentId:"sc-qsqc5z-1"})(["display:none;position:absolute;border:1px dotted ",";z-index:1;"],(t=>{let{theme:e}=t;return e.colors.border.selection}));function SelectionCanvas(e){let{children:p}=e;const j=m((t=>{let{state:e}=t;return e.currentPage?.elements||l})),{selectedElements:x,clearSelection:v}=m((t=>{let{state:{selectedElements:e},actions:{clearSelection:o}}=t;return{selectedElements:e,clearSelection:o}})),{fullbleedContainer:E,isEditing:b,nodesById:C,clearEditing:T,selectIntersection:M}=d((t=>{let{state:{fullbleedContainer:e,isEditing:o,nodesById:r},actions:{clearEditing:s,selectIntersection:i}}=t;return{fullbleedContainer:e,isEditing:o,nodesById:r,clearEditing:s,selectIntersection:i}})),S=o((()=>E?.closest("[data-scroll-container]")),[E]),{editorToDataX:I,editorToDataY:w}=n((t=>({editorToDataX:t.actions.editorToDataX,editorToDataY:t.actions.editorToDataY}))),D=r(null),k=r(null),L=r([0,0]),P=r([0,0]),R=r([0,0]),X=r(g),Y=s((()=>{const[t,e]=P.current,[o,r]=R.current;return[Math.min(t,o),Math.min(e,r),Math.abs(t-o),Math.abs(e-r)]}),[]),q=s((()=>{const t=k.current;if(!t)return;const e=X.current,[o,r,s,i]=Y();t.style.left=`${o}px`,t.style.top=`${r}px`,t.style.width=`${s}px`,t.style.height=`${i}px`,t.style.display=e===f?"block":"none"}),[Y]),B=s((t=>{C[j[0].id].contains(t.target)||(x.length&&v(),b&&T());let e=0,o=0;for(let t=D.current;t;t=t.offsetParent)e+=t.offsetLeft,o+=t.offsetTop;const r=t.pageX-e,s=t.pageY-o;L.current=[e,o],P.current=[r,s],R.current=[r,s],X.current=u,q()}),[T,v,j,b,C,x.length,q]),$=s((t=>{if(X.current===g)return;const[e,o]=P.current,[r,s]=L.current,i=t.pageX-r,n=t.pageY-s;R.current[0]=i,R.current[1]=n,q(),Math.abs(e-i)+Math.abs(o-n)>10&&(X.current=f)}),[q]),_=s((()=>{if(X.current===f){const[t,e,o,r]=Y(),{offsetLeft:s,offsetTop:i,offsetHeight:n,offsetWidth:p}=E,{offsetLeft:c,offsetTop:l}=S,m=i+l+(n-p/a)/2,d=I(t-(s+c)),g=w(e-m),f=I(o),u=w(r);v(),T(),M({x:d,y:g,width:f,height:u})}X.current=g,q()}),[T,v,I,w,E,Y,S,M,q]);return i((()=>(document.addEventListener("mouseup",_),()=>{document.removeEventListener("mouseup",_)})),[_]),i(q),t.createElement(y,{onMouseDown:B,onMouseMove:$,"data-fix-caret":!0},p,t.createElement(c,{ref:D},t.createElement(h,{ref:k})))}export{SelectionCanvas as default};
