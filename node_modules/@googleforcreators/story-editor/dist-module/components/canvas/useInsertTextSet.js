/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useBatchingCallback as o,useCallback as t}from"@googleforcreators/react";import{PAGE_WIDTH as r,FULLBLEED_HEIGHT as e,DANGER_ZONE_HEIGHT as s}from"@googleforcreators/units";import{getHTMLFormatters as i}from"@googleforcreators/rich-text";import{ELEMENT_TYPES as p}from"@googleforcreators/elements";import a from"../../utils/objectWithout.js";import"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"react";import"prop-types";import"../../app/story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../../app/config/context.js";import"../../app/api/context.js";import"../../app/history/historyProvider.js";import"../../app/history/context.js";import"../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../app/story/storyTriggers/storyTriggersProvider.js";import"../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import l from"../../app/story/useStory.js";import"../../utils/storyPageToNode.js";import"@ap.cx/hues";import"../../app/pageCanvas/context.js";import"../../app/pageCanvas/pageCanvasCacheValidator.js";import n from"../../app/pageCanvas/useCalculateAccessibleTextColors.js";import c from"./useInsertElement.js";function m(){let m=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const g=c(),d=n(),{setSelectedElementsById:f}=l((o=>{let{actions:{setSelectedElementsById:t}}=o;return{setSelectedElementsById:t}})),u=o((async function(o){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m;const r=i(),{setColor:e}=r,s=[],l=o.some((o=>o.content?.includes("color:")));let n=[],c=null;const u={r:255,g:255,b:255},y={r:0,g:0,b:0},h={...u,a:.3},j={...y,a:.3};let x,b,S;if(t&&!l){n=await Promise.all(o.map((o=>"text"===o.type?d(o):null))),c=n.find((o=>o));const t=n.every((o=>null===o||o.color?.r===c.color?.r&&o.color?.g===c.color?.g&&o.color?.b===c.color?.b&&o.color?.a===c.color?.a));b=n.reduce(((o,t)=>t?.backgroundColor?o+1:o),0);const r=n.reduce(((o,t)=>0===t?.backgroundColor?.r&&0===t?.backgroundColor?.g&&0===t?.backgroundColor?.b?o+1:o),0);if(x=b-r>0?j:h,S=b>0||!1===t,S){const{textSetHeight:t,textSetWidth:r}=o[0],e=t=>Math.min.apply(null,o.map((o=>o[t]))),i={x:e("x")-24,y:e("y")-24,width:r+48,height:t+48,backgroundColor:{color:x},type:"shape"};s.push(g(p.SHAPE,i))}}o.forEach(((o,r)=>{const i=a(o,["id","normalizedOffsetX","normalizedOffsetY","textSetWidth","textSetHeight"]);if(t&&!l){const t=0===x.r?u:y,s=S?{color:t}:n[r];"text"===o.type&&s.color&&(i.content=e(i.content,s)),"shape"===o.type&&c.color&&(o.border?i.border.color=c:i.backgroundColor=c)}s.push(g(o.type,i))})),f({elementIds:s.map((o=>{let{id:t}=o;return t}))})}),[d,m,g,f]),y=t(((o,t)=>{let{offsetX:i,offsetY:p}=t;if(!o.length)return;const a=o.map((o=>{const t=o.normalizedOffsetX+i,a=o.normalizedOffsetY+p,{width:l,height:n}=o;return t>r||t+l<0||a>e||a+n<-s?null:{...o,x:t,y:a}})).filter((o=>o));u(a,!1)}),[u]);return{insertTextSet:u,insertTextSetByOffset:y}}export{m as default};
