/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{getBox as t,getBoundRect as o,FULLBLEED_RATIO as e,PAGE_RATIO as r}from"@googleforcreators/units";import{getMediaSizePositionProps as i,preloadImage as s}from"@googleforcreators/media";import{createSolidFromString as a}from"@googleforcreators/patterns";import{calculateLuminanceFromStyleColor as n,calculateLuminanceFromRGB as p,checkContrastFromLuminances as c}from"../../../../utils/contrastUtils.js";import"@googleforcreators/dom";import"../../constants.js";import{getSpansFromContent as g}from"../../utils/getSpansFromContent.js";import"react";import"../../../../types.js";import"../../../footer/pagepreview/index.js";import"../../../thumbnail/constants.js";import"prop-types";import"@googleforcreators/design-system";import"../../../thumbnail/styles.js";import"@googleforcreators/i18n";import"@googleforcreators/elements";import"@googleforcreators/react";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"@googleforcreators/fonts";import"../../../../constants/fonts.js";import"../../../../constants/multipleValue.js";import"../../../../app/font/context.js";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../app/media/useUploadMedia.js";import m from"../../../../utils/getMediaBaseColor.js";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";function l(t,o){return t>=.3333333333333333*o}function h(e,r,i){const{pageSize:s}=i,a=t(e,s?.width,s?.height),n=o([a]),p=n.width*n.height,c=[...r].map(((e,r)=>{const a=t(e,s?.width,s?.height),p=o([a]),c=function(t,o){const e=Math.min(t.endX,o.endX)-Math.max(t.startX,o.startX),r=Math.min(t.endY,o.endY)-Math.max(t.startY,o.startY);return e>=0&&r>=0?e*r:0}(n,p);return{element:e.isBackground||e.isDefaultBackground?{...e,backgroundColor:i?.backgroundColor}:e,area:c,index:r}})).reverse();let g=p;const m=[];for(const t of c){if(!l(g,p))break;l(t.area,p)&&m.push(t.element),g-=t.area}return m}function d(n){let{background:p,text:c,page:g}=n;const{pageSize:l}=g,h=(l?.width/e-l?.width/r)/2,d=t(c,l?.width,l?.height),f=o([d]),{resource:j,scale:y,focalX:x,focalY:w}=p,b=t(p,l?.width,l?.height),{width:k,height:v}=b,C=i(j,k,v,y,x,w);return async function(t){let{bgImage:o,bgBox:e,overlapBox:r}=t;function i(t){return new Promise(((i,s)=>{try{const s=document.createElement("canvas");s.width=o.width,s.height=o.height;const a=s.getContext("2d");if(o.rotationAngle){const t=o.offsetX+e.width/2,r=o.offsetY+e.height/2;a.translate(t,r),a.rotate(o.rotationAngle*u),a.translate(-t,-r)}let n=0,p=0;const{flip:c}=o;(c.vertical||c.horizontal)&&(n=c.horizontal?-1*o.width:0,p=c.vertical?-1*o.height:0,a.scale(c.horizontal?-1:1,c.vertical?-1:1)),a.drawImage(t,n,p,o.width,o.height);i(a.getImageData(r.x,r.y,r.width,r.height))}catch(t){s(t)}}))}const n=await s({src:o.src,width:o.width,height:o.height}),p=await i(n),c=document.createElement("canvas");c.width=r.width,c.height=r.height;c.getContext("2d").putImageData(p,0,0);const g=await m(c.toDataURL(),c.width,c.height),{color:{r:l,g:h,b:d}}=a(g);return{r:l,g:h,b:d}}({bgImage:{offsetX:C.offsetX,offsetY:C.offsetY,src:p.resource.src,width:C.width,height:C.height,rotationAngle:p.isBackground?void 0:p.rotationAngle,flip:p.flip},bgBox:b,overlapBox:{x:p.isBackground?C.offsetX+Math.abs(f.startX):C.offsetX+Math.abs(f.startX)-b.x,y:p.isBackground?C.offsetY+Math.abs(f.startY+h):C.offsetY+Math.abs(f.startY+h)-(b.y+h),width:f.width,height:f.height}}).catch((()=>{}))}const u=Math.PI/180;function f(t){let{background:o}=t;return o?.backgroundColor?.color}function j(t){switch(t.type){case"image":return d;case"shape":return f;default:return()=>{}}}async function y(t,o){const e=[];(t||[]).forEach((t=>{const r=x({...t,pageSize:o});r instanceof Promise?e.push(r.then((o=>({result:o,page:t})))):e.push(r)}));return(await Promise.all(e)).filter((t=>t.result.some((t=>{let{id:o}=t;return o})))).map((t=>t))}async function x(t){const o=[];t.elements.forEach(((e,r)=>{if("text"===e.type&&"NONE"===e.backgroundTextMode){const i=function(t){const o=g(t.content),e=o.map((t=>t.style?.color)).filter(Boolean),r=0===e.length&&0!==o.length,i=0!==t.content.length&&0===o.length;return(r||i)&&e.push("rgb(0, 0, 0)"),e}(e),s=t.elements.slice(0,r),a=h(e,s,t);for(const r of a){const s=j(r)({background:r,text:e,page:t}),a=t=>t&&{backgroundColor:t,textStyleColors:i,fontSize:e.fontSize,id:e.id,isBackgroundElement:r.isBackground},n=s instanceof Promise?s.then(a):a(s);o.push(n)}}}));const e=(await Promise.all(o)).map((t=>function(){let{backgroundColor:t,textStyleColors:o,fontSize:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!(!o||!t)&&o.some((o=>{if(!o)return!1;const r=n(o),i=p(t);return!c(r,i,e).WCAG_AA}))}(t)&&{id:t.id,isBackground:t.isBackgroundElement}));return e.filter((t=>{let{id:o}=t;return o}))}export{y as getPagesWithFailedContrast,x as pageBackgroundTextLowContrast};
