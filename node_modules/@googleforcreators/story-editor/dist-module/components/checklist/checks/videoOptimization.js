/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{__,sprintf,_n}from"@googleforcreators/i18n";import t from"styled-components";import{useReducer as r,useMemo as o,useCallback as i}from"@googleforcreators/react";import{Button as s,BUTTON_TYPES as n,BUTTON_SIZES as a,Tooltip as p}from"@googleforcreators/design-system";import"../../../constants/fonts.js";import{MEDIA_VIDEO_DIMENSIONS_THRESHOLD as m}from"../../../constants/media.js";import"../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"prop-types";import"../../../app/story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../../../app/config/context.js";import"../../../app/api/context.js";import"../../../app/history/historyProvider.js";import"../../../app/history/context.js";import"../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import c from"../../../app/story/useStory.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../utils/generateBlurhash.worker.js";import"../../../app/media/media3p/providerConfiguration.js";import l from"../../../app/media/utils/useFFmpeg.js";import"../../../app/media/media3p/api/context.js";import"../../../app/media/local/constants.js";import"../../../app/media/media3p/providerReducer.js";import"../../../app/media/context.js";import d from"../../../app/media/local/useLocalMedia.js";import{PRIORITY_COPY as u}from"../constants.js";import{THUMBNAIL_TYPES as g}from"../../thumbnail/constants.js";import f from"../../thumbnail/thumbnail.js";import"../../thumbnail/styles.js";import{LayerThumbnail as h}from"../../thumbnail/components/LayerThumbnail.js";import{StyledVideoOptimizationIcon as y}from"../../checklistCard/styles.js";import j from"../../checklistCard/checklistCard.js";import{CARD_TYPE as E}from"../../checklistCard/constants.js";import{DefaultFooterText as w}from"../../checklistCard/defaultFooterText.js";import{filterStoryElements as T}from"../utils/filterStoryElements.js";import"../../../app/highlights/styles.js";import b from"../../../app/highlights/useHighlights.js";import"../../../app/highlights/context.js";import"../../../app/highlights/states.js";import"../../../app/highlights/quickActions/constants.js";import"../../../app/highlights/quickActions/useQuickActions.js";import{useRegisterCheck as v}from"../countContext/checkCountContext.js";import{useIsChecklistMounted as C}from"../popupMountedContext.js";const k=t(s).withConfig({displayName:"videoOptimization__OptimizeButton",componentId:"sc-1dz2s9g-0"})(["margin-top:4px;"]);function z(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{resource:t}=e;if(!t)return!1;const{isOptimized:r,height:o=0,width:i=0}=t;if("video"!==e.type||r)return!1;const s=o*i,n=s>m.WIDTH*m.HEIGHT;return n}const R={},x="cancelled",I="uploaded",O="uploading";function S(e,t){switch(t.type){case x:return{...e,[t.element.resource.id]:x};case I:return{...e,[t.element.resource.id]:I};case O:return{...e,[t.element.resource.id]:O};default:throw new Error}}const BulkVideoOptimization=()=>{const t=C(),[s,m]=r(S,R),l=c((e=>{let{state:t}=e;return t?.pages})),{optimizeVideo:L,isNewResourceTranscoding:A,isCurrentResourceTranscoding:N,canTranscodeResource:V}=d((e=>{let{actions:{optimizeVideo:t},state:{isNewResourceTranscoding:r,canTranscodeResource:o,isCurrentResourceTranscoding:i}}=e;return{optimizeVideo:t,isNewResourceTranscoding:r,canTranscodeResource:o,isCurrentResourceTranscoding:i}})),P=o((()=>T(l,z)),[l]).filter(((e,t,r)=>r.findIndex((t=>t.resource.id===e.resource.id))===t)),H=b((e=>{let{setHighlights:t}=e;return t})),M=i((async e=>{if(V(e.resource)&&s[e.resource.id]!==O){m({type:O,element:e});try{await L({resource:e.resource})}catch(t){return void m({type:x,element:e})}m({type:I,element:e})}}),[V,L,s]),U=i((()=>{const e=P.filter((e=>{let{resource:t}=e;return!A(t?.id)&&!N(t?.id)}));return new Promise((t=>{e.map((e=>async()=>{await M(e)})).reduce(((e,t)=>e.then(t)),Promise.resolve()).then(t)}))}),[A,N,M,P]),$=i((async()=>{await U()}),[U]),_=i((e=>async()=>{H({pageId:e.pageId,elementId:e.id}),await M(e)}),[M,H]),{footer:B,title:D}=u.videoNotOptimized,F=o((()=>Object.values(s).filter((e=>e===O))),[s]),G=o((()=>F.length>0||P.some((e=>A(e.resource.id)||N(e.resource.id)))),[F,P,A,N]),q=P.length>0;v("VideoOptimization",q);let Q=1===P.length?__("Optimize video","web-stories"):__("Optimize all videos","web-stories");if(G){const e=F.length+P.filter((e=>A(e.resource.id)||N(e.resource.id))).length;Q=sprintf(
/* translators: 1: number of videos currently transcoding. 2: total number of videos in list. */
_n("Optimizing %1$d of %2$d","Optimizing %1$d of %2$d",e,"web-stories"),e,P.length)}return q&&t&&e.createElement(j,{cta:e.createElement(k,{type:n.SECONDARY,size:a.SMALL,onClick:$,disabled:G},Q),title:D,cardType:P.length>1?E.MULTIPLE_ISSUE:E.SINGLE_ISSUE,footer:e.createElement(w,null,B),thumbnails:P.map((t=>e.createElement(f,{key:t.resource.id,onClick:_(t),isLoading:A(t.resource.id)||N(t.resource.id),type:g.VIDEO,displayBackground:e.createElement(h,{page:t}),"aria-label":__("Go to offending video","web-stories"),isError:s[t.resource.id]===x},e.createElement(p,{title:s[t.resource.id]===O||A(t.resource.id)||N(t.resource.id)?__("Video optimization in progress","web-stories"):__("Optimize","web-stories")},e.createElement(y,null)))))})},VideoOptimization=()=>{const{isTranscodingEnabled:t}=l();return t?e.createElement(BulkVideoOptimization,null):null};export{VideoOptimization as default,z as videoElementsNotOptimized};
