/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import r from"react";import"prop-types";import{useState as e,useMemo as t,useCallback as o}from"@googleforcreators/react";import{useGlobalIsKeyPressed as s}from"@googleforcreators/design-system";import{useTransform as i}from"@googleforcreators/transform";import{MEDIA_ELEMENT_TYPES as n,ELEMENT_TYPES as l,getDefinitionForType as a}from"@googleforcreators/elements";import"../../constants/fonts.js";import"../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"../../app/story/context.js";import"@googleforcreators/migration";import"@googleforcreators/templates";import"../../app/config/context.js";import"../../app/api/context.js";import"../../app/history/historyProvider.js";import"../../app/history/context.js";import"../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../app/story/storyTriggers/storyTriggersProvider.js";import"../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import p from"../../app/story/useStory.js";import c from"../canvas/utils/getElementProperties.js";import{noop as m}from"../../utils/noop.js";import g from"./context.js";const u=n,d=n.concat(l.SHAPE),f=r=>u.includes(r),y=r=>d.includes(r);function DropTargetsProvider(n){let{children:l}=n;const[u,d]=e(null),[v,T]=e({}),[j,h]=e(null),{actions:{pushTransform:D}}=i(),{currentPage:P,combineElements:E}=p((r=>{let{state:{currentPage:e},actions:{combineElements:t}}=r;return{currentPage:e,combineElements:t}})),S=t((()=>P?.elements||[]),[P?.elements]),b=t((()=>S.filter((r=>{let{id:e}=r;return e in v})).map((r=>{let{id:e}=r;return e})).reverse()),[v,S]),x=o((function(r,e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const o=document.elementsFromPoint(r,e);return b.find((r=>o.includes(v[r])&&r!==t))||null}),[b,v]),R=o(((r,e)=>{T((t=>({...t,[r]:e})))}),[]),A=o((r=>{T((e=>{const{[r]:t,...o}=e;return o}))}),[]),I=o((function(r,e,t){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!f(r?.type))return;const s=c(r.type,{resource:r}),i=S.find((r=>{let{id:e}=r;return e===o})),n=i?.scale??s.scale,l=i?.focalX??s.focalX,a=i?.focalY??s.focalY,p=i?.flip??s.flip,m=x(e,t,o);m&&m!==j?(D(m,{dropTargets:{active:!0,replacement:{resource:r,scale:n,focalX:l,focalY:a,flip:p}}}),o&&D(o,{dropTargets:{hover:!0}})):m||o&&D(o,{dropTargets:{hover:!1}}),h(m),S.filter((r=>{let{id:e}=r;return e!==m})).forEach((r=>D(r.id,{dropTargets:{active:!1,replacement:null}})))}),[j,S,x,D]),X=o((function(r){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!f(r?.type))return;if(!j||j===e)return void Object.keys(v).filter((r=>r!==e)).map((r=>D(r,null)));const t={secondId:j},o=S.find((r=>{let{id:t}=r;return t===e}));t.firstElement=o||c(r.type,{resource:r}),E(t),S.filter((r=>{let{id:t}=r;return v[t]&&t!==e})).forEach((r=>{D(r.id,{dropTargets:{active:!1,replacement:null}}),D(r.id,null)})),h(null);const{onDropHandler:s}=a(r.type);s&&r.src&&!r.isPlaceholder&&s(j)}),[j,E,S,v,D]),Y=s("mod"),k={state:{dropTargets:v,activeDropTargetId:j,draggingResource:u,isDropTargetingDisabled:Y},actions:{registerDropTarget:Y?m:R,unregisterDropTarget:A,isDropSource:Y?()=>!1:f,isDropTarget:Y?()=>!1:y,handleDrag:Y?m:I,handleDrop:Y?m:X,setDraggingResource:Y?m:d}};return r.createElement(g.Provider,{value:k},l)}export{DropTargetsProvider as default};
