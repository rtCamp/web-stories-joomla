/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{themeHelpers as t,BaseInput as r,List as o,noop as n}from"@googleforcreators/design-system";import{useReducer as a,useState as l,useRef as s,useEffect as i,useMemo as p,useCallback as u}from"@googleforcreators/react";import"prop-types";import c,{css as d}from"styled-components";import{v4 as m}from"uuid";import f,{ACTIONS as g}from"./reducer.js";import y from"./tag.js";function h(){return h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},h.apply(this,arguments)}const E=m(),x=c.div.withConfig({displayName:"input__Border",componentId:"sc-1nuo5lh-0"})([""," display:flex;flex-direction:column;margin-bottom:6px;"],(e=>{let{theme:r,isInputFocused:o}=e;return d(["color:",";border:1px solid ",";border-radius:",";",";"],r.colors.fg.primary,r.colors.border.defaultNormal,r.borders.radius.small,o&&t.focusCSS)})),w=c.div.withConfig({displayName:"input__InputWrapper",componentId:"sc-1nuo5lh-1"})(["display:flex;flex-wrap:wrap;padding:0;"]),b=c(r).attrs({type:"text"}).withConfig({displayName:"input__TextInput",componentId:"sc-1nuo5lh-2"})(["width:auto;flex-grow:1;height:32px;margin:2px 0;padding-left:4px;"]),T=c(o).withConfig({displayName:"input__SuggestionList",componentId:"sc-1nuo5lh-3"})(["max-height:120px;overflow-y:scroll;border-top:",";display:block;list-style-type:none;width:100%;padding:6px 4px 4px;margin-top:6px;li{cursor:pointer;padding:4px;width:100%;"," border-radius:",";&:hover{background-color:",";}}"],(e=>{let{theme:t}=e;return`1px solid ${t.colors.border.defaultNormal}`}),t.focusableOutlineCSS(),(e=>{let{theme:t}=e;return t.borders.radius.small}),(e=>{let{theme:t}=e;return t.colors.bg.tertiary}));function Input(t){let{suggestedTerms:r=[],onTagsChange:o,onInputChange:c,suggestedTermsLabel:d,tagDisplayTransformer:_,tokens:k=[],onUndo:C=n,...v}=t;const[{value:I,tags:A,offset:D,tagBuffer:S},F]=a(f,{value:"",tags:[...k],tagBuffer:null,offset:0}),[B,N]=l(!1),[O,U]=l(!1),L=s(),M=s(),R=s();i((()=>{F({type:g.UPDATE_TAGS,payload:k})}),[k]);const K=m(),V=r.length;i((()=>{U(V>0)}),[V]);const j=s(o);j.current=o,i((()=>{S&&j.current?.(S)}),[S]);const G=s(c);G.current=c,i((()=>{G.current?.(I)}),[I]);const{handleFocus:P,handleBlur:z,handleKeyDown:W,handleChange:$,removeTag:q}=p((()=>({handleKeyDown:e=>{""===e.target.value&&("ArrowLeft"===e.key&&F({type:g.INCREMENT_OFFSET}),"ArrowRight"===e.key&&F({type:g.DECREMENT_OFFSET}),"Backspace"===e.key&&F({type:g.REMOVE_TAG}),"z"===e.key&&e.metaKey&&C(e)),"ArrowDown"===e.key&&r.length>0&&M?.current?.firstChild?.focus(),["Comma",",","Enter"].includes(e.key)&&F({type:g.SUBMIT_VALUE})},handleChange:e=>{F({type:g.UPDATE_VALUE,payload:e.target.value})},removeTag:e=>()=>{F({type:g.REMOVE_TAG,payload:e}),L?.current.focus()},handleFocus:()=>{N(!0)},handleBlur:()=>{F({type:g.RESET_OFFSET}),N(!1)}})),[C,r]),H=S||A,J=u(((e,t)=>{e.preventDefault(),U(!1),F({type:g.SUBMIT_VALUE,payload:t}),L?.current.focus()}),[]),Q=u(((e,t,r)=>{const o=t+1,n=t-1;"ArrowDown"===e.key&&o<V&&M?.current?.children?.[o]?.focus(),"ArrowUp"===e.key&&(n<0?L?.current.focus():M?.current?.children?.[n]?.focus()),"Enter"===e.key&&J(e,r)}),[J,V]);return e.createElement(x,{ref:R,isInputFocused:B},e.createElement(w,null,[...H.slice(0,H.length-D),E,...H.slice(H.length-D)].map((t=>t===E?e.createElement(b,h({},v,{key:E,value:I,onKeyDown:W,onChange:$,onFocus:P,onBlur:z,size:"4",ref:L,autoComplete:O?"off":"on","aria-expanded":O,"aria-autocomplete":"list","aria-owns":O?K:null,role:"combobox"})):e.createElement(y,{key:t,onDismiss:q(t)},_(t)||t)))),O&&e.createElement(T,{"aria-label":d,role:"listbox",ref:M,id:K,"data-testid":"suggested_terms_list"},r.map(((t,r)=>{let{name:o,id:n}=t;return e.createElement("li",{key:n,"aria-selected":I===o,role:"option",tabIndex:0,onClick:e=>J(e,o),onKeyDown:e=>Q(e,r,o)},o)}))))}export{Input as default};
