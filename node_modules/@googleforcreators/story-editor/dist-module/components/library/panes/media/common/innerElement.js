/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import r,{css as t}from"styled-components";import{memo as o,useRef as i,useEffect as a}from"@googleforcreators/react";import"prop-types";import{getSmallestUrlForWidth as n,resourceList as s}from"@googleforcreators/media";import{Text as p,THEME_CONSTANTS as l,Icons as c,noop as m}from"@googleforcreators/design-system";import d from"../../shared/libraryMoveable.js";import"../../../../dropTargets/provider.js";import g from"../../../../dropTargets/useDropTargets.js";import"@googleforcreators/tracking";import"@googleforcreators/templates";import"../../../../../app/config/context.js";import"../../../../../app/api/context.js";import"../../../../../constants/fonts.js";import"../../../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../../app/history/historyProvider.js";import"../../../../../app/history/context.js";import"../../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"@googleforcreators/i18n";import"../../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../../utils/generateBlurhash.worker.js";import"../../../../../app/media/media3p/providerConfiguration.js";import"../../../../../app/media/utils/useFFmpeg.js";import"../../../../../app/media/media3p/api/context.js";import"../../../../../app/media/local/constants.js";import"../../../../../app/media/media3p/providerReducer.js";import"../../../../../app/media/context.js";import{ContentType as u}from"../../../../../app/media/media3p/constants.js";import y from"../../shared/insertionOverlay.js";function h(){return h=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},h.apply(this,arguments)}const f=t(["width:100%;cursor:pointer;transition:0.2s transform,0.15s opacity;border-radius:4px;opacity:0;"]),E=r.img.withConfig({displayName:"innerElement__Image",componentId:"sc-qkk7ov-0"})(["",""],f),j=r.video.withConfig({displayName:"innerElement__Video",componentId:"sc-qkk7ov-1"})([""," object-fit:cover;",""],f,(e=>{let{showWithoutDelay:r}=e;return r?"opacity: 1;":""})),v=r.div.withConfig({displayName:"innerElement__DurationWrapper",componentId:"sc-qkk7ov-2"})(["position:absolute;bottom:8px;left:8px;background:",";border-radius:100px;height:18px;padding:0 6px;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64})),k=r.div.withConfig({displayName:"innerElement__MuteWrapper",componentId:"sc-qkk7ov-3"})(["position:absolute;bottom:8px;right:8px;height:24px;width:24px;background:",";color:",";border-radius:100px;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64}),(e=>{let{theme:r}=e;return r.colors.fg.primary})),I=r(p).attrs({forwardedAs:"span",size:l.TYPOGRAPHY.PRESET_SIZES.X_SMALL}).withConfig({displayName:"innerElement__Duration",componentId:"sc-qkk7ov-4"})(["color:",";display:block;"],(e=>{let{theme:r}=e;return r.colors.fg.primary})),D=r.img.withConfig({displayName:"innerElement__CloneImg",componentId:"sc-qkk7ov-5"})(["opacity:0;width:",";height:",";position:absolute;"],(e=>{let{width:r}=e;return`${r}px`}),(e=>{let{height:r}=e;return`${r}px`}));var b=o((function InnerElement(r){let{type:t,src:o,resource:p,alt:l,width:f,height:b,onClick:w,onLoad:T=m,showVideoDetail:x,mediaElement:_,active:O,isMuted:C}=r;const R=i(null),P=i(null),{handleDrag:F,handleDrop:M}=g((e=>{let{state:r,actions:t}=e;return{handleDrag:t.handleDrag,handleDrop:t.handleDrop,dropTargets:r.dropTargets,activeDropTargetId:r.activeDropTargetId}}),((e,r)=>{if(P.current)return!1;if(null===P.current)return P.current=!1,!1;if(e?.dropTargets&&r?.dropTargets){const t=Object.keys(e.dropTargets),o=Object.keys(r.dropTargets);if(t.join()!==o.join())return!1}return e?.activeDropTargetId===r?.activeDropTargetId})),{setDraggingResource:S}=g((e=>{let{actions:{setDraggingResource:r}}=e;return{setDraggingResource:r}}));let A;a((()=>{p.poster&&(R.current=p.poster)}),[p.poster]);const{lengthFormatted:q,poster:G,mimeType:N}=p,V=G??R.current,L=V||n(f,p),W={width:f,height:b,alt:l,crossOrigin:"anonymous"},Y={...W,onLoad:()=>{_.current&&(_.current.style.opacity=1),T()},loading:"lazy",decoding:"async",draggable:!1},z={...Y,onLoad:void 0},X={...Y,src:L},$={...W,title:l,alt:null,loop:t===u.GIF,muted:!0,preload:"metadata",poster:V,showWithoutDelay:O};if(t===u.IMAGE?(A=e.createElement(E,h({key:o},X,{ref:_})),z.src=L):[u.VIDEO,u.GIF].includes(t)&&(A=e.createElement(e.Fragment,null,G&&!O?e.createElement(E,h({key:o},X,{ref:_})):e.createElement(j,h({key:o},$,{ref:_}),t===u.GIF?p.output.src&&e.createElement("source",{src:p.output.src,type:p.output.mimeType}):e.createElement("source",{src:n(f,p),type:N})),t===u.VIDEO&&x&&q&&e.createElement(v,null,e.createElement(I,null,q)),t===u.VIDEO&&x&&C&&e.createElement(k,null,e.createElement(c.Muted,null))),z.src=G),!A)throw new Error("Invalid media element type.");const B=t===u.IMAGE?L:G;return e.createElement(e.Fragment,null,A,O&&e.createElement(y,{showIcon:!1}),e.createElement(d,{active:O,handleDrag:e=>{P.current||(s.set(p.id,{url:L,type:"cached"}),S(p),P.current=!0),F(p,e.clientX,e.clientY)},handleDragEnd:()=>{M(p),P.current=!1},type:p.type,elementProps:{resource:p},onClick:w(B),cloneElement:D,cloneProps:z}))}));export{b as default};
