/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import r from"styled-components";import"prop-types";import{memo as t,useRef as o,useState as i,useCallback as n,useEffect as s}from"@googleforcreators/react";import{rgba as a}from"polished";import{__}from"@googleforcreators/i18n";import{LoadingBar as p}from"@googleforcreators/design-system";import{Blurhash as m}from"react-blurhash";import l from"../local/dropDownMenu.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"@googleforcreators/templates";import"../../../../../app/config/context.js";import"../../../../../app/api/context.js";import"../../../../../constants/fonts.js";import"../../../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../../app/history/historyProvider.js";import"../../../../../app/history/context.js";import"../../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../../utils/generateBlurhash.worker.js";import"../../../../../app/media/media3p/providerConfiguration.js";import"../../../../../app/media/utils/useFFmpeg.js";import"../../../../../app/media/media3p/api/context.js";import"../../../../../app/media/local/constants.js";import"../../../../../app/media/media3p/providerReducer.js";import"../../../../../app/media/context.js";import c from"../../../../../app/media/local/useLocalMedia.js";import{ContentType as d}from"../../../../../app/media/media3p/constants.js";import u from"../../../../tooltip/tooltip.js";import g from"./attribution.js";import h from"./innerElement.js";import f from"./insertionMenu.js";const y=r.div.attrs((e=>({style:{width:e.width+"px",height:e.height+"px",margin:e.margin,backgroundColor:"transparent",color:"inherit",border:"none",padding:0}}))).withConfig({displayName:"mediaElement__Container",componentId:"sc-n7038j-0"})([""]),E=r.div.withConfig({displayName:"mediaElement__InnerContainer",componentId:"sc-n7038j-1"})(["position:relative;display:flex;margin-bottom:10px;background-color:",";"],(e=>{let{theme:r,$baseColor:t}=e;return t||a(r.colors.standard.black,.3)})),j=r(m).withConfig({displayName:"mediaElement__BlurhashContainer",componentId:"sc-n7038j-2"})(["position:absolute !important;top:0;left:0;"]);function Element(r){let{index:t,resource:a,width:m,height:u,margin:C,onInsert:b,providerType:v,canEditMedia:R}=r;const{id:w,src:M,type:P,width:x,height:I,alt:T,isMuted:U,baseColor:k,blurHash:N}=a,{isCurrentResourceProcessing:_,isCurrentResourceUploading:S}=c((e=>{let{state:r}=e;return{isCurrentResourceProcessing:r.isCurrentResourceProcessing,isCurrentResourceUploading:r.isCurrentResourceUploading}})),A=x&&I?x/I:1,F=m||u/A,L=u||F/A,B=o(),[D,O]=i(!0),[V,$]=i(!1),[G,H]=i(!1),[q,z]=i(!1),J=n((()=>$(!0)),[]),K=n((()=>$(!1)),[]),Q=n((()=>H(!0)),[]),W=n((()=>H(!1)),[]),X=n((()=>{H(!1),$(!1)}),[]),[Y,Z]=i(null),ee=o(V);ee.current=V,s((()=>{if(![d.VIDEO,d.GIF].includes(P))return;const e=()=>{null!==Y&&(clearTimeout(Y),Z(null))};if(!G)if(V){if(O(!1),B.current&&null==Y){const e=setTimeout((()=>{ee.current&&M&&B.current.play().catch((()=>{}))}),600);Z(e)}}else O(!0),e(),B.current&&B.current?.pause&&M&&(B.current.pause(),B.current.currentTime=0);return e}),[G,V,P,M,Y,Z,ee]);const re=n((e=>()=>{b(a,e)}),[b,a]),te=V&&a.attribution?.author?.displayName&&a.attribution?.author?.url&&e.createElement(g,{author:a.attribution.author.displayName,url:a.attribution.author.url}),oe=o(),ie=n((()=>z(!0)),[]),ne=!q&&!V;return e.createElement(y,{ref:oe,"data-testid":`mediaElement-${P}`,"data-id":w,className:"mediaElement",width:F,height:L,margin:C,onPointerEnter:J,onFocus:J,onPointerLeave:K,onBlur:K,tabIndex:"-1"},e.createElement(E,{$baseColor:ne&&k},e.createElement(h,{type:P,src:M,mediaElement:B,resource:a,alt:T,isMuted:U,width:F,height:L,onClick:re,onLoad:ie,showVideoDetail:D,active:V}),te,ne&&N&&e.createElement(j,{hash:N,width:F,height:L,punch:1}),(!M||_(w)||S(w))&&e.createElement(p,{loadingMessage:__("Uploading media…","web-stories")}),e.createElement(f,{resource:a,display:V,onInsert:b,width:F,index:t,isLocal:"local"===v,setParentActive:J,setParentInactive:K}),"local"===v&&R&&e.createElement(l,{resource:a,display:V,isMenuOpen:G,onMenuOpen:Q,onMenuCancelled:W,onMenuSelected:X,setParentActive:J})))}function MediaElement(r){const{isCurrentResourceProcessing:t,isCurrentResourceUploading:o}=c((e=>{let{state:r}=e;return{isCurrentResourceProcessing:r.isCurrentResourceProcessing,isCurrentResourceUploading:r.isCurrentResourceUploading}})),{id:i}=r.resource;return t(i)||o(i)?e.createElement(u,{title:__("Uploading media…","web-stories")},e.createElement(Element,r)):e.createElement(Element,r)}MediaElement.defaultProps={providerType:"local",canEditMedia:!1};var C=t(MediaElement);export{C as default};
