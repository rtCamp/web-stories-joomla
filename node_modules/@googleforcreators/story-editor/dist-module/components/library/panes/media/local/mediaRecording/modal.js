/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{__}from"@googleforcreators/i18n";import{Text as r,THEME_CONSTANTS as o,Toggle as t,Button as a,BUTTON_TYPES as i,BUTTON_SIZES as n}from"@googleforcreators/design-system";import{useRef as l,useState as s,useCallback as m,useEffect as c,useMemo as d}from"@googleforcreators/react";import p from"styled-components";import"prop-types";import g from"@wmik/use-media-recorder";import{blobToFile as u}from"@googleforcreators/media";import{v4 as b}from"uuid";import f from"../../../../../dialog/dialog.js";import E from"../../../../../canvas/useUploadWithPreview.js";import{ImageCapture as h}from"./imageCapture.js";const w=p.video.withConfig({displayName:"modal__Video",componentId:"sc-mu21h6-0"})(["width:100%;height:100%;"]),y=p.div.withConfig({displayName:"modal__VideoWrapper",componentId:"sc-mu21h6-1"})(["width:240px;aspect-ratio:9 / 16;background:#000;margin:0 auto;"]);function Modal(p){let{isOpen:S,onClose:R}=p;const C=l(),[P,v]=s(null),[M,L]=s(!1),[O,_]=s(!0),[j,A]=s(!0),I=m((e=>{const r=u(e,"test-recording.webm","video/webm");v(r)}),[]),T=E(),{error:k,status:Y,mediaBlob:x,stopRecording:$,startRecording:z,liveStream:F,clearMediaStream:U,clearMediaBlob:B}=g({recordScreen:!1,blobOptions:{type:"video/webm"},mediaStreamConstraints:{audio:j,video:O},onStop:I}),G=m((()=>{U(),B(),R(),C.current&&(C.current.srcObject=null),L(!1)}),[B,U,R]),H=m((()=>{T([P]),R(),"recording"===Y&&($(),L(!1),v(null))}),[P,T,R,Y,$]);c((()=>{C.current&&F&&(C.current.srcObject=F)}),[F]);const N="recording"===Y,V=d((()=>`toggle_${b()}`),[]),W=d((()=>`toggle_${b()}`),[]),Z=__("Insert","web-stories");return e.createElement(f,{onClose:G,isOpen:S,title:__("Record video / audio","web-stories"),onPrimary:H,primaryText:Z,secondaryText:__("Cancel","web-stories"),primaryRest:{disabled:"stopped"!==Y&&!1===M}},e.createElement(r,null,__("Record content for your story using your camera / microphone.","web-stories")),e.createElement(r,null,k?`${Y} ${k.message}`:Y),!M&&e.createElement(y,null,x&&!F&&e.createElement(e.Fragment,null,e.createElement(w,{src:URL.createObjectURL(x),autoPlay:!0,controls:!0})),!x&&F&&e.createElement(w,{ref:C,autoPlay:!0})),N&&e.createElement(h,{videoRef:C,onCapture:e=>{v(e),L(!0)},onClear:M?()=>L(!1):null}),e.createElement(r,{as:"label",htmlFor:V,size:o.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Camera","web-stories")),e.createElement(t,{id:V,"aria-label":__("Enable camera","web-stories"),name:V,checked:O,onChange:()=>_((e=>!e))}),e.createElement(r,{as:"label",htmlFor:W,size:o.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Microphone","web-stories")),e.createElement(t,{id:W,"aria-label":__("Enable microphone","web-stories"),name:W,checked:j,onChange:()=>A((e=>!e))}),e.createElement(a,{type:i.PRIMARY,size:n.SMALL,onClick:N?$:z,disabled:!1},__(N?"Stop recording":"Start recording","web-stories")))}export{Modal as default};
