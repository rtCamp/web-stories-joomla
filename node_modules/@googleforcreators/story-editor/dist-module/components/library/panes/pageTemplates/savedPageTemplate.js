/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{themeHelpers as t,useKeyDownEffect as a,Icons as r}from"@googleforcreators/design-system";import{__}from"@googleforcreators/i18n";import{forwardRef as o,useState as i,useFocusOut as p,useCallback as l,useEffect as s,useRef as m}from"@googleforcreators/react";import"prop-types";import n from"styled-components";import{generatePatternStyles as g}from"@googleforcreators/patterns";import{fetchRemoteBlob as d,blobToFile as c}from"@googleforcreators/media";import{trackError as h}from"@googleforcreators/tracking";import"@googleforcreators/templates";import"../../../../app/config/context.js";import u from"../../../../app/config/useConfig.js";import"../../../../app/api/context.js";import f from"../../../../app/api/useAPI.js";import v from"../../../../app/pageDataUrls/usePageDataUrls.js";import"@googleforcreators/units";import"../../../../utils/storyPageToNode.js";import"../../../../app/pageDataUrls/context.js";import P from"../../../../app/uploader/useUploader.js";import{PageSizePropType as w}from"../../../../types.js";import{focusStyle as y}from"../../../panels/shared/styles.js";import S from"../../../canvas/displayElement.js";import T from"../shared/insertionOverlay.js";import b from"../../../canvas/useFocusCanvas.js";import{ActionButton as j}from"../shared/index.js";import I from"../../../../utils/useRovingTabIndex/index.js";import x from"../../useLibrary.js";const _=n.img.withConfig({displayName:"savedPageTemplate__TemplateImage",componentId:"sc-5hfe38-0"})(["width:100%;height:auto;"]),C=n.div.withConfig({displayName:"savedPageTemplate__PageTemplateWrapper",componentId:"sc-5hfe38-1"})(["height:","px;width:","px;cursor:pointer;",";",";"],(e=>{let{pageSize:t}=e;return t.height}),(e=>{let{pageSize:t}=e;return t.width}),(e=>{let{isHighlighted:a}=e;return a&&t.focusCSS}),y);C.propTypes={pageSize:w.isRequired};const E=n.div.withConfig({displayName:"savedPageTemplate__PreviewPageWrapper",componentId:"sc-5hfe38-2"})(["position:relative;height:","px;width:","px;background-color:",";border-radius:",";overflow:hidden;",""],(e=>{let{pageSize:t}=e;return t.height}),(e=>{let{pageSize:t}=e;return t.width}),(e=>{let{theme:t}=e;return t.colors.interactiveBg.secondary}),(e=>{let{theme:t}=e;return t.borders.radius.small}),(e=>{let{background:t}=e;return g(t)}));E.propTypes={pageSize:w.isRequired};const k=n(j).withConfig({displayName:"savedPageTemplate__DeleteButton",componentId:"sc-5hfe38-3"})(["top:4px;right:4px;"]);function SavedPageTemplate(t,o){let{page:n,pageSize:g,handleDelete:w,index:y,...z}=t;const{capabilities:{hasUploadMediaAction:U}}=u(),{actions:{updatePageTemplate:D}}=f(),{actions:{uploadFile:N}}=P(),{updateSavedTemplate:F}=x((e=>({updateSavedTemplate:e.actions.updateSavedTemplate}))),q=v((e=>{let{actions:t}=e;return t.queuePageImageGeneration})),B=v((e=>{let{state:{dataUrls:t}}=e;return t[n.id]})),[R,$]=i(!1);p(o,(()=>$(!1)),[]);const{highlightedTemplate:A,onClick:H}=z,L=l((()=>$(!0)),[]),M=l((()=>{$(!1)}),[]),W=n.image?.url||B,G=U&&B&&!n.image?.url;s((()=>{G&&(async()=>{try{const e=await d(B),t=c(e,`web-stories-page-template-${n.templateId}.jpg`,"image/jpeg"),a=await N(t,{templateId:n.templateId,mediaSource:"page-template"});D(n.templateId,{featured_media:a.id}),F({templateId:n.templateId,image:{id:a.id,height:a.height,width:a.width,url:a.src}})}catch(e){h("upload_generated_page_template_image",e?.message)}})()}),[B,N,D,n.templateId,G,F]),s((()=>{!W&&U&&q(n)}),[W,q,n,U]);const O=m(),J=m();I({ref:O},[],2),I({ref:J},[],2);const K=b();return a(J,"tab",K,[K]),e.createElement(C,{pageSize:g,role:"listitem",ref:o,onPointerEnter:L,onPointerLeave:M,"aria-label":n.title,isHighlighted:n.id===A,onFocus:L,onBlur:M,onClick:H},e.createElement(E,{pageSize:g,background:n.backgroundColor},W?e.createElement(_,{alt:n.image?.alt||__("Saved Page Template","web-stories"),src:W,height:n.image?.height,width:n.image?.height,draggable:!1}):n.elements.map((t=>e.createElement(S,{key:t.id,previewMode:!0,element:t}))),R&&e.createElement(T,{showIcon:!1}),e.createElement(j,{ref:O,onClick:e=>{e.stopPropagation(),H(e)},"aria-label":__("Use template","web-stories"),$display:R,tabIndex:0===y?0:-1},e.createElement(r.PlusFilledSmall,null)),e.createElement(k,{ref:J,$display:R,onClick:e=>{e.stopPropagation(),w(n,e)},"aria-label":__("Delete Page Template","web-stories"),tabIndex:R?0:-1},e.createElement(r.TrashFilledSmall,null))))}const z=o(SavedPageTemplate);SavedPageTemplate.displayName="SavedPageTemplate";export{z as default};
