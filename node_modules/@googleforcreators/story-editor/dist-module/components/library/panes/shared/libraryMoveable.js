/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"react";import"prop-types";import{useState as e,useRef as r,useCallback as o}from"@googleforcreators/react";import n from"styled-components";import{editorToDataX as s,editorToDataY as a}from"@googleforcreators/units";import{useKeyDownEffect as i}from"@googleforcreators/design-system";import{InOverlay as p,Moveable as l,areEventsDragging as c}from"@googleforcreators/moveable";import{useTransform as m}from"@googleforcreators/transform";import{ZOOM_SETTING as g}from"../../../../constants/index.js";import"../../../dropTargets/provider.js";import u from"../../../dropTargets/useDropTargets.js";import f from"../../../../app/layout/useLayout.js";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import d from"../../../canvas/useInsertElement.js";import"../../../canvas/canvasLayout.js";import h from"../../../canvas/useInsertTextSet.js";import y from"../../../../utils/isTargetOutOfContainer.js";import j from"../../../canvas/utils/useSnapping.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import v from"../../../../utils/objectWithout.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import x from"../../../../app/story/useStory.js";import"@googleforcreators/i18n";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import{noop as T}from"../../../../utils/noop.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"@googleforcreators/rich-text";import"../text/textPresets.js";import"../../../../app/canvas/context.js";import b from"../../../../app/canvas/useCanvas.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import E from"../../../../utils/usePerformanceTracking.js";import{TRACKING_EVENTS as C}from"../../../../constants/performanceTrackingEvents.js";function S(){return S=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},S.apply(this,arguments)}const w=n.div.withConfig({displayName:"libraryMoveable__TargetBox",componentId:"sc-jgbz52-0"})(["position:absolute;width:100%;height:100%;top:0;z-index:1;cursor:pointer;"]);function LibraryMoveable(n){let{type:D,elementProps:I={},handleDrag:P,handleDragEnd:R,onClick:O=T,cloneElement:$,cloneProps:k,elements:B=[],active:X=!1}=n;const L=$,[M,F]=e(!1),[N,Y]=e(!1),[Z,z]=e(!1),_=r(null),A=r(null),U=r(null),W=r(null),H=r(null),q=f((t=>{let{state:{pageWidth:e,pageHeight:r}}=t;return{width:e,height:r}})),{setZoomSetting:G}=f((t=>{let{actions:{setZoomSetting:e}}=t;return{setZoomSetting:e}})),J=d(),{backgroundElement:K}=x((t=>({backgroundElement:t.state.currentPage?.elements?.[0]??{}}))),{fullbleedContainer:Q,nodesById:V,pageContainer:tt}=b((t=>({fullbleedContainer:t.state.fullbleedContainer,pageContainer:t.state.pageContainer,nodesById:t.state.nodesById}))),{activeDropTargetId:et,setDraggingResource:rt}=u((t=>{let{state:{activeDropTargetId:e},actions:{setDraggingResource:r}}=t;return{activeDropTargetId:e,setDraggingResource:r}})),{clearTransforms:ot,pushTransform:nt}=m((t=>({clearTransforms:t.actions.clearTransforms,pushTransform:t.actions.pushTransform}))),st={translate:[0,0]},{insertTextSetByOffset:at}=h(),it=r({}),pt=o((()=>{A.current.style.transform=null,_.current.style.transform=null,_.current.style.opacity=0,F(!1),ot(),rt(null)}),[rt,ot]);i(M?document.body:{current:null},"esc",(()=>{Y(!0),pt()}),[M,pt]);const lt=o((()=>{let t=0,e=0;for(let r=W.current;r;r=r.offsetParent)t+=r.offsetLeft,e+=r.offsetTop;return{offsetX:t,offsetY:e}}),[W]);E({node:A.current,eventData:{...C.INSERT_ELEMENT,label:D},eventType:"pointerdown"});const{offsetX:ct}=lt(),mt=j({isDragging:!0,canSnap:!0,otherNodes:Object.values(v(V,[K.id])),snappingOffsetX:ct});return t.createElement(t.Fragment,null,t.createElement(w,{ref:A,onPointerOver:()=>z(!0),onPointerOut:()=>z(!1)}),(M||X||Z)&&t.createElement(t.Fragment,null,t.createElement(p,{ref:W,zIndex:1,pointerEvents:"none",render:()=>t.createElement(L,S({ref:_},k))}),t.createElement(l,S({ref:H,className:"default-moveable hide-handles",target:A.current,edge:!0,draggable:!0,origin:!1,pinchable:!0,onDragStart:t=>{let{set:e,inputEvent:r}=t;r.stopPropagation(),Y(!1),e(st.translate),F(!0),(t=>{const{timeStamp:e,clientX:r,clientY:o}=t;it.current={timeStamp:e,clientX:r,clientY:o}})(r),G(g.FIT);const{offsetX:o,offsetY:n}=lt(),s=A.current.getBoundingClientRect();U.current={width:s.width,height:s.height},A.current.style.width=`${k.width}px`,A.current.style.height=`${k.height}px`;const a=s.left-o,i=s.top-n;_.current.style.left=`${a}px`,_.current.style.top=`${i}px`,H.current&&H.current.updateRect()},onDrag:t=>{let{beforeTranslate:e,inputEvent:r}=t;if(nt(null,{drag:e}),N)return!1;st.translate=e,_.current&&c(it.current,r)&&(1===_.current.style.opacity||et?et&&(_.current.style.opacity=0):_.current.style.opacity=1,_.current.style.transform=`translate(${e[0]}px, ${e[1]}px)`,A.current.style.transform=`translate(${e[0]}px, ${e[1]}px)`),P?.(r)},onDragEnd:t=>{let{inputEvent:e}=t;if(N)return!1;if(A.current.style.width=`${U.current.width}px`,A.current.style.height=`${U.current.height}px`,!c(it.current,e))return pt(),O(),!1;if(et&&R)R();else if(!y(_.current,Q)){const{x:t,y:e,width:r,height:o}=_.current.getBoundingClientRect(),{x:n,y:i}=tt.getBoundingClientRect();"textSet"===D?at(B,{offsetX:s(t-n,q.width),offsetY:a(e-i,q.height)}):J(D,{...I,x:s(t-n,q.width),y:a(e-i,q.height),width:s(r,q.width),height:a(o,q.height)})}pt()}},mt))))}export{LibraryMoveable as default};
