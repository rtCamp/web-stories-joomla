/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import{useState as o,useRef as t,useEffect as r,useCallback as e}from"@googleforcreators/react";import{dataFontEm as s,PAGE_HEIGHT as i}from"@googleforcreators/units";import{getHTMLFormatters as p}from"@googleforcreators/rich-text";import{BACKGROUND_TEXT_MODE as n}from"@googleforcreators/elements";import{calculateTextHeight as a}from"@googleforcreators/element-library";import m from"../../../../utils/getInsertedElementSize.js";import l from"../../useLibrary.js";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import c from"../../../../app/history/useHistory.js";import"react";import"prop-types";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../constants/fonts.js";import"../../../../constants/multipleValue.js";import"../../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"@googleforcreators/i18n";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../utils/generateBlurhash.worker.js";import"@googleforcreators/design-system";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/stickers";import"./textPresets.js";import"../../../../app/canvas/context.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import"../../../../utils/storyPageToNode.js";import"@ap.cx/hues";import"../../../../app/pageCanvas/context.js";import"../../../../app/pageCanvas/pageCanvasCacheValidator.js";import g from"../../../../app/pageCanvas/useCalculateAccessibleTextColors.js";import{applyHiddenPadding as u}from"../../../panels/design/textStyle/utils.js";const d=s(1);function f(s){let{shouldUseSmartColor:f}=s;const{insertElement:j}=l((o=>({insertElement:o.actions.insertElement}))),{state:{versionNumber:y}}=c(),h=p(),{setColor:x}=h,[v,C]=o(null),[b,T]=o(null),k=t(null),P=g();r((()=>{k.current?.element&&!k.current.versionNumber?k.current.versionNumber=y:k.current?.versionNumber&&(k.current=null)}),[y]);const S=e((o=>{const{y:t}=o;if(!k.current)return t;const{element:{height:r,y:e}}=k.current;let s=e+r+d;const{width:p,height:n}=m("text",o.width,o.height,{...o,y:s});return s+n>=i&&(s=t),{width:p,height:n,y:s}}),[]);r((()=>{if(v&&b){const{content:o}=b,{color:t,backgroundColor:r}=v,e=r?{backgroundColor:{color:r},backgroundTextMode:n.HIGHLIGHT,padding:u(b)}:null,s={...b,content:t?x(o,{color:t}):o,...e},i=j("text",{...s,height:a(s,s.width)});k.current={versionNumber:null,element:i},C(null),T(null)}}),[v,b,j,x]);const E=e((async function(o){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{isPositioned:r,accessibleColors:e}=t,s=r?{}:S(o);if(f){if(T({...o,...s}),e)return void C(e);C(await P({...o,...s}))}else{const t=j("text",{...o,...s});k.current={versionNumber:null,element:t}}}),[S,P,f,j]);return{getPosition:S,insertPreset:E}}export{f as default};
