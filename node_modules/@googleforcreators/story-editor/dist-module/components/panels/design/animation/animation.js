/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import t from"styled-components";import o from"react";import{useRef as e,useMemo as r,useCallback as i,shallowEqual as s,useDebouncedCallback as p,useEffect as a}from"@googleforcreators/react";import"prop-types";import{v4 as n}from"uuid";import{__}from"@googleforcreators/i18n";import{getAnimationEffectDefaults as m,STORY_ANIMATION_STATE as l,hasOffsets as c,BG_MIN_SCALE as g,BG_MAX_SCALE as d,BACKGROUND_ANIMATION_EFFECTS as f,DIRECTION as u,SCALE_DIRECTION as h}from"@googleforcreators/animation";import{progress as j}from"@googleforcreators/units";import"../../../../types.js";import"../../../form/color/color.js";import"../../../form/filterToggle/filterToggle.js";import"../../../form/linkIcon.js";import"../../../form/link.js";import"../../../form/media.js";import"@googleforcreators/design-system";import"@googleforcreators/media";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../constants/fonts.js";import"../../../../constants/multipleValue.js";import"../../../../app/font/context.js";import"@googleforcreators/tracking";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import T from"../../../form/row.js";import"../../../form/switch.js";import"../../../form/textArea.js";import"../../../form/context.js";import"../../../form/dateTime/dateTime.js";import"../../../form/required.js";import"../../../form/radioGroup/index.js";import"../../../form/select/select.js";import"../../../form/hierarchical/index.js";import"../../panel/panel.js";import"../../panel/context.js";import"../../panel/shared/title.js";import"../../panel/shared/content.js";import y from"../../panel/simplePanel.js";import{styles as O}from"../../../../app/highlights/index.js";import _,{getEffectName as E,getEffectDirection as x}from"./effectPanel.js";import A from"./effectChooserDropdown/effectChooserDropdown.js";import b from"../../../../app/highlights/useHighlights.js";import v from"../../../../app/highlights/states.js";const S=t(T).withConfig({displayName:"animation__StyledRow",componentId:"sc-1j3eshx-0"})(["margin-bottom:-1px;"]),P=t.div.withConfig({displayName:"animation__GroupWrapper",componentId:"sc-1j3eshx-1"})([""," margin-bottom:16px;"],(t=>{let{hasAnimation:o,theme:e}=t;return o&&`\n    border: 1px solid ${e.colors.border.defaultNormal};\n    border-radius: ${e.borders.radius.small};\n  `})),C=__("The background image is too small to animate. Double click on the bg & scale the image before applying the animation.","web-stories");function AnimationPanel(t){let{selectedElements:T,selectedElementAnimations:y,pushUpdateForObject:N,updateAnimationState:w}=t;const B=e(!1),{highlight:M,resetHighlight:k}=b((t=>({highlight:t[v.ANIMATION],resetHighlight:t.onFocusOut,cancelHighlight:t.cancelEffect}))),L=1===T.length&&T[0].isBackground,R=r((()=>{const t=T.map((t=>t.animation)).filter(Boolean);return y.map((o=>({...t.find((t=>t.id===o.id))||o}))).filter((t=>!t.delete))}),[T,y]),F=i((function(t){let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s(t,R[0])||(N("animation",t,null,o),B.current=!0)}),[N,R]),H=i((t=>{let{animation:o,...e}=t;if(!o)return;const r=y[0]?.id||n(),i=m(o),s=y[0]?.type===o?{duration:y[0]?.duration,delay:y[0]?.delay}:{};N("animation",{id:r,type:o,...i,...s,...e},null,!0),B.current=!0}),[y,N]),G=document.activeElement,U=p((()=>{B.current&&(w({animationState:l.PLAYING_SELECTED}),B.current=!1)}),300);a(U,[y,w,G,U]);const D=i((()=>{N("animation",{...R[0],delete:!0},null,!0)}),[N,R]),$=r((()=>{if(T[0]?.isBackground){const t=["media","image","video","gif"].includes(T[0].type)&&c({element:T[0]}),o=j(T[0]?.scale||0,{MIN:g,MAX:d});return{[f.PAN.value]:{tooltip:C,options:[!t.bottom&&u.TOP_TO_BOTTOM,!t.left&&u.RIGHT_TO_LEFT,!t.top&&u.BOTTOM_TO_TOP,!t.right&&u.LEFT_TO_RIGHT].filter(Boolean)},[f.ZOOM.value]:{tooltip:C,options:[o<=.01&&h.SCALE_IN,o>=.99&&h.SCALE_OUT].filter(Boolean)},[f.PAN_AND_ZOOM.value]:{tooltip:C,options:[!t.bottom&&u.TOP_TO_BOTTOM,!t.left&&u.RIGHT_TO_LEFT,!t.top&&u.BOTTOM_TO_TOP,!t.right&&u.LEFT_TO_RIGHT,o<=.01&&h.SCALE_IN,o>=.99&&h.SCALE_OUT].filter(Boolean)}}}return{}}),[T]),Z=E(R[0]?.type);return T.length>1?null:o.createElement(I,{name:"animation",title:__("Animation","web-stories"),onAnimationEnd:()=>k(),isPersistable:!M,$_css:M?.showEffect&&O.FLASH},o.createElement(P,{hasAnimation:Z},o.createElement(S,null,o.createElement(A,{ref:t=>{t&&M?.focus&&M?.showEffect&&t.focus()},onAnimationSelected:H,onNoEffectSelected:D,isBackgroundEffects:L,disabledTypeOptionsMap:$,direction:x(R[0]),selectedEffectType:R[0]?.type,selectButtonStylesOverride:M?.focus&&O.OUTLINE})),R[0]&&o.createElement(_,{animation:R[0],onChange:F,disabledTypeOptionsMap:$})))}var I=t(y).withConfig({displayName:"animation___StyledSimplePanel",componentId:"sc-1j3eshx-2"})(["",""],(t=>t.$_css));export{AnimationPanel as default};
