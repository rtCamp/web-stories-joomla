/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"styled-components";import t from"react";import{useMemo as o,useState as r,useBatchingCallback as i,useDebouncedCallback as s,useCallback as n,useEffect as a}from"@googleforcreators/react";import"prop-types";import{__}from"@googleforcreators/i18n";import{Text as p,Input as l,THEME_CONSTANTS as m}from"@googleforcreators/design-system";import{toAbsoluteUrl as c,isValidUrl as d,withProtocol as g}from"@googleforcreators/url";import"../../../../constants/fonts.js";import{MULTIPLE_VALUE as f,MULTIPLE_DISPLAY_VALUE as u}from"../../../../constants/multipleValue.js";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import h from"../../../../app/api/useAPI.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import j from"../../../../utils/useCORSProxy.js";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"@googleforcreators/units";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import y from"../../../../app/canvas/useCanvas.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import x from"../../../../utils/useElementsWithLinks.js";import"../../../form/color/color.js";import"../../../form/filterToggle/filterToggle.js";import k from"../../../form/linkIcon.js";import E from"../../../form/link.js";import"../../../form/media.js";import w from"../../../form/row.js";import"../../../form/switch.js";import"../../../form/textArea.js";import"../../../form/context.js";import"../../../form/dateTime/dateTime.js";import"../../../form/required.js";import"../../../form/radioGroup/index.js";import"../../../form/select/select.js";import"../../../form/hierarchical/index.js";import{createLink as v}from"../../../elementLink/index.js";import"../../panel/panel.js";import"../../panel/context.js";import"../../panel/shared/title.js";import"../../panel/shared/content.js";import L from"../../panel/simplePanel.js";import{inputContainerStyleOverride as b}from"../../shared/styles.js";import"../../shared/flipControls.js";import P from"../../shared/linkRelations.js";import C from"../../shared/useCommonObjectValue.js";import{styles as I}from"../../../../app/highlights/index.js";import T from"../../../../app/highlights/useHighlights.js";import S from"../../../../app/highlights/states.js";const _=e.div.withConfig({displayName:"link__IconInfo",componentId:"sc-niusn4-0"})(["display:flex;flex-direction:column;margin-left:20px;"]),A=e(p).withConfig({displayName:"link__IconText",componentId:"sc-niusn4-1"})(["color:",";"],(e=>{let{theme:t}=e;return t.colors.fg.secondary})),R=e.span.withConfig({displayName:"link__Error",componentId:"sc-niusn4-2"})(["font-size:12px;line-height:16px;color:",";"],(e=>{let{theme:t}=e;return t.colors.fg.negative}));function LinkPanel(e){let{selectedElements:p,pushUpdateForObject:L}=e;const{clearEditing:O,setDisplayLinkGuidelines:F,displayLinkGuidelines:H}=y((e=>({clearEditing:e.actions.clearEditing,setDisplayLinkGuidelines:e.actions.setDisplayLinkGuidelines,displayLinkGuidelines:e.state.displayLinkGuidelines}))),{highlight:U,resetHighlight:N,cancelHighlight:B}=T((e=>({highlight:e[S.LINK],resetHighlight:e.onFocusOut,cancelHighlight:e.cancelEffect}))),{hasElementsInAttachmentArea:M}=x(),D=o((()=>v({icon:null,desc:null})),[]),W=C(p,"link",D),z=v(W),{url:V="",desc:Y="",icon:Z,rel:$=[]}=z,[q,K]=r(!1),[J,Q]=r(!1),{actions:{getLinkMetadata:X}}=h(),{getProxiedUrl:ee,checkResourceAccess:te}=j(),oe=i((e=>{let{newUrl:t,newTitle:o,newIcon:r,needsProxy:i}=e;return L("link",(()=>t?v({url:t,needsProxy:i,desc:o||"",icon:r?c(t,r):""}):null),D,!0)}),[L,D]),[re,ie]=r(!d(g(V))),se=s(n((async e=>{if(e.startsWith("http://")||e.startsWith("https://")){K(!0);try{const{title:t,image:o}=X?await X(e):{},r=!!o&&await te(o);oe({newUrl:e,newTitle:t,newIcon:o,needsProxy:r})}catch(e){ie(!0)}finally{K(!1)}}}),[te,X,oe]),1200),ne=n(((e,t)=>{if(O(),se.cancel(),e.url){if(f===e.url)return;const t=g(e.url),o=d(t);ie(!o),o&&se(t)}L("link",""!==e.url?{...e}:null,D,t)}),[O,L,D,se]),ae=n((e=>{ne({icon:e?.src},!0)}),[ne]),pe=Boolean(V?.length),le=pe&&!re;a((()=>{if(J){const e=pe&&V!==f;F(M&&!e)}}),[p,J,M,pe,F,V]);const me=Z?ee(z,Z):null,ce=f===V,de=f===Y,ge=f===$,fe=n((e=>ne({rel:e},!0)),[ne]);return t.createElement(G,{name:"link",title:__("Link","web-stories"),onAnimationEnd:()=>N(),isPersistable:!U,$_css:U?.showEffect&&I.FLASH},t.createElement(E,{ref:e=>{e&&U?.focus&&U?.showEffect&&(e.addEventListener("keydown",B,{once:!0}),e.focus())},onChange:e=>!H&&ne({url:e},!e),onBlur:()=>{F(!1),Q(!1)},onFocus:()=>{Q(!0)},value:V||"",placeholder:ce?u:__("Enter an address to apply a link","web-stories"),isIndeterminate:ce,"aria-label":__("Element link","web-stories"),hasError:H}),H&&t.createElement(w,null,t.createElement(R,null,__("Link can not reside below the dashed line when a page attachment is present","web-stories"))),le&&t.createElement(t.Fragment,null,t.createElement(w,null,t.createElement(l,{placeholder:de?u:__("Optional description","web-stories"),onChange:e=>{let{target:t}=e;return ne({desc:t.value},!t.value)},value:Y,"aria-label":__("Link description","web-stories"),isIndeterminate:de,disabled:q,containerStyleOverride:b})),t.createElement(w,{spaceBetween:!1},t.createElement(k,{handleChange:ae,icon:me,isLoading:q,disabled:q}),t.createElement(_,null,t.createElement(A,{size:m.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Optional brand icon","web-stories")))),!ge&&t.createElement(P,{onChangeRel:fe,rel:$})))}var G=e(L).withConfig({displayName:"link___StyledSimplePanel",componentId:"sc-niusn4-3"})(["",""],(e=>e.$_css));export{LinkPanel as default};
