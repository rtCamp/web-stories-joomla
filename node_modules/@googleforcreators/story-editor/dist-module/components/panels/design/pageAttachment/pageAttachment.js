/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{useState as t,useEffect as r,useCallback as o,useDebouncedCallback as a}from"@googleforcreators/react";import{__}from"@googleforcreators/i18n";import{toAbsoluteUrl as s,isValidUrl as i,withProtocol as n}from"@googleforcreators/url";import{Checkbox as p,ThemeGlobals as m,Text as l,THEME_CONSTANTS as c,Input as g}from"@googleforcreators/design-system";import{v4 as d}from"uuid";import u from"styled-components";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"prop-types";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import h from"../../../../app/api/useAPI.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import{OUTLINK_THEME as f}from"../../../../constants/index.js";import"../../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import j from"../../../../app/story/useStory.js";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import y from"../../../../utils/useCORSProxy.js";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"@googleforcreators/units";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import x from"../../../../app/canvas/useCanvas.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import E from"../../../../utils/useElementsWithLinks.js";import"../../../form/color/color.js";import"../../../form/filterToggle/filterToggle.js";import P from"../../../form/linkIcon.js";import A from"../../../form/link.js";import"../../../form/media.js";import k from"../../../form/row.js";import"../../../form/switch.js";import"../../../form/textArea.js";import"../../../form/context.js";import"../../../form/dateTime/dateTime.js";import"../../../form/required.js";import"../../../form/radioGroup/index.js";import"../../../form/select/select.js";import"../../../form/hierarchical/index.js";import"../../panel/panel.js";import"../../panel/context.js";import"../../panel/shared/title.js";import"../../panel/shared/content.js";import S from"../../panel/simplePanel.js";import"../../shared/flipControls.js";import b from"../../shared/linkRelations.js";const w=u.label.withConfig({displayName:"pageAttachment__Label",componentId:"sc-qn4x32-0"})(["margin-left:12px;"]),C=u(p).withConfig({displayName:"pageAttachment__StyledCheckbox",componentId:"sc-qn4x32-1"})(["",""],(e=>{let{theme:t}=e;return`\n    input[type='checkbox']&.${m.FOCUS_VISIBLE_SELECTOR} ~ div, input[type='checkbox']:focus ~ div {\n      box-shadow: 0px 0px 0 2px ${t.colors.bg.secondary}, 0px 0px 0 4px ${t.colors.border.focus} !important;\n    }\n  `})),T=u(k).withConfig({displayName:"pageAttachment__StyledRow",componentId:"sc-qn4x32-2"})(["justify-content:flex-start;"]),L=u.div.withConfig({displayName:"pageAttachment__Space",componentId:"sc-qn4x32-3"})(["width:20px;"]),R=u(l).attrs({size:c.TYPOGRAPHY.PRESET_SIZES.SMALL}).withConfig({displayName:"pageAttachment__HelperText",componentId:"sc-qn4x32-4"})(["color:",";"],(e=>{let{theme:t}=e;return t.colors.fg.secondary}));function PageAttachmentPanel(){const{currentPage:p,updateCurrentPageProperties:m,hasProducts:u}=j((e=>{let{state:t,actions:r}=e;return{updateCurrentPageProperties:r.updateCurrentPageProperties,currentPage:t.currentPage,hasProducts:t.currentPage.elements?.some((e=>{let{type:t,product:r}=e;return"product"===t&&r?.productId}))}})),{setDisplayLinkGuidelines:v}=x((e=>({setDisplayLinkGuidelines:e.actions.setDisplayLinkGuidelines}))),{actions:{getLinkMetadata:I}}=h(),{pageAttachment:_={}}=p,D=__("Learn more","web-stories"),{url:G,ctaText:Y=D,icon:B,theme:F,rel:H=[]}=_,[M,O]=t(Y),[q,U]=t(G),[z,N]=t(!1),[Z,K]=t(!1),{hasLinksInAttachmentArea:$}=E();r((()=>()=>{v(!1)}),[$,v,G]);r((()=>{z&&G?.length&&N(!1)}),[G,z]);const W=o((e=>{const t={..._,...e};m({properties:{pageAttachment:t}})}),[m,_]),V=a(W,300),{getProxiedUrl:J,checkResourceAccess:Q}=y(),X=a(o((async e=>{if(e.startsWith("http://")||e.startsWith("https://")){K(!0);try{const{image:t}=I?await I(e):{},r=t?s(e,t):"",o=!!r&&await Q(r);W({url:e,icon:r,needsProxy:o})}catch(t){W({url:e,icon:"",needsProxy:!1}),te(!0)}finally{K(!1)}}}),[Q,I,W]),1200),[ee,te]=t(G&&!i(n(G).trim())),re=M===D,oe=Boolean(G)&&!ee,ae=o((e=>{X.cancel(),U(e),te(!1);const t=n(e.trim());i(t)&&X(t)}),[X]),se=o((e=>{let{target:t}=e;const{value:r}=t;O(r),V({ctaText:r})}),[V]),ie=o((e=>{W({icon:e?.src},!0)}),[W]),ne=o((e=>W({rel:e},!0)),[W]),pe=o((e=>{let{target:t}=e;t.value?(V.cancel(),W({ctaText:M||D})):(W({ctaText:D}),O(D))}),[M,V,D,W]),me=`cb-${d()}`;if(u)return e.createElement(S,{name:"pageAttachment",title:__("Call to Action","web-stories"),collapsedByDefault:!1},e.createElement(k,null,e.createElement(R,null,__("Since there are products on this page, you cannot add a regular page attachment, but only customize the appearance of the shopping call to action.","web-stories"))),e.createElement(T,null,e.createElement(C,{id:me,checked:F===f.DARK,onChange:e=>W({theme:e.target.checked?f.DARK:f.LIGHT})}),e.createElement(w,{htmlFor:me},e.createElement(l,{as:"span",size:c.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Use dark theme","web-stories")))));const le=B?J(_,B):null;let ce;const ge=z||ee;return ge&&(ce=__(z?"Links cannot reside below the dashed line when a page attachment is present. If you add a page attachment, your viewers will not be able to click on the link.":"Invalid link","web-stories")),e.createElement(S,{name:"pageAttachment",title:__("Call to Action","web-stories"),collapsedByDefault:!1},e.createElement(A,{onChange:e=>ae(e?.trim()),onBlur:()=>{V.cancel(),W({url:q?.trim().length?n(q.trim()):""})},onFocus:()=>{$&&!G?.length&&(N(!0),v(!0))},value:q,clear:!0,"aria-label":__("Type an address to add a page attachment link","web-stories"),hasError:ge,hint:ce}),oe&&e.createElement(e.Fragment,null,e.createElement(k,null,e.createElement(g,{onChange:se,onBlur:pe,value:M,"aria-label":__("Page Attachment CTA text","web-stories"),suffix:re?__("Default","web-stories"):null})),e.createElement(T,null,e.createElement(C,{id:me,checked:F===f.DARK,onChange:e=>W({theme:e.target.checked?f.DARK:f.LIGHT})}),e.createElement(w,{htmlFor:me},e.createElement(l,{as:"span",size:c.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Use dark theme","web-stories")))),e.createElement(T,null,e.createElement(P,{handleChange:ie,icon:le,isLoading:Z,disabled:Z}),e.createElement(L,null),e.createElement(l,{as:"span",size:c.TYPOGRAPHY.PRESET_SIZES.SMALL},__("Link icon","web-stories"))),e.createElement(b,{onChangeRel:ne,rel:H})))}export{PageAttachmentPanel as default};
