/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{useState as t,useCallback as r,useDebouncedCallback as o,useMemo as s,useEffect as a}from"@googleforcreators/react";import{sprintf,_n,__}from"@googleforcreators/i18n";import"prop-types";import{useLiveRegion as i}from"@googleforcreators/design-system";import p from"../../../form/tags/index.js";import m from"../../../../utils/cleanForSlug.js";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"../../../../app/history/historyProvider.js";import n from"../../../../app/history/useHistory.js";import"../../../../constants/fonts.js";import"../../../../constants/multipleValue.js";import"@googleforcreators/animation";import"uuid";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../app/taxonomy/context.js";import l from"../../../../app/taxonomy/useTaxonomy.js";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../app/font/context.js";import"@googleforcreators/media";import"@googleforcreators/tracking";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"@googleforcreators/units";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import{ContentHeading as c,WordCloud as d}from"./shared.js";import{deepEquals as g}from"../../../form/tags/reducer.js";function FlatTermSelector(u){let{taxonomy:f,canCreateTerms:j}=u;const[y,h]=t([]),{createTerm:T,termCache:x,addSearchResultsToCache:b,terms:C=[],setTerms:v,addTermToSelection:E}=l((e=>{let{state:{termCache:t,terms:r},actions:{createTerm:o,addSearchResultsToCache:s,setTerms:a,addTermToSelection:i}}=e;return{termCache:t,createTerm:o,addSearchResultsToCache:s,terms:r,setTerms:a,addTermToSelection:i}})),{undo:S}=n((e=>{let{actions:{undo:t}}=e;return{undo:t}})),[k,B]=t([]),R=i("assertive"),w=r((e=>{const t=e.map((e=>[m(e),e])),r=t.map((e=>{let[t]=e;return t})).map((e=>x[f.restBase]?.[e])).filter((e=>e)).map((e=>e.id));if(g(C[f.restBase],r)||v(f,r),!j)return;t.filter((e=>{let[t]=e;return!x[f.restBase]?.[t]})).map((e=>{let[,t]=e;return t})).forEach((e=>T(f,e,null,!0)))}),[j,C,f,x,v,T]),F=o((async e=>{if(0===e.length)return void B([]);if(e.length<3)return;const t=await b(f,{search:e,per_page:20});B(t);const r=t.length,o=sprintf(
/* Translators: %d: Number of results. */
_n("%d result found.","%d results found.","web-stories","web-stories"),r);R(o)}),300),I=s((()=>(C[f.restBase]||[]).map((e=>Object.values(x[f.restBase]||{}).find((t=>t.id===e)))).filter((e=>void 0!==e)).map((e=>e.name))),[f,C,x]),L=r((e=>x[f.restBase]?.[m(e)]?.name),[f,x]);return a((()=>{!async function(){const e=await b(f,{orderby:"count",order:"desc",hide_empty:!0});h(e)}()}),[f,b]),e.createElement(e.Fragment,null,e.createElement(c,null,f.labels.name),e.createElement("div",{key:f.slug},e.createElement(p.Label,{htmlFor:`${f.slug}-input`},f.labels.addNewItem),e.createElement(p.Input,{id:`${f.slug}-input`,"aria-describedby":`${f.slug}-description`,name:f.slug,onTagsChange:w,onInputChange:F,tagDisplayTransformer:L,tokens:I,onUndo:S,suggestedTerms:k,suggestedTermsLabel:f?.labels?.itemsList}),e.createElement(p.Description,{id:`${f.slug}-description`},f.labels.separateItemsWithCommas),y.length>0&&e.createElement(d.Wrapper,{"data-testid":`${f.slug}-most-used`},e.createElement(d.Heading,null,f.labels.mostUsed),e.createElement(d.List,null,y.map(((t,r)=>e.createElement(d.ListItem,{key:t.id},e.createElement(d.Word,{onClick:()=>{C[f.restBase]?.includes(t.id)||E(f,t)}},t.name,r<y.length-1&&
/* translators: delimiter used in a list */
__(",","web-stories")),r<y.length-1&&" ")))))))}export{FlatTermSelector as default};
