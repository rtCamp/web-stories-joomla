/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{sprintf,__}from"@googleforcreators/i18n";import{themeHelpers as r,THEME_CONSTANTS as t,Text as o,Button as a,BUTTON_VARIANTS as s,BUTTON_SIZES as i,BUTTON_TYPES as m,useLiveRegion as p,Input as n,DropDown as l}from"@googleforcreators/design-system";import{useMemo as c,useState as d,useRef as g,useCallback as f,useEffect as u}from"@googleforcreators/react";import"prop-types";import j from"styled-components";import{v4 as y}from"uuid";import"../../../form/color/color.js";import"../../../form/filterToggle/filterToggle.js";import"../../../form/linkIcon.js";import"../../../form/link.js";import"../../../form/media.js";import"@googleforcreators/media";import"@googleforcreators/transform";import"../../../dropTargets/provider.js";import"../../../dropTargets/context.js";import"../../../../app/history/historyProvider.js";import"../../../../app/history/context.js";import"@googleforcreators/templates";import"../../../../app/config/context.js";import"../../../../app/api/context.js";import"@googleforcreators/fonts";import"@googleforcreators/dom";import"../../../../constants/fonts.js";import"../../../../constants/multipleValue.js";import"../../../../app/font/context.js";import"@googleforcreators/tracking";import"@googleforcreators/animation";import"@googleforcreators/masks";import"@googleforcreators/element-library";import"@googleforcreators/elements";import"../../../../app/story/context.js";import"@googleforcreators/migration";import"../../../../app/story/actions/useSaveStory.js";import"clone-deep";import"../../../../app/story/useStoryReducer/useStoryReducer.js";import"@googleforcreators/output";import"../../../../app/story/storyTriggers/storyTriggersProvider.js";import"../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js";import"../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js";import"../../../../app/media/useUploadMedia.js";import"@googleforcreators/patterns";import"../../../../utils/generateBlurhash.worker.js";import"../../../../app/media/media3p/providerConfiguration.js";import"../../../../app/media/utils/useFFmpeg.js";import"../../../../app/media/media3p/api/context.js";import"../../../../app/media/local/constants.js";import"../../../../app/media/media3p/providerReducer.js";import"../../../../app/media/context.js";import"sat";import"@googleforcreators/units";import"../../../../app/layout/context.js";import"../../../../app/layout/useZoomSetting.js";import"@googleforcreators/rich-text";import"@googleforcreators/stickers";import"../../../library/panes/text/textPresets.js";import"../../../../app/canvas/context.js";import"../../../../app/currentUser/context.js";import"../../../../app/helpCenter/provider.js";import"../../../../app/helpCenter/context.js";import"../../../helpCenter/constants.js";import"../../../../app/rightClickMenu/context.js";import"../../../form/row.js";import"../../../form/switch.js";import"../../../form/textArea.js";import"../../../form/context.js";import"../../../form/dateTime/dateTime.js";import"../../../form/required.js";import"../../../form/radioGroup/index.js";import"../../../form/select/select.js";import h from"../../../form/hierarchical/index.js";import"../../../../app/taxonomy/context.js";import x from"../../../../app/taxonomy/useTaxonomy.js";import{ContentHeading as b,LinkButton as T}from"./shared.js";import{makeFlatOptionTree as E}from"../../../form/hierarchical/utils/index.js";const C="NO_PARENT_VALUE",v=j.div.withConfig({displayName:"HierarchicalTermSelector__ContentArea",componentId:"sc-17x36f5-0"})(["label,* > label{",";color:",";}"],(e=>{let{theme:o}=e;return r.expandPresetStyles({preset:o.typography.presets.label[t.TYPOGRAPHY.PRESET_SIZES.SMALL],theme:o})}),(e=>{let{theme:r}=e;return r.colors.fg.secondary})),S=j.form.withConfig({displayName:"HierarchicalTermSelector__AddNewCategoryForm",componentId:"sc-17x36f5-1"})(["margin:24px 0 16px;"]),I=j.div.withConfig({displayName:"HierarchicalTermSelector__ButtonContainer",componentId:"sc-17x36f5-2"})(["display:flex;gap:8px;"]),w=j(o).attrs({forwardedAs:"label",size:t.TYPOGRAPHY.PRESET_SIZES.SMALL}).withConfig({displayName:"HierarchicalTermSelector__Label",componentId:"sc-17x36f5-3"})(["display:inline-block;margin:12px 0;"]),A=j(a).attrs({variant:s.RECTANGLE,size:i.SMALL,type:m.SECONDARY}).withConfig({displayName:"HierarchicalTermSelector__AddNewCategoryButton",componentId:"sc-17x36f5-4"})(["margin-top:20px;"]);function HierarchicalTermSelector(r){let{noParentId:t=C,taxonomy:o,canCreateTerms:a}=r;const{createTerm:s,termCache:i,terms:m,setTerms:j}=x((e=>{let{state:{termCache:r,terms:t},actions:{createTerm:o,setTerms:a}}=e;return{createTerm:o,setTerms:a,termCache:r,terms:t}})),k=c((()=>i?.[o.restBase]?Object.values(i[o.restBase]).map((e=>({id:e.id,parent:e.parent,value:e.id,label:e.name,checked:m[o.restBase]?.includes(e.id),slug:e.slug}))):[]),[o,i,m]),[N,_]=d(!1),[P,L]=d(""),[R,H]=d(t),F=c(y,[]),[B,M]=d(!1),O=g(),Y=g(),[G,V]=d(!1),[U,Z]=d(""),$=f((e=>Z(e)),[]),z=p("assertive"),D=f((()=>{L(""),H(t)}),[t]),q=f(((e,r)=>{let{id:t,checked:a}=r;const s=k.find((e=>e.id===t));j(o,(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const r=e.findIndex((e=>e===s.id));return a&&-1===r?[...e,s.id]:!a&&r>-1?[...e.slice(0,r),...e.slice(r+1)]:e}))}),[k,j,o]),J=f((()=>{_(!N),D(),M(!N),V(N)}),[D,N]),K=f((e=>{L(e.target.value)}),[]),Q=c((()=>k.find((e=>e.id===R))?.slug),[R,k]),W=f((e=>{e.preventDefault();s(o,P,{id:R===t?0:R,slug:Q},!0),z(sprintf(
/* Translators: %s: Taxonomy label name. */
__("%s added.","web-stories"),o.labels.singular_name)),_(!1),D(),V(N)}),[s,z,P,t,D,R,N,o,Q]),X=f(((e,r)=>H(r)),[]);u((()=>{const e=O.current;if(e){const r=e=>{"Enter"===e.key&&W(e)};return e.addEventListener("keypress",r),()=>{e.removeEventListener("keypress",r)}}return null}),[W,O]),u((()=>{G&&Y.current.focus()}),[G]);const ee=c((()=>E(k,U)),[k,U]),re=c((()=>[{value:C,label:__("None","web-stories")}].concat(ee).map((e=>{let{$level:r,label:t,...o}=e;return{...o,label:`${Array.from({length:r},(()=>"â€” ")).join("")} ${t}`}}))),[ee]);return e.createElement(v,null,e.createElement(b,null,o.labels.name),e.createElement(h,{inputValue:U,onInputChange:$,label:o.labels.searchItems,options:ee,onChange:q,noOptionsText:o.labels?.notFound}),a?e.createElement(e.Fragment,null,!N&&e.createElement(T,{ref:Y,"aria-expanded":!1,onClick:J},o.labels.addNewItem),N?e.createElement(S,{ref:O,onSubmit:W},e.createElement(n,{autoFocus:!0,name:o.labels.newItemName,label:o.labels.newItemName,value:P,onChange:K,hasFocus:B}),e.createElement(w,{htmlFor:F},o.labels.parentItem),e.createElement(l,{id:F,ariaLabel:o.labels.parentItem,options:re,selectedValue:R,onMenuItemClick:X}),e.createElement(I,null,e.createElement(A,{disabled:!P.length,type:"submit"},o.labels.addNewItem),e.createElement(A,{"aria-expanded":!0,onClick:J},__("Cancel","web-stories")))):null):null)}export{HierarchicalTermSelector as default};
