/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import e from"react";import{__,sprintf,translateToExclusiveList as o}from"@googleforcreators/i18n";import{Input as t}from"@googleforcreators/design-system";import"prop-types";import r from"styled-components";import{useState as i,useRef as s,useLayoutEffect as l,useCallback as n}from"@googleforcreators/react";import{trackEvent as a,trackError as p}from"@googleforcreators/tracking";import{withProtocol as c}from"@googleforcreators/url";import m from"../../dialog/dialog.js";import{isValidUrlForHotlinking as f,getErrorMessage as g}from"../../library/panes/media/local/hotlink/utils.js";import"@googleforcreators/templates";import"../../../app/config/context.js";import"../../../app/api/context.js";import u from"../../../app/api/useAPI.js";import d from"../../../utils/useCORSProxy.js";const y=r.form.withConfig({displayName:"hotlinkModal__InputWrapper",componentId:"sc-bvssi1-0"})(["margin:16px 4px;width:470px;height:100px;"]);function HotlinkModal(r){let{isOpen:h,onClose:b,onSelect:w,allowedFileTypes:x=[],title:k}=r;const[I,_]=i(!1),[v,j]=i(""),[C,T]=i(!1),E=s(null),{actions:{getHotlinkInfo:P}}=u(),{checkResourceAccess:R}=d(),S=C||!v||I,H=__(I?"Insertingâ€¦":"Insert","web-stories");let M=__("No file types are currently supported.","web-stories");x.length&&(M=sprintf(
/* translators: %s is a list of allowed file extensions. */
__("You can insert %s.","web-stories"),o(x))),l((()=>{const e=setTimeout((()=>{h&&E.current&&E.current.focus()}));return()=>clearTimeout(e)}),[h,E]);const O=n((()=>{if(v?.length>0){const e=c(v);j(e),f(e)||T(__("Invalid link.","web-stories"))}}),[v]),z=n((e=>{C&&T(null),j(e)}),[j,C]),A=n((async()=>{if(v)if(f(v)){_(!0);try{const e=await P(v),o=await R(v);a("hotlink_file",{event_label:v,file_size:e.fileSize,file_type:e.mimeType,needs_proxy:o}),w({src:v,needsProxy:o})}catch(e){p("hotlink_file",e?.message),T(g(e.code,M))}finally{_(!1)}}else T(__("Invalid link.","web-stories"))}),[M,w,v,P,T,R]),B=n((e=>{e.preventDefault(),S||A()}),[S,A]);return e.createElement(m,{onClose:()=>{b(),j(""),T(!1),_(!1)},isOpen:h,title:k,onPrimary:()=>A(),primaryText:H,secondaryText:__("Cancel","web-stories"),primaryRest:{disabled:S}},e.createElement(y,{onSubmit:B},e.createElement(t,{ref:E,onChange:e=>{let{target:{value:o}}=e;return z(o)},value:v,hint:C?.length?C:M,hasError:Boolean(C?.length),onBlur:O,label:__("URL","web-stories"),type:"url",required:!0})))}export{HotlinkModal as default};
