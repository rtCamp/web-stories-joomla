/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),t=require("@googleforcreators/tracking"),r=require("@googleforcreators/design-system"),o=require("@googleforcreators/animation"),s=require("@googleforcreators/transform"),n=require("@googleforcreators/elements"),i=require("../../constants/index.js");require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("react"),require("prop-types"),require("../story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../config/context.js"),require("../api/context.js"),require("../history/historyProvider.js"),require("../history/context.js"),require("../story/actions/useSaveStory.js"),require("clone-deep"),require("../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../story/storyTriggers/storyTriggersProvider.js"),require("../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../story/storyTriggers/storyEvents/onPageAddedRegister.js");var l=require("../story/useStory.js");require("sat"),require("@googleforcreators/units"),require("../layout/context.js"),require("../layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/media"),require("@googleforcreators/i18n"),require("../media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../utils/generateBlurhash.worker.js"),require("../media/media3p/providerConfiguration.js"),require("../media/utils/useFFmpeg.js"),require("../media/media3p/api/context.js"),require("../media/local/constants.js"),require("../media/media3p/providerReducer.js"),require("../media/context.js"),require("@googleforcreators/stickers"),require("../../components/library/panes/text/textPresets.js"),require("./context.js");var a=require("./useCanvas.js");module.exports=function(u){const{selectedElementIds:c,selectedElements:d,arrangeSelection:g,clearSelection:m,deleteSelectedElements:f,duplicateElementsById:E,updateSelectedElements:y,setSelectedElementsById:q,currentPage:S,animationState:p,updateAnimationState:I}=l((e=>{let{state:{selectedElementIds:t,selectedElements:r,currentPage:o,animationState:s},actions:{arrangeSelection:n,clearSelection:i,deleteSelectedElements:l,duplicateElementsById:a,updateSelectedElements:u,setSelectedElementsById:c,updateAnimationState:d}}=e;return{currentPage:o,selectedElementIds:t,selectedElements:r,arrangeSelection:n,clearSelection:i,deleteSelectedElements:l,duplicateElementsById:a,updateSelectedElements:u,setSelectedElementsById:c,animationState:s,updateAnimationState:d}})),{actions:{clearTransforms:T}}=s.useTransform(),{isEditing:A,getNodeForElement:j,setEditingElement:R}=a((e=>{let{state:{isEditing:t},actions:{getNodeForElement:r,setEditingElement:o}}=e;return{isEditing:t,getNodeForElement:r,setEditingElement:o}})),v=e.useRef(null);v.current=c,e.useEffect((()=>{const e=u.current;if(!e)return;const t=e.ownerDocument,r=()=>{setTimeout((()=>{if(t.activeElement===t.body){const t=v.current,r=1===t?.length?j(t[0]):null;if(""!==window.getSelection().toString())return;r?r.focus({preventScroll:!0}):e.focus({preventScroll:!0})}}),300)};return t.addEventListener("focusout",r,!0),()=>{t.removeEventListener("focusout",r,!0)}}),[u,j]),r.useGlobalKeyDownEffect("delete",(()=>f()),[f]),r.useGlobalKeyDownEffect("esc",(()=>{m(),T()}),[m,T]),r.useGlobalKeyDownEffect({key:["mod+a"]},(()=>{const e=S.elements.map((e=>{let{id:t}=e;return t}));q({elementIds:e})}),[S,q]),r.useGlobalKeyDownEffect({key:["up","down","left","right"],shift:!0},(e=>{let{key:t,shiftKey:o}=e;if(A)return;if(d?.[0]?.isBackground)return;const{dx:s,dy:n}=r.getKeyboardMovement(t,o);y({properties:e=>{let{x:t,y:r}=e;return{x:t+s,y:r+n}}})}),[y,A,d]),r.useGlobalKeyDownEffect({key:["mod+up","mod+down","mod+left","mod+right"],shift:!0},(e=>{const{key:t,shiftKey:r}=e;e.preventDefault();const o=function(e,t){if("ArrowUp"===e)return t?i.LAYER_DIRECTIONS.FRONT:i.LAYER_DIRECTIONS.FORWARD;if("ArrowDown"===e)return t?i.LAYER_DIRECTIONS.BACK:i.LAYER_DIRECTIONS.BACKWARD;return null}(t,r);o&&g({position:o})}),[g]),r.useGlobalKeyDownEffect({key:"enter",clickable:!1},(()=>{if(1!==d.length)return;const{type:e,id:t}=d[0],{hasEditMode:r}=n.getDefinitionForType(e);r&&R(t)}),[d,R]);const D=e.useCallback((()=>{0!==d.length&&E({elementIds:d.map((e=>e.id))})}),[E,d]);r.useGlobalKeyDownEffect("clone",(()=>D()),[D]);const N=[o.STORY_ANIMATION_STATE.PLAYING,o.STORY_ANIMATION_STATE.PLAYING_SELECTED].includes(p);r.useGlobalKeyDownEffect({key:["mod+k"]},(e=>{e.preventDefault(),I({animationState:N?o.STORY_ANIMATION_STATE.RESET:o.STORY_ANIMATION_STATE.PLAYING}),t.trackEvent("canvas_play_animations",{status:N?"stop":"play"})}),[N,I])};
