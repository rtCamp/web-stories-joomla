/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");require("prop-types");var t=require("@googleforcreators/react"),a=require("@googleforcreators/fonts"),n=require("@googleforcreators/dom"),s=require("../../constants/fonts.js");require("../../constants/multipleValue.js"),require("@googleforcreators/templates"),require("../config/context.js"),require("../api/context.js");var r=require("../api/useAPI.js"),o=require("./context.js"),l=require("./actions/useLoadFontFiles.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=u(e);exports.GOOGLE_MENU_FONT_URL="https://fonts.googleapis.com/css",exports.default=function FontProvider(e){let{children:u}=e;const[i,f]=t.useState([]),[m,d]=t.useState([]),[g,y]=t.useState([]),[p,F]=t.useState(null),{actions:{getFonts:b}}=r(),h=i.length>0?i:m,q=t.useCallback((async()=>{if(p||!b)return;const e=await b({service:"custom"});if(!e.length)return;const t=e.map((e=>({...e,id:e.family,name:e.family,value:e.family})));F(t)}),[b,p]),v=t.useCallback((async()=>{if(m.length||!b)return;const e=await b({include:a.CURATED_FONT_NAMES.join(",")});if(!e.length)return;const t=e.map((e=>({id:e.family,name:e.family,value:e.family,...e})));d(t)}),[b,m]),{maybeEnqueueFontStyle:C,maybeLoadFont:k}=l(),E=t.useCallback((e=>{const t=h.find((t=>t.family===e));return t||{}}),[h]),j=t.useCallback((async e=>{if(e.length<2)return f([]),[];const t=(await b({search:e})).map((e=>({...e,id:e.family,name:e.family,value:e.family})));return f(t),t}),[b]),S=t.useCallback((e=>{const t=[{name:s.FONT_WEIGHT_NAMES[400],value:400}],a=E(e);let n=t;if(a){const{weights:e}=a;e&&(n=e.map((e=>({name:s.FONT_WEIGHT_NAMES[e],value:e}))))}return n}),[E]),_=t.useCallback((e=>{const t=E(e);return t?.fallbacks?t.fallbacks:[]}),[E]),N=t.useCallback((e=>{const t=[e];g.forEach((a=>{e.family!==a.family&&t.push(a)})),y(t.slice(0,5))}),[g]),O=t.useRef([]),T=t.useCallback((e=>{const t=e.filter((e=>!O.current.includes(e)));if(!t?.length)return;O.current=O.current.concat(t);const a=`https://fonts.googleapis.com/css?family=${encodeURIComponent(t.join("|"))}&subset=menu&display=swap`;n.loadStylesheet(a,"web-stories-google-fonts-menu-css").catch((()=>{O.current=O.current.filter((e=>!t.includes(e)))}))}),[]),w=t.useCallback((e=>{for(const t of e){const e=p.find((e=>{let{family:a}=e;return a===t}));e&&k(e)}}),[p,k]),x={state:{fonts:i.length>0?i:m,curatedFonts:m,customFonts:p,recentFonts:g},actions:{getFontsBySearch:j,getFontByName:E,maybeEnqueueFontStyle:C,getFontWeight:S,getFontFallback:_,ensureMenuFontsLoaded:T,ensureCustomFontsLoaded:w,addRecentFont:N,getCustomFonts:q,getCuratedFonts:v}};return c.default.createElement(o.Provider,{value:x},u)};
