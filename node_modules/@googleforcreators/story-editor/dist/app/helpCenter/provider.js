/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");require("prop-types");var t=require("@googleforcreators/react"),r=require("@googleforcreators/tracking"),n=require("@googleforcreators/units"),i=require("@googleforcreators/design-system");require("@googleforcreators/templates"),require("../config/context.js");var a=require("../config/useConfig.js");require("../api/context.js");var s=require("../api/useAPI.js");require("../currentUser/context.js");var o=require("../currentUser/useCurrentUser.js"),c=require("../../components/helpCenter/constants.js"),u=require("./context.js"),d=require("./useHelpCenter/effects.js");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=p(e);const g=d.composeEffects([d.resetNavigationIndexOnOpen,d.createDynamicNavigationFlow,d.deriveBottomNavigation,d.deriveTransitionDirection,d.deriveDisabledButtons,d.deriveReadTip,d.deriveUnreadTipsCount,d.deriveAutoOpen,d.resetIsOpeningToTip]),T=(e,t)=>{let{state:r,actions:n}=e;const i={...r,...t(r)};return{state:g(r,i),actions:n}},v=d.composeEffects([d.deriveInitialOpen,d.deriveInitialUnreadTipsCount]),E=i.localStore.getItemByKey(i.LOCAL_STORAGE_PREFIX.HELP_CENTER),f=e=>({isOpen:!1,isOpeningToTip:!1,navigationIndex:-1,navigationFlow:Object.keys({...c.TIPS,...e.additionalTips}),isLeftToRightTransition:!0,hasBottomNavigation:!1,isPrevDisabled:!0,isNextDisabled:!1,readTips:{},readError:!1,unreadTipsCount:E?.unreadTipsCount??0,isHydrated:!1,tips:{...c.TIPS,...e.additionalTips},tipKeys:Object.keys({...c.TIPS,...e.additionalTips})}),I=e=>({state:v(E,f(e)),actions:{goToNext:()=>e=>{let{navigationIndex:t,navigationFlow:r}=e;return{navigationIndex:n.clamp(t+1,{MIN:0,MAX:r.length-1})}},goToPrev:()=>e=>{let{navigationIndex:t,navigationFlow:r}=e;return{navigationIndex:n.clamp(t-1,{MIN:0,MAX:r.length-1})}},goToMenu:()=>()=>({navigationIndex:-1}),goToTip:e=>t=>{let{navigationFlow:r}=t;return{navigationIndex:r.findIndex((t=>t===e))}},openToUnreadTip:e=>t=>{let{navigationFlow:r,readTips:n}=t;return n[e]?{}:{isOpen:!0,isOpeningToTip:!0,navigationIndex:r.findIndex((t=>t===e))}},toggle:()=>e=>{let{isOpen:t}=e;return r.trackEvent("help_center_toggled",{status:t?"closed":"open"}),{isOpen:!t}},close:()=>e=>{let{isOpen:t}=e;return t&&r.trackEvent("help_center_toggled",{status:"closed"}),{isOpen:!1}},hydrateReadTipsSuccess:e=>t=>({readTips:{...e?.readTips??{},...t.readTips},isHydrated:!0}),persistingReadTipsError:()=>()=>({readError:!0})}});exports.default=function HelpCenterProvider(e){let{children:n}=e;const{additionalTips:c={}}=a(),{actions:{updateCurrentUser:d}}=s(),p=Boolean(d),[g,v]=t.useReducer(T,I({additionalTips:c})),{currentUser:E,updateCurrentUser:f}=o((e=>{let{state:t,actions:r}=e;return{currentUser:t.currentUser,updateCurrentUser:r.updateCurrentUser}})),O=t.useMemo((()=>Object.entries(g.actions).reduce(((e,t)=>{let[r,n]=t;return e[r]=function(){return v(n(...arguments))},e}),{})),[g.actions]),{isHydrated:C,unreadTipsCount:_}=g.state;t.useEffect((()=>{if(C){const e=i.localStore.getItemByKey(i.LOCAL_STORAGE_PREFIX.HELP_CENTER);i.localStore.setItemByKey(i.LOCAL_STORAGE_PREFIX.HELP_CENTER,{...e,unreadTipsCount:_})}}),[C,_]);const{isOpen:x}=g.state;t.useEffect((()=>{const e=i.localStore.getItemByKey(i.LOCAL_STORAGE_PREFIX.HELP_CENTER);i.localStore.setItemByKey(i.LOCAL_STORAGE_PREFIX.HELP_CENTER,{...e,isOpen:x})}),[x]),t.useEffect((()=>{!C&&E?.onboarding&&O.hydrateReadTipsSuccess({readTips:E.onboarding})}),[O,E,C]);const y=(R=g.state.readTips,Object.keys(R||{}).join(" "));var R;const m=t.useRef(!1);t.useEffect((()=>{var e;(y||C)&&p&&(m.current?f({onboarding:(e=y,e.split(" ").sort(((e,t)=>e.localeCompare(t))).reduce(((e,t)=>({...e,[t]:!0})),{}))}).catch(O.persistingReadTipsError):m.current=!0)}),[O,f,p,y,C]);const[P,S]=t.useState(g.state);t.useEffect((()=>S(g.state)),[g.state]);const j=!P.isOpen&&g.state.isOpen?g.state.navigationIndex:P.navigationIndex;t.useEffect((()=>{if(j>-1&&g.state.navigationFlow.length>=j){const e=g.state.navigationFlow[j];r.trackEvent("help_center_read_tip",{name:e,unread_count:g.state.unreadTipsCount}),g.state.unreadTipsCount===g.state.navigationFlow.length&&r.trackEvent("tutorial_begin"),"done"===e&&r.trackEvent("tutorial_complete")}}),[j]);const q=t.useMemo((()=>({state:{...g.state,navigationIndex:j},actions:O})),[O,g.state,j]);return l.default.createElement(u.Provider,{value:q},n)},exports.deriveState=g,exports.getInitial=I,exports.getInitialState=f;
