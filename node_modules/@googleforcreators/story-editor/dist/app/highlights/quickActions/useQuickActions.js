/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");require("prop-types");var t=require("@googleforcreators/react"),r=require("@googleforcreators/i18n"),s=require("@googleforcreators/design-system"),n=require("@googleforcreators/tracking"),o=require("@googleforcreators/elements"),i=require("@googleforcreators/media"),a=require("../states.js"),c=require("../useHighlights.js"),l=require("../../../components/design/updateProperties.js");require("../../history/historyProvider.js");var u=require("../../history/useHistory.js");require("../../config/context.js");var E=require("../../config/useConfig.js");require("@googleforcreators/templates"),require("../../api/context.js"),require("../../../constants/fonts.js"),require("../../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("../../story/context.js"),require("@googleforcreators/migration"),require("../../story/actions/useSaveStory.js"),require("clone-deep"),require("../../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output");var d=require("../../story/storyTriggers/useStoryTriggers.js");require("../../story/storyTriggers/storyTriggersProvider.js"),require("../../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../story/storyTriggers/storyEvents/onPageAddedRegister.js");var m=require("../../story/storyTriggers/storyEvents/types.js"),T=require("../../story/useStory.js");require("../../media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../utils/generateBlurhash.worker.js"),require("../../media/media3p/providerConfiguration.js");var p=require("../../media/utils/useFFmpeg.js");require("../../media/media3p/api/context.js"),require("../../media/local/constants.js"),require("../../media/media3p/providerReducer.js"),require("../../media/context.js");var g=require("../../media/local/useLocalMedia.js"),I=require("../../media/constants.js"),A=require("../../../utils/useApplyTextAutoStyle.js"),N=require("./utils/getResetProperties.js"),S=require("./constants.js");function _(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var k=_(e);function y(){return y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},y.apply(this,arguments)}const C=r.sprintf(
/* translators: %s: Ctrl/Cmd + Z keyboard shortcut */
r.__("Press %s to undo the last change","web-stories"),s.prettifyShortcut("mod+z")),{Bucket:q,ColorBucket:M,CircleSpeed:R,Eraser:O,LetterTPlus:P,Link:h,Media:f,PictureSwap:v,Captions:b}=s.Icons;exports.MediaPicker=e=>{let{render:n,...o}=e;const{allowedMimeTypes:{image:a,vector:c,video:l},MediaUpload:u}=E(),{selectedElements:d,updateElementsById:m}=T((e=>{let{state:{selectedElements:t},actions:{updateElementsById:r}}=e;return{selectedElements:t,updateElementsById:r}})),{resetWithFetch:A,postProcessingResource:N,optimizeVideo:S,optimizeGif:_,canTranscodeResource:C}=g((e=>{let{state:{canTranscodeResource:t},actions:{resetWithFetch:r,postProcessingResource:s,optimizeVideo:n,optimizeGif:o}}=e;return{canTranscodeResource:t,resetWithFetch:r,postProcessingResource:s,optimizeVideo:n,optimizeGif:o}})),{isTranscodingEnabled:q}=p(),{showSnackbar:M}=s.useSnackbar();let R=t.useMemo((()=>[...a,...c,...l]),[a,c,l]);const O=t.useMemo((()=>R.map((e=>i.getExtensionsFromMimeType(e))).flat()),[R]);q&&(R=R.concat(I.TRANSCODABLE_MIME_TYPES));const P=I.TRANSCODABLE_MIME_TYPES.filter((e=>!l.includes(e)));let h=r.__("No file types are currently supported.","web-stories");O.length&&(h=r.sprintf(
/* translators: %s: list of allowed file types. */
r.__("Please choose only %s to insert into page.","web-stories"),r.translateToExclusiveList(O)));const f=t.useCallback(((e,t)=>{i.resourceList.set(e.id,{url:t,type:"cached"}),m({elementIds:[d?.[0]?.id],properties:{type:e.type,resource:e}})}),[d,m]),v=t.useCallback((e=>{try{q&&C(e)&&(P.includes(e.mimeType)&&S({resource:e}),"image/gif"===e.mimeType&&_({resource:e})),f(e,e.sizes?.medium?.sourceUrl||e.src),N(e)}catch(e){M({message:e.message,dismissable:!0})}}),[q,C,f,N,P,S,_,M]);return k.default.createElement(u,y({title:r.__("Replace media","web-stories"),buttonInsertText:r.__("Replace media","web-stories"),onSelect:v,onClose:A,type:R,onSelectErrorMessage:h,render:e=>n({onClick:e})},o))},exports.default=()=>{const{capabilities:{hasUploadMediaAction:e},isRTL:i}=E(),p=d.useStoryTriggersDispatch(),{backgroundElement:g,selectedElementAnimations:I,selectedElements:_,updateElementsById:k}=T((e=>{let{state:{currentPage:t,selectedElementAnimations:r,selectedElements:s},actions:{updateElementsById:n}}=e;return{backgroundElement:t?.elements.find((e=>e.isBackground)),selectedElementAnimations:r,selectedElements:s,updateElementsById:n}})),{undo:y}=u((e=>{let{actions:{undo:t}}=e;return{undo:t}})),L=s.useSnackbar((e=>{let{showSnackbar:t}=e;return t})),{setHighlights:D}=c((e=>{let{setHighlights:t}=e;return{setHighlights:t}})),j=t.useRef(y);j.current=y;const B=_?.[0],x=t.useCallback((e=>{e.stopPropagation()}),[]),F=t.useCallback(((e,t,r)=>{const s={};r.includes(S.RESET_PROPERTIES.OVERLAY)&&(s.overlay=null),r.includes(S.RESET_PROPERTIES.ANIMATION)&&k({elementIds:[t],properties:e=>l(e,{animation:{...I?.[0],delete:!0}},!0)}),r.includes(S.RESET_PROPERTIES.STYLES)&&(s.opacity=100,s.border=null,s.borderRadius=null),e===o.ELEMENT_TYPES.TEXT&&(s.borderRadius=S.RESET_DEFAULTS.TEXT_BORDER_RADIUS),k({elementIds:[t],properties:e=>l(e,s,!0)})}),[I,k]),w=t.useCallback((e=>{let{elementId:t,resetProperties:s,elementType:o}=e;F(o,t,s),L({actionLabel:r.__("Undo","web-stories"),dismissible:!1,message:r.__("Element properties have been reset","web-stories"),onAction:()=>{j.current(),n.trackEvent("quick_action",{name:`undo_${S.ACTIONS.RESET_ELEMENT.trackingEventName}`,element:o,isBackground:!0})},actionHelpText:C})}),[F,L]),G=t.useCallback((e=>t=>r=>{r.preventDefault(),D({elementId:t||B?.id,highlight:e})}),[D,B]),U=t.useMemo((()=>{const e=(_?.[0]?.resource?.id?.toString()||"").startsWith("media/")?a.default.MEDIA3P:a.default.MEDIA;return G(e)}),[G,_]),{handleFocusAnimationPanel:Y,handleFocusLinkPanel:K,handleFocusPageBackground:H,handleFocusTextSetsPanel:z,handleFocusCaptionsPanel:V}=t.useMemo((()=>({handleFocusAnimationPanel:G(a.default.ANIMATION),handleFocusLinkPanel:G(a.default.LINK),handleFocusPageBackground:G(a.default.PAGE_BACKGROUND),handleFocusTextSetsPanel:G(a.default.TEXT_SET),handleFocusCaptionsPanel:G(a.default.CAPTIONS)})),[G]),X=t.useMemo((()=>({tooltipPlacement:i?s.PLACEMENT.LEFT:s.PLACEMENT.RIGHT,onMouseDown:x})),[x,i]),W=t.useMemo((()=>[{Icon:q,label:S.ACTIONS.CHANGE_BACKGROUND_COLOR.text,onClick:e=>{H(g?.id)(e),n.trackEvent("quick_action",{name:S.ACTIONS.CHANGE_BACKGROUND_COLOR.trackingEventName,element:"none"})},...X},{Icon:f,label:S.ACTIONS.INSERT_BACKGROUND_MEDIA.text,onClick:e=>{U()(e),n.trackEvent("quick_action",{name:S.ACTIONS.INSERT_BACKGROUND_MEDIA.trackingEventName,element:"none"})},separator:"top",...X},{Icon:P,label:S.ACTIONS.INSERT_TEXT.text,onClick:e=>{z()(e),n.trackEvent("quick_action",{name:S.ACTIONS.INSERT_TEXT.trackingEventName,element:"none"})},...X}]),[X,g,U,H,z]),$=t.useMemo((()=>N(B,I)),[B,I]),J=$.length>0,Q=t.useMemo((()=>{const e=[{Icon:R,label:S.ACTIONS.ADD_ANIMATION.text,onClick:e=>{Y()(e),n.trackEvent("quick_action",{name:S.ACTIONS.ADD_ANIMATION.trackingEventName,element:B?.type})},...X},{Icon:h,label:S.ACTIONS.ADD_LINK.text,onClick:e=>{K()(e),n.trackEvent("quick_action",{name:S.ACTIONS.ADD_LINK.trackingEventName,element:B?.type})},...X}],t={Icon:O,label:S.ACTIONS.RESET_ELEMENT.text,onClick:()=>{w({elementId:B?.id,resetProperties:$,elementType:B?.type}),n.trackEvent("quick_action",{name:S.ACTIONS.RESET_ELEMENT.trackingEventName,element:B?.type})},separator:"top",...X};return J?[...e,t]:e}),[Y,B?.id,B?.type,X,K,J,w,$]),Z=t.useMemo((()=>{const t=[];return e&&t.push({Icon:v,label:S.ACTIONS.REPLACE_MEDIA.text,onClick:()=>{p(m.STORY_EVENTS.onReplaceForegroundMedia),n.trackEvent("quick_action",{name:S.ACTIONS.REPLACE_MEDIA.trackingEventName,element:B?.type})},wrapWithMediaPicker:!0,...X}),[...t,...Q]}),[X,Q,e,p,B?.type]),ee=Q,te=A(B,(e=>k({elementIds:[B?.id],properties:e}))),re=t.useMemo((()=>[{Icon:M,label:S.ACTIONS.AUTO_STYLE_TEXT.text,onClick:()=>{te(),n.trackEvent("quick_action",{name:S.ACTIONS.AUTO_STYLE_TEXT.trackingEventName,element:B?.type})},...X},...Q]),[te,Q,X,B?.type]),se=t.useMemo((()=>{const[e,t]=J?[Z.slice(0,Z.length-1),Z.slice(-1)]:[Z,[]];return[...e,{Icon:b,label:S.ACTIONS.ADD_CAPTIONS.text,onClick:e=>{V()(e),n.trackEvent("quick_action",{name:S.ACTIONS.ADD_CAPTIONS.trackingEventName,element:B?.type})},...X},...t]}),[X,Z,V,B?.type,J]),ne=t.useMemo((()=>{const t=[{Icon:R,label:S.ACTIONS.ADD_ANIMATION.text,onClick:e=>{Y()(e),n.trackEvent("quick_action",{name:S.ACTIONS.ADD_ANIMATION.trackingEventName,element:B?.type,isBackground:!0})},...X}];e&&t.unshift({Icon:v,label:S.ACTIONS.REPLACE_BACKGROUND_MEDIA.text,onClick:()=>{p(m.STORY_EVENTS.onReplaceBackgroundMedia),n.trackEvent("quick_action",{name:S.ACTIONS.REPLACE_BACKGROUND_MEDIA.trackingEventName,element:B?.type,isBackground:!0})},wrapWithMediaPicker:!0,...X});const r={Icon:O,label:S.ACTIONS.RESET_ELEMENT.text,onClick:()=>{w({elementId:B?.id,resetProperties:$,elementType:o.ELEMENT_TYPES.IMAGE}),n.trackEvent("quick_action",{name:S.ACTIONS.RESET_ELEMENT.trackingEventName,element:B?.type,isBackground:!0})},separator:"top",...X};return J?[...t,r]:t}),[X,p,w,Y,e,$,B,J]);if(_.length>1)return[];const oe=Boolean(g&&g?.resource),ie=0===_.length,ae=_?.[0]?.isBackground;if(ie||ae&&!oe)return W;if(ae&&oe){return"video"===B.type?[...ne]:ne}switch(_?.[0]?.type){case o.ELEMENT_TYPES.IMAGE:case o.ELEMENT_TYPES.GIF:return Z;case o.ELEMENT_TYPES.SHAPE:return ee;case o.ELEMENT_TYPES.TEXT:return re;case o.ELEMENT_TYPES.VIDEO:return se;case o.ELEMENT_TYPES.STICKER:return Q;default:return[]}};
