/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),s=require("@googleforcreators/media"),r=require("@googleforcreators/tracking");require("react"),require("prop-types"),require("@googleforcreators/templates"),require("../../config/context.js");var i=require("../../config/useConfig.js");require("../../api/context.js");var t=require("../../api/useAPI.js"),a=require("../utils/useUploadVideoFrame.js"),o=require("../utils/useProcessMedia.js"),n=require("../useUploadMedia.js"),c=require("../utils/useDetectVideoHasAudio.js"),u=require("../utils/useDetectBaseColor.js"),d=require("../utils/useDetectBlurhash.js"),l=require("./types.js");module.exports=function(g,p){const{media:m,pageToken:T,mediaType:h,searchTerm:M}=g,{fetchMediaStart:P,fetchMediaSuccess:f,fetchMediaError:C,resetFilters:E,prependMedia:R,setMediaType:y,setSearchTerm:q,setNextPage:k,setAudioProcessing:b,removeAudioProcessing:B,setPosterProcessing:j,removePosterProcessing:v,setBaseColorProcessing:w,removeBaseColorProcessing:V,setBlurhashProcessing:x,removeBlurhashProcessing:N,updateMediaElement:A,deleteMediaElement:I}=p,{actions:{getMedia:U,updateMedia:F}}=t(),H=e.useRef(!1);e.useEffect((()=>(H.current=!0,()=>{H.current=!1})),[]);const S=e.useCallback((function(){let{searchTerm:e="",pageToken:s=1,mediaType:i,cacheBust:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=arguments.length>1?arguments[1]:void 0;if(!U)return null;P({pageToken:s});const o=r.getTimeTracker("load_media");return U({mediaType:i===l.LOCAL_MEDIA_TYPE_ALL?"":i,searchTerm:e,pagingNum:s,cacheBust:t}).then((r=>{let{data:t,headers:o}=r;if(!H.current)return;const n=parseInt(o.totalPages),c=parseInt(o.totalItems);a({media:t,mediaType:i,searchTerm:e,pageToken:s,nextPageToken:s<n?s+1:void 0,totalPages:n,totalItems:c})})).catch(C).finally((()=>{o()}))}),[C,P,U]),{uploadMedia:z,isUploading:D,isTranscoding:L,isNewResourceProcessing:_,isCurrentResourceProcessing:G,isNewResourceTranscoding:W,isNewResourceMuting:O,isElementTrimming:Y,isCurrentResourceUploading:J,isCurrentResourceTranscoding:K,isCurrentResourceMuting:Q,isCurrentResourceTrimming:X,canTranscodeResource:Z}=n({media:m,prependMedia:R,updateMediaElement:A,deleteMediaElement:I}),{uploadVideoFrame:$}=a({updateMediaElement:A}),{updateVideoIsMuted:ee}=c({updateMediaElement:A}),{updateBaseColor:se}=u({updateMediaElement:A}),{updateBlurHash:re}=d({updateMediaElement:A}),{allowedMimeTypes:{video:ie},capabilities:{hasUploadMediaAction:te}}=i(),ae=e.useRef();ae.current=g;const oe=e.useCallback((()=>{const{mediaType:e}=ae.current;E();const s=!ae.current.pageToken;e||ae.current.searchTerm||!s||S({mediaType:e,cacheBust:!0},f)}),[S,f,E]);e.useEffect((()=>{S({searchTerm:M,pageToken:T,mediaType:h},f)}),[S,f,h,T,M]);const ne=e.useCallback(((e,s)=>{const{posterProcessed:r,posterProcessing:i}=ae.current;(async()=>{r.includes(e)||i.includes(e)||(j({id:e}),await $(e,s),v({id:e}))})()}),[j,$,v]),ce=e.useCallback(((e,s)=>{const{audioProcessed:r,audioProcessing:i}=ae.current;(async()=>{r.includes(e)||i.includes(e)||(b({id:e}),await ee(e,s),B({id:e}))})()}),[b,ee,B]),ue=e.useCallback((e=>{const{baseColorProcessed:s,baseColorProcessing:r}=ae.current,{id:i}=e;(async()=>{s.includes(i)||r.includes(i)||(w({id:i}),await se(e),V({id:i}))})()}),[w,se,V]),de=e.useCallback((e=>{const{blurHashProcessed:s,blurHashProcessing:r}=ae.current,{id:i}=e;(async()=>{s.includes(i)||r.includes(i)||(x({id:i}),await re({resource:e}),N({id:i}))})()}),[ae,x,re,N]),le=e.useCallback((e=>{if(!e)return;const{type:r,isMuted:i,baseColor:t,src:a,id:o,posterId:n,mimeType:c,poster:u,blurHash:d}=e;if(!Z(e))return;te&&(!ie.includes(c)&&"gif"!==r||n||ne(o,a),ie.includes(c)&&null===i&&ce(o,a));const l="image"===r?s.getSmallestUrlForWidth(0,e):u;l&&!t&&ue(e),l&&!d&&de(e)}),[Z,ie,ue,de,ce,ne,te]),{optimizeVideo:ge,optimizeGif:pe,muteExistingVideo:me,trimExistingVideo:Te}=o({postProcessingResource:le,uploadMedia:z,updateMedia:F,deleteMediaElement:I});e.useEffect((()=>{m?.forEach((e=>le(e)))}),[m,h,M,le]);const he=Boolean(ae.current?.posterProcessing?.length);return{state:{...g,isUploading:D||he,isTranscoding:L,isNewResourceProcessing:_,isCurrentResourceProcessing:G,isNewResourceTranscoding:W,isNewResourceMuting:O,isElementTrimming:Y,isCurrentResourceUploading:J,isCurrentResourceTranscoding:K,isCurrentResourceMuting:Q,isCurrentResourceTrimming:X,canTranscodeResource:Z},actions:{setNextPage:k,setMediaType:y,setSearchTerm:q,resetFilters:E,uploadMedia:z,resetWithFetch:oe,uploadVideoPoster:ne,postProcessingResource:le,deleteMediaElement:I,updateMediaElement:A,optimizeVideo:ge,optimizeGif:pe,muteExistingVideo:me,trimExistingVideo:Te}}};
