/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),r=require("@googleforcreators/i18n"),s=require("@googleforcreators/design-system"),o=require("../../utils/usePreventWindowUnload.js"),i=require("../uploader/useUploader.js"),t=require("./utils/useMediaUploadQueue/index.js"),n=require("./utils/getResourceFromLocalFile.js"),a=require("./utils/useFFmpeg.js");const c=s.LOCAL_STORAGE_PREFIX.VIDEO_OPTIMIZATION_DIALOG_DISMISSED;module.exports=function(u){let{media:d,prependMedia:l,updateMediaElement:g,deleteMediaElement:f}=u;const{actions:{validateFileForUpload:m}}=i(),{showSnackbar:p}=s.useSnackbar(),R=o(),{state:{isUploading:U,isTranscoding:E,pending:T,progress:I,uploaded:F,failures:S,finished:w,isNewResourceProcessing:C,isCurrentResourceProcessing:P,isNewResourceTranscoding:b,isNewResourceMuting:M,isElementTrimming:v,isCurrentResourceUploading:_,isCurrentResourceTranscoding:h,isCurrentResourceMuting:q,isCurrentResourceTrimming:y,canTranscodeResource:D},actions:{addItem:N,removeItem:O,finishItem:j}}=t(),{isTranscodingEnabled:L,canTranscodeFile:A,isFileTooLarge:V}=a(),k=e.useRef();k.current=d,e.useEffect((()=>{R("upload",U)}),[U,R]),e.useEffect((()=>{const e=Boolean(s.localStore.getItemByKey(c));E&&e&&p({message:r.__("Video optimization in progress","web-stories"),dismissible:!0})}),[E,p]),e.useEffect((()=>{const e=T.filter((e=>{let{resource:{id:r}}=e;return!k.current.find((e=>{let{id:s}=e;return s===r}))}));if(!e.length)return;for(const{onUploadStart:r,resource:s}of e)r&&r({resource:s});const r=e.map((e=>{let{resource:r}=e;return r}));l({media:r})}),[T,l]),e.useEffect((()=>{for(const{onUploadProgress:e,resource:r}of I){const{id:s}=r;r&&(g({id:s,data:r}),e&&e({id:s,resource:r}))}}),[I,g]),e.useEffect((()=>{for(const{id:e,resource:r,onUploadSuccess:s,previousResourceId:o}of F){const{id:i}=r;r&&(g({id:i,data:r}),o&&g({id:o,data:r}),s&&(s({id:i,resource:r}),o&&s({id:o,resource:r})),j({id:e}))}}),[F,g,j]),e.useEffect((()=>{for(const{id:e}of w)O({id:e})}),[w,O]),e.useEffect((()=>{for(const{id:e,onUploadError:s,error:o,resource:i}of S){const{id:t}=i;s&&s({id:t}),f({id:t}),O({id:e});const n=i&&["video","gif"].includes(i.type)?i.poster:i.src;p({message:o?.message||r.__("File could not be uploaded. Please try a different file.","web-stories"),thumbnail:n&&{src:n,alt:i?.alt},dismissible:!0})}}),[S,f,O,p]);const x=e.useCallback((async function(e){let{onUploadStart:r,onUploadProgress:s,onUploadError:o,onUploadSuccess:i,additionalData:t,muteVideo:a,trimData:c,resource:u,posterFile:d,originalResourceId:l,elementId:g}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e?.length&&await Promise.all(e.reverse().map((async e=>{const f=L&&A(e),R=f&&V(e);try{m(e,f,R)}catch(e){return void p({message:e.message,dismissible:!0})}if(!u||!d){const{resource:r,posterFile:s}=await n(e);d=s,u=r}N({file:e,resource:u,onUploadStart:r,onUploadProgress:s,onUploadError:o,onUploadSuccess:i,additionalData:t,posterFile:d,muteVideo:a,trimData:c,originalResourceId:l,elementId:g})})))}),[p,m,N,A,L,V]);return{uploadMedia:x,isUploading:U,isTranscoding:E,isNewResourceProcessing:C,isCurrentResourceProcessing:P,isNewResourceTranscoding:b,isNewResourceMuting:M,isElementTrimming:v,isCurrentResourceUploading:_,isCurrentResourceTranscoding:h,isCurrentResourceMuting:q,isCurrentResourceTrimming:y,canTranscodeResource:D}};
