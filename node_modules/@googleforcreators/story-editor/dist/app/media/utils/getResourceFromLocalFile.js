/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/media"),t=require("uuid");require("../../../constants/fonts.js");var i=require("../../../constants/media.js");require("../../../constants/multipleValue.js");var r=require("./getPosterName.js");const a=t=>{const i=e.getFileName(t),r=e.getTypeFromMime(t.type);return a={type:r||"image",mimeType:"image"===r?"image/png":"video/mp4",src:"",...e.getResourceSize({}),alt:i},e.createResource({...a,isPlaceholder:!0});var a};module.exports=async o=>{const s=e.getTypeFromMime(o.type);let c=a(o),l=null;try{if("image"===s&&(c=await(async t=>{const i=e.getFileName(t),r=t.type,a=await e.createFileReader(t),o=e.createBlob(new window.Blob([a.result],{type:r})),{width:s,height:c}=await e.getImageDimensions(o);return e.createResource({type:"image",mimeType:r,src:o,...e.getResourceSize({width:s,height:c}),alt:i})})(o)),"video"===s){const t=await(async t=>{const a=e.getFileName(t),o=t.type,s=await e.createFileReader(t),c=e.createBlob(new Blob([s.result],{type:o})),l=await e.preloadVideo(c),n=""!==l.canPlayType(o),{length:g,lengthFormatted:m}=e.getVideoLength(l);await e.seekVideo(l);const u=e.hasVideoGotAudio(l),d=e.blobToFile(await e.getImageFromVideo(l),r(e.getFileName(t)),i.MEDIA_POSTER_IMAGE_MIME_TYPE),p=e.createBlob(d),{width:h,height:y}=await e.getImageDimensions(p);return{resource:e.createResource({type:"video",mimeType:o,src:n?c:"",...e.getResourceSize({width:h,height:y}),poster:p,isMuted:!u,length:g,lengthFormatted:m,alt:a}),posterFile:d}})(o);c=t.resource,l=t.posterFile}}catch{}return c.id=t.v4(),{resource:c,posterFile:l}};
