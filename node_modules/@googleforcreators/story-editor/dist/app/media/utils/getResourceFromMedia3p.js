/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/media"),r=require("../media3p/providerConfiguration.js");function t(e,t){const i=t.sort(((e,r)=>(r.width??0)-(e.width??0))),l=function(e){return{originalWidth:e[0].width,originalHeight:e[0].height}}(i);return i.map((t=>function(e,t,i){const{originalWidth:l,originalHeight:o}=i;if(!l||!o)throw new Error("No original size present.");const a=r.PROVIDERS[e.provider.toLowerCase()];if(!(t.width&&t.height||a.defaultPreviewWidth))throw new Error("Missing width and height for: "+e);return{file:e.name,sourceUrl:t.url,mimeType:t.mimeType,width:t.width??a.defaultPreviewWidth,height:t.height??a.defaultPreviewWidth*o/l}}(e,t,l)))}function i(e){return(e.author||e.registerUsageUrl)&&{author:e.author&&{displayName:e.author.displayName,url:e.author.url},registerUsageUrl:e.registerUsageUrl}}function l(e){return Math.floor(e/60)+":"+Math.floor(e%60).toString().padStart(2,"0")}function o(r){const l=function(e){if("image"!==e.type.toLowerCase())throw new Error("Invalid media type.");if(e.imageUrls?.length<3)throw new Error("Invalid number of urls for asset. Need at least 3: "+e);const r=t(e,e.imageUrls),i=[["full",r[0]],["large",r[1]],...r.slice(2,r.length-1).map((e=>[e.width+"_"+e.height,e])),["web_stories_thumbnail",r[r.length-1]]];return Object.fromEntries(new Map(i))}(r);return e.createResource({id:r.name,baseColor:r.color,blurHash:r.blurHash,type:r.type.toLowerCase(),mimeType:l.full.mimeType,creationDate:r.createTime,src:l.full.sourceUrl,width:l.full.width,height:l.full.height,alt:r.description||r.title||r.name,isExternal:!0,isPlaceholder:!1,sizes:l,attribution:i(r)})}function a(r){const o=function(e){if("video"!==e.type.toLowerCase())throw new Error("Invalid media type.");if(e.videoUrls?.length<2)throw new Error("Invalid number of urls for asset. Need at least 2: "+e);const r=t(e,e.videoUrls);return{full:r[0],preview:r[r.length-1]}}(r),a=parseInt(r.videoMetadata.duration.trimEnd("s"));return e.createResource({id:r.name,baseColor:r.color,posterId:r.name,type:r.type.toLowerCase(),mimeType:o.full.mimeType,creationDate:r.createTime,src:o.full.sourceUrl,width:o.full.width,height:o.full.height,poster:r.imageUrls[0].url,length:a,lengthFormatted:l(a),alt:r.description||r.title||r.name,isExternal:!0,isPlaceholder:!1,isOptimized:!0,isMuted:!0,sizes:o,attribution:i(r)})}function n(r){const{imageUrls:l,videoUrls:o,previewUrl:a}=function(e){if("gif"!==e.type.toLowerCase())throw new Error("Invalid media type");if(e.imageUrls?.length<3)throw new Error("Invalid number of urls for asset. Need at least 3: "+e);const r=e.imageUrls.filter((e=>{let{imageName:r}=e;return r.endsWith("preview")})).map((e=>{let{url:r}=e;return r})).shift(),i=e.imageUrls.filter((e=>{let{url:t}=e;return t!==r})),l=t(e,i),o=t(e,e.videoUrls.filter((e=>{let{mimeType:r}=e;return"image/webm"===r}))),a=t(e,e.videoUrls.filter((e=>{let{mimeType:r}=e;return"video/mp4"===r}))),n=[["full",l[0]],["large",l[1]],...l.slice(2,l.length-1).map((e=>[e.width+"_"+e.height,e])),["web_stories_thumbnail",l[l.length-1]]];return{imageUrls:Object.fromEntries(new Map(n)),videoUrls:{webm:{full:o[0],preview:o[o.length-1]},mp4:{full:a[0],preview:a[o.length-1]}},previewUrl:r}}(r);return e.createResource({id:r.name,baseColor:r.color,posterId:r.name,type:r.type.toLowerCase(),mimeType:l.full.mimeType,creationDate:r.createTime,src:l.full.sourceUrl,width:l.full.width,height:l.full.height,poster:a,alt:r.description||r.title||r.name,isPlaceholder:!1,isOptimized:!0,isExternal:!0,sizes:l,output:{mimeType:o.mp4.full.mimeType,src:o.mp4.full.sourceUrl},attribution:i(r)})}module.exports=function(e){switch(e.type.toLowerCase()){case"image":return o(e);case"video":return a(e);case"gif":return n(e);default:throw new Error("Invalid media type.")}};
