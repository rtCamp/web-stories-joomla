/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("uuid"),r=require("@googleforcreators/react"),t=require("@googleforcreators/tracking"),o=require("@googleforcreators/media");require("react"),require("prop-types"),require("../../config/context.js");var a=require("../../config/useConfig.js");require("@googleforcreators/templates"),require("../../api/context.js"),require("../../currentUser/context.js");var i=require("../../currentUser/useCurrentUser.js");require("../../../constants/fonts.js");var n=require("../../../constants/media.js");require("../../../constants/multipleValue.js");var c=require("../constants.js"),s=require("./getPosterName.js");function E(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}const l="undefined"!=typeof WEB_STORIES_ENV&&"development"===WEB_STORIES_ENV,_=e=>{let{size:r}=e;return r>=n.MEDIA_TRANSCODING_MAX_FILE_SIZE},u={CODEC:["-vcodec","libx264"],SCALE:["-vf",`scale='min(${n.MEDIA_VIDEO_DIMENSIONS_THRESHOLD.WIDTH},iw)':'min(${n.MEDIA_VIDEO_DIMENSIONS_THRESHOLD.HEIGHT},ih)':'force_original_aspect_ratio=decrease',pad='width=ceil(iw/2)*2:height=ceil(ih/2)*2'`],FPS:["-r","24"],FASTSTART:["-movflags","+faststart"],COLOR_PROFILE:["-pix_fmt","yuv420p"],PRESET:["-preset","fast"],SEEK_TO_START:["-ss","00:00:01.000"],SINGLE_FRAME:["-frames:v","1"]},T=[...u.CODEC,...u.SCALE,...u.FPS,...u.FASTSTART,...u.COLOR_PROFILE,...u.PRESET];module.exports=function(){const{ffmpegCoreUrl:d,capabilities:{hasUploadMediaAction:f}}=a(),{currentUser:g}=i((e=>{let{state:r}=e;return{currentUser:r.currentUser}})),m=Boolean(window?.crossOriginIsolated),I=r.useCallback((async e=>{const{createFFmpeg:r,fetchFile:t}=await Promise.resolve().then((function(){return E(require("@ffmpeg/ffmpeg"))})),o=r({corePath:d,log:l});return await o.load(),o.FS("writeFile",e.name,await t(e)),o}),[d]),S=r.useCallback((async r=>{const a=t.getTimeTracker("load_video_poster_ffmpeg");let i;try{i=await I(r);const t=e.v4()+"."+n.MEDIA_POSTER_IMAGE_FILE_TYPE,c=o.getFileName(r),E=s(c);await i.run(...u.SEEK_TO_START,"-i",r.name,...u.SINGLE_FRAME,...u.SCALE,...u.COLOR_PROFILE,...u.PRESET,t);const l=i.FS("readFile",t);return o.blobToFile(new Blob([l.buffer],{type:n.MEDIA_POSTER_IMAGE_MIME_TYPE}),E,n.MEDIA_POSTER_IMAGE_MIME_TYPE)}catch(e){throw console.error(e),t.trackError("video_poster_generation_ffmpeg",e.message),e}finally{try{i.exit()}catch{}a()}}),[I]),D=r.useCallback((async r=>{const a=t.getTimeTracker("load_video_transcoding");let i;try{i=await I(r);const t=e.v4()+"."+n.MEDIA_TRANSCODED_FILE_TYPE,c=o.getFileName(r)+"."+n.MEDIA_TRANSCODED_FILE_TYPE;await i.run("-i",r.name,...T,t);const s=i.FS("readFile",t);return o.blobToFile(new Blob([s.buffer],{type:n.MEDIA_TRANSCODED_MIME_TYPE}),c,n.MEDIA_TRANSCODED_MIME_TYPE)}catch(e){throw console.error(e),t.trackError("video_transcoding",e.message),e}finally{try{i.exit()}catch{}a()}}),[I]),F=r.useCallback((async(r,a,i)=>{const c=t.getTimeTracker("load_trim_video_transcoding");let s;try{s=await I(r);const t=r?.type||n.MEDIA_TRANSCODED_MIME_TYPE,E=o.getExtensionFromMimeType(t),l=e.v4()+"."+E,_=o.getFileName(r)+"-trimmed."+E;await s.run("-i",r.name,"-ss",a,"-to",i,l);const u=s.FS("readFile",l);return o.blobToFile(new Blob([u.buffer],{type:t}),_,t)}catch(e){throw console.log(e),t.trackError("trim_video_transcoding",e.message),e}finally{try{s.exit()}catch{}c()}}),[I]),M=r.useCallback((async r=>{const a=t.getTimeTracker("load_mute_video_transcoding");let i;try{i=await I(r);const t=r?.type||n.MEDIA_TRANSCODED_MIME_TYPE,c=o.getExtensionFromMimeType(t),s=e.v4()+"."+c,E=o.getFileName(r)+"-muted."+c;await i.run("-i",r.name,"-vcodec","copy","-an",s);const l=i.FS("readFile",s);return o.blobToFile(new Blob([l.buffer],{type:t}),E,t)}catch(e){throw console.log(e),t.trackError("mute_video_transcoding",e.message),e}finally{try{i.exit()}catch{}a()}}),[I]),A=r.useCallback((async r=>{const a=t.getTimeTracker("load_gif_conversion");let i;try{i=await I(r);const t=e.v4()+"."+n.MEDIA_TRANSCODED_FILE_TYPE,c=o.getFileName(r)+"."+n.MEDIA_TRANSCODED_FILE_TYPE;await i.run("-i",r.name,...T,t);const s=i.FS("readFile",t);return new o.blobToFile(new Blob([s.buffer],{type:n.MEDIA_TRANSCODED_MIME_TYPE}),c,n.MEDIA_TRANSCODED_MIME_TYPE)}catch(e){throw console.error(e),t.trackError("gif_conversion",e.message),e}finally{try{i.exit()}catch(e){}a()}}),[I]),O=r.useCallback((e=>c.TRANSCODABLE_MIME_TYPES.includes(e.type)),[]),p=Boolean(g?.mediaOptimization),y=f&&p&&m;return r.useMemo((()=>({isTranscodingEnabled:y,canTranscodeFile:O,isFileTooLarge:_,transcodeVideo:D,stripAudioFromVideo:M,getFirstFrameOfVideo:S,convertGifToVideo:A,trimVideo:F})),[y,O,D,M,S,A,F])};
