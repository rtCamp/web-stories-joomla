/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),r=require("@googleforcreators/tracking"),i=require("@googleforcreators/media"),t=require("../../../uploader/useUploader.js"),a=require("../../../../utils/noop.js"),s=require("../useUploadVideoFrame.js"),u=require("../useFFmpeg.js"),o=require("../getResourceFromLocalFile.js"),n=require("./reducer.js"),c=require("./constants.js");const d={queue:[]};module.exports=function(){const{actions:{uploadFile:T}}=t(),{isTranscodingEnabled:l,canTranscodeFile:I,transcodeVideo:S,stripAudioFromVideo:m,getFirstFrameOfVideo:f,convertGifToVideo:E,trimVideo:M}=u(),[U,g]=e.useReduction(d,n),{uploadVideoPoster:A}=s({updateMediaElement:a.noop}),p=e.useRef(!1),D=e.useRef(null),_=e.useRef(null),{startUploading:N,finishUploading:q,cancelUploading:R,startTranscoding:y,startMuting:h,startTrimming:C,finishTranscoding:G,finishMuting:w,finishTrimming:F,replacePlaceholderResource:P}=g;e.useEffect((()=>{(async()=>{await Promise.all(U.queue.map((async e=>{const{id:r,file:i,state:t,resource:a}=e;if([c.ITEM_STATUS.TRIMMED,c.ITEM_STATUS.MUTED,c.ITEM_STATUS.TRANSCODED].includes(t)&&a.isPlaceholder&&!a.poster)try{const{resource:e,posterFile:t}=await o(i);if(!p.current)return;P({id:r,resource:e,posterFile:t})}catch{}})))})()}),[U.queue,P]),e.useEffect((()=>{(async()=>{await Promise.all(U.queue.map((async e=>{const{id:r,file:t,state:a,resource:s}=e;if(c.ITEM_STATUS.PENDING!==a||!s.isPlaceholder)return;if(!l||!I(t))return;if(!(null!==_.current)){_.current=r;try{const e=await f(t),a=i.createBlob(e),{width:u,height:o}=await i.getImageDimensions(a),n={...s,poster:a,width:u,height:o};if(!p.current)return;P({id:r,resource:n,posterFile:e})}catch{}finally{_.current=null}}})))})()}),[U.queue,l,I,f,P]);const v=e.useCallback((async e=>{const{id:i,file:t,additionalData:a={}}=e;y({id:i});try{const e=await E(t);if(!p.current)return;a.mediaSource="gif-conversion",a.isMuted=!0,G({id:i,file:e,additionalData:a})}catch(e){R({id:i,error:e}),r.trackError("upload_media",e?.message)}finally{D.current=null}}),[y,G,E,R]),b=e.useCallback((async e=>{const{id:i,file:t,additionalData:a={},trimData:s}=e;C({id:i});try{const e=await M(t,s.start,s.end);if(!p.current)return;a.meta={...a.meta,trimData:s},F({id:i,file:e,additionalData:a})}catch(e){R({id:i,error:e}),r.trackError("upload_media",e?.message)}finally{D.current=null}}),[C,F,M,R]),k=e.useCallback((async e=>{const{id:i,file:t,additionalData:a={}}=e;h({id:i});try{const e=await m(t);if(!p.current)return;a.isMuted=!0,w({id:i,file:e,additionalData:a})}catch(e){R({id:i,error:e}),r.trackError("upload_media",e?.message)}finally{D.current=null}}),[h,w,m,R]),O=e.useCallback((async e=>{const{id:i,file:t,additionalData:a={}}=e;y({id:i});try{const e=await S(t);if(!p.current)return;a.mediaSource="video-optimization",G({id:i,file:e,additionalData:a})}catch(e){R({id:i,error:e}),r.trackError("upload_media",e?.message)}finally{D.current=null}}),[y,G,S,R]),L=e.useCallback((async e=>{const{id:r,file:t,resource:a,additionalData:s={}}=e;let{posterFile:u}=e,o=await T(t,s);if(p.current){if(!a.poster&&!u)try{u=await f(t)}catch{}try{const e=i.getFileName(u),{poster:r,posterId:t}=await A(o.id,e,u);if(!p.current)return;o={...o,poster:r||o.poster||a.poster,posterId:t}}catch{}q({id:r,resource:o})}}),[q,f,T,A]),V=e.useCallback((async e=>{const{id:r,file:i,additionalData:t={}}=e,a=await T(i,t);p.current&&q({id:r,resource:a})}),[q,T]),j=e.useCallback((async e=>{const{id:i,file:t,resource:a}=e;N({id:i}),r.trackEvent("upload_media",{file_size:t?.size,file_type:t?.type});const s=r.getTimeTracker("load_upload_media");try{["video","gif"].includes(a.type)?await L(e):await V(e)}catch(e){R({id:i,error:e}),r.trackError("upload_media",e?.message)}finally{s()}}),[N,R,V,L]);return e.useEffect((()=>{(async()=>{await Promise.all(U.queue.map((async e=>{const{id:r,file:t,state:a,resource:s,additionalData:u={},muteVideo:o,trimData:n}=e;if(c.ITEM_STATUS.PENDING!==a)return;"video"===s.type&&null!==s.isMuted&&void 0===u?.isMuted&&(u.isMuted=s.isMuted),s?.baseColor&&(u.meta={...u.meta,baseColor:s.baseColor}),s?.blurHash&&!s?.trimData&&(u.meta={...u.meta,blurHash:s.blurHash});const d="image/gif"===s.mimeType&&i.isAnimatedGif(await t.arrayBuffer()),T=l&&(d||I(t)),S=null!==D.current;if(!T||!S){if(l){if(d)return D.current=r,void v(e);if(I(t))return D.current=r,n?void b(e):o?void k(e):void O(e)}j(e)}})))})()}),[U.queue,l,I,v,b,k,O,j]),e.useEffect((()=>{U.queue.map((e=>{const{state:r}=e;[c.ITEM_STATUS.TRANSCODED,c.ITEM_STATUS.MUTED,c.ITEM_STATUS.TRIMMED].includes(r)&&j(e)}))}),[U.queue,j]),e.useEffect((()=>(p.current=!0,()=>{p.current=!1})),[]),e.useMemo((()=>{const e=U.queue.filter((e=>![c.ITEM_STATUS.PENDING,c.ITEM_STATUS.CANCELLED,c.ITEM_STATUS.UPLOADED,c.ITEM_STATUS.FINISHED].includes(e.state))),r=U.queue.filter((e=>e.state===c.ITEM_STATUS.PENDING)),i=U.queue.filter((e=>e.state===c.ITEM_STATUS.UPLOADED)),t=U.queue.filter((e=>e.state===c.ITEM_STATUS.FINISHED));return{state:{progress:e,pending:r,uploaded:i,failures:U.queue.filter((e=>e.state===c.ITEM_STATUS.CANCELLED)),finished:t,isUploading:U.queue.some((e=>![c.ITEM_STATUS.FINISHED,c.ITEM_STATUS.CANCELLED,c.ITEM_STATUS.PENDING].includes(e.state))),isTranscoding:U.queue.some((e=>e.state===c.ITEM_STATUS.TRANSCODING)),isMuting:U.queue.some((e=>e.state===c.ITEM_STATUS.MUTING)),isTrimming:U.queue.some((e=>e.state===c.ITEM_STATUS.TRIMMING)),isCurrentResourceMuting:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.MUTING&&r.resource.id===e)),isCurrentResourceProcessing:e=>U.queue.some((r=>[c.ITEM_STATUS.TRANSCODING,c.ITEM_STATUS.TRIMMING,c.ITEM_STATUS.MUTING].includes(r.state)&&r.resource.id===e)),isCurrentResourceUploading:e=>U.queue.some((r=>[c.ITEM_STATUS.PENDING,c.ITEM_STATUS.UPLOADING,c.ITEM_STATUS.UPLOADED,c.ITEM_STATUS.FINISHED].includes(r.state)&&(r.resource.id===e||r.previousResourceId===e))),isCurrentResourceTranscoding:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.TRANSCODING&&r.resource.id===e)),isCurrentResourceTrimming:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.TRIMMING&&r.resource.id===e)),isNewResourceMuting:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.MUTING&&r.originalResourceId===e)),isNewResourceProcessing:e=>U.queue.some((r=>[c.ITEM_STATUS.TRANSCODING,c.ITEM_STATUS.TRIMMING,c.ITEM_STATUS.MUTING].includes(r.state)&&r.originalResourceId===e)),isNewResourceTranscoding:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.TRANSCODING&&r.originalResourceId===e)),isElementTrimming:e=>U.queue.some((r=>r.state===c.ITEM_STATUS.TRIMMING&&r.elementId===e)),canTranscodeResource:e=>{const{isExternal:r,id:i,src:t}=e||{};return!r&&t&&!U.queue.some((e=>e.resource.id===i||e.previousResourceId===i||e.originalResourceId===i))}},actions:{addItem:g.addItem,removeItem:g.removeItem,finishItem:g.finishItem}}}),[U,g])};
