/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),r=require("@googleforcreators/tracking"),t=require("@googleforcreators/media");require("react"),require("prop-types"),require("@googleforcreators/templates"),require("../../config/context.js");var o=require("../../config/useConfig.js");require("../../api/context.js");var s=require("../../api/useAPI.js");require("../../../constants/fonts.js"),require("../../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../story/context.js"),require("@googleforcreators/migration"),require("../../history/historyProvider.js"),require("../../history/context.js"),require("../../story/actions/useSaveStory.js"),require("clone-deep"),require("../../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../story/storyTriggers/storyTriggersProvider.js"),require("../../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../story/storyTriggers/storyEvents/onPageAddedRegister.js");var i=require("../../story/useStory.js"),a=require("../../uploader/useUploader.js"),u=require("./getPosterName.js");module.exports=function(d){let{updateMediaElement:n}=d;const{actions:{updateMedia:c}}=s(),{actions:{uploadFile:g}}=a(),{storyId:l}=o(),{updateElementsByResourceId:p}=i((e=>({updateElementsByResourceId:e.actions.updateElementsByResourceId}))),y=e.useCallback((async(e,r,o)=>{if(!o)return{};o.name||(o.name=r);const s=await g(o,{mediaId:e,mediaSource:"poster-generation"}),{id:i,src:a,width:u,height:d}=s;e&&await c(e,{posterId:i,storyId:l});try{await t.preloadImage({src:a})}catch{}return{posterId:i,poster:a,posterWidth:u,posterHeight:d}}),[l,c,g]);return{uploadVideoFrame:e.useCallback((async(e,o)=>{const s=r.getTimeTracker("load_video_poster");try{const r=t.getFileNameFromUrl(o),i=u(r),a=await t.getFirstFrameOfVideo(o),{posterId:d,poster:c,posterWidth:g,posterHeight:l}=await y(e,i,a),q=g&&l&&{width:g,height:l}||null;p({id:e,properties:e=>{let{resource:r}=e;return{resource:{...r,posterId:d,poster:c,...q}}}}),n({id:e,data:{posterId:d,poster:c,...q}})}catch(e){r.trackError("video_poster_generation",e.message)}finally{s()}}),[y,p,n]),uploadVideoPoster:y}};
