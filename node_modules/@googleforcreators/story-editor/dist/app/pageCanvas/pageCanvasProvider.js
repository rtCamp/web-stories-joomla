/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react");require("prop-types");var r=require("@googleforcreators/react"),t=require("../../utils/storyPageToCanvas.js"),a=require("../../utils/contrastUtils.js"),s=require("../../utils/useIdleTaskQueue.js"),n=require("../../constants/index.js");require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../config/context.js"),require("../api/context.js"),require("../history/historyProvider.js"),require("../history/context.js"),require("../story/actions/useSaveStory.js"),require("clone-deep"),require("../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../story/storyTriggers/storyTriggersProvider.js"),require("../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../story/storyTriggers/storyEvents/onPageAddedRegister.js");var o=require("../story/useStory.js"),i=require("./context.js"),u=require("./getPixelDataFromCanvas.js"),l=require("./usePageCanvasMap.js"),c=require("./usePageSnapshot.js"),g=require("./pageCanvasCacheValidator.js"),d=require("./getPageWithoutSelection.js");function q(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var v=q(e);module.exports=function PageCanvasProvider(e){let{children:q}=e;const p=s(),[y,C]=l(),{getSnapshotCanvas:P,setSnapshot:j}=c(),f=o((e=>{let{state:r}=e;return r.pages.map((e=>{let{id:r}=e;return r}))})),{currentPage:m,singleElementSelection:S}=o((e=>{let{state:r}=e;return{singleElementSelection:1===r.selectedElementIds?.length?r.selectedElementIds:n.STABLE_ARRAY,currentPage:r.currentPage}})),E={currentPageValue:m,pageCanvasMapValue:y,singleElementSelectionValue:S},h=r.useRef(E);h.current=E;const x=r.useCallback((e=>{let[r,a]=e;return p([r,async()=>{const e=await t(a,{});C.setPageCanvas({pageId:a.id,canvas:e})}])}),[p,C]),b=r.useCallback((()=>{const{currentPageValue:e,pageCanvasMapValue:r}=h.current;r[e.id]||x([e.id,e])}),[x]),T=r.useCallback((async(e,r)=>{const a=d(e,r);let s=P(a);return s||(s=await t(a,{}),j({page:a,canvas:s})),s}),[j,P]),V=r.useCallback((async e=>{const{pageCanvasMapValue:r}=h.current;let a=r[e.id];return a||(a=await t(e,{}),C.setPageCanvas({pageId:e.id,canvas:a})),a}),[C]),k=r.useCallback((async e=>{const{currentPageValue:r,singleElementSelectionValue:t}=h.current;let s;s=t.includes(e.id)?await T(r,t):await V(r);const{fontSize:n}=e,o=u(s,e);return a.getAccessibleTextColorsFromPixels(o,n)}),[T,V]);return v.default.createElement(i.Provider,{value:{state:{pageCanvasMap:y},actions:{calculateAccessibleTextColors:k,generateDeferredPageCanvas:x,generateDeferredCurrentPageCanvas:b}}},f.map((e=>v.default.createElement(g,{key:e,pageId:e,clearPageCanvasCache:C.clearPageCanvas}))),q)};
