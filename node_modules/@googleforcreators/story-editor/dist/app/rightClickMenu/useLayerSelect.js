/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/react"),t=require("sat"),o=require("@googleforcreators/i18n"),s=require("@googleforcreators/design-system"),n=require("@googleforcreators/tracking"),i=require("styled-components"),u=require("@googleforcreators/elements"),l=require("@googleforcreators/units"),a=require("../story/useStory.js");require("prop-types"),require("../layout/context.js"),require("../layout/useZoomSetting.js"),require("../../constants/fonts.js"),require("../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("../story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../config/context.js");var c=require("../config/useConfig.js");require("../api/context.js"),require("../history/historyProvider.js"),require("../history/context.js"),require("../story/actions/useSaveStory.js"),require("clone-deep"),require("../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../story/storyTriggers/storyTriggersProvider.js"),require("../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/media"),require("../media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../utils/generateBlurhash.worker.js"),require("../media/media3p/providerConfiguration.js"),require("../media/utils/useFFmpeg.js"),require("../media/media3p/api/context.js"),require("../media/local/constants.js"),require("../media/media3p/providerReducer.js"),require("../media/context.js"),require("@googleforcreators/stickers"),require("../../components/library/panes/text/textPresets.js"),require("../canvas/context.js");var g=require("../canvas/useCanvas.js");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=d(e),f=d(t);const y=d(i).default(s.Icons.ChevronRightSmall).withConfig({displayName:"useLayerSelect__ReversedIcon",componentId:"sc-169lxcx-0"})(["transform:rotate(180deg);"]);module.exports=function(e){let{menuItemProps:t,menuPosition:i,isMenuOpen:d}=e;const{isRTL:q}=c(),[p,h]=r.useState(!1),j=g((e=>{let{state:{nodesById:r}}=e;return r})),{currentPage:x,selectedElements:v,setSelectedElementsById:S}=a((e=>{let{state:{currentPage:r,selectedElements:t},actions:{setSelectedElementsById:o}}=e;return{currentPage:r,selectedElements:t,setSelectedElementsById:o}})),I=l.useUnits((e=>{let{actions:{getBox:r}}=e;return r}));r.useEffect((()=>{d||h(!1)}),[d]);const{x:k,y:B}=i,w=r.useCallback((()=>{if(!x?.elements?.length||!Object.keys(j)?.length)return[];const e=new f.default.Vector(k,B),r=x.elements.find((e=>{let{isBackground:r}=e;return r})),t=j[r.id],{x:o,y:s,width:n,height:i}=t.getBoundingClientRect(),u=new f.default.Box(new f.default.Vector(o,s),n,i).toPolygon(),l=-I(r).y,a=x.elements.map((e=>{if(e.isBackground)return{element:e,polygon:u};const{id:r,rotationAngle:t}=e;if(!j[r])return null;const o=I(e),s=new f.default.Vector(u.pos.x+o.x+o.width/2,u.pos.y+l+o.y+o.height/2),n=new f.default.Box(s,o.width,o.height).toPolygon(),i=new f.default.Vector(-o.width/2,-o.height/2);return n.setOffset(i),n.setAngle(t*Math.PI/180),{element:e,polygon:n}})).map((r=>{let{element:t,polygon:o}=r;return f.default.pointInPolygon(e,o)?t:null})).filter(Boolean);return a.reverse(),a}),[x,I,k,B,j]),E=r.useMemo((()=>{if(!d||0===v.length)return[];const e=w();return 1===e.length&&e[0].id===v[0].id?[]:e.map((e=>{const{id:r,isBackground:i,type:l}=e,{LayerContent:a}=u.getDefinitionForType(l);return{key:r,supportsIcon:!0,icon:v[0].id===r?m.default.createElement(s.Icons.CheckmarkSmall,null):null,label:i?m.default.createElement("span",null,o.__("Background","web-stories")):m.default.createElement(a,{element:e}),onClick:()=>{S({elementIds:[r]}),n.trackEvent("context_menu_action",{name:"layer_selected",element:l,isBackground:i})},...t}}))}),[w,d,t,S,v]);return E.length>0?{label:o.__("Select Layer","web-stories"),openSubMenu:()=>h(!0),closeSubMenu:()=>h(!1),isSubMenuOpen:p,subMenuItems:p?E:[],SuffixIcon:q?y:s.Icons.ChevronRightSmall,...t}:null};
