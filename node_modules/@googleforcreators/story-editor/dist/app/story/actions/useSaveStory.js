/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/i18n"),s=require("@googleforcreators/react"),t=require("@googleforcreators/tracking"),r=require("@googleforcreators/design-system"),o=require("@googleforcreators/dom");require("react"),require("prop-types"),require("@googleforcreators/templates"),require("../../config/context.js");var i=require("../../config/useConfig.js");require("../../api/context.js");var a=require("../../api/useAPI.js"),u=require("../../../utils/useRefreshPostEditURL.js"),n=require("../utils/getStoryPropsToSave.js");require("../../history/historyProvider.js");var l=require("../../history/useHistory.js");const d={400:e._x("Bad Request","HTTP status description","web-stories"),401:e._x("Unauthorized","HTTP status description","web-stories"),403:e._x("Forbidden","HTTP status description","web-stories"),500:e._x("Internal Server Error","HTTP status description","web-stories")};module.exports=function(c){let{storyId:g,pages:p,story:y,updateStory:v}=c;const{actions:{saveStoryById:f}}=a(),{actions:{resetNewChanges:b}}=l(),{metadata:h,flags:q}=i(),{showSnackbar:_}=r.useSnackbar(),[k,m]=s.useState(!1),[w,P]=s.useState(!1),{editLink:T}=y,S=u(g,T);return{saveStory:s.useCallback((s=>{m(!0);const r=["publish","future","private"].includes(y.status),i=t.getTimeTracker("load_save_story");return Promise.resolve().then((()=>f({storyId:g,...n({story:y,pages:p,metadata:h,flags:q}),...s}))).then((e=>{const{status:s,slug:t,link:o,previewLink:i,editLink:a,embedPostLink:u,featuredMedia:n}=e;v({properties:{status:s,slug:t,link:o,previewLink:i,editLink:a,embedPostLink:u,featuredMedia:n}}),S();const l=["publish","future","private"].includes(e.status);P(!r&&l)})).catch((s=>{const r=s.message?o.stripHTML(s.message):null;let i=e.__("Failed to save the story","web-stories");r&&(i=e.sprintf(
/* translators: %s: error message */
e.__("Failed to save the story: %s","web-stories"),r)),Object.prototype.hasOwnProperty.call(d,s?.data?.status)&&(i=r?e.sprintf(
/* translators: 1: error message. 2: status code */
e.__("Failed to save the story: %1$s (%2$s)","web-stories"),r,d[s?.data?.status]):e.sprintf(
/* translators: %s: error message */
e.__("Failed to save the story: %s","web-stories"),d[s?.data?.status])),console.log(e.__("Failed to save the story","web-stories"),s),t.trackError("save_story",r),_({message:i,dismissible:!0})})).finally((()=>{m(!1),b(),i()}))}),[y,p,h,f,g,v,S,_,b,q]),isSaving:k,isFreshlyPublished:w}};
