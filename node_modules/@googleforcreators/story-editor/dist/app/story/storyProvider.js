/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react");require("prop-types");var t=require("@googleforcreators/react"),r=require("../../constants/index.js"),s=require("./context.js"),i=require("./effects/useLoadStory.js"),n=require("./actions/useSaveStory.js"),o=require("./effects/useHashState.js"),a=require("./effects/useHistoryEntry.js"),u=require("./effects/useHistoryReplay.js"),l=require("./useStoryReducer/useStoryReducer.js"),c=require("./actions/useAutoSave.js"),d=require("./storyTriggers/storyTriggersProvider.js");function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("./storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("./storyTriggers/storyEvents/onPageAddedRegister.js");var g=y(e);module.exports=function StoryProvider(e){let{storyId:y,initialEdits:S,children:f}=e;const[m,v]=o.default("page",null),{state:A,api:p,internal:{restore:E}}=l({current:m}),{pages:q,current:R,selection:h,story:j,animationState:P,capabilities:T,copiedElementState:I}=A;t.useEffect((()=>v(R)),[R,v]);let b=null,L=null,x=null,B=null;R&&(b=R,L=q.findIndex((e=>{let{id:t}=e;return t===R})),x=L+1,B=q[L]);const Y=t.useMemo((()=>h.length>0?h:r.STABLE_ARRAY),[h]),_=!B,M=B?.elements,H=t.useMemo((()=>{if(_)return r.STABLE_ARRAY;const e=M.filter((e=>{let{id:t}=e;return h.includes(t)}));return e.length>0?e:r.STABLE_ARRAY}),[_,M,h]),F=B?.animations,N=t.useMemo((()=>{if(_)return r.STABLE_ARRAY;const e=(F||[]).reduce(((e,t)=>{let{targets:r,...s}=t;return r.some((e=>h.includes(e)))?[...e,{targets:r,...s}]:e}),[]);return e.length>0?e:r.STABLE_ARRAY}),[_,h,F]),k=H.length>0,w=0===q.length;i({restore:E,shouldLoad:w,storyId:y,story:S?.story}),a({pages:q,current:R,selection:h,story:j,capabilities:T}),u({restore:E});const{updateStory:z}=p,{saveStory:C,isSaving:D,isFreshlyPublished:G}=n({storyId:y,pages:q,story:j,updateStory:z}),{autoSave:J,isAutoSaving:K}=c({storyId:y,pages:q,story:j}),O=t.useMemo((()=>({pages:q,currentPage:B,currentPageId:b,currentPageIndex:L,currentPageNumber:x,selectedElementIds:Y,selectedElements:H,selectedElementAnimations:N,hasSelection:k,story:j,animationState:P,capabilities:T,meta:{isSaving:D||K,isSavingStory:D,isAutoSavingStory:K,isFreshlyPublished:G},copiedElementState:I})),[q,B,b,L,x,Y,H,N,k,j,P,T,D,K,G,I]),Q={state:O,actions:{...p,autoSave:J,saveStory:C},internal:{reducerState:A,restore:E}};return g.default.createElement(s.Provider,{value:Q},g.default.createElement(d.StoryTriggersProvider,{story:O},f))};
