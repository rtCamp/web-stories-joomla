/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/react"),t=require("../../utils/cleanForSlug.js");require("prop-types"),require("@googleforcreators/templates"),require("../config/context.js"),require("../api/context.js");var s=require("../api/useAPI.js");require("../history/historyProvider.js");var o=require("../history/useHistory.js");require("../../constants/fonts.js"),require("../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../story/context.js"),require("@googleforcreators/migration"),require("../story/actions/useSaveStory.js"),require("clone-deep"),require("../story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../story/storyTriggers/storyTriggersProvider.js"),require("../story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../story/storyTriggers/storyEvents/onPageAddedRegister.js");var a=require("../story/useStory.js"),i=require("./context.js"),n=require("./utils/index.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=u(e);function l(){return l=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},l.apply(this,arguments)}module.exports=function TaxonomyProvider(e){const[u,g]=r.useState([]),[y,d]=r.useState({}),[m,f]=r.useState(!0),{actions:{clearHistory:h}}=o(),{updateStory:p,isStoryLoaded:q,terms:j,hasTaxonomies:v}=a((e=>{let{state:{pages:r,story:t},actions:{updateStory:s}}=e;return{updateStory:s,isStoryLoaded:r.length>0,terms:t.terms,hasTaxonomies:t?.taxonomies?.length>0}})),{getTaxonomyTerm:T,createTaxonomyTerm:S,getTaxonomies:x}=s((e=>{let{actions:r}=e;return r}));r.useEffect((()=>{v&&async function(){try{const e=await x();g(e)}catch(e){console.error(e.message)}}()}),[v,x]);const b=r.useRef(!1);r.useEffect((()=>{if(u.length>0&&q&&!b.current){const e=n.dictionaryOnKey(u,"slug"),r=n.mapObjectKeys(n.cacheFromEmbeddedTerms(j),(r=>e[r]?.restBase)),t=n.mapObjectVals(r,(e=>Object.values(e).map((e=>e.id))));d(r),h(),p({properties:{terms:t}}),b.current=!0}}),[j,q,u,d,h,p]);const E=r.useCallback((function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];p({properties:t=>{const s="function"==typeof r?r(t.terms[e.restBase]):r;return{...t,terms:{...t.terms,[e.restBase]:s}}}})}),[p]),P=r.useCallback(((e,r)=>{E(e,(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.includes(r.id)?e:[...e,r.id]}))}),[E]),O=r.useCallback((async function(e,r){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=[];const a=e?.restPath;if(!a)return[];try{o=await T(a,r)}catch(e){console.error(e.message)}if(o.length<1)return o;const i={[e.restBase]:n.dictionaryOnKey(o,"slug")};if(d((e=>n.mergeNestedDictionaries(e,i))),s&&r.search){const s=t(r.search),a=o.find((e=>e.slug===s));a&&P(e,a)}return o}),[T,P]),B=r.useCallback((async function(e,r,s){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const a={name:r};s?.id&&(a.parent=s.id,a.slug=`${s.slug}-${t(a.name)}`);const i=a?.slug||t(r),u=y[e.restBase]?.[i];if(u)return void(o&&P(e,u));const c=e?.restPath;if(c)try{const r=await S(c,a),t={[e.restBase]:{[r.slug]:r}};d((e=>n.mergeNestedDictionaries(e,t))),o&&P(e,r)}catch(t){"term_exists"===t.code&&O(e,{search:r},o)}}),[S,y,O,P]);r.useEffect((()=>{if(m&&u?.length){u.filter((e=>e.hierarchical)).forEach((e=>O(e,{per_page:-1}))),f(!1)}}),[O,m,u]);const C=r.useMemo((()=>({state:{taxonomies:u,termCache:y,terms:Array.isArray(j)?{}:j},actions:{createTerm:B,addSearchResultsToCache:O,setTerms:E,addTermToSelection:P}})),[y,j,u,B,O,E,P]);return c.default.createElement(i.Provider,l({},e,{value:C}))};
