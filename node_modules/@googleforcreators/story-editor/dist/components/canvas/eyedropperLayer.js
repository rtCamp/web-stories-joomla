/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/react"),t=require("styled-components"),o=require("polished"),a=require("@googleforcreators/units"),i=require("@googleforcreators/design-system");require("@googleforcreators/transform"),require("../dropTargets/provider.js"),require("../dropTargets/context.js"),require("../../app/history/historyProvider.js"),require("../../app/history/context.js"),require("prop-types"),require("@googleforcreators/templates"),require("../../app/config/context.js"),require("../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../constants/fonts.js"),require("../../constants/multipleValue.js"),require("../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../app/story/context.js"),require("@googleforcreators/migration"),require("../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("@googleforcreators/i18n"),require("../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../utils/generateBlurhash.worker.js"),require("../../app/media/media3p/providerConfiguration.js"),require("../../app/media/utils/useFFmpeg.js"),require("../../app/media/media3p/api/context.js"),require("../../app/media/local/constants.js"),require("../../app/media/media3p/providerReducer.js"),require("../../app/media/context.js"),require("sat");var s=require("../../app/layout/useLayout.js");require("../../app/layout/context.js"),require("../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../library/panes/text/textPresets.js"),require("../../app/canvas/context.js");var n=require("../../app/canvas/useCanvas.js");require("../../app/currentUser/context.js"),require("../../app/helpCenter/provider.js"),require("../../app/helpCenter/context.js"),require("../helpCenter/constants.js"),require("../../app/rightClickMenu/context.js");var p=require("./layout.js"),l=require("./utils/getColorFromPixelData.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=u(e),c=u(t);const g=c.default(p.Layer).withConfig({displayName:"eyedropperLayer__EyedropperBackground",componentId:"sc-nf74gq-0"})(["background:",";cursor:not-allowed;z-index:2;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64})),f=c.default(p.PageArea).withConfig({displayName:"eyedropperLayer__DisplayPageArea",componentId:"sc-nf74gq-1"})(["position:absolute;"]),y=c.default.div.withConfig({displayName:"eyedropperLayer__EyedropperCanvas",componentId:"sc-nf74gq-2"})(["background:transparent;border-radius:5px;position:absolute;z-index:2;transform:translateZ(0);top:0;left:0;bottom:0;right:0;cursor:default;"]),m=c.default.div.withConfig({displayName:"eyedropperLayer__ColorInfo",componentId:"sc-nf74gq-3"})(["text-transform:uppercase;margin-top:30px;padding:9px;min-width:102px;text-align:center;"]),q=c.default.div.withConfig({displayName:"eyedropperLayer__Circle",componentId:"sc-nf74gq-4"})(["transform:translateY(20px);background:",";border:2px solid black;border-radius:50%;overflow:hidden;width:","px;height:","px;"],(e=>{let{theme:r}=e;return r.colors.bg.primary}),198,200),h=c.default.div.withConfig({displayName:"eyedropperLayer__Magnifier",componentId:"sc-nf74gq-5"})(["position:absolute;top:0;left:0;transform:translateY(-2000px);pointer-events:none;"]),x=c.default.div.withConfig({displayName:"eyedropperLayer__Center",componentId:"sc-nf74gq-6"})(["position:absolute;top:0;left:0;right:0;bottom:0;z-index:3;background:",";cursor:not-allowed;display:flex;justify-content:center;align-items:center;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64})),b=c.default.img.withConfig({displayName:"eyedropperLayer__CanvasImage",componentId:"sc-nf74gq-7"})(["width:100%;"]);module.exports=function EyedropperLayer(){const{fullbleedContainer:e,isEyedropperActive:t,eyedropperCallback:p,eyedropperImg:u,eyedropperPixelData:c,setIsEyedropperActive:E,setEyedropperImg:j,setEyedropperPixelData:v}=n((e=>{let{state:{fullbleedContainer:r,isEyedropperActive:t,eyedropperCallback:o,eyedropperImg:a,eyedropperPixelData:i},actions:{setIsEyedropperActive:s,setEyedropperImg:n,setEyedropperPixelData:p}}=e;return{fullbleedContainer:r,isEyedropperActive:t,eyedropperCallback:o,eyedropperImg:a,eyedropperPixelData:i,setIsEyedropperActive:s,setEyedropperImg:n,setEyedropperPixelData:p}})),{pageWidth:C}=s((e=>{let{state:{pageWidth:r}}=e;return{pageWidth:r}})),I=C/a.FULLBLEED_RATIO,w=u,k=r.useRef(),_=r.useRef(),L=r.useRef(),P=r.useRef(),R=r.useRef(),D=()=>{E(!1),j(null),v(null)};return r.useFocusOut(R,D,[t,w]),i.useGlobalKeyDownEffect("esc",D),t&&!w?d.default.createElement(d.default.Fragment,null,d.default.createElement(x,{onClick:D},d.default.createElement(i.CircularProgress,null))):t&&w?d.default.createElement(g,{"data-testid":"eyedropperLayer",onMouseMove:r=>{const{left:t,top:a,width:i,height:s}=e.getBoundingClientRect(),n=(r.clientX-t)*(C/i),p=(r.clientY-a)*(I/s);if(n<0||p<0||n>i||p>s)return void(L.current.style.display="none");L.current.style.display="block",L.current.style.transform=`translate(${n-100}px, ${p}px)`,function(e,r){const t=_.current;if(t){const o=t.getContext("2d");o.imageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,o.msImageSmoothingEnabled=!1,o.clearRect(0,0,200,200),o.drawImage(k.current,Math.round(e-3.5),Math.round(r-3.5),7,7,0,0,200,200),o.beginPath(),o.rect(Math.round(100)-14.285714285714286,Math.round(100)-14.285714285714286,28.571428571428573,28.571428571428573),o.stroke()}}(n,p);const u=l(c,n,p,i),{r:d,g:g,b:f,a:y}=u,m=o.rgba(d,g,f,y);P.current.style.background=`rgba(${d},${g},${f},${y})`,P.current.style.color=o.readableColor(m,"#333","#EDEDED",!1),P.current.innerText=m}},d.default.createElement(f,{withSafezone:!1,showOverflow:!0},d.default.createElement(y,{ref:R,onClick:r=>{const{left:t,top:o,width:a,height:i}=e.getBoundingClientRect(),s=(r.clientX-t)*(C/a),n=(r.clientY-o)*(I/i),u=l(c,s,n,C);p(u)}},d.default.createElement(b,{ref:k,src:w,alt:""}),d.default.createElement(h,{ref:L},d.default.createElement(q,null,d.default.createElement("canvas",{ref:_,width:200,height:200})),d.default.createElement(m,{ref:P}))))):null};
