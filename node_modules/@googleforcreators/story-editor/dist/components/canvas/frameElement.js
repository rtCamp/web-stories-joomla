/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("styled-components"),t=require("@googleforcreators/i18n"),o=require("@googleforcreators/react"),s=require("@googleforcreators/units"),i=require("@googleforcreators/transform");require("prop-types");var a=require("@googleforcreators/elements"),n=require("@googleforcreators/element-library"),u=require("@googleforcreators/masks"),l=require("@googleforcreators/design-system");require("../dropTargets/provider.js");var c=require("../dropTargets/useDropTargets.js");require("../../app/history/historyProvider.js"),require("../../app/history/context.js"),require("@googleforcreators/templates"),require("../../app/config/context.js");var p=require("../../app/config/useConfig.js");require("../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../constants/fonts.js"),require("../../constants/multipleValue.js");var g=require("../../constants/performanceTrackingEvents.js");require("../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("uuid"),require("../../app/story/context.js"),require("@googleforcreators/migration"),require("../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var d=require("../../app/story/useStory.js");require("../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../utils/generateBlurhash.worker.js"),require("../../app/media/media3p/providerConfiguration.js"),require("../../app/media/utils/useFFmpeg.js"),require("../../app/media/media3p/api/context.js"),require("../../app/media/local/constants.js"),require("../../app/media/media3p/providerReducer.js"),require("../../app/media/context.js"),require("sat"),require("../../app/layout/context.js"),require("../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../library/panes/text/textPresets.js"),require("../../app/canvas/context.js");var m=require("../../app/canvas/useCanvas.js");require("../../app/currentUser/context.js"),require("../../app/helpCenter/provider.js"),require("../../app/helpCenter/context.js"),require("../helpCenter/constants.js"),require("../../app/rightClickMenu/context.js");var f=require("../elementLink/frame.js"),q=require("../../utils/useDoubleClick.js"),E=require("../../utils/usePerformanceTracking.js");require("./editLayerFocusManager/context.js");var y=require("./editLayerFocusManager/useFocusGroupRef.js"),v=require("./editLayerFocusManager/useEditLayerFocusManager.js"),j=require("./editLayerFocusManager/constants.js");function T(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=T(e),S=T(r);function x(){return x=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},x.apply(this,arguments)}const D=S.default.div.withConfig({displayName:"frameElement__Wrapper",componentId:"sc-80q0sm-0"})([""," "," "," outline:1px solid transparent;transition:outline-color 0.5s;&:focus,&:active,&:hover{outline-color:",";}"],n.elementWithPosition,n.elementWithSize,n.elementWithRotation,(e=>{let{theme:r,hasMask:t}=e;return t?"transparent":r.colors.border.selection})),k=S.default.div.withConfig({displayName:"frameElement__EmptyFrame",componentId:"sc-80q0sm-1"})(["position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"]),NOOP=()=>{},C=t.sprintf(
/* translators: 1: Ctrl Key 2: Alt Key */
t.__("To exit the canvas area, press Escape. Press Tab to move to the next group or element. To enter floating menu, press %1$s %2$s p.","web-stories"),l.prettifyShortcut("ctrl"),l.prettifyShortcut("alt"));var R=o.memo((function FrameElement(e){let{id:r}=e;const t=l.useLiveRegion(),n=v((e=>{let{enterFocusGroup:r}=e;return r})),[T,S]=o.useState(!1),R=y(j.ELEMENT_SELECTION),{setNodeForElement:b,handleSelectElement:F,isEditing:L,setEditingElement:M,setEditingElementWithState:I}=m((e=>{let{state:r,actions:t}=e;return{setNodeForElement:t.setNodeForElement,handleSelectElement:t.handleSelectElement,isEditing:r.isEditing,setEditingElement:t.setEditingElement,setEditingElementWithState:t.setEditingElementWithState}})),{isSelected:P,isOnlySelectedElement:N,isActive:w,isBackground:_,element:O}=d((e=>{let{state:t}=e;const o=t.selectedElementIds.includes(r),s=o&&1===t.selectedElementIds.length,i=s&&!T&&!L;return{isSelected:o,isBackground:t.currentPage?.elements[0].id===r,element:t.currentPage?.elements.find((e=>e.id===r)),isOnlySelectedElement:s,isActive:i}})),{type:W,flip:A}=O,{Frame:B,isMaskable:G,Controls:U}=a.getDefinitionForType(W),K=o.useRef(),V=o.useCombinedRefs(K,R),[$,z]=o.useState(!1),{isRTL:H,styleConstants:{topOffset:Z}={}}=p(),{draggingResource:J,activeDropTargetId:Q,isDropSource:X,registerDropTarget:Y,unregisterDropTarget:ee}=c((e=>{let{state:{draggingResource:r,activeDropTargetId:t},actions:{isDropSource:o,registerDropTarget:s,unregisterDropTarget:i}}=e;return{draggingResource:r,activeDropTargetId:t,isDropSource:o,registerDropTarget:s,unregisterDropTarget:i}})),re=i.useTransform((e=>{let{state:r}=e;return!P&&$&&!r.isAnythingTransforming})),te=s.useUnits((e=>{let{actions:r}=e;return r.getBox}));o.useLayoutEffect((()=>{b(r,K.current)}),[r,b]);const oe=te(O);i.useTransformHandler(r,(e=>{const r=K.current;void 0!==e?.dropTargets?.hover&&(r.style.opacity=e.dropTargets.hover?0:1),S(null!==e)}));const{isMedia:se}=a.getDefinitionForType(W),ie=o.useCallback((e=>{P||F(r,e),M(r)}),[r,M,F,P]),ae=q(NOOP,ie),ne=o.useCallback((e=>{P||F(r,e),_||t(C)}),[F,r,_,P,t]),ue=o.useCallback((e=>{P||F(r,e),K.current.focus({preventScroll:!0}),_||e.stopPropagation()}),[F,r,_,P]);return E({node:K.current,eventData:{...g.TRACKING_EVENTS.SELECT_ELEMENT,label:O.type},eventType:"pointerdown"}),l.useKeyDownEffect(K,{key:["ctrl+alt+p"]},(()=>{n({groupId:j.EDIT_ELEMENT,cleanup:()=>K.current?.focus()})}),[n]),h.default.createElement(f,{element:O,active:re,anchorRef:K},U&&h.default.createElement(U,{isTransforming:T,box:oe,elementRef:K,element:O,isRTL:H,topOffset:Z,isActive:w}),h.default.createElement(D,x({ref:V,"data-element-id":r},oe,{tabIndex:-1,role:"presentation",hasMask:G,"data-testid":"frameElement",onMouseDown:ue,onFocus:ne,onPointerEnter:()=>z(!0),onPointerLeave:()=>z(!1),onClick:se?ae(r):null}),h.default.createElement(u.FrameWithMask,{element:O,fill:!0,flip:A,draggingResource:J,activeDropTargetId:Q,isDropSource:X,registerDropTarget:Y,unregisterDropTarget:ee},B?h.default.createElement(B,{wrapperRef:K,element:O,box:oe,isOnlySelectedElement:N,setEditingElementWithState:I}):h.default.createElement(k,null))))}));module.exports=R;
