/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react");require("prop-types");var r=require("styled-components"),t=require("@googleforcreators/react"),o=require("@googleforcreators/units"),s=require("@googleforcreators/moveable");require("@googleforcreators/transform"),require("../dropTargets/provider.js"),require("../dropTargets/context.js"),require("../../app/history/historyProvider.js"),require("../../app/history/context.js"),require("@googleforcreators/templates"),require("../../app/config/context.js"),require("../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom");var a=require("../../constants/index.js");require("../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../app/story/context.js"),require("@googleforcreators/migration"),require("../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var i=require("../../app/story/useStory.js");require("@googleforcreators/i18n"),require("../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../utils/generateBlurhash.worker.js"),require("@googleforcreators/design-system"),require("../../app/media/media3p/providerConfiguration.js"),require("../../app/media/utils/useFFmpeg.js"),require("../../app/media/media3p/api/context.js"),require("../../app/media/local/constants.js"),require("../../app/media/media3p/providerReducer.js"),require("../../app/media/context.js"),require("sat"),require("../../app/layout/context.js"),require("../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../library/panes/text/textPresets.js"),require("../../app/canvas/context.js");var n=require("../../app/canvas/useCanvas.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("../../app/currentUser/context.js"),require("../../app/helpCenter/provider.js"),require("../../app/helpCenter/context.js"),require("../helpCenter/constants.js"),require("../../app/rightClickMenu/context.js");var c=u(e),l=u(r);const p=0,d=1,g=2,f=s.withOverlay(l.default.div.withConfig({displayName:"selectionCanvas__Container",componentId:"sc-qsqc5z-0"})(["position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;user-select:none;"])),q=l.default.div.withConfig({displayName:"selectionCanvas__Lasso",componentId:"sc-qsqc5z-1"})(["display:none;position:absolute;border:1px dotted ",";z-index:1;"],(e=>{let{theme:r}=e;return r.colors.border.selection}));module.exports=function SelectionCanvas(e){let{children:r}=e;const u=i((e=>{let{state:r}=e;return r.currentPage?.elements||a.STABLE_ARRAY})),{selectedElements:l,clearSelection:m}=i((e=>{let{state:{selectedElements:r},actions:{clearSelection:t}}=e;return{selectedElements:r,clearSelection:t}})),{fullbleedContainer:y,isEditing:h,nodesById:j,clearEditing:v,selectIntersection:x}=n((e=>{let{state:{fullbleedContainer:r,isEditing:t,nodesById:o},actions:{clearEditing:s,selectIntersection:a}}=e;return{fullbleedContainer:r,isEditing:t,nodesById:o,clearEditing:s,selectIntersection:a}})),b=t.useMemo((()=>y?.closest("[data-scroll-container]")),[y]),{editorToDataX:E,editorToDataY:C}=o.useUnits((e=>({editorToDataX:e.actions.editorToDataX,editorToDataY:e.actions.editorToDataY}))),T=t.useRef(null),R=t.useRef(null),M=t.useRef([0,0]),k=t.useRef([0,0]),I=t.useRef([0,0]),S=t.useRef(p),w=t.useCallback((()=>{const[e,r]=k.current,[t,o]=I.current;return[Math.min(e,t),Math.min(r,o),Math.abs(e-t),Math.abs(r-o)]}),[]),A=t.useCallback((()=>{const e=R.current;if(!e)return;const r=S.current,[t,o,s,a]=w();e.style.left=`${t}px`,e.style.top=`${o}px`,e.style.width=`${s}px`,e.style.height=`${a}px`,e.style.display=r===d?"block":"none"}),[w]),D=t.useCallback((e=>{j[u[0].id].contains(e.target)||(l.length&&m(),h&&v());let r=0,t=0;for(let e=T.current;e;e=e.offsetParent)r+=e.offsetLeft,t+=e.offsetTop;const o=e.pageX-r,s=e.pageY-t;M.current=[r,t],k.current=[o,s],I.current=[o,s],S.current=g,A()}),[v,m,u,h,j,l.length,A]),L=t.useCallback((e=>{if(S.current===p)return;const[r,t]=k.current,[o,s]=M.current,a=e.pageX-o,i=e.pageY-s;I.current[0]=a,I.current[1]=i,A(),Math.abs(r-a)+Math.abs(t-i)>10&&(S.current=d)}),[A]),P=t.useCallback((()=>{if(S.current===d){const[e,r,t,s]=w(),{offsetLeft:a,offsetTop:i,offsetHeight:n,offsetWidth:u}=y,{offsetLeft:c,offsetTop:l}=b,p=a+c,d=i+l+(n-u/o.PAGE_RATIO)/2,g=E(e-p),f=C(r-d),q=E(t),h=C(s);m(),v(),x({x:g,y:f,width:q,height:h})}S.current=p,A()}),[v,m,E,C,y,w,b,x,A]);return t.useEffect((()=>(document.addEventListener("mouseup",P),()=>{document.removeEventListener("mouseup",P)})),[P]),t.useEffect(A),c.default.createElement(f,{onMouseDown:D,onMouseMove:L,"data-fix-caret":!0},r,c.default.createElement(s.InOverlay,{ref:T},c.default.createElement(q,{ref:R})))};
