/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("@googleforcreators/react"),r=require("@googleforcreators/units"),t=require("@googleforcreators/rich-text"),o=require("@googleforcreators/elements"),s=require("../../utils/objectWithout.js");require("../../constants/fonts.js"),require("../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("react"),require("prop-types"),require("../../app/story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../../app/config/context.js"),require("../../app/api/context.js"),require("../../app/history/historyProvider.js"),require("../../app/history/context.js"),require("../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var i=require("../../app/story/useStory.js");require("../../utils/storyPageToNode.js"),require("@ap.cx/hues"),require("../../app/pageCanvas/context.js"),require("../../app/pageCanvas/pageCanvasCacheValidator.js");var a=require("../../app/pageCanvas/useCalculateAccessibleTextColors.js"),l=require("./useInsertElement.js");module.exports=function(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const u=l(),c=a(),{setSelectedElementsById:g}=i((e=>{let{actions:{setSelectedElementsById:r}}=e;return{setSelectedElementsById:r}})),p=e.useBatchingCallback((async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n;const i=t.getHTMLFormatters(),{setColor:a}=i,l=[],p=e.some((e=>e.content?.includes("color:")));let d=[],y=null;const f={r:255,g:255,b:255},q={r:0,g:0,b:0},h={...f,a:.3},m={...q,a:.3};let j,x,E;if(r&&!p){d=await Promise.all(e.map((e=>"text"===e.type?c(e):null))),y=d.find((e=>e));const r=d.every((e=>null===e||e.color?.r===y.color?.r&&e.color?.g===y.color?.g&&e.color?.b===y.color?.b&&e.color?.a===y.color?.a));x=d.reduce(((e,r)=>r?.backgroundColor?e+1:e),0);const t=d.reduce(((e,r)=>0===r?.backgroundColor?.r&&0===r?.backgroundColor?.g&&0===r?.backgroundColor?.b?e+1:e),0);if(j=x-t>0?m:h,E=x>0||!1===r,E){const{textSetHeight:r,textSetWidth:t}=e[0],s=r=>Math.min.apply(null,e.map((e=>e[r]))),i={x:s("x")-24,y:s("y")-24,width:t+48,height:r+48,backgroundColor:{color:j},type:"shape"};l.push(u(o.ELEMENT_TYPES.SHAPE,i))}}e.forEach(((e,t)=>{const o=s(e,["id","normalizedOffsetX","normalizedOffsetY","textSetWidth","textSetHeight"]);if(r&&!p){const r=0===j.r?f:q,s=E?{color:r}:d[t];"text"===e.type&&s.color&&(o.content=a(o.content,s)),"shape"===e.type&&y.color&&(e.border?o.border.color=y:o.backgroundColor=y)}l.push(u(e.type,o))})),g({elementIds:l.map((e=>{let{id:r}=e;return r}))})}),[c,n,u,g]),d=e.useCallback(((e,t)=>{let{offsetX:o,offsetY:s}=t;if(!e.length)return;const i=e.map((e=>{const t=e.normalizedOffsetX+o,i=e.normalizedOffsetY+s,{width:a,height:l}=e;return t>r.PAGE_WIDTH||t+a<0||i>r.FULLBLEED_HEIGHT||i+l<-r.DANGER_ZONE_HEIGHT?null:{...e,x:t,y:i}})).filter((e=>e));p(i,!1)}),[p]);return{insertTextSet:p,insertTextSetByOffset:d}};
