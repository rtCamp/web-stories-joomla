/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@googleforcreators/units"),r=require("@googleforcreators/media"),t=require("@googleforcreators/patterns"),o=require("../../../../utils/contrastUtils.js");require("@googleforcreators/dom"),require("../../constants.js");var i=require("../../utils/getSpansFromContent.js");require("react"),require("../../../../types.js"),require("../../../footer/pagepreview/index.js"),require("../../../thumbnail/constants.js"),require("prop-types"),require("@googleforcreators/design-system"),require("../../../thumbnail/styles.js"),require("@googleforcreators/i18n"),require("@googleforcreators/elements"),require("@googleforcreators/react"),require("@googleforcreators/templates"),require("../../../../app/config/context.js"),require("../../../../app/api/context.js"),require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/fonts"),require("../../../../constants/fonts.js"),require("../../../../constants/multipleValue.js"),require("../../../../app/font/context.js"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../app/media/useUploadMedia.js");var a=require("../../../../utils/getMediaBaseColor.js");require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js"),require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js");function s(e,r){return e>=.3333333333333333*r}function n(r,t,o){const{pageSize:i}=o,a=e.getBox(r,i?.width,i?.height),n=e.getBoundRect([a]),u=n.width*n.height,c=[...t].map(((r,t)=>{const a=e.getBox(r,i?.width,i?.height),s=e.getBoundRect([a]),u=function(e,r){const t=Math.min(e.endX,r.endX)-Math.max(e.startX,r.startX),o=Math.min(e.endY,r.endY)-Math.max(e.startY,r.startY);return t>=0&&o>=0?t*o:0}(n,s);return{element:r.isBackground||r.isDefaultBackground?{...r,backgroundColor:o?.backgroundColor}:r,area:u,index:t}})).reverse();let g=u;const l=[];for(const e of c){if(!s(g,u))break;s(e.area,u)&&l.push(e.element),g-=e.area}return l}function u(o){let{background:i,text:s,page:n}=o;const{pageSize:u}=n,g=(u?.width/e.FULLBLEED_RATIO-u?.width/e.PAGE_RATIO)/2,l=e.getBox(s,u?.width,u?.height),p=e.getBoundRect([l]),{resource:h,scale:d,focalX:f,focalY:m}=i,q=e.getBox(i,u?.width,u?.height),{width:x,height:j}=q,y=r.getMediaSizePositionProps(h,x,j,d,f,m);return async function(e){let{bgImage:o,bgBox:i,overlapBox:s}=e;function n(e){return new Promise(((r,t)=>{try{const t=document.createElement("canvas");t.width=o.width,t.height=o.height;const a=t.getContext("2d");if(o.rotationAngle){const e=o.offsetX+i.width/2,r=o.offsetY+i.height/2;a.translate(e,r),a.rotate(o.rotationAngle*c),a.translate(-e,-r)}let n=0,u=0;const{flip:g}=o;(g.vertical||g.horizontal)&&(n=g.horizontal?-1*o.width:0,u=g.vertical?-1*o.height:0,a.scale(g.horizontal?-1:1,g.vertical?-1:1)),a.drawImage(e,n,u,o.width,o.height);r(a.getImageData(s.x,s.y,s.width,s.height))}catch(e){t(e)}}))}const u=await r.preloadImage({src:o.src,width:o.width,height:o.height}),g=await n(u),l=document.createElement("canvas");l.width=s.width,l.height=s.height;l.getContext("2d").putImageData(g,0,0);const p=await a(l.toDataURL(),l.width,l.height),{color:{r:h,g:d,b:f}}=t.createSolidFromString(p);return{r:h,g:d,b:f}}({bgImage:{offsetX:y.offsetX,offsetY:y.offsetY,src:i.resource.src,width:y.width,height:y.height,rotationAngle:i.isBackground?void 0:i.rotationAngle,flip:i.flip},bgBox:q,overlapBox:{x:i.isBackground?y.offsetX+Math.abs(p.startX):y.offsetX+Math.abs(p.startX)-q.x,y:i.isBackground?y.offsetY+Math.abs(p.startY+g):y.offsetY+Math.abs(p.startY+g)-(q.y+g),width:p.width,height:p.height}}).catch((()=>{}))}const c=Math.PI/180;function g(e){let{background:r}=e;return r?.backgroundColor?.color}function l(e){switch(e.type){case"image":return u;case"shape":return g;default:return()=>{}}}async function p(e){const r=[];e.elements.forEach(((t,o)=>{if("text"===t.type&&"NONE"===t.backgroundTextMode){const a=function(e){const r=i.getSpansFromContent(e.content),t=r.map((e=>e.style?.color)).filter(Boolean),o=0===t.length&&0!==r.length,a=0!==e.content.length&&0===r.length;return(o||a)&&t.push("rgb(0, 0, 0)"),t}(t),s=e.elements.slice(0,o),u=n(t,s,e);for(const o of u){const i=l(o)({background:o,text:t,page:e}),s=e=>e&&{backgroundColor:e,textStyleColors:a,fontSize:t.fontSize,id:t.id,isBackgroundElement:o.isBackground},n=i instanceof Promise?i.then(s):s(i);r.push(n)}}}));const t=(await Promise.all(r)).map((e=>function(){let{backgroundColor:e,textStyleColors:r,fontSize:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!(!r||!e)&&r.some((r=>{if(!r)return!1;const i=o.calculateLuminanceFromStyleColor(r),a=o.calculateLuminanceFromRGB(e);return!o.checkContrastFromLuminances(i,a,t).WCAG_AA}))}(e)&&{id:e.id,isBackground:e.isBackgroundElement}));return t.filter((e=>{let{id:r}=e;return r}))}exports.getPagesWithFailedContrast=async function(e,r){const t=[];return(e||[]).forEach((e=>{const o=p({...e,pageSize:r});o instanceof Promise?t.push(o.then((r=>({result:r,page:e})))):t.push(o)})),(await Promise.all(t)).filter((e=>e.result.some((e=>{let{id:r}=e;return r})))).map((e=>e))},exports.pageBackgroundTextLowContrast=p;
