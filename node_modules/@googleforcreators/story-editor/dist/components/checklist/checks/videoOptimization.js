/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),r=require("@googleforcreators/i18n"),t=require("styled-components"),i=require("@googleforcreators/react"),s=require("@googleforcreators/design-system");require("../../../constants/fonts.js");var o=require("../../../constants/media.js");require("../../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("prop-types"),require("../../../app/story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../../../app/config/context.js"),require("../../../app/api/context.js"),require("../../../app/history/historyProvider.js"),require("../../../app/history/context.js"),require("../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var a=require("../../../app/story/useStory.js");require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../utils/generateBlurhash.worker.js"),require("../../../app/media/media3p/providerConfiguration.js");var u=require("../../../app/media/utils/useFFmpeg.js");require("../../../app/media/media3p/api/context.js"),require("../../../app/media/local/constants.js"),require("../../../app/media/media3p/providerReducer.js"),require("../../../app/media/context.js");var n=require("../../../app/media/local/useLocalMedia.js"),c=require("../constants.js"),l=require("../../thumbnail/constants.js"),d=require("../../thumbnail/thumbnail.js");require("../../thumbnail/styles.js");var p=require("../../thumbnail/components/LayerThumbnail.js"),g=require("../../checklistCard/styles.js"),m=require("../../checklistCard/checklistCard.js"),q=require("../../checklistCard/constants.js"),h=require("../../checklistCard/defaultFooterText.js"),f=require("../utils/filterStoryElements.js");require("../../../app/highlights/styles.js");var y=require("../../../app/highlights/useHighlights.js");require("../../../app/highlights/context.js"),require("../../../app/highlights/states.js"),require("../../../app/highlights/quickActions/constants.js"),require("../../../app/highlights/quickActions/useQuickActions.js");var j=require("../countContext/checkCountContext.js"),E=require("../popupMountedContext.js");function T(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _=T(e);const v=T(t).default(s.Button).withConfig({displayName:"videoOptimization__OptimizeButton",componentId:"sc-1dz2s9g-0"})(["margin-top:4px;"]);function I(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{resource:r}=e;if(!r)return!1;const{isOptimized:t,height:i=0,width:s=0}=r;if("video"!==e.type||t)return!1;const a=i*s,u=a>o.MEDIA_VIDEO_DIMENSIONS_THRESHOLD.WIDTH*o.MEDIA_VIDEO_DIMENSIONS_THRESHOLD.HEIGHT;return u}const C={},O="cancelled",b="uploaded",S="uploading";function R(e,r){switch(r.type){case O:return{...e,[r.element.resource.id]:O};case b:return{...e,[r.element.resource.id]:b};case S:return{...e,[r.element.resource.id]:S};default:throw new Error}}const BulkVideoOptimization=()=>{const e=E.useIsChecklistMounted(),[t,o]=i.useReducer(R,C),u=a((e=>{let{state:r}=e;return r?.pages})),{optimizeVideo:T,isNewResourceTranscoding:k,isCurrentResourceTranscoding:w,canTranscodeResource:z}=n((e=>{let{actions:{optimizeVideo:r},state:{isNewResourceTranscoding:t,canTranscodeResource:i,isCurrentResourceTranscoding:s}}=e;return{optimizeVideo:r,isNewResourceTranscoding:t,canTranscodeResource:i,isCurrentResourceTranscoding:s}})),x=i.useMemo((()=>f.filterStoryElements(u,I)),[u]).filter(((e,r,t)=>t.findIndex((r=>r.resource.id===e.resource.id))===r)),M=y((e=>{let{setHighlights:r}=e;return r})),N=i.useCallback((async e=>{if(z(e.resource)&&t[e.resource.id]!==S){o({type:S,element:e});try{await T({resource:e.resource})}catch(r){return void o({type:O,element:e})}o({type:b,element:e})}}),[z,T,t]),D=i.useCallback((()=>{const e=x.filter((e=>{let{resource:r}=e;return!k(r?.id)&&!w(r?.id)}));return new Promise((r=>{e.map((e=>async()=>{await N(e)})).reduce(((e,r)=>e.then(r)),Promise.resolve()).then(r)}))}),[k,w,N,x]),P=i.useCallback((async()=>{await D()}),[D]),A=i.useCallback((e=>async()=>{M({pageId:e.pageId,elementId:e.id}),await N(e)}),[N,M]),{footer:L,title:H}=c.PRIORITY_COPY.videoNotOptimized,V=i.useMemo((()=>Object.values(t).filter((e=>e===S))),[t]),B=i.useMemo((()=>V.length>0||x.some((e=>k(e.resource.id)||w(e.resource.id)))),[V,x,k,w]),U=x.length>0;j.useRegisterCheck("VideoOptimization",U);let Y=1===x.length?r.__("Optimize video","web-stories"):r.__("Optimize all videos","web-stories");if(B){const e=V.length+x.filter((e=>k(e.resource.id)||w(e.resource.id))).length;Y=r.sprintf(
/* translators: 1: number of videos currently transcoding. 2: total number of videos in list. */
r._n("Optimizing %1$d of %2$d","Optimizing %1$d of %2$d",e,"web-stories"),e,x.length)}return U&&e&&_.default.createElement(m,{cta:_.default.createElement(v,{type:s.BUTTON_TYPES.SECONDARY,size:s.BUTTON_SIZES.SMALL,onClick:P,disabled:B},Y),title:H,cardType:x.length>1?q.CARD_TYPE.MULTIPLE_ISSUE:q.CARD_TYPE.SINGLE_ISSUE,footer:_.default.createElement(h.DefaultFooterText,null,L),thumbnails:x.map((e=>_.default.createElement(d,{key:e.resource.id,onClick:A(e),isLoading:k(e.resource.id)||w(e.resource.id),type:l.THUMBNAIL_TYPES.VIDEO,displayBackground:_.default.createElement(p.LayerThumbnail,{page:e}),"aria-label":r.__("Go to offending video","web-stories"),isError:t[e.resource.id]===O},_.default.createElement(s.Tooltip,{title:t[e.resource.id]===S||k(e.resource.id)||w(e.resource.id)?r.__("Video optimization in progress","web-stories"):r.__("Optimize","web-stories")},_.default.createElement(g.StyledVideoOptimizationIcon,null)))))})};exports.default=()=>{const{isTranscodingEnabled:e}=u();return e?_.default.createElement(BulkVideoOptimization,null):null},exports.videoElementsNotOptimized=I;
