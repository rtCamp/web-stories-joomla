/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react");require("prop-types");var r=require("@googleforcreators/react"),t=require("@googleforcreators/design-system"),o=require("@googleforcreators/transform"),s=require("@googleforcreators/elements");require("../../constants/fonts.js"),require("../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("../../app/story/context.js"),require("@googleforcreators/migration"),require("@googleforcreators/templates"),require("../../app/config/context.js"),require("../../app/api/context.js"),require("../../app/history/historyProvider.js"),require("../../app/history/context.js"),require("../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var n=require("../../app/story/useStory.js"),i=require("../canvas/utils/getElementProperties.js"),a=require("../../utils/noop.js"),l=require("./context.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=u(e);const p=s.MEDIA_ELEMENT_TYPES,g=s.MEDIA_ELEMENT_TYPES.concat(s.ELEMENT_TYPES.SHAPE),d=e=>p.includes(e),f=e=>g.includes(e);module.exports=function DropTargetsProvider(e){let{children:u}=e;const[p,g]=r.useState(null),[m,y]=r.useState({}),[q,E]=r.useState(null),{actions:{pushTransform:T}}=o.useTransform(),{currentPage:v,combineElements:j}=n((e=>{let{state:{currentPage:r},actions:{combineElements:t}}=e;return{currentPage:r,combineElements:t}})),P=r.useMemo((()=>v?.elements||[]),[v?.elements]),h=r.useMemo((()=>P.filter((e=>{let{id:r}=e;return r in m})).map((e=>{let{id:r}=e;return r})).reverse()),[m,P]),D=r.useCallback((function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const o=document.elementsFromPoint(e,r);return h.find((e=>o.includes(m[e])&&e!==t))||null}),[h,m]),b=r.useCallback(((e,r)=>{y((t=>({...t,[e]:r})))}),[]),S=r.useCallback((e=>{y((r=>{const{[e]:t,...o}=r;return o}))}),[]),k=r.useCallback((function(e,r,t){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!d(e?.type))return;const s=i(e.type,{resource:e}),n=P.find((e=>{let{id:r}=e;return r===o})),a=n?.scale??s.scale,l=n?.focalX??s.focalX,u=n?.focalY??s.focalY,c=n?.flip??s.flip,p=D(r,t,o);p&&p!==q?(T(p,{dropTargets:{active:!0,replacement:{resource:e,scale:a,focalX:l,focalY:u,flip:c}}}),o&&T(o,{dropTargets:{hover:!0}})):p||o&&T(o,{dropTargets:{hover:!1}}),E(p),P.filter((e=>{let{id:r}=e;return r!==p})).forEach((e=>T(e.id,{dropTargets:{active:!1,replacement:null}})))}),[q,P,D,T]),M=r.useCallback((function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!d(e?.type))return;if(!q||q===r)return void Object.keys(m).filter((e=>e!==r)).map((e=>T(e,null)));const t={secondId:q},o=P.find((e=>{let{id:t}=e;return t===r}));t.firstElement=o||i(e.type,{resource:e}),j(t),P.filter((e=>{let{id:t}=e;return m[t]&&t!==r})).forEach((e=>{T(e.id,{dropTargets:{active:!1,replacement:null}}),T(e.id,null)})),E(null);const{onDropHandler:n}=s.getDefinitionForType(e.type);n&&e.src&&!e.isPlaceholder&&n(q)}),[q,j,P,m,T]),x=t.useGlobalIsKeyPressed("mod"),I={state:{dropTargets:m,activeDropTargetId:q,draggingResource:p,isDropTargetingDisabled:x},actions:{registerDropTarget:x?a.noop:b,unregisterDropTarget:S,isDropSource:x?()=>!1:d,isDropTarget:x?()=>!1:f,handleDrag:x?a.noop:k,handleDrop:x?a.noop:M,setDraggingResource:x?a.noop:g}};return c.default.createElement(l.Provider,{value:I},u)};
