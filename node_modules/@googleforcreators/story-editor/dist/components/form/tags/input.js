/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("@googleforcreators/design-system"),r=require("@googleforcreators/react");require("prop-types");var o=require("styled-components"),a=require("uuid"),n=require("./reducer.js"),l=require("./tag.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=u(e),i=u(o);function d(){return d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},d.apply(this,arguments)}const c=a.v4(),p=i.default.div.withConfig({displayName:"input__Border",componentId:"sc-1nuo5lh-0"})([""," display:flex;flex-direction:column;margin-bottom:6px;"],(e=>{let{theme:r,isInputFocused:a}=e;return o.css(["color:",";border:1px solid ",";border-radius:",";",";"],r.colors.fg.primary,r.colors.border.defaultNormal,r.borders.radius.small,a&&t.themeHelpers.focusCSS)})),f=i.default.div.withConfig({displayName:"input__InputWrapper",componentId:"sc-1nuo5lh-1"})(["display:flex;flex-wrap:wrap;padding:0;"]),g=i.default(t.BaseInput).attrs({type:"text"}).withConfig({displayName:"input__TextInput",componentId:"sc-1nuo5lh-2"})(["width:auto;flex-grow:1;height:32px;margin:2px 0;padding-left:4px;"]),m=i.default(t.List).withConfig({displayName:"input__SuggestionList",componentId:"sc-1nuo5lh-3"})(["max-height:120px;overflow-y:scroll;border-top:",";display:block;list-style-type:none;width:100%;padding:6px 4px 4px;margin-top:6px;li{cursor:pointer;padding:4px;width:100%;"," border-radius:",";&:hover{background-color:",";}}"],(e=>{let{theme:t}=e;return`1px solid ${t.colors.border.defaultNormal}`}),t.themeHelpers.focusableOutlineCSS(),(e=>{let{theme:t}=e;return t.borders.radius.small}),(e=>{let{theme:t}=e;return t.colors.bg.tertiary}));module.exports=function Input(e){let{suggestedTerms:o=[],onTagsChange:u,onInputChange:i,suggestedTermsLabel:y,tagDisplayTransformer:h,tokens:E=[],onUndo:T=t.noop,...C}=e;const[{value:x,tags:b,offset:w,tagBuffer:I},S]=r.useReducer(n.default,{value:"",tags:[...E],tagBuffer:null,offset:0}),[A,v]=r.useState(!1),[k,_]=r.useState(!1),N=r.useRef(),O=r.useRef(),D=r.useRef();r.useEffect((()=>{S({type:n.ACTIONS.UPDATE_TAGS,payload:E})}),[E]);const R=a.v4(),F=o.length;r.useEffect((()=>{_(F>0)}),[F]);const B=r.useRef(u);B.current=u,r.useEffect((()=>{I&&B.current?.(I)}),[I]);const U=r.useRef(i);U.current=i,r.useEffect((()=>{U.current?.(x)}),[x]);const{handleFocus:q,handleBlur:L,handleKeyDown:M,handleChange:j,removeTag:K}=r.useMemo((()=>({handleKeyDown:e=>{""===e.target.value&&("ArrowLeft"===e.key&&S({type:n.ACTIONS.INCREMENT_OFFSET}),"ArrowRight"===e.key&&S({type:n.ACTIONS.DECREMENT_OFFSET}),"Backspace"===e.key&&S({type:n.ACTIONS.REMOVE_TAG}),"z"===e.key&&e.metaKey&&T(e)),"ArrowDown"===e.key&&o.length>0&&O?.current?.firstChild?.focus(),["Comma",",","Enter"].includes(e.key)&&S({type:n.ACTIONS.SUBMIT_VALUE})},handleChange:e=>{S({type:n.ACTIONS.UPDATE_VALUE,payload:e.target.value})},removeTag:e=>()=>{S({type:n.ACTIONS.REMOVE_TAG,payload:e}),N?.current.focus()},handleFocus:()=>{v(!0)},handleBlur:()=>{S({type:n.ACTIONS.RESET_OFFSET}),v(!1)}})),[T,o]),V=I||b,G=r.useCallback(((e,t)=>{e.preventDefault(),_(!1),S({type:n.ACTIONS.SUBMIT_VALUE,payload:t}),N?.current.focus()}),[]),P=r.useCallback(((e,t,r)=>{const o=t+1,a=t-1;"ArrowDown"===e.key&&o<F&&O?.current?.children?.[o]?.focus(),"ArrowUp"===e.key&&(a<0?N?.current.focus():O?.current?.children?.[a]?.focus()),"Enter"===e.key&&G(e,r)}),[G,F]);return s.default.createElement(p,{ref:D,isInputFocused:A},s.default.createElement(f,null,[...V.slice(0,V.length-w),c,...V.slice(V.length-w)].map((e=>e===c?s.default.createElement(g,d({},C,{key:c,value:x,onKeyDown:M,onChange:j,onFocus:q,onBlur:L,size:"4",ref:N,autoComplete:k?"off":"on","aria-expanded":k,"aria-autocomplete":"list","aria-owns":k?R:null,role:"combobox"})):s.default.createElement(l,{key:e,onDismiss:K(e)},h(e)||e)))),k&&s.default.createElement(m,{"aria-label":y,role:"listbox",ref:O,id:R,"data-testid":"suggested_terms_list"},o.map(((e,t)=>{let{name:r,id:o}=e;return s.default.createElement("li",{key:o,"aria-selected":x===r,role:"option",tabIndex:0,onClick:e=>G(e,r),onKeyDown:e=>P(e,t,r)},r)}))))};
