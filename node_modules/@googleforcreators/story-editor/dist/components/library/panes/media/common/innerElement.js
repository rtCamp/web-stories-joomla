/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("styled-components"),t=require("@googleforcreators/react");require("prop-types");var o=require("@googleforcreators/media"),a=require("@googleforcreators/design-system"),n=require("../../shared/libraryMoveable.js");require("../../../../dropTargets/provider.js");var i=require("../../../../dropTargets/useDropTargets.js");require("@googleforcreators/tracking"),require("@googleforcreators/templates"),require("../../../../../app/config/context.js"),require("../../../../../app/api/context.js"),require("../../../../../constants/fonts.js"),require("../../../../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../../app/history/historyProvider.js"),require("../../../../../app/history/context.js"),require("../../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("@googleforcreators/i18n"),require("../../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../../utils/generateBlurhash.worker.js"),require("../../../../../app/media/media3p/providerConfiguration.js"),require("../../../../../app/media/utils/useFFmpeg.js"),require("../../../../../app/media/media3p/api/context.js"),require("../../../../../app/media/local/constants.js"),require("../../../../../app/media/media3p/providerReducer.js"),require("../../../../../app/media/context.js");var s=require("../../../../../app/media/media3p/constants.js"),l=require("../../shared/insertionOverlay.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=u(e),c=u(r);function d(){return d=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},d.apply(this,arguments)}const g=r.css(["width:100%;cursor:pointer;transition:0.2s transform,0.15s opacity;border-radius:4px;opacity:0;"]),m=c.default.img.withConfig({displayName:"innerElement__Image",componentId:"sc-qkk7ov-0"})(["",""],g),y=c.default.video.withConfig({displayName:"innerElement__Video",componentId:"sc-qkk7ov-1"})([""," object-fit:cover;",""],g,(e=>{let{showWithoutDelay:r}=e;return r?"opacity: 1;":""})),f=c.default.div.withConfig({displayName:"innerElement__DurationWrapper",componentId:"sc-qkk7ov-2"})(["position:absolute;bottom:8px;left:8px;background:",";border-radius:100px;height:18px;padding:0 6px;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64})),h=c.default.div.withConfig({displayName:"innerElement__MuteWrapper",componentId:"sc-qkk7ov-3"})(["position:absolute;bottom:8px;right:8px;height:24px;width:24px;background:",";color:",";border-radius:100px;"],(e=>{let{theme:r}=e;return r.colors.opacity.black64}),(e=>{let{theme:r}=e;return r.colors.fg.primary})),q=c.default(a.Text).attrs({forwardedAs:"span",size:a.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.X_SMALL}).withConfig({displayName:"innerElement__Duration",componentId:"sc-qkk7ov-4"})(["color:",";display:block;"],(e=>{let{theme:r}=e;return r.colors.fg.primary})),E=c.default.img.withConfig({displayName:"innerElement__CloneImg",componentId:"sc-qkk7ov-5"})(["opacity:0;width:",";height:",";position:absolute;"],(e=>{let{width:r}=e;return`${r}px`}),(e=>{let{height:r}=e;return`${r}px`}));var v=t.memo((function InnerElement(e){let{type:r,src:u,resource:c,alt:g,width:v,height:j,onClick:T,onLoad:k=a.noop,showVideoDetail:I,mediaElement:D,active:b,isMuted:w}=e;const x=t.useRef(null),C=t.useRef(null),{handleDrag:_,handleDrop:O}=i((e=>{let{state:r,actions:t}=e;return{handleDrag:t.handleDrag,handleDrop:t.handleDrop,dropTargets:r.dropTargets,activeDropTargetId:r.activeDropTargetId}}),((e,r)=>{if(C.current)return!1;if(null===C.current)return C.current=!1,!1;if(e?.dropTargets&&r?.dropTargets){const t=Object.keys(e.dropTargets),o=Object.keys(r.dropTargets);if(t.join()!==o.join())return!1}return e?.activeDropTargetId===r?.activeDropTargetId})),{setDraggingResource:R}=i((e=>{let{actions:{setDraggingResource:r}}=e;return{setDraggingResource:r}}));let S;t.useEffect((()=>{c.poster&&(x.current=c.poster)}),[c.poster]);const{lengthFormatted:F,poster:M,mimeType:P}=c,A=M??x.current,N=A||o.getSmallestUrlForWidth(v,c),G={width:v,height:j,alt:g,crossOrigin:"anonymous"},L={...G,onLoad:()=>{D.current&&(D.current.style.opacity=1),k()},loading:"lazy",decoding:"async",draggable:!1},V={...L,onLoad:void 0},W={...L,src:N},U={...G,title:g,alt:null,loop:r===s.ContentType.GIF,muted:!0,preload:"metadata",poster:A,showWithoutDelay:b};if(r===s.ContentType.IMAGE?(S=p.default.createElement(m,d({key:u},W,{ref:D})),V.src=N):[s.ContentType.VIDEO,s.ContentType.GIF].includes(r)&&(S=p.default.createElement(p.default.Fragment,null,M&&!b?p.default.createElement(m,d({key:u},W,{ref:D})):p.default.createElement(y,d({key:u},U,{ref:D}),r===s.ContentType.GIF?c.output.src&&p.default.createElement("source",{src:c.output.src,type:c.output.mimeType}):p.default.createElement("source",{src:o.getSmallestUrlForWidth(v,c),type:P})),r===s.ContentType.VIDEO&&I&&F&&p.default.createElement(f,null,p.default.createElement(q,null,F)),r===s.ContentType.VIDEO&&I&&w&&p.default.createElement(h,null,p.default.createElement(a.Icons.Muted,null))),V.src=M),!S)throw new Error("Invalid media element type.");const Y=r===s.ContentType.IMAGE?N:M;return p.default.createElement(p.default.Fragment,null,S,b&&p.default.createElement(l,{showIcon:!1}),p.default.createElement(n,{active:b,handleDrag:e=>{C.current||(o.resourceList.set(c.id,{url:N,type:"cached"}),R(c),C.current=!0),_(c,e.clientX,e.clientY)},handleDragEnd:()=>{O(c),C.current=!1},type:c.type,elementProps:{resource:c},onClick:T(Y),cloneElement:E,cloneProps:V}))}));module.exports=v;
