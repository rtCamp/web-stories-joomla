/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("styled-components");require("prop-types");var t=require("@googleforcreators/react"),i=require("polished"),a=require("@googleforcreators/i18n"),o=require("@googleforcreators/design-system"),s=require("react-blurhash"),n=require("../local/dropDownMenu.js");require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/templates"),require("../../../../../app/config/context.js"),require("../../../../../app/api/context.js"),require("../../../../../constants/fonts.js"),require("../../../../../constants/multipleValue.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../../app/history/historyProvider.js"),require("../../../../../app/history/context.js"),require("../../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../../utils/generateBlurhash.worker.js"),require("../../../../../app/media/media3p/providerConfiguration.js"),require("../../../../../app/media/utils/useFFmpeg.js"),require("../../../../../app/media/media3p/api/context.js"),require("../../../../../app/media/local/constants.js"),require("../../../../../app/media/media3p/providerReducer.js"),require("../../../../../app/media/context.js");var u=require("../../../../../app/media/local/useLocalMedia.js"),l=require("../../../../../app/media/media3p/constants.js"),c=require("../../../../tooltip/tooltip.js"),d=require("./attribution.js"),p=require("./innerElement.js"),g=require("./insertionMenu.js");function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var f=m(e),h=m(r);const q=h.default.div.attrs((e=>({style:{width:e.width+"px",height:e.height+"px",margin:e.margin,backgroundColor:"transparent",color:"inherit",border:"none",padding:0}}))).withConfig({displayName:"mediaElement__Container",componentId:"sc-n7038j-0"})([""]),y=h.default.div.withConfig({displayName:"mediaElement__InnerContainer",componentId:"sc-n7038j-1"})(["position:relative;display:flex;margin-bottom:10px;background-color:",";"],(e=>{let{theme:r,$baseColor:t}=e;return t||i.rgba(r.colors.standard.black,.3)})),C=h.default(s.Blurhash).withConfig({displayName:"mediaElement__BlurhashContainer",componentId:"sc-n7038j-2"})(["position:absolute !important;top:0;left:0;"]);function Element(e){let{index:r,resource:i,width:s,height:c,margin:m,onInsert:h,providerType:E,canEditMedia:j}=e;const{id:b,src:v,type:R,width:w,height:M,alt:P,isMuted:k,baseColor:x,blurHash:I}=i,{isCurrentResourceProcessing:T,isCurrentResourceUploading:S}=u((e=>{let{state:r}=e;return{isCurrentResourceProcessing:r.isCurrentResourceProcessing,isCurrentResourceUploading:r.isCurrentResourceUploading}})),_=w&&M?w/M:1,U=s||c/_,N=c||U/_,B=t.useRef(),[L,A]=t.useState(!0),[F,D]=t.useState(!1),[O,V]=t.useState(!1),[$,G]=t.useState(!1),H=t.useCallback((()=>D(!0)),[]),z=t.useCallback((()=>D(!1)),[]),J=t.useCallback((()=>V(!0)),[]),K=t.useCallback((()=>V(!1)),[]),Q=t.useCallback((()=>{V(!1),D(!1)}),[]),[W,X]=t.useState(null),Y=t.useRef(F);Y.current=F,t.useEffect((()=>{if(![l.ContentType.VIDEO,l.ContentType.GIF].includes(R))return;const e=()=>{null!==W&&(clearTimeout(W),X(null))};if(!O)if(F){if(A(!1),B.current&&null==W){const e=setTimeout((()=>{Y.current&&v&&B.current.play().catch((()=>{}))}),600);X(e)}}else A(!0),e(),B.current&&B.current?.pause&&v&&(B.current.pause(),B.current.currentTime=0);return e}),[O,F,R,v,W,X,Y]);const Z=t.useCallback((e=>()=>{h(i,e)}),[h,i]),ee=F&&i.attribution?.author?.displayName&&i.attribution?.author?.url&&f.default.createElement(d,{author:i.attribution.author.displayName,url:i.attribution.author.url}),re=t.useRef(),te=t.useCallback((()=>G(!0)),[]),ie=!$&&!F;return f.default.createElement(q,{ref:re,"data-testid":`mediaElement-${R}`,"data-id":b,className:"mediaElement",width:U,height:N,margin:m,onPointerEnter:H,onFocus:H,onPointerLeave:z,onBlur:z,tabIndex:"-1"},f.default.createElement(y,{$baseColor:ie&&x},f.default.createElement(p,{type:R,src:v,mediaElement:B,resource:i,alt:P,isMuted:k,width:U,height:N,onClick:Z,onLoad:te,showVideoDetail:L,active:F}),ee,ie&&I&&f.default.createElement(C,{hash:I,width:U,height:N,punch:1}),(!v||T(b)||S(b))&&f.default.createElement(o.LoadingBar,{loadingMessage:a.__("Uploading media…","web-stories")}),f.default.createElement(g,{resource:i,display:F,onInsert:h,width:U,index:r,isLocal:"local"===E,setParentActive:H,setParentInactive:z}),"local"===E&&j&&f.default.createElement(n,{resource:i,display:F,isMenuOpen:O,onMenuOpen:J,onMenuCancelled:K,onMenuSelected:Q,setParentActive:H})))}function MediaElement(e){const{isCurrentResourceProcessing:r,isCurrentResourceUploading:t}=u((e=>{let{state:r}=e;return{isCurrentResourceProcessing:r.isCurrentResourceProcessing,isCurrentResourceUploading:r.isCurrentResourceUploading}})),{id:i}=e.resource;return r(i)||t(i)?f.default.createElement(c,{title:a.__("Uploading media…","web-stories")},f.default.createElement(Element,e)):f.default.createElement(Element,e)}MediaElement.defaultProps={providerType:"local",canEditMedia:!1};var E=t.memo(MediaElement);module.exports=E;
