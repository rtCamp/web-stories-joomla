/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("@googleforcreators/i18n"),r=require("@googleforcreators/design-system"),a=require("@googleforcreators/react"),o=require("styled-components");require("prop-types");var l=require("@wmik/use-media-recorder"),i=require("@googleforcreators/media"),s=require("uuid"),n=require("../../../../../dialog/dialog.js"),u=require("../../../../../canvas/useUploadWithPreview.js"),c=require("./imageCapture.js");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=d(e),g=d(o),b=d(l);const f=g.default.video.withConfig({displayName:"modal__Video",componentId:"sc-mu21h6-0"})(["width:100%;height:100%;"]),p=g.default.div.withConfig({displayName:"modal__VideoWrapper",componentId:"sc-mu21h6-1"})(["width:240px;aspect-ratio:9 / 16;background:#000;margin:0 auto;"]);module.exports=function Modal(e){let{isOpen:o,onClose:l}=e;const d=a.useRef(),[g,_]=a.useState(null),[E,S]=a.useState(!1),[T,w]=a.useState(!0),[C,h]=a.useState(!0),y=a.useCallback((e=>{const t=i.blobToFile(e,"test-recording.webm","video/webm");_(t)}),[]),v=u(),{error:R,status:q,mediaBlob:M,stopRecording:O,startRecording:P,liveStream:k,clearMediaStream:x,clearMediaBlob:A}=b.default({recordScreen:!1,blobOptions:{type:"video/webm"},mediaStreamConstraints:{audio:C,video:T},onStop:y}),I=a.useCallback((()=>{x(),A(),l(),d.current&&(d.current.srcObject=null),S(!1)}),[A,x,l]),L=a.useCallback((()=>{v([g]),l(),"recording"===q&&(O(),S(!1),_(null))}),[g,v,l,q,O]);a.useEffect((()=>{d.current&&k&&(d.current.srcObject=k)}),[k]);const N="recording"===q,j=a.useMemo((()=>`toggle_${s.v4()}`),[]),Y=a.useMemo((()=>`toggle_${s.v4()}`),[]),B=t.__("Insert","web-stories");return m.default.createElement(n,{onClose:I,isOpen:o,title:t.__("Record video / audio","web-stories"),onPrimary:L,primaryText:B,secondaryText:t.__("Cancel","web-stories"),primaryRest:{disabled:"stopped"!==q&&!1===E}},m.default.createElement(r.Text,null,t.__("Record content for your story using your camera / microphone.","web-stories")),m.default.createElement(r.Text,null,R?`${q} ${R.message}`:q),!E&&m.default.createElement(p,null,M&&!k&&m.default.createElement(m.default.Fragment,null,m.default.createElement(f,{src:URL.createObjectURL(M),autoPlay:!0,controls:!0})),!M&&k&&m.default.createElement(f,{ref:d,autoPlay:!0})),N&&m.default.createElement(c.ImageCapture,{videoRef:d,onCapture:e=>{_(e),S(!0)},onClear:E?()=>S(!1):null}),m.default.createElement(r.Text,{as:"label",htmlFor:j,size:r.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},t.__("Camera","web-stories")),m.default.createElement(r.Toggle,{id:j,"aria-label":t.__("Enable camera","web-stories"),name:j,checked:T,onChange:()=>w((e=>!e))}),m.default.createElement(r.Text,{as:"label",htmlFor:Y,size:r.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},t.__("Microphone","web-stories")),m.default.createElement(r.Toggle,{id:Y,"aria-label":t.__("Enable microphone","web-stories"),name:Y,checked:C,onChange:()=>h((e=>!e))}),m.default.createElement(r.Button,{type:r.BUTTON_TYPES.PRIMARY,size:r.BUTTON_SIZES.SMALL,onClick:N?O:P,disabled:!1},N?t.__("Stop recording","web-stories"):t.__("Start recording","web-stories")))};
