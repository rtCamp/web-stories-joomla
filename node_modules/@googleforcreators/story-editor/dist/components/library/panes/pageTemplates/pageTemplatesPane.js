/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),r=require("@googleforcreators/react"),t=require("styled-components"),a=require("@googleforcreators/i18n"),o=require("@googleforcreators/units"),s=require("@googleforcreators/design-system"),i=require("@googleforcreators/migration"),l=require("@googleforcreators/tracking"),u=require("../shared/index.js");require("../../../form/color/color.js"),require("../../../form/filterToggle/filterToggle.js"),require("../../../form/linkIcon.js"),require("../../../form/link.js"),require("../../../form/media.js"),require("@googleforcreators/media"),require("prop-types"),require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js");var n=require("../../../../app/config/useConfig.js");require("../../../../app/api/context.js");var p=require("../../../../app/api/useAPI.js");require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../constants/fonts.js"),require("../../../../constants/multipleValue.js"),require("../../../../app/font/context.js"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../text/textPresets.js"),require("../../../../app/canvas/context.js"),require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js"),require("../../../form/row.js"),require("../../../form/switch.js"),require("../../../form/textArea.js"),require("../../../form/context.js"),require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js");var c=require("../../../form/select/select.js");require("../../../form/hierarchical/index.js");var m=require("../../useLibrary.js"),d=require("./paneId.js"),g=require("./defaultTemplates.js"),f=require("./savedTemplates.js"),q=require("./templateSave.js");function j(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=j(e),T=j(t);function y(){return y=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},y.apply(this,arguments)}const v=T.default(u.Pane).withConfig({displayName:"pageTemplatesPane__StyledPane",componentId:"sc-hm7mfr-0"})(["height:100%;padding:0;overflow:hidden;"]),x=T.default.div.withConfig({displayName:"pageTemplatesPane__PaneInner",componentId:"sc-hm7mfr-1"})(["height:100%;display:flex;flex-direction:column;"]),E=T.default.div.withConfig({displayName:"pageTemplatesPane__DropDownWrapper",componentId:"sc-hm7mfr-2"})(["text-align:left;margin:28px 16px 17px;"]),_=T.default.div.withConfig({displayName:"pageTemplatesPane__ButtonWrapper",componentId:"sc-hm7mfr-3"})(["padding:0 1em;margin-top:24px;"]),S=s.LOCAL_STORAGE_PREFIX.DEFAULT_VIEW_PAGE_TEMPLATE_LAYOUT,P=s.localStore.getItemByKey(S);exports.PaneInner=x,exports.StyledPane=v,exports.default=function PageTemplatesPane(e){const{actions:{getCustomPageTemplates:t}}=p(),{canViewDefaultTemplates:u}=n(),j=Boolean(t),{savedTemplates:T,setSavedTemplates:I,nextTemplatesToFetch:w,setNextTemplatesToFetch:A}=m((e=>({savedTemplates:e.state.savedTemplates,nextTemplatesToFetch:e.state.nextTemplatesToFetch,setSavedTemplates:e.actions.setSavedTemplates,setNextTemplatesToFetch:e.actions.setNextTemplatesToFetch}))),[C,b]=r.useState(null===P?u:u&&P),[F,k]=r.useState(null),[L,O]=r.useState(!1),R=r.useCallback((e=>{I((r=>[e,...r||[]])),k(e.id),s.localStore.setItemByKey(S,!1)}),[I]),M=r.useCallback((()=>{w&&(O(!0),t(w).then((e=>{let{templates:r,hasMore:t}=e;const a=r.map((e=>{let{version:r,templateId:t,...a}=e;const o={pages:[a]},s=i.migrate(o,r||25);return{templateId:t,version:i.DATA_VERSION,...s.pages[0]}}));I((e=>[...e||[],...a])),A(!!t&&w+1)})).catch((e=>{l.trackError("saved_templates",e.message),A(!1),I((e=>e??[]))})).finally((()=>O(!1))))}),[t,w,I,A]);r.useEffect((()=>{T||C||M()}),[T,M,C]),r.useEffect((()=>{let e=null;return F&&(e=setTimeout((()=>{k(null)}),1e3)),()=>clearTimeout(e)}),[F]);const D=[];u&&D.push({value:"default",label:a.__("Default templates","web-stories")}),j&&D.push({value:"saved",label:a.__("Saved templates","web-stories")});const N=r.useMemo((()=>({width:158,height:Math.round(158/o.PAGE_RATIO),containerHeight:Math.round(158/o.FULLBLEED_RATIO)})),[]);return h.default.createElement(v,y({id:d},e),h.default.createElement(x,null,h.default.createElement(h.default.Fragment,null,j&&h.default.createElement(_,null,h.default.createElement(q,{setShowDefaultTemplates:b,updateList:R})),h.default.createElement(E,null,D.length>1&&h.default.createElement(c,{options:D,selectedValue:C?"default":"saved",onMenuItemClick:(e,r)=>{const t="default"===r;C!==t&&(b("default"===r),s.localStore.setItemByKey(S,t))},"aria-label":a.__("Select templates type","web-stories")}))),C?h.default.createElement(g,{pageSize:N}):h.default.createElement(f,{pageSize:N,highlightedTemplate:F,loadTemplates:M,isLoading:L})))};
