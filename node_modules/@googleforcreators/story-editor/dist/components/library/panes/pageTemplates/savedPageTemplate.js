/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),t=require("@googleforcreators/design-system"),a=require("@googleforcreators/i18n"),r=require("@googleforcreators/react");require("prop-types");var i=require("styled-components"),l=require("@googleforcreators/patterns"),o=require("@googleforcreators/media"),s=require("@googleforcreators/tracking");require("@googleforcreators/templates"),require("../../../../app/config/context.js");var p=require("../../../../app/config/useConfig.js");require("../../../../app/api/context.js");var n=require("../../../../app/api/useAPI.js"),u=require("../../../../app/pageDataUrls/usePageDataUrls.js");require("@googleforcreators/units"),require("../../../../utils/storyPageToNode.js"),require("../../../../app/pageDataUrls/context.js");var d=require("../../../../app/uploader/useUploader.js"),g=require("../../../../types.js"),c=require("../../../panels/shared/styles.js"),m=require("../../../canvas/displayElement.js"),f=require("../shared/insertionOverlay.js"),h=require("../../../canvas/useFocusCanvas.js"),v=require("../shared/index.js"),q=require("../../../../utils/useRovingTabIndex/index.js"),y=require("../../useLibrary.js");function P(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var S=P(e),b=P(i);const T=b.default.img.withConfig({displayName:"savedPageTemplate__TemplateImage",componentId:"sc-5hfe38-0"})(["width:100%;height:auto;"]),w=b.default.div.withConfig({displayName:"savedPageTemplate__PageTemplateWrapper",componentId:"sc-5hfe38-1"})(["height:","px;width:","px;cursor:pointer;",";",";"],(e=>{let{pageSize:t}=e;return t.height}),(e=>{let{pageSize:t}=e;return t.width}),(e=>{let{isHighlighted:a}=e;return a&&t.themeHelpers.focusCSS}),c.focusStyle);w.propTypes={pageSize:g.PageSizePropType.isRequired};const I=b.default.div.withConfig({displayName:"savedPageTemplate__PreviewPageWrapper",componentId:"sc-5hfe38-2"})(["position:relative;height:","px;width:","px;background-color:",";border-radius:",";overflow:hidden;",""],(e=>{let{pageSize:t}=e;return t.height}),(e=>{let{pageSize:t}=e;return t.width}),(e=>{let{theme:t}=e;return t.colors.interactiveBg.secondary}),(e=>{let{theme:t}=e;return t.borders.radius.small}),(e=>{let{background:t}=e;return l.generatePatternStyles(t)}));I.propTypes={pageSize:g.PageSizePropType.isRequired};const j=b.default(v.ActionButton).withConfig({displayName:"savedPageTemplate__DeleteButton",componentId:"sc-5hfe38-3"})(["top:4px;right:4px;"]);function SavedPageTemplate(e,i){let{page:l,pageSize:g,handleDelete:c,index:P,...b}=e;const{capabilities:{hasUploadMediaAction:_}}=p(),{actions:{updatePageTemplate:x}}=n(),{actions:{uploadFile:E}}=d(),{updateSavedTemplate:C}=y((e=>({updateSavedTemplate:e.actions.updateSavedTemplate}))),k=u((e=>{let{actions:t}=e;return t.queuePageImageGeneration})),z=u((e=>{let{state:{dataUrls:t}}=e;return t[l.id]})),[D,F]=r.useState(!1);r.useFocusOut(i,(()=>F(!1)),[]);const{highlightedTemplate:R,onClick:U}=b,B=r.useCallback((()=>F(!0)),[]),N=r.useCallback((()=>{F(!1)}),[]),A=l.image?.url||z,H=_&&z&&!l.image?.url;r.useEffect((()=>{H&&(async()=>{try{const e=await o.fetchRemoteBlob(z),t=o.blobToFile(e,`web-stories-page-template-${l.templateId}.jpg`,"image/jpeg"),a=await E(t,{templateId:l.templateId,mediaSource:"page-template"});x(l.templateId,{featured_media:a.id}),C({templateId:l.templateId,image:{id:a.id,height:a.height,width:a.width,url:a.src}})}catch(e){s.trackError("upload_generated_page_template_image",e?.message)}})()}),[z,E,x,l.templateId,H,C]),r.useEffect((()=>{!A&&_&&k(l)}),[A,k,l,_]);const $=r.useRef(),L=r.useRef();q.default({ref:$},[],2),q.default({ref:L},[],2);const M=h();return t.useKeyDownEffect(L,"tab",M,[M]),S.default.createElement(w,{pageSize:g,role:"listitem",ref:i,onPointerEnter:B,onPointerLeave:N,"aria-label":l.title,isHighlighted:l.id===R,onFocus:B,onBlur:N,onClick:U},S.default.createElement(I,{pageSize:g,background:l.backgroundColor},A?S.default.createElement(T,{alt:l.image?.alt||a.__("Saved Page Template","web-stories"),src:A,height:l.image?.height,width:l.image?.height,draggable:!1}):l.elements.map((e=>S.default.createElement(m,{key:e.id,previewMode:!0,element:e}))),D&&S.default.createElement(f,{showIcon:!1}),S.default.createElement(v.ActionButton,{ref:$,onClick:e=>{e.stopPropagation(),U(e)},"aria-label":a.__("Use template","web-stories"),$display:D,tabIndex:0===P?0:-1},S.default.createElement(t.Icons.PlusFilledSmall,null)),S.default.createElement(j,{ref:L,$display:D,onClick:e=>{e.stopPropagation(),c(l,e)},"aria-label":a.__("Delete Page Template","web-stories"),tabIndex:D?0:-1},S.default.createElement(t.Icons.TrashFilledSmall,null))))}const _=r.forwardRef(SavedPageTemplate);SavedPageTemplate.displayName="SavedPageTemplate",module.exports=_;
