/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react");require("prop-types");var r=require("@googleforcreators/react"),t=require("styled-components"),o=require("@googleforcreators/units"),a=require("@googleforcreators/design-system"),n=require("@googleforcreators/moveable"),s=require("@googleforcreators/transform"),i=require("../../../../constants/index.js");require("../../../dropTargets/provider.js");var u=require("../../../dropTargets/useDropTargets.js"),l=require("../../../../app/layout/useLayout.js");require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js");var c=require("../../../canvas/useInsertElement.js");require("../../../canvas/canvasLayout.js");var p=require("../../../canvas/useInsertTextSet.js"),g=require("../../../../utils/isTargetOutOfContainer.js"),d=require("../../../canvas/utils/useSnapping.js");require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js"),require("../../../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking");var f=require("../../../../utils/objectWithout.js");require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var q=require("../../../../app/story/useStory.js");require("@googleforcreators/i18n"),require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js");var m=require("../../../../utils/noop.js");require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/rich-text"),require("../text/textPresets.js"),require("../../../../app/canvas/context.js");var y=require("../../../../app/canvas/useCanvas.js");require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js");var h=require("../../../../utils/usePerformanceTracking.js"),v=require("../../../../constants/performanceTrackingEvents.js");function j(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var T=j(e);function x(){return x=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},x.apply(this,arguments)}const E=j(t).default.div.withConfig({displayName:"libraryMoveable__TargetBox",componentId:"sc-jgbz52-0"})(["position:absolute;width:100%;height:100%;top:0;z-index:1;cursor:pointer;"]);module.exports=function LibraryMoveable(e){let{type:t,elementProps:j={},handleDrag:b,handleDragEnd:D,onClick:S=m.noop,cloneElement:C,cloneProps:R,elements:w=[],active:I=!1}=e;const O=C,[P,k]=r.useState(!1),[X,$]=r.useState(!1),[B,N]=r.useState(!1),Y=r.useRef(null),M=r.useRef(null),F=r.useRef(null),L=r.useRef(null),Z=r.useRef(null),_=l((e=>{let{state:{pageWidth:r,pageHeight:t}}=e;return{width:r,height:t}})),{setZoomSetting:z}=l((e=>{let{actions:{setZoomSetting:r}}=e;return{setZoomSetting:r}})),A=c(),{backgroundElement:G}=q((e=>({backgroundElement:e.state.currentPage?.elements?.[0]??{}}))),{fullbleedContainer:K,nodesById:U,pageContainer:W}=y((e=>({fullbleedContainer:e.state.fullbleedContainer,pageContainer:e.state.pageContainer,nodesById:e.state.nodesById}))),{activeDropTargetId:H,setDraggingResource:V}=u((e=>{let{state:{activeDropTargetId:r},actions:{setDraggingResource:t}}=e;return{activeDropTargetId:r,setDraggingResource:t}})),{clearTransforms:J,pushTransform:Q}=s.useTransform((e=>({clearTransforms:e.actions.clearTransforms,pushTransform:e.actions.pushTransform}))),ee={translate:[0,0]},{insertTextSetByOffset:re}=p(),te=r.useRef({}),oe=r.useCallback((()=>{M.current.style.transform=null,Y.current.style.transform=null,Y.current.style.opacity=0,k(!1),J(),V(null)}),[V,J]);a.useKeyDownEffect(P?document.body:{current:null},"esc",(()=>{$(!0),oe()}),[P,oe]);const ae=r.useCallback((()=>{let e=0,r=0;for(let t=L.current;t;t=t.offsetParent)e+=t.offsetLeft,r+=t.offsetTop;return{offsetX:e,offsetY:r}}),[L]);h({node:M.current,eventData:{...v.TRACKING_EVENTS.INSERT_ELEMENT,label:t},eventType:"pointerdown"});const{offsetX:ne}=ae(),se=d({isDragging:!0,canSnap:!0,otherNodes:Object.values(f(U,[G.id])),snappingOffsetX:ne});return T.default.createElement(T.default.Fragment,null,T.default.createElement(E,{ref:M,onPointerOver:()=>N(!0),onPointerOut:()=>N(!1)}),(P||I||B)&&T.default.createElement(T.default.Fragment,null,T.default.createElement(n.InOverlay,{ref:L,zIndex:1,pointerEvents:"none",render:()=>T.default.createElement(O,x({ref:Y},R))}),T.default.createElement(n.Moveable,x({ref:Z,className:"default-moveable hide-handles",target:M.current,edge:!0,draggable:!0,origin:!1,pinchable:!0,onDragStart:e=>{let{set:r,inputEvent:t}=e;t.stopPropagation(),$(!1),r(ee.translate),k(!0),(e=>{const{timeStamp:r,clientX:t,clientY:o}=e;te.current={timeStamp:r,clientX:t,clientY:o}})(t),z(i.ZOOM_SETTING.FIT);const{offsetX:o,offsetY:a}=ae(),n=M.current.getBoundingClientRect();F.current={width:n.width,height:n.height},M.current.style.width=`${R.width}px`,M.current.style.height=`${R.height}px`;const s=n.left-o,u=n.top-a;Y.current.style.left=`${s}px`,Y.current.style.top=`${u}px`,Z.current&&Z.current.updateRect()},onDrag:e=>{let{beforeTranslate:r,inputEvent:t}=e;if(Q(null,{drag:r}),X)return!1;ee.translate=r,Y.current&&n.areEventsDragging(te.current,t)&&(1===Y.current.style.opacity||H?H&&(Y.current.style.opacity=0):Y.current.style.opacity=1,Y.current.style.transform=`translate(${r[0]}px, ${r[1]}px)`,M.current.style.transform=`translate(${r[0]}px, ${r[1]}px)`),b?.(t)},onDragEnd:e=>{let{inputEvent:r}=e;if(X)return!1;if(M.current.style.width=`${F.current.width}px`,M.current.style.height=`${F.current.height}px`,!n.areEventsDragging(te.current,r))return oe(),S(),!1;if(H&&D)D();else if(!g(Y.current,K)){const{x:e,y:r,width:a,height:n}=Y.current.getBoundingClientRect(),{x:s,y:i}=W.getBoundingClientRect();"textSet"===t?re(w,{offsetX:o.editorToDataX(e-s,_.width),offsetY:o.editorToDataY(r-i,_.height)}):A(t,{...j,x:o.editorToDataX(e-s,_.width),y:o.editorToDataY(r-i,_.height),width:o.editorToDataX(a,_.width),height:o.editorToDataY(n,_.height)})}oe()}},se))))};
