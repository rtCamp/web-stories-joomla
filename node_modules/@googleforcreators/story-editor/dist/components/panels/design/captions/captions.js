/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("styled-components"),r=require("react");require("prop-types");var t=require("uuid"),s=require("@googleforcreators/react"),o=require("@googleforcreators/i18n"),i=require("@googleforcreators/design-system"),a=require("flagged");require("../../../form/color/color.js"),require("../../../form/filterToggle/filterToggle.js"),require("../../../form/linkIcon.js"),require("../../../form/link.js"),require("../../../form/media.js"),require("@googleforcreators/media"),require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js");var n=require("../../../../app/config/useConfig.js");require("../../../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../constants/fonts.js");var u=require("../../../../constants/multipleValue.js");require("../../../../app/font/context.js"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/units"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js"),require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js"),require("../../../form/row.js"),require("../../../form/switch.js"),require("../../../form/textArea.js");var l=require("../../../form/usePresubmitHandler.js");require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js"),require("../../../form/select/select.js"),require("../../../form/hierarchical/index.js"),require("../../panel/panel.js"),require("../../panel/context.js"),require("../../panel/shared/title.js"),require("../../panel/shared/content.js");var c=require("../../panel/simplePanel.js");require("../../shared/flipControls.js"),require("../../shared/linkRelations.js");var p=require("../../shared/getCommonValue.js"),d=require("../../../../app/highlights/index.js"),g=require("../../shared/captionsPanelContent.js"),q=require("../../../../app/highlights/useHighlights.js"),f=require("../../../../app/highlights/states.js");function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var j=m(e),h=m(r);const y=j.default(i.Button).withConfig({displayName:"captions__StyledButton",componentId:"sc-17zds0n-0"})(["",";"],(e=>{let{theme:r}=e;return i.themeHelpers.focusableOutlineCSS(r.colors.border.focus,r.colors.bg.secondary)})),T=j.default(y).withConfig({displayName:"captions__UploadButton",componentId:"sc-17zds0n-1"})(["padding:12px 8px;"]);var x=j.default(T).withConfig({displayName:"captions___StyledUploadButton",componentId:"sc-17zds0n-2"})(["",""],(e=>e.$_css));const _={ALT_TEXT:{MAX:1e3}};var v=j.default(c).withConfig({displayName:"captions___StyledSimplePanel",componentId:"sc-17zds0n-3"})(["",""],(e=>e.$_css2));exports.MIN_MAX=_,exports.default=function CaptionsPanel(e){let{selectedElements:r,pushUpdate:c}=e;const m=p(r,"tracks",[]),j=m===u.MULTIPLE_VALUE,y=a.useFeature("captionHotlinking"),{capabilities:{hasUploadMediaAction:T}}=n();l((e=>{let{resource:r}=e;return{resource:{...r,alt:r.alt?.slice(0,_.ALT_TEXT.MAX)}}}),[]);const C=s.useCallback((e=>{let r=[];if(e){const t=m.findIndex((r=>{let{id:t}=r;return t===e}));r=[...m.slice(0,t),...m.slice(t+1)]}c({tracks:r},!0)}),[m,c]),E=s.useCallback((e=>{let{src:r="",id:s,needsProxy:o=!1}=e;const i={track:r,trackId:s,trackName:r.split("/").pop(),id:t.v4(),kind:"captions",srclang:"",label:"",needsProxy:o};c({tracks:[...m,i]},!0)}),[m,c]),{highlight:k,resetHighlight:S}=q((e=>({highlight:e[f.default.CAPTIONS],resetHighlight:e.onFocusOut,cancelHighlight:e.cancelEffect}))),A=s.useCallback((e=>h.default.createElement(x,{onAnimationEnd:()=>S(),ref:e=>{e&&k?.focus&&k?.showEffect&&e.focus()},onClick:e,type:i.BUTTON_TYPES.SECONDARY,size:i.BUTTON_SIZES.SMALL,variant:i.BUTTON_VARIANTS.RECTANGLE,$_css:k?.showEffect&&d.styles.OUTLINE},o.__("Upload a file","web-stories"))),[S,k?.focus,k?.showEffect]);return T||y||m.length?h.default.createElement(v,{onAnimationEnd:()=>S(),name:"caption",title:o.__("Caption and Subtitles","web-stories"),isPersistable:!k,$_css2:k?.showEffect&&d.styles.FLASH},h.default.createElement(g,{isIndeterminate:j,tracks:j?[]:m,handleChangeTrack:E,handleRemoveTrack:C,renderUploadButton:A})):null};
