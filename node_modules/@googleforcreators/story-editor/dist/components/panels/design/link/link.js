/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("styled-components"),r=require("react"),t=require("@googleforcreators/react");require("prop-types");var i=require("@googleforcreators/i18n"),s=require("@googleforcreators/design-system"),a=require("@googleforcreators/url");require("../../../../constants/fonts.js");var o=require("../../../../constants/multipleValue.js");require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js"),require("../../../../app/api/context.js");var n=require("../../../../app/api/useAPI.js");require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns");var l=require("../../../../utils/useCORSProxy.js");require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/units"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js");var u=require("../../../../app/canvas/useCanvas.js");require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js");var c=require("../../../../utils/useElementsWithLinks.js");require("../../../form/color/color.js"),require("../../../form/filterToggle/filterToggle.js");var p=require("../../../form/linkIcon.js"),d=require("../../../form/link.js");require("../../../form/media.js");var g=require("../../../form/row.js");require("../../../form/switch.js"),require("../../../form/textArea.js"),require("../../../form/context.js"),require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js"),require("../../../form/select/select.js"),require("../../../form/hierarchical/index.js");var f=require("../../../elementLink/index.js");require("../../panel/panel.js"),require("../../panel/context.js"),require("../../panel/shared/title.js"),require("../../panel/shared/content.js");var q=require("../../panel/simplePanel.js"),m=require("../../shared/styles.js");require("../../shared/flipControls.js");var h=require("../../shared/linkRelations.js"),j=require("../../shared/useCommonObjectValue.js"),y=require("../../../../app/highlights/index.js"),E=require("../../../../app/highlights/useHighlights.js"),L=require("../../../../app/highlights/states.js");function k(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var x=k(e),_=k(r);const v=x.default.div.withConfig({displayName:"link__IconInfo",componentId:"sc-niusn4-0"})(["display:flex;flex-direction:column;margin-left:20px;"]),w=x.default(s.Text).withConfig({displayName:"link__IconText",componentId:"sc-niusn4-1"})(["color:",";"],(e=>{let{theme:r}=e;return r.colors.fg.secondary})),P=x.default.span.withConfig({displayName:"link__Error",componentId:"sc-niusn4-2"})(["font-size:12px;line-height:16px;color:",";"],(e=>{let{theme:r}=e;return r.colors.fg.negative}));var b=x.default(q).withConfig({displayName:"link___StyledSimplePanel",componentId:"sc-niusn4-3"})(["",""],(e=>e.$_css));module.exports=function LinkPanel(e){let{selectedElements:r,pushUpdateForObject:q}=e;const{clearEditing:k,setDisplayLinkGuidelines:x,displayLinkGuidelines:I}=u((e=>({clearEditing:e.actions.clearEditing,setDisplayLinkGuidelines:e.actions.setDisplayLinkGuidelines,displayLinkGuidelines:e.state.displayLinkGuidelines}))),{highlight:T,resetHighlight:C,cancelHighlight:U}=E((e=>({highlight:e[L.default.LINK],resetHighlight:e.onFocusOut,cancelHighlight:e.cancelEffect}))),{hasElementsInAttachmentArea:A}=c(),S=t.useMemo((()=>f.createLink({icon:null,desc:null})),[]),M=j(r,"link",S),R=f.createLink(M),{url:V="",desc:O="",icon:G,rel:H=[]}=R,[F,N]=t.useState(!1),[D,B]=t.useState(!1),{actions:{getLinkMetadata:Y}}=n(),{getProxiedUrl:W,checkResourceAccess:z}=l(),Z=t.useBatchingCallback((e=>{let{newUrl:r,newTitle:t,newIcon:i,needsProxy:s}=e;return q("link",(()=>r?f.createLink({url:r,needsProxy:s,desc:t||"",icon:i?a.toAbsoluteUrl(r,i):""}):null),S,!0)}),[q,S]),[$,K]=t.useState(!a.isValidUrl(a.withProtocol(V))),J=t.useDebouncedCallback(t.useCallback((async e=>{if(e.startsWith("http://")||e.startsWith("https://")){N(!0);try{const{title:r,image:t}=Y?await Y(e):{},i=!!t&&await z(t);Z({newUrl:e,newTitle:r,newIcon:t,needsProxy:i})}catch(e){K(!0)}finally{N(!1)}}}),[z,Y,Z]),1200),Q=t.useCallback(((e,r)=>{if(k(),J.cancel(),e.url){if(o.MULTIPLE_VALUE===e.url)return;const r=a.withProtocol(e.url),t=a.isValidUrl(r);K(!t),t&&J(r)}q("link",""!==e.url?{...e}:null,S,r)}),[k,q,S,J]),X=t.useCallback((e=>{Q({icon:e?.src},!0)}),[Q]),ee=Boolean(V?.length),re=ee&&!$;t.useEffect((()=>{if(D){const e=ee&&V!==o.MULTIPLE_VALUE;x(A&&!e)}}),[r,D,A,ee,x,V]);const te=G?W(R,G):null,ie=o.MULTIPLE_VALUE===V,se=o.MULTIPLE_VALUE===O,ae=o.MULTIPLE_VALUE===H,oe=t.useCallback((e=>Q({rel:e},!0)),[Q]);return _.default.createElement(b,{name:"link",title:i.__("Link","web-stories"),onAnimationEnd:()=>C(),isPersistable:!T,$_css:T?.showEffect&&y.styles.FLASH},_.default.createElement(d,{ref:e=>{e&&T?.focus&&T?.showEffect&&(e.addEventListener("keydown",U,{once:!0}),e.focus())},onChange:e=>!I&&Q({url:e},!e),onBlur:()=>{x(!1),B(!1)},onFocus:()=>{B(!0)},value:V||"",placeholder:ie?o.MULTIPLE_DISPLAY_VALUE:i.__("Enter an address to apply a link","web-stories"),isIndeterminate:ie,"aria-label":i.__("Element link","web-stories"),hasError:I}),I&&_.default.createElement(g,null,_.default.createElement(P,null,i.__("Link can not reside below the dashed line when a page attachment is present","web-stories"))),re&&_.default.createElement(_.default.Fragment,null,_.default.createElement(g,null,_.default.createElement(s.Input,{placeholder:se?o.MULTIPLE_DISPLAY_VALUE:i.__("Optional description","web-stories"),onChange:e=>{let{target:r}=e;return Q({desc:r.value},!r.value)},value:O,"aria-label":i.__("Link description","web-stories"),isIndeterminate:se,disabled:F,containerStyleOverride:m.inputContainerStyleOverride})),_.default.createElement(g,{spaceBetween:!1},_.default.createElement(p,{handleChange:X,icon:te,isLoading:F,disabled:F}),_.default.createElement(v,null,_.default.createElement(w,{size:s.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},i.__("Optional brand icon","web-stories")))),!ae&&_.default.createElement(h,{onChangeRel:oe,rel:H})))};
