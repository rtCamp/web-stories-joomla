/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/react"),t=require("@googleforcreators/i18n"),a=require("@googleforcreators/url"),o=require("@googleforcreators/design-system"),s=require("uuid"),i=require("styled-components");require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("prop-types"),require("@googleforcreators/templates"),require("../../../../app/config/context.js"),require("../../../../app/api/context.js");var n=require("../../../../app/api/useAPI.js");require("@googleforcreators/fonts"),require("@googleforcreators/dom");var l=require("../../../../constants/index.js");require("../../../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var u=require("../../../../app/story/useStory.js");require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns");var c=require("../../../../utils/useCORSProxy.js");require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/units"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js");var p=require("../../../../app/canvas/useCanvas.js");require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js");var d=require("../../../../utils/useElementsWithLinks.js");require("../../../form/color/color.js"),require("../../../form/filterToggle/filterToggle.js");var g=require("../../../form/linkIcon.js"),m=require("../../../form/link.js");require("../../../form/media.js");var f=require("../../../form/row.js");require("../../../form/switch.js"),require("../../../form/textArea.js"),require("../../../form/context.js"),require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js"),require("../../../form/select/select.js"),require("../../../form/hierarchical/index.js"),require("../../panel/panel.js"),require("../../panel/context.js"),require("../../panel/shared/title.js"),require("../../panel/shared/content.js");var h=require("../../panel/simplePanel.js");require("../../shared/flipControls.js");var q=require("../../shared/linkRelations.js");function E(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var j=E(e),x=E(i);const y=x.default.label.withConfig({displayName:"pageAttachment__Label",componentId:"sc-qn4x32-0"})(["margin-left:12px;"]),T=x.default(o.Checkbox).withConfig({displayName:"pageAttachment__StyledCheckbox",componentId:"sc-qn4x32-1"})(["",""],(e=>{let{theme:r}=e;return`\n    input[type='checkbox']&.${o.ThemeGlobals.FOCUS_VISIBLE_SELECTOR} ~ div, input[type='checkbox']:focus ~ div {\n      box-shadow: 0px 0px 0 2px ${r.colors.bg.secondary}, 0px 0px 0 4px ${r.colors.border.focus} !important;\n    }\n  `})),_=x.default(f).withConfig({displayName:"pageAttachment__StyledRow",componentId:"sc-qn4x32-2"})(["justify-content:flex-start;"]),b=x.default.div.withConfig({displayName:"pageAttachment__Space",componentId:"sc-qn4x32-3"})(["width:20px;"]),S=x.default(o.Text).attrs({size:o.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL}).withConfig({displayName:"pageAttachment__HelperText",componentId:"sc-qn4x32-4"})(["color:",";"],(e=>{let{theme:r}=e;return r.colors.fg.secondary}));module.exports=function PageAttachmentPanel(){const{currentPage:e,updateCurrentPageProperties:i,hasProducts:E}=u((e=>{let{state:r,actions:t}=e;return{updateCurrentPageProperties:t.updateCurrentPageProperties,currentPage:r.currentPage,hasProducts:r.currentPage.elements?.some((e=>{let{type:r,product:t}=e;return"product"===r&&t?.productId}))}})),{setDisplayLinkGuidelines:x}=p((e=>({setDisplayLinkGuidelines:e.actions.setDisplayLinkGuidelines}))),{actions:{getLinkMetadata:C}}=n(),{pageAttachment:k={}}=e,P=t.__("Learn more","web-stories"),{url:A,ctaText:v=P,icon:w,theme:L,rel:I=[]}=k,[R,N]=r.useState(v),[H,M]=r.useState(A),[O,U]=r.useState(!1),[D,G]=r.useState(!1),{hasLinksInAttachmentArea:K}=d();r.useEffect((()=>()=>{x(!1)}),[K,x,A]),r.useEffect((()=>{O&&A?.length&&U(!1)}),[A,O]);const Y=r.useCallback((e=>{const r={...k,...e};i({properties:{pageAttachment:r}})}),[i,k]),B=r.useDebouncedCallback(Y,300),{getProxiedUrl:F,checkResourceAccess:z}=c(),Z=r.useDebouncedCallback(r.useCallback((async e=>{if(e.startsWith("http://")||e.startsWith("https://")){G(!0);try{const{image:r}=C?await C(e):{},t=r?a.toAbsoluteUrl(e,r):"",o=!!t&&await z(t);Y({url:e,icon:t,needsProxy:o})}catch(r){Y({url:e,icon:"",needsProxy:!1}),V(!0)}finally{G(!1)}}}),[z,C,Y]),1200),[$,V]=r.useState(A&&!a.isValidUrl(a.withProtocol(A).trim())),W=R===P,J=Boolean(A)&&!$,Q=r.useCallback((e=>{Z.cancel(),M(e),V(!1);const r=a.withProtocol(e.trim());a.isValidUrl(r)&&Z(r)}),[Z]),X=r.useCallback((e=>{let{target:r}=e;const{value:t}=r;N(t),B({ctaText:t})}),[B]),ee=r.useCallback((e=>{Y({icon:e?.src},!0)}),[Y]),re=r.useCallback((e=>Y({rel:e},!0)),[Y]),te=r.useCallback((e=>{let{target:r}=e;r.value?(B.cancel(),Y({ctaText:R||P})):(Y({ctaText:P}),N(P))}),[R,B,P,Y]),ae=`cb-${s.v4()}`;if(E)return j.default.createElement(h,{name:"pageAttachment",title:t.__("Call to Action","web-stories"),collapsedByDefault:!1},j.default.createElement(f,null,j.default.createElement(S,null,t.__("Since there are products on this page, you cannot add a regular page attachment, but only customize the appearance of the shopping call to action.","web-stories"))),j.default.createElement(_,null,j.default.createElement(T,{id:ae,checked:L===l.OUTLINK_THEME.DARK,onChange:e=>Y({theme:e.target.checked?l.OUTLINK_THEME.DARK:l.OUTLINK_THEME.LIGHT})}),j.default.createElement(y,{htmlFor:ae},j.default.createElement(o.Text,{as:"span",size:o.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},t.__("Use dark theme","web-stories")))));const oe=w?F(k,w):null;let se;const ie=O||$;return ie&&(se=O?t.__("Links cannot reside below the dashed line when a page attachment is present. If you add a page attachment, your viewers will not be able to click on the link.","web-stories"):t.__("Invalid link","web-stories")),j.default.createElement(h,{name:"pageAttachment",title:t.__("Call to Action","web-stories"),collapsedByDefault:!1},j.default.createElement(m,{onChange:e=>Q(e?.trim()),onBlur:()=>{B.cancel(),Y({url:H?.trim().length?a.withProtocol(H.trim()):""})},onFocus:()=>{K&&!A?.length&&(U(!0),x(!0))},value:H,clear:!0,"aria-label":t.__("Type an address to add a page attachment link","web-stories"),hasError:ie,hint:se}),J&&j.default.createElement(j.default.Fragment,null,j.default.createElement(f,null,j.default.createElement(o.Input,{onChange:X,onBlur:te,value:R,"aria-label":t.__("Page Attachment CTA text","web-stories"),suffix:W?t.__("Default","web-stories"):null})),j.default.createElement(_,null,j.default.createElement(T,{id:ae,checked:L===l.OUTLINK_THEME.DARK,onChange:e=>Y({theme:e.target.checked?l.OUTLINK_THEME.DARK:l.OUTLINK_THEME.LIGHT})}),j.default.createElement(y,{htmlFor:ae},j.default.createElement(o.Text,{as:"span",size:o.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},t.__("Use dark theme","web-stories")))),j.default.createElement(_,null,j.default.createElement(g,{handleChange:ee,icon:oe,isLoading:D,disabled:D}),j.default.createElement(b,null),j.default.createElement(o.Text,{as:"span",size:o.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},t.__("Link icon","web-stories"))),j.default.createElement(q,{onChangeRel:re,rel:I})))};
