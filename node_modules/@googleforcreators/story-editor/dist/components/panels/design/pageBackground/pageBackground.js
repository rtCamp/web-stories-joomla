/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("styled-components"),r=require("react"),t=require("@googleforcreators/react"),a=require("@googleforcreators/i18n");require("prop-types");var o=require("@googleforcreators/design-system"),i=require("@googleforcreators/tracking"),s=require("@googleforcreators/elements"),n=require("../../../form/color/color.js");require("../../../form/filterToggle/filterToggle.js"),require("../../../form/linkIcon.js"),require("../../../form/link.js"),require("../../../form/media.js");var l=require("../../../form/mediaUploadButton.js"),u=require("../../../form/row.js");require("../../../form/switch.js"),require("../../../form/textArea.js"),require("../../../form/context.js"),require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js"),require("../../../form/select/select.js"),require("../../../form/hierarchical/index.js"),require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js");var c=require("../../../../app/config/useConfig.js");require("../../../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../constants/fonts.js"),require("../../../../constants/multipleValue.js"),require("../../../../app/font/context.js"),require("@googleforcreators/media"),require("@googleforcreators/animation"),require("uuid"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js");var p=require("../../../../app/story/useStory.js");require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns");var d=require("../../../../utils/useCORSProxy.js");require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/units");var g=require("../../../../app/layout/useLayout.js");require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text");var m=require("../../../canvas/utils/getElementProperties.js");require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js"),require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js"),require("../../../checklist/checklistContext/context.js"),require("../../../checklist/checkpointContext/checkpointContext.js"),require("../../../checklist/countContext/checkCountContext.js"),require("../../../checklist/checklist.js");var f=require("../../../../app/highlights/index.js"),h=require("../../../checklist/constants.js");require("../../../checklistCard/styles.js"),require("../../../checklist/checks/shared/thumbnailWrapper.js"),require("../../../checklistCard/constants.js"),require("../../../thumbnail/constants.js"),require("../../../thumbnail/styles.js"),require("../../../../types.js"),require("../../../footer/pagepreview/index.js");var q=require("../../../checklist/checks/pageBackgroundLowTextContrast/check.js");require("../../../checklist/checks/videoOptimization.js"),require("../../panel/panel.js"),require("../../panel/context.js"),require("../../panel/shared/title.js"),require("../../panel/shared/content.js");var j=require("../../panel/simplePanel.js"),k=require("../../shared/flipControls.js");require("../../shared/linkRelations.js");var x=require("../warning/warning.js"),y=require("../../../../app/highlights/useHighlights.js"),C=require("../../../../app/highlights/states.js");function E(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _=E(e),T=E(r);const v={horizontal:!1,vertical:!1},B=_.default(u).withConfig({displayName:"pageBackground__Row",componentId:"sc-1rac0x7-0"})(["justify-content:flex-start;"]),b=_.default.div.withConfig({displayName:"pageBackground__SelectedMedia",componentId:"sc-1rac0x7-1"})(["width:128px;height:36px;border-radius:4px;border:1px solid ",";display:flex;justify-content:space-between;margin-right:12px;"],(e=>{let{theme:r}=e;return r.colors.border.defaultNormal})),w=_.default.div.withConfig({displayName:"pageBackground__MediaWrapper",componentId:"sc-1rac0x7-2"})(["height:24px;width:24px;border-radius:4px;overflow:hidden;margin:5px;img{object-fit:cover;max-height:100%;max-width:100%;}"]),P=_.default(o.Button).withConfig({displayName:"pageBackground__RemoveButton",componentId:"sc-1rac0x7-3"})(["margin:1px;align-self:center;"]),S=_.default(o.Button).attrs({size:o.BUTTON_SIZES.SMALL,variant:o.BUTTON_VARIANTS.SQUARE,type:o.BUTTON_TYPES.TERTIARY}).withConfig({displayName:"pageBackground__ReplaceButton",componentId:"sc-1rac0x7-4"})(["margin-right:8px;"]),I=_.default(o.Text).withConfig({displayName:"pageBackground__Text",componentId:"sc-1rac0x7-5"})(["align-self:center;width:55px;"]);var A=_.default(j).withConfig({displayName:"pageBackground___StyledSimplePanel",componentId:"sc-1rac0x7-6"})(["",""],(e=>e.$_css));module.exports=function PageBackgroundPanel(e){let{selectedElements:r,pushUpdate:u}=e;const{isDefaultBackground:j}=r[0],{combineElements:E,currentPage:_,clearBackgroundElement:R,updateCurrentPageProperties:N,currentPageBackgroundColor:U}=p((e=>{let{state:r,actions:t}=e;return{currentPage:r.currentPage,clearBackgroundElement:t.clearBackgroundElement,combineElements:t.combineElements,updateCurrentPageProperties:t.updateCurrentPageProperties,currentPageBackgroundColor:!j||r.currentPage?.backgroundColor}})),{getProxiedUrl:O}=d(),{capabilities:{hasUploadMediaAction:L}}=c(),M=g((e=>{let{state:{pageWidth:r,pageHeight:t}}=e;return{width:r,height:t}})),[H,Y]=t.useState(!1),F=t.useCallback((e=>{N({properties:{backgroundColor:e}})}),[N]),z=t.useCallback((()=>{u({isBackground:!1,opacity:100},!0),R()}),[u,R]),D=t.useCallback((e=>{const t=s.createNewElement(e.type,m(e.type,{resource:e}));E({firstElement:t,secondId:r[0].id}),i.trackEvent("replace_background_media")}),[E,r]),G=t.useCallback((e=>T.default.createElement(S,{onClick:e,"aria-label":a.__("Replace","web-stories")},T.default.createElement(o.Icons.ArrowCloud,null))),[]),{highlight:W,resetHighlight:Z,cancelHighlight:V}=y((e=>({highlight:e[C.default.PAGE_BACKGROUND],resetHighlight:e.onFocusOut,cancelHighlight:e.cancelEffect})));t.useEffect((()=>{q.getPagesWithFailedContrast([_],M).then((e=>{const r=e[0]?.result,t=r?.some((e=>{let{isBackground:r}=e;return r}));Y(Boolean(t))})).catch((()=>{}))}),[_,M]);const Q=r[0];if(!Q||!Q.isBackground)return null;const $=Q.isBackground&&!j,{backgroundColor:K}=_,{LayerIcon:J}=s.getDefinitionForType(Q.type),X=r[0]?.flip||v;return T.default.createElement(A,{onAnimationEnd:()=>Z(),name:"pageBackground",title:a.__("Page Background","web-stories"),isPersistable:!W,collapsedByDefault:!1,$_css:W?.showEffect&&f.styles.FLASH},j&&T.default.createElement(B,null,T.default.createElement(n,{ref:e=>{e&&W?.focus&&W?.showEffect&&(e.addEventListener("keydown",V,{once:!0}),e.focus())},allowsGradient:!0,value:K,onChange:F,label:a.__("Background color","web-stories"),allowsSavedColors:!0,allowsOpacity:!1})),$&&T.default.createElement(B,{expand:!1},T.default.createElement(b,null,T.default.createElement(w,null,T.default.createElement(J,{element:Q,getProxiedUrl:O,currentPageBackgroundColor:U})),T.default.createElement(I,{size:o.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL},a.__("Media","web-stories")),T.default.createElement(P,{"aria-label":a.__("Detach background","web-stories"),onClick:z,size:o.BUTTON_SIZES.SMALL,variant:o.BUTTON_VARIANTS.SQUARE,type:o.BUTTON_TYPES.TERTIARY},T.default.createElement(o.Icons.Cross,null))),L&&T.default.createElement(o.Tooltip,{title:a.__("Replace","web-stories")},T.default.createElement(l,{buttonInsertText:a.__("Use as background","web-stories"),onInsert:D,renderButton:G})),T.default.createElement(k,{onChange:e=>u({flip:e},!0),value:X})),H&&T.default.createElement(x,{message:h.ACCESSIBILITY_COPY.lowContrast.backgroundPanel}))};
