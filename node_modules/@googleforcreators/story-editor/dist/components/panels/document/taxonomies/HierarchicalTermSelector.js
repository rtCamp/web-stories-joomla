/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/i18n"),t=require("@googleforcreators/design-system"),a=require("@googleforcreators/react");require("prop-types");var o=require("styled-components"),s=require("uuid");require("../../../form/color/color.js"),require("../../../form/filterToggle/filterToggle.js"),require("../../../form/linkIcon.js"),require("../../../form/link.js"),require("../../../form/media.js"),require("@googleforcreators/media"),require("@googleforcreators/transform"),require("../../../dropTargets/provider.js"),require("../../../dropTargets/context.js"),require("../../../../app/history/historyProvider.js"),require("../../../../app/history/context.js"),require("@googleforcreators/templates"),require("../../../../app/config/context.js"),require("../../../../app/api/context.js"),require("@googleforcreators/fonts"),require("@googleforcreators/dom"),require("../../../../constants/fonts.js"),require("../../../../constants/multipleValue.js"),require("../../../../app/font/context.js"),require("@googleforcreators/tracking"),require("@googleforcreators/animation"),require("@googleforcreators/masks"),require("@googleforcreators/element-library"),require("@googleforcreators/elements"),require("../../../../app/story/context.js"),require("@googleforcreators/migration"),require("../../../../app/story/actions/useSaveStory.js"),require("clone-deep"),require("../../../../app/story/useStoryReducer/useStoryReducer.js"),require("@googleforcreators/output"),require("../../../../app/story/storyTriggers/storyTriggersProvider.js"),require("../../../../app/story/storyTriggers/storyEvents/onInitialElementAddedRegister.js"),require("../../../../app/story/storyTriggers/storyEvents/onPageAddedRegister.js"),require("../../../../app/media/useUploadMedia.js"),require("@googleforcreators/patterns"),require("../../../../utils/generateBlurhash.worker.js"),require("../../../../app/media/media3p/providerConfiguration.js"),require("../../../../app/media/utils/useFFmpeg.js"),require("../../../../app/media/media3p/api/context.js"),require("../../../../app/media/local/constants.js"),require("../../../../app/media/media3p/providerReducer.js"),require("../../../../app/media/context.js"),require("sat"),require("@googleforcreators/units"),require("../../../../app/layout/context.js"),require("../../../../app/layout/useZoomSetting.js"),require("@googleforcreators/rich-text"),require("@googleforcreators/stickers"),require("../../../library/panes/text/textPresets.js"),require("../../../../app/canvas/context.js"),require("../../../../app/currentUser/context.js"),require("../../../../app/helpCenter/provider.js"),require("../../../../app/helpCenter/context.js"),require("../../../helpCenter/constants.js"),require("../../../../app/rightClickMenu/context.js"),require("../../../form/row.js"),require("../../../form/switch.js"),require("../../../form/textArea.js"),require("../../../form/context.js"),require("../../../form/dateTime/dateTime.js"),require("../../../form/required.js"),require("../../../form/radioGroup/index.js"),require("../../../form/select/select.js");var i=require("../../../form/hierarchical/index.js");require("../../../../app/taxonomy/context.js");var l=require("../../../../app/taxonomy/useTaxonomy.js"),n=require("./shared.js"),u=require("../../../form/hierarchical/utils/index.js");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=c(e),d=c(o);const m="NO_PARENT_VALUE",f=d.default.div.withConfig({displayName:"HierarchicalTermSelector__ContentArea",componentId:"sc-17x36f5-0"})(["label,* > label{",";color:",";}"],(e=>{let{theme:r}=e;return t.themeHelpers.expandPresetStyles({preset:r.typography.presets.label[t.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL],theme:r})}),(e=>{let{theme:r}=e;return r.colors.fg.secondary})),g=d.default.form.withConfig({displayName:"HierarchicalTermSelector__AddNewCategoryForm",componentId:"sc-17x36f5-1"})(["margin:24px 0 16px;"]),q=d.default.div.withConfig({displayName:"HierarchicalTermSelector__ButtonContainer",componentId:"sc-17x36f5-2"})(["display:flex;gap:8px;"]),j=d.default(t.Text).attrs({forwardedAs:"label",size:t.THEME_CONSTANTS.TYPOGRAPHY.PRESET_SIZES.SMALL}).withConfig({displayName:"HierarchicalTermSelector__Label",componentId:"sc-17x36f5-3"})(["display:inline-block;margin:12px 0;"]),y=d.default(t.Button).attrs({variant:t.BUTTON_VARIANTS.RECTANGLE,size:t.BUTTON_SIZES.SMALL,type:t.BUTTON_TYPES.SECONDARY}).withConfig({displayName:"HierarchicalTermSelector__AddNewCategoryButton",componentId:"sc-17x36f5-4"})(["margin-top:20px;"]);module.exports=function HierarchicalTermSelector(e){let{noParentId:o=m,taxonomy:c,canCreateTerms:d}=e;const{createTerm:T,termCache:h,terms:x,setTerms:b}=l((e=>{let{state:{termCache:r,terms:t},actions:{createTerm:a,setTerms:o}}=e;return{createTerm:a,setTerms:o,termCache:r,terms:t}})),C=a.useMemo((()=>h?.[c.restBase]?Object.values(h[c.restBase]).map((e=>({id:e.id,parent:e.parent,value:e.id,label:e.name,checked:x[c.restBase]?.includes(e.id),slug:e.slug}))):[]),[c,h,x]),[E,S]=a.useState(!1),[v,_]=a.useState(""),[k,N]=a.useState(o),I=a.useMemo(s.v4,[]),[A,w]=a.useState(!1),R=a.useRef(),L=a.useRef(),[P,M]=a.useState(!1),[H,O]=a.useState(""),B=a.useCallback((e=>O(e)),[]),F=t.useLiveRegion("assertive"),U=a.useCallback((()=>{_(""),N(o)}),[o]),Y=a.useCallback(((e,r)=>{let{id:t,checked:a}=r;const o=C.find((e=>e.id===t));b(c,(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const r=e.findIndex((e=>e===o.id));return a&&-1===r?[...e,o.id]:!a&&r>-1?[...e.slice(0,r),...e.slice(r+1)]:e}))}),[C,b,c]),V=a.useCallback((()=>{S(!E),U(),w(!E),M(E)}),[U,E]),D=a.useCallback((e=>{_(e.target.value)}),[]),G=a.useMemo((()=>C.find((e=>e.id===k))?.slug),[k,C]),Z=a.useCallback((e=>{e.preventDefault();T(c,v,{id:k===o?0:k,slug:G},!0),F(r.sprintf(
/* Translators: %s: Taxonomy label name. */
r.__("%s added.","web-stories"),c.labels.singular_name)),S(!1),U(),M(E)}),[T,F,v,o,U,k,E,c,G]),$=a.useCallback(((e,r)=>N(r)),[]);a.useEffect((()=>{const e=R.current;if(e){const r=e=>{"Enter"===e.key&&Z(e)};return e.addEventListener("keypress",r),()=>{e.removeEventListener("keypress",r)}}return null}),[Z,R]),a.useEffect((()=>{P&&L.current.focus()}),[P]);const z=a.useMemo((()=>u.makeFlatOptionTree(C,H)),[C,H]),J=a.useMemo((()=>[{value:m,label:r.__("None","web-stories")}].concat(z).map((e=>{let{$level:r,label:t,...a}=e;return{...a,label:`${Array.from({length:r},(()=>"â€” ")).join("")} ${t}`}}))),[z]);return p.default.createElement(f,null,p.default.createElement(n.ContentHeading,null,c.labels.name),p.default.createElement(i.default,{inputValue:H,onInputChange:B,label:c.labels.searchItems,options:z,onChange:Y,noOptionsText:c.labels?.notFound}),d?p.default.createElement(p.default.Fragment,null,!E&&p.default.createElement(n.LinkButton,{ref:L,"aria-expanded":!1,onClick:V},c.labels.addNewItem),E?p.default.createElement(g,{ref:R,onSubmit:Z},p.default.createElement(t.Input,{autoFocus:!0,name:c.labels.newItemName,label:c.labels.newItemName,value:v,onChange:D,hasFocus:A}),p.default.createElement(j,{htmlFor:I},c.labels.parentItem),p.default.createElement(t.DropDown,{id:I,ariaLabel:c.labels.parentItem,options:J,selectedValue:k,onMenuItemClick:$}),p.default.createElement(q,null,p.default.createElement(y,{disabled:!v.length,type:"submit"},c.labels.addNewItem),p.default.createElement(y,{"aria-expanded":!0,onClick:V},r.__("Cancel","web-stories")))):null):null)};
