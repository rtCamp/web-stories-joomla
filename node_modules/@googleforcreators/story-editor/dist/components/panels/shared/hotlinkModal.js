/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";var e=require("react"),r=require("@googleforcreators/i18n"),t=require("@googleforcreators/design-system");require("prop-types");var o=require("styled-components"),i=require("@googleforcreators/react"),s=require("@googleforcreators/tracking"),l=require("@googleforcreators/url"),a=require("../../dialog/dialog.js"),n=require("../../library/panes/media/local/hotlink/utils.js");require("@googleforcreators/templates"),require("../../../app/config/context.js"),require("../../../app/api/context.js");var u=require("../../../app/api/useAPI.js"),c=require("../../../utils/useCORSProxy.js");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var f=p(e);const g=p(o).default.form.withConfig({displayName:"hotlinkModal__InputWrapper",componentId:"sc-bvssi1-0"})(["margin:16px 4px;width:470px;height:100px;"]);module.exports=function HotlinkModal(e){let{isOpen:o,onClose:p,onSelect:d,allowedFileTypes:_=[],title:y}=e;const[m,b]=i.useState(!1),[h,k]=i.useState(""),[q,w]=i.useState(!1),v=i.useRef(null),{actions:{getHotlinkInfo:x}}=u(),{checkResourceAccess:C}=c(),E=q||!h||m,I=m?r.__("Insertingâ€¦","web-stories"):r.__("Insert","web-stories");let j=r.__("No file types are currently supported.","web-stories");_.length&&(j=r.sprintf(
/* translators: %s is a list of allowed file extensions. */
r.__("You can insert %s.","web-stories"),r.translateToExclusiveList(_))),i.useLayoutEffect((()=>{const e=setTimeout((()=>{o&&v.current&&v.current.focus()}));return()=>clearTimeout(e)}),[o,v]);const S=i.useCallback((()=>{if(h?.length>0){const e=l.withProtocol(h);k(e),n.isValidUrlForHotlinking(e)||w(r.__("Invalid link.","web-stories"))}}),[h]),T=i.useCallback((e=>{q&&w(null),k(e)}),[k,q]),P=i.useCallback((async()=>{if(h)if(n.isValidUrlForHotlinking(h)){b(!0);try{const e=await x(h),r=await C(h);s.trackEvent("hotlink_file",{event_label:h,file_size:e.fileSize,file_type:e.mimeType,needs_proxy:r}),d({src:h,needsProxy:r})}catch(e){s.trackError("hotlink_file",e?.message),w(n.getErrorMessage(e.code,j))}finally{b(!1)}}else w(r.__("Invalid link.","web-stories"))}),[j,d,h,x,w,C]),R=i.useCallback((e=>{e.preventDefault(),E||P()}),[E,P]);return f.default.createElement(a,{onClose:()=>{p(),k(""),w(!1),b(!1)},isOpen:o,title:y,onPrimary:()=>P(),primaryText:I,secondaryText:r.__("Cancel","web-stories"),primaryRest:{disabled:E}},f.default.createElement(g,{onSubmit:R},f.default.createElement(t.Input,{ref:v,onChange:e=>{let{target:{value:r}}=e;return T(r)},value:h,hint:q?.length?q:j,hasError:Boolean(q?.length),onBlur:S,label:r.__("URL","web-stories"),type:"url",required:!0})))};
